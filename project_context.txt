# Contexte du Projet : Fleet & Geofence API
GÃ©nÃ©rÃ© le : 12/23/2025 15:53:27
Framework : Spring Boot WebFlux (Reactive)

## 1. Arborescence du Projet

Structure du dossier pour le volume Nouveau nom
Le numÚro de sÚrie du volume est 30FA-23FE
D:.
ª   .classpath
ª   .project
ª   docker-compose.yml
ª   Dockerfile
ª   import_context.sh
ª   import_context_window.ps1
ª   pom.xml
ª   project_context.txt
ª   Readme.md
ª   todo.md
ª   
ª   +---wrapper
ª           maven-wrapper.properties
ª           
+---.settings
ª       org.eclipse.core.resources.prefs
ª       org.eclipse.jdt.core.prefs
ª       
ª       settings.json
ª       
ª   ª   .project
ª   ª   docker-compose.yml
ª   ª   Dockerfile
ª   ª   import_context.sh
ª   ª   pom.xml
ª   ª   project_context.txt
ª   ª   Readme.md
ª   ª   todo.md
ª   ª   
ª   ª   +---wrapper
ª   ª           maven-wrapper.properties
ª   ª           
ª   +---.settings
ª   ª       org.eclipse.core.resources.prefs
ª   ª       
ª   ª       settings.json
ª   ª       
ª   +---docs
ª   ª   ª   contracts_fleet_management.md
ª   ª   ª   database_setup.md
ª   ª   ª   fleet-management.pdf
ª   ª   ª   remarks_of_conception.md
ª   ª   ª   
ª   ª   +---data
ª   ª   ª   +---YOWYOB_DB
ª   ª   ª           README.md
ª   ª   ª           yowyob_db_init.sql
ª   ª   ª           yowyob_db_seed.sql
ª   ª   ª           yowyob_db_test.sql
ª   ª   ª           
ª   ª   +---prompts
ª   ª           master_pair_programmer.md
ª   ª           
ª   +---src
ª   ª   +---main
ª   ª   ª   +---java
ª   ª   ª   ª   +---com
ª   ª   ª   ª       +---yowyob
ª   ª   ª   ª           +---fleet
ª   ª   ª   ª               ª   FleetManagementApplication.class
ª   ª   ª   ª               ª   
ª   ª   ª   ª               +---application
ª   ª   ª   ª               ª   +---service
ª   ª   ª   ª               ª           ProductService.class
ª   ª   ª   ª               ª           
ª   ª   ª   ª               +---domain
ª   ª   ª   ª               ª   +---exception
ª   ª   ª   ª               ª   ª       StockFullException.class
ª   ª   ª   ª               ª   ª       
ª   ª   ª   ª               ª   +---model
ª   ª   ª   ª               ª   ª       Product.class
ª   ª   ª   ª               ª   ª       
ª   ª   ª   ª               ª   +---ports
ª   ª   ª   ª               ª       +---in
ª   ª   ª   ª               ª       ª       CreateProductUseCase.class
ª   ª   ª   ª               ª       ª       
ª   ª   ª   ª               ª       +---out
ª   ª   ª   ª               ª               ProductCachePort.class
ª   ª   ª   ª               ª               ProductEventPublisherPort.class
ª   ª   ª   ª               ª               ProductRepositoryPort.class
ª   ª   ª   ª               ª               StockClientPort.class
ª   ª   ª   ª               ª               
ª   ª   ª   ª               +---infrastructure
ª   ª   ª   ª                   +---adapters
ª   ª   ª   ª                   ª   +---inbound
ª   ª   ª   ª                   ª   ª   +---kafka
ª   ª   ª   ª                   ª   ª   ª       ProductEventConsumer.class
ª   ª   ª   ª                   ª   ª   ª       
ª   ª   ª   ª                   ª   ª   +---rest
ª   ª   ª   ª                   ª   ª       ª   GlobalExceptionHandler.class
ª   ª   ª   ª                   ª   ª       ª   HealthCheckController.class
ª   ª   ª   ª                   ª   ª       ª   ProductController.class
ª   ª   ª   ª                   ª   ª       ª   
ª   ª   ª   ª                   ª   ª       +---dto
ª   ª   ª   ª                   ª   ª               ProductRequest.class
ª   ª   ª   ª                   ª   ª               ProductResponse.class
ª   ª   ª   ª                   ª   ª               
ª   ª   ª   ª                   ª   +---outbound
ª   ª   ª   ª                   ª       +---cache
ª   ª   ª   ª                   ª       ª       RedisAdapter.class
ª   ª   ª   ª                   ª       ª       
ª   ª   ª   ª                   ª       +---external
ª   ª   ª   ª                   ª       ª   ª   StockAdapter.class
ª   ª   ª   ª                   ª       ª   ª   
ª   ª   ª   ª                   ª       ª   +---client
ª   ª   ª   ª                   ª       ª           StockApiClient$StockResponse.class
ª   ª   ª   ª                   ª       ª           StockApiClient.class
ª   ª   ª   ª                   ª       ª           
ª   ª   ª   ª                   ª       +---messaging
ª   ª   ª   ª                   ª       ª       KafkaAdapter.class
ª   ª   ª   ª                   ª       ª       
ª   ª   ª   ª                   ª       +---persistence
ª   ª   ª   ª                   ª           ª   PostgresR2dbcAdapter.class
ª   ª   ª   ª                   ª           ª   
ª   ª   ª   ª                   ª           +---entity
ª   ª   ª   ª                   ª           ª       ProductEntity.class
ª   ª   ª   ª                   ª           ª       
ª   ª   ª   ª                   ª           +---repository
ª   ª   ª   ª                   ª                   ProductR2dbcRepository.class
ª   ª   ª   ª                   ª                   
ª   ª   ª   ª                   +---config
ª   ª   ª   ª                   ª       DatabaseInitConfig.class
ª   ª   ª   ª                   ª       KafkaConfig.class
ª   ª   ª   ª                   ª       OpenApiConfig.class
ª   ª   ª   ª                   ª       RedisConfig.class
ª   ª   ª   ª                   ª       SecurityConfig.class
ª   ª   ª   ª                   ª       WebClientConfig.class
ª   ª   ª   ª                   ª       
ª   ª   ª   ª                   +---mappers
ª   ª   ª   ª                           ProductMapper.class
ª   ª   ª   ª                           
ª   ª   ª   +---resources
ª   ª   ª       ª   application.yml
ª   ª   ª       ª   prod.application.yml
ª   ª   ª       ª   schema.sql.bak
ª   ª   ª       ª   
ª   ª   ª       +---local
ª   ª   ª               data.sql
ª   ª   ª               schema.sql
ª   ª   ª               
ª   ª   +---test
ª   ª       +---java
ª   ª           +---com
ª   ª               +---yowyob
ª   ª                   +---reactive_hexagonal
ª   ª                           ReactiveHexagonalApplicationTests.class
ª   ª                           
ª       +---classes
ª       ª   ª   application.yml
ª       ª   ª   prod.application.yml
ª       ª   ª   schema.sql.bak
ª       ª   ª   
ª       ª   +---com
ª       ª   ª   +---yowyob
ª       ª   ª       +---fleet
ª       ª   ª           +---application
ª       ª   ª           ª   +---service
ª       ª   ª           +---domain
ª       ª   ª           ª   +---exception
ª       ª   ª           ª   +---model
ª       ª   ª           ª   +---ports
ª       ª   ª           ª       +---in
ª       ª   ª           ª       +---out
ª       ª   ª           +---infrastructure
ª       ª   ª               +---adapters
ª       ª   ª               ª   +---inbound
ª       ª   ª               ª   ª   +---kafka
ª       ª   ª               ª   ª   +---rest
ª       ª   ª               ª   ª       +---dto
ª       ª   ª               ª   +---outbound
ª       ª   ª               ª       +---cache
ª       ª   ª               ª       +---external
ª       ª   ª               ª       ª   +---client
ª       ª   ª               ª       +---messaging
ª       ª   ª               ª       +---persistence
ª       ª   ª               ª           +---entity
ª       ª   ª               ª           +---repository
ª       ª   ª               +---config
ª       ª   ª               +---mappers
ª       ª   +---local
ª       ª   ª       data.sql
ª       ª   ª       schema.sql
ª       ª   ª       
ª       ª   +---META-INF
ª       ª           MANIFEST.MF
ª       ª           
ª       +---generated-sources
ª       ª   +---annotations
ª       +---test-classes
ª           +---com
ª               +---yowyob
ª                   +---reactive_hexagonal
+---docs
ª   ª   contracts_fleet_management.md
ª   ª   database_setup.md
ª   ª   fleet-management.pdf
ª   ª   remarks_of_conception.md
ª   ª   
ª   +---data
ª   ª   +---YOWYOB_DB
ª   ª           README.md
ª   ª           yowyob_db_init.sql
ª   ª           yowyob_db_seed.sql
ª   ª           yowyob_db_test.sql
ª   ª           
ª   +---prompts
ª           master_pair_programmer.md
ª           
+---src
ª   +---main
ª   ª   +---java
ª   ª   ª   +---com
ª   ª   ª       +---yowyob
ª   ª   ª           +---fleet
ª   ª   ª               ª   FleetManagementApplication.java
ª   ª   ª               ª   
ª   ª   ª               +---application
ª   ª   ª               ª   +---service
ª   ª   ª               ª           AuthService.java
ª   ª   ª               ª           ProductService.java
ª   ª   ª               ª           
ª   ª   ª               +---domain
ª   ª   ª               ª   +---exception
ª   ª   ª               ª   ª       StockFullException.java
ª   ª   ª               ª   ª       
ª   ª   ª               ª   +---model
ª   ª   ª               ª   ª       Product.java
ª   ª   ª               ª   ª       
ª   ª   ª               ª   +---ports
ª   ª   ª               ª       +---in
ª   ª   ª               ª       ª       AuthUseCase.java
ª   ª   ª               ª       ª       CreateProductUseCase.java
ª   ª   ª               ª       ª       
ª   ª   ª               ª       +---out
ª   ª   ª               ª               AuthPort.java
ª   ª   ª               ª               ProductCachePort.java
ª   ª   ª               ª               ProductEventPublisherPort.java
ª   ª   ª               ª               ProductRepositoryPort.java
ª   ª   ª               ª               StockClientPort.java
ª   ª   ª               ª               
ª   ª   ª               +---infrastructure
ª   ª   ª                   +---adapters
ª   ª   ª                   ª   +---inbound
ª   ª   ª                   ª   ª   +---kafka
ª   ª   ª                   ª   ª   ª       ProductEventConsumer.java
ª   ª   ª                   ª   ª   ª       
ª   ª   ª                   ª   ª   +---rest
ª   ª   ª                   ª   ª       ª   AuthController.java
ª   ª   ª                   ª   ª       ª   GlobalExceptionHandler.java
ª   ª   ª                   ª   ª       ª   HealthCheckController.java
ª   ª   ª                   ª   ª       ª   ProductController.java
ª   ª   ª                   ª   ª       ª   
ª   ª   ª                   ª   ª       +---dto
ª   ª   ª                   ª   ª               ProductRequest.java
ª   ª   ª                   ª   ª               ProductResponse.java
ª   ª   ª                   ª   ª               
ª   ª   ª                   ª   +---outbound
ª   ª   ª                   ª       +---cache
ª   ª   ª                   ª       ª       RedisAdapter.java
ª   ª   ª                   ª       ª       
ª   ª   ª                   ª       +---external
ª   ª   ª                   ª       ª   ª   FakeAuthAdapter.java
ª   ª   ª                   ª       ª   ª   RemoteAuthAdapter.java
ª   ª   ª                   ª       ª   ª   StockAdapter.java
ª   ª   ª                   ª       ª   ª   
ª   ª   ª                   ª       ª   +---client
ª   ª   ª                   ª       ª           AuthApiClient.java
ª   ª   ª                   ª       ª           StockApiClient.java
ª   ª   ª                   ª       ª           
ª   ª   ª                   ª       +---messaging
ª   ª   ª                   ª       ª       KafkaAdapter.java
ª   ª   ª                   ª       ª       
ª   ª   ª                   ª       +---persistence
ª   ª   ª                   ª           ª   PostgresR2dbcAdapter.java
ª   ª   ª                   ª           ª   
ª   ª   ª                   ª           +---entity
ª   ª   ª                   ª           ª       ProductEntity.java
ª   ª   ª                   ª           ª       
ª   ª   ª                   ª           +---repository
ª   ª   ª                   ª                   ProductR2dbcRepository.java
ª   ª   ª                   ª                   
ª   ª   ª                   +---config
ª   ª   ª                   ª       AuthConfig.java
ª   ª   ª                   ª       DatabaseInitConfig.java
ª   ª   ª                   ª       KafkaConfig.java
ª   ª   ª                   ª       OpenApiConfig.java
ª   ª   ª                   ª       RedisConfig.java
ª   ª   ª                   ª       SecurityConfig.java
ª   ª   ª                   ª       WebClientConfig.java
ª   ª   ª                   ª       
ª   ª   ª                   +---mappers
ª   ª   ª                           ProductMapper.java
ª   ª   ª                           
ª   ª   +---resources
ª   ª       ª   application.yml
ª   ª       ª   prod.application.yml
ª   ª       ª   schema.sql.bak
ª   ª       ª   
ª   ª       +---local
ª   ª               data.sql
ª   ª               schema.sql
ª   ª               
ª   +---test
ª       +---java
ª           +---com
ª               +---yowyob
ª                   +---reactive_hexagonal
ª                           ReactiveHexagonalApplicationTests.java
ª                           
    +---classes
    ª   ª   application.yml
    ª   ª   prod.application.yml
    ª   ª   schema.sql.bak
    ª   ª   
    ª   +---com
    ª   ª   +---yowyob
    ª   ª       +---fleet
    ª   ª           ª   FleetManagementApplication.class
    ª   ª           ª   
    ª   ª           +---application
    ª   ª           ª   +---service
    ª   ª           ª           AuthService.class
    ª   ª           ª           ProductService.class
    ª   ª           ª           
    ª   ª           +---domain
    ª   ª           ª   +---exception
    ª   ª           ª   ª       StockFullException.class
    ª   ª           ª   ª       
    ª   ª           ª   +---model
    ª   ª           ª   ª       Product.class
    ª   ª           ª   ª       
    ª   ª           ª   +---ports
    ª   ª           ª       +---in
    ª   ª           ª       ª       AuthUseCase.class
    ª   ª           ª       ª       CreateProductUseCase.class
    ª   ª           ª       ª       
    ª   ª           ª       +---out
    ª   ª           ª               AuthPort$AuthResponse.class
    ª   ª           ª               AuthPort.class
    ª   ª           ª               ProductCachePort.class
    ª   ª           ª               ProductEventPublisherPort.class
    ª   ª           ª               ProductRepositoryPort.class
    ª   ª           ª               StockClientPort.class
    ª   ª           ª               
    ª   ª           +---infrastructure
    ª   ª               +---adapters
    ª   ª               ª   +---inbound
    ª   ª               ª   ª   +---kafka
    ª   ª               ª   ª   ª       ProductEventConsumer.class
    ª   ª               ª   ª   ª       
    ª   ª               ª   ª   +---rest
    ª   ª               ª   ª       ª   AuthController$LoginRequest.class
    ª   ª               ª   ª       ª   AuthController$RegisterDto.class
    ª   ª               ª   ª       ª   AuthController.class
    ª   ª               ª   ª       ª   GlobalExceptionHandler.class
    ª   ª               ª   ª       ª   HealthCheckController.class
    ª   ª               ª   ª       ª   ProductController.class
    ª   ª               ª   ª       ª   
    ª   ª               ª   ª       +---dto
    ª   ª               ª   ª               ProductRequest.class
    ª   ª               ª   ª               ProductResponse.class
    ª   ª               ª   ª               
    ª   ª               ª   +---outbound
    ª   ª               ª       +---cache
    ª   ª               ª       ª       RedisAdapter.class
    ª   ª               ª       ª       
    ª   ª               ª       +---external
    ª   ª               ª       ª   ª   FakeAuthAdapter.class
    ª   ª               ª       ª   ª   RemoteAuthAdapter.class
    ª   ª               ª       ª   ª   StockAdapter.class
    ª   ª               ª       ª   ª   
    ª   ª               ª       ª   +---client
    ª   ª               ª       ª           AuthApiClient$LoginRequest.class
    ª   ª               ª       ª           AuthApiClient$RegisterRequest.class
    ª   ª               ª       ª           AuthApiClient$TraMaSysResponse.class
    ª   ª               ª       ª           AuthApiClient$UserDetail.class
    ª   ª               ª       ª           AuthApiClient.class
    ª   ª               ª       ª           StockApiClient$StockResponse.class
    ª   ª               ª       ª           StockApiClient.class
    ª   ª               ª       ª           
    ª   ª               ª       +---messaging
    ª   ª               ª       ª       KafkaAdapter.class
    ª   ª               ª       ª       
    ª   ª               ª       +---persistence
    ª   ª               ª           ª   PostgresR2dbcAdapter.class
    ª   ª               ª           ª   
    ª   ª               ª           +---entity
    ª   ª               ª           ª       ProductEntity.class
    ª   ª               ª           ª       
    ª   ª               ª           +---repository
    ª   ª               ª                   ProductR2dbcRepository.class
    ª   ª               ª                   
    ª   ª               +---config
    ª   ª               ª       AuthConfig.class
    ª   ª               ª       DatabaseInitConfig.class
    ª   ª               ª       KafkaConfig.class
    ª   ª               ª       OpenApiConfig.class
    ª   ª               ª       RedisConfig.class
    ª   ª               ª       SecurityConfig.class
    ª   ª               ª       WebClientConfig.class
    ª   ª               ª       
    ª   ª               +---mappers
    ª   ª                       ProductMapper.class
    ª   ª                       ProductMapperImpl.class
    ª   ª                       
    ª   +---local
    ª           data.sql
    ª           schema.sql
    ª           
    +---generated-sources
    ª   +---annotations
    ª       +---com
    ª           +---yowyob
    ª               +---fleet
    ª                   +---infrastructure
    ª                       +---mappers
    ª                               ProductMapperImpl.java
    ª                               
    +---generated-test-sources
    ª   +---test-annotations
    +---maven-status
    ª   +---maven-compiler-plugin
    ª       +---compile
    ª       ª   +---default-compile
    ª       ª           createdFiles.lst
    ª       ª           inputFiles.lst
    ª       ª           
    ª       +---testCompile
    ª           +---default-testCompile
    ª                   createdFiles.lst
    ª                   inputFiles.lst
    ª                   
    +---test-classes
        +---com
            +---yowyob
                +---reactive_hexagonal
                        ReactiveHexagonalApplicationTests.class
                        


## 2. Contenu des Fichiers

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\docker-compose.yml
`$ext
services:
  fleet-db:
    image: postgres:16
    container_name: fleet-management-db
    environment:
      POSTGRES_DB: yowyob_db
      POSTGRES_USER: fleet_admin
      POSTGRES_PASSWORD: fleet_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\pom.xml
`$ext
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.6</version>
        <relativePath/>
    </parent>
    
    <groupId>com.yowyob</groupId>
    <artifactId>reactive-hexagonal</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>reactive-hexagonal</name>
    <description>Template Hexagonal Reactive pour com.yowyob</description>
    
    <properties>
        <java.version>21</java.version>
        <spring-cloud.version>2023.0.0</spring-cloud.version>
        <mapstruct.version>1.5.5.Final</mapstruct.version>
    </properties>
    
    <dependencies>
        <!-- REACTIVE CORE -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <dependency>
             <groupId>org.springframework.boot</groupId>
             <artifactId>spring-boot-starter-actuator</artifactId>
	</dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>

  
	<dependency>
	   <groupId>io.micrometer</groupId>
	   <artifactId>micrometer-registry-prometheus</artifactId>
	</dependency>

        <!-- DATA (R2DBC & REDIS) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-r2dbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>r2dbc-postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
        </dependency>

        <!-- MESSAGING (KAFKA) -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>
        <dependency>
            <groupId>io.projectreactor.kafka</groupId>
            <artifactId>reactor-kafka</artifactId>
            <version>1.3.22</version>
        </dependency>

        <!-- CLOUD & RESILIENCE -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-circuitbreaker-reactor-resilience4j</artifactId>
        </dependency>

        <!-- TOOLS (Lombok & Mapstruct) -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>${mapstruct.version}</version>
        </dependency>
        
        <!-- Docker Compose Auto-setup -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-docker-compose</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        
        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.projectreactor</groupId>
            <artifactId>reactor-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Documentation API (Swagger/OpenAPI) -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webflux-ui</artifactId>
            <version>2.5.0</version>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${mapstruct.version}</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\Readme.md
`$ext
# Fleet Management & Geofencing API ðŸššðŸ›°ï¸

Service backend rÃ©actif pour la gestion de flottes de vÃ©hicules et le gÃ©orepÃ©rage en temps rÃ©el.

## ðŸ¤ Workflow de Collaboration IA

Ce projet est dÃ©veloppÃ© en mode **Pair Programming** avec une IA (Gemini/ChatGPT). Pour maintenir la cohÃ©rence :

1. **Roadmap** : Consultez le fichier `todo.md` pour voir la tÃ¢che en cours.
2. **Contextualisation** : L'IA a besoin du code source complet. Utilisez le script de synchronisation :
   ```bash
   chmod +x import_context.sh
   ./import_context.sh
   ```
   Cela gÃ©nÃ¨re/met Ã  jour le fichier `project_context.txt`.
3. **Initialisation de l'IA** : Pour commencer une session, copiez-collez le contenu de `docs/prompts/master_pair_programmer.md` suivi du contenu de `project_context.txt`.

## ðŸ› ï¸ Installation & Tests

### PrÃ©requis
- Java 21
- PostgreSQL (avec accÃ¨s aux serveurs distants configurÃ©s dans le `.yml`)

### Lancer l'application
```bash
./mvnw clean install
./mvnw spring-boot:run
```

### Valider les changements
- **Swagger UI** : [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **SantÃ© de la DB** : Utilisez les endpoints dÃ©finis dans chaque jalon (voir `todo.md`).
```


---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\todo.md
`$ext
### ðŸ“‹ Roadmap Macro : API Fleet & Geofence

#### Jalon 1 : Initialisation, Structure & Persistence (Fondations)
- [x] **TÃ¢che 1.1 :** Nettoyage et Refactoring du template (Renommage packages, suppression de la logique "Product").
- [x] **TÃ¢che 1.2 :** ImplÃ©mentation du SchÃ©ma de donnÃ©es (Traduction du contrat v1.0 en SQL pour PostgreSQL).
- [x] **TÃ¢che 1.3 :** Mise en place du mÃ©canisme de **Seeding** (GÃ©nÃ©ration automatique de donnÃ©es de test au dÃ©marrage).
- [x] **TÃ¢che 1.4 :** **Validation swagger** : VÃ©rification de l'Ã©tat de la base de donnÃ©es via un endpoint de santÃ© (Health Check).
- [x] **TÃ¢che 1.5:** *Guide*: Elaboration d'un guide pour que les collaborateurs puissent initialiser la bd sans probleme et la seed en mode local.(le plus facilement possible) 

#### Jalon 2 : Authentification & AccÃ¨s (CU1)
- [x] **TÃ¢che 2.1 :** Configuration de la SÃ©curitÃ© RÃ©active (Spring Security).
- [ ] **TÃ¢che 2.2 :** IntÃ©gration du Service d'Authentification externe (Adaptateur WebClient).
- [ ] **TÃ¢che 2.3 :** ImplÃ©mentation du **Mode DÃ©gradÃ© (Fake Auth)** pour le dÃ©veloppement local.
- [ ] **TÃ¢che 2.4 :** **Validation Postman** : Tests de login, gÃ©nÃ©ration de token et accÃ¨s restreint par rÃ´les (RBAC).
- [ ] **TÃ¢che 2.5 :** IntÃ©gration des routes "mot de passe oubliÃ©" et autres via l'API d'authentification externe.

#### Jalon 3 : Gestion de la Flotte (CU17, CU18, CU19)
- [ ] **TÃ¢che 3.1 :** Use-Case : CrÃ©er / Modifier / Supprimer une Flotte (Fleets).
- [ ] **TÃ¢che 3.2 :** Use-Case : CrÃ©er / Modifier / Supprimer un VÃ©hicule (Vehicles).
- [ ] **TÃ¢che 3.3 :** Gestion des paramÃ¨tres dÃ©taillÃ©s (Financial & Maintenance parameters).
- [ ] **TÃ¢che 3.4 :** **Validation Postman** : CRUD complet des vÃ©hicules et flottes.

#### Jalon 4 : Gestion des Chauffeurs & Assignations (CU21, CU24)
- [ ] **TÃ¢che 4.1 :** Use-Case : CrÃ©er / GÃ©rer un profil Driver (liÃ© Ã  l'utilisateur distant).
- [ ] **TÃ¢che 4.2 :** Use-Case : Assigner / LibÃ©rer un vÃ©hicule Ã  un chauffeur.
- [ ] **TÃ¢che 4.3 :** **Validation Postman** : ScÃ©nario complet d'enregistrement et d'affectation d'un chauffeur.

#### Jalon 5 : Gestion des Trajets & Temps RÃ©el (CU4, CU5, CU2, CU14)
- [ ] **TÃ¢che 5.1 :** Use-Case : DÃ©marrer un trajet (Start Trip).
- [ ] **TÃ¢che 5.2 :** Use-Case : Terminer un trajet (End Trip) et calcul des statistiques de fin de trajet.
- [ ] **TÃ¢che 5.3 :** Mise Ã  jour des paramÃ¨tres opÃ©rationnels (Positions GPS, vitesse, fuel) en flux continu.
- [ ] **TÃ¢che 5.4 :** **Validation Postman** : Simulation d'un trajet complet et vÃ©rification des logs.

#### Jalon 6 : Moteur de Geofencing & Alertes (CU10, CU11, CU12, CU13)
- [ ] **TÃ¢che 6.1 :** Use-Case : DÃ©finir et gÃ©rer les zones (Geofence Zones).
- [ ] **TÃ¢che 6.2 :** Moteur de dÃ©tection rÃ©actif (Intersection position / zone).
- [ ] **TÃ¢che 6.3 :** Publication des alertes dans Kafka.
- [ ] **TÃ¢che 6.4 :** **Validation Postman** : DÃ©clenchement manuel d'une alerte en injectant une position GPS hors zone.

#### Jalon 7 : IntÃ©grations Services PÃ©riphÃ©riques (Fare, Payment, Medias, Notification)
- [ ] **TÃ¢che 7.1 :** Adaptateurs pour Fare Calculator & Payment (avec mode Fake data).
- [ ] **TÃ¢che 7.2 :** Adaptateur pour l'API Media (Gestion des images).
- [ ] **TÃ¢che 7.3 :** IntÃ©gration finale du service de Notification.
- [ ] **TÃ¢che 7.4 :** **Validation Postman** : Tests de bout en bout incluant les services externes.


---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\.mvn\wrapper\maven-wrapper.properties
`$ext
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\docker-compose.yml
`$ext
services:
  fleet-db:
    image: postgres:16
    container_name: fleet-management-db
    environment:
      POSTGRES_DB: yowyob_db
      POSTGRES_USER: fleet_admin
      POSTGRES_PASSWORD: fleet_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\pom.xml
`$ext
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.6</version>
        <relativePath/>
    </parent>
    
    <groupId>com.yowyob</groupId>
    <artifactId>reactive-hexagonal</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>reactive-hexagonal</name>
    <description>Template Hexagonal Reactive pour com.yowyob</description>
    
    <properties>
        <java.version>21</java.version>
        <spring-cloud.version>2023.0.0</spring-cloud.version>
        <mapstruct.version>1.5.5.Final</mapstruct.version>
    </properties>
    
    <dependencies>
        <!-- REACTIVE CORE -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <dependency>
             <groupId>org.springframework.boot</groupId>
             <artifactId>spring-boot-starter-actuator</artifactId>
	</dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>

  
	<dependency>
	   <groupId>io.micrometer</groupId>
	   <artifactId>micrometer-registry-prometheus</artifactId>
	</dependency>

        <!-- DATA (R2DBC & REDIS) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-r2dbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>r2dbc-postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
        </dependency>

        <!-- MESSAGING (KAFKA) -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>
        <dependency>
            <groupId>io.projectreactor.kafka</groupId>
            <artifactId>reactor-kafka</artifactId>
            <version>1.3.22</version>
        </dependency>

        <!-- CLOUD & RESILIENCE -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-circuitbreaker-reactor-resilience4j</artifactId>
        </dependency>

        <!-- TOOLS (Lombok & Mapstruct) -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>${mapstruct.version}</version>
        </dependency>
        
        <!-- Docker Compose Auto-setup -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-docker-compose</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        
        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.projectreactor</groupId>
            <artifactId>reactor-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Documentation API (Swagger/OpenAPI) -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webflux-ui</artifactId>
            <version>2.5.0</version>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${mapstruct.version}</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\Readme.md
`$ext
# Fleet Management & Geofencing API ðŸššðŸ›°ï¸

Service backend rÃ©actif pour la gestion de flottes de vÃ©hicules et le gÃ©orepÃ©rage en temps rÃ©el.

## ðŸ¤ Workflow de Collaboration IA

Ce projet est dÃ©veloppÃ© en mode **Pair Programming** avec une IA (Gemini/ChatGPT). Pour maintenir la cohÃ©rence :

1. **Roadmap** : Consultez le fichier `todo.md` pour voir la tÃ¢che en cours.
2. **Contextualisation** : L'IA a besoin du code source complet. Utilisez le script de synchronisation :
   ```bash
   chmod +x import_context.sh
   ./import_context.sh
   ```
   Cela gÃ©nÃ¨re/met Ã  jour le fichier `project_context.txt`.
3. **Initialisation de l'IA** : Pour commencer une session, copiez-collez le contenu de `docs/prompts/master_pair_programmer.md` suivi du contenu de `project_context.txt`.

## ðŸ› ï¸ Installation & Tests

### PrÃ©requis
- Java 21
- PostgreSQL (avec accÃ¨s aux serveurs distants configurÃ©s dans le `.yml`)

### Lancer l'application
```bash
./mvnw clean install
./mvnw spring-boot:run
```

### Valider les changements
- **Swagger UI** : [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **SantÃ© de la DB** : Utilisez les endpoints dÃ©finis dans chaque jalon (voir `todo.md`).
```


---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\todo.md
`$ext
### ðŸ“‹ Roadmap Macro : API Fleet & Geofence

#### Jalon 1 : Initialisation, Structure & Persistence (Fondations)
- [x] **TÃ¢che 1.1 :** Nettoyage et Refactoring du template (Renommage packages, suppression de la logique "Product").
- [x] **TÃ¢che 1.2 :** ImplÃ©mentation du SchÃ©ma de donnÃ©es (Traduction du contrat v1.0 en SQL pour PostgreSQL).
- [x] **TÃ¢che 1.3 :** Mise en place du mÃ©canisme de **Seeding** (GÃ©nÃ©ration automatique de donnÃ©es de test au dÃ©marrage).
- [x] **TÃ¢che 1.4 :** **Validation swagger** : VÃ©rification de l'Ã©tat de la base de donnÃ©es via un endpoint de santÃ© (Health Check).
- [x] **TÃ¢che 1.5:** *Guide*: Elaboration d'un guide pour que les collaborateurs puissent initialiser la bd sans probleme et la seed en mode local.(le plus facilement possible) 

#### Jalon 2 : Authentification & AccÃ¨s (CU1)
- [x] **TÃ¢che 2.1 :** Configuration de la SÃ©curitÃ© RÃ©active (Spring Security).
- [ ] **TÃ¢che 2.2 :** IntÃ©gration du Service d'Authentification externe (Adaptateur WebClient).
- [ ] **TÃ¢che 2.3 :** ImplÃ©mentation du **Mode DÃ©gradÃ© (Fake Auth)** pour le dÃ©veloppement local.
- [ ] **TÃ¢che 2.4 :** **Validation Postman** : Tests de login, gÃ©nÃ©ration de token et accÃ¨s restreint par rÃ´les (RBAC).
- [ ] **TÃ¢che 2.5 :** IntÃ©gration des routes "mot de passe oubliÃ©" et autres via l'API d'authentification externe.

#### Jalon 3 : Gestion de la Flotte (CU17, CU18, CU19)
- [ ] **TÃ¢che 3.1 :** Use-Case : CrÃ©er / Modifier / Supprimer une Flotte (Fleets).
- [ ] **TÃ¢che 3.2 :** Use-Case : CrÃ©er / Modifier / Supprimer un VÃ©hicule (Vehicles).
- [ ] **TÃ¢che 3.3 :** Gestion des paramÃ¨tres dÃ©taillÃ©s (Financial & Maintenance parameters).
- [ ] **TÃ¢che 3.4 :** **Validation Postman** : CRUD complet des vÃ©hicules et flottes.

#### Jalon 4 : Gestion des Chauffeurs & Assignations (CU21, CU24)
- [ ] **TÃ¢che 4.1 :** Use-Case : CrÃ©er / GÃ©rer un profil Driver (liÃ© Ã  l'utilisateur distant).
- [ ] **TÃ¢che 4.2 :** Use-Case : Assigner / LibÃ©rer un vÃ©hicule Ã  un chauffeur.
- [ ] **TÃ¢che 4.3 :** **Validation Postman** : ScÃ©nario complet d'enregistrement et d'affectation d'un chauffeur.

#### Jalon 5 : Gestion des Trajets & Temps RÃ©el (CU4, CU5, CU2, CU14)
- [ ] **TÃ¢che 5.1 :** Use-Case : DÃ©marrer un trajet (Start Trip).
- [ ] **TÃ¢che 5.2 :** Use-Case : Terminer un trajet (End Trip) et calcul des statistiques de fin de trajet.
- [ ] **TÃ¢che 5.3 :** Mise Ã  jour des paramÃ¨tres opÃ©rationnels (Positions GPS, vitesse, fuel) en flux continu.
- [ ] **TÃ¢che 5.4 :** **Validation Postman** : Simulation d'un trajet complet et vÃ©rification des logs.

#### Jalon 6 : Moteur de Geofencing & Alertes (CU10, CU11, CU12, CU13)
- [ ] **TÃ¢che 6.1 :** Use-Case : DÃ©finir et gÃ©rer les zones (Geofence Zones).
- [ ] **TÃ¢che 6.2 :** Moteur de dÃ©tection rÃ©actif (Intersection position / zone).
- [ ] **TÃ¢che 6.3 :** Publication des alertes dans Kafka.
- [ ] **TÃ¢che 6.4 :** **Validation Postman** : DÃ©clenchement manuel d'une alerte en injectant une position GPS hors zone.

#### Jalon 7 : IntÃ©grations Services PÃ©riphÃ©riques (Fare, Payment, Medias, Notification)
- [ ] **TÃ¢che 7.1 :** Adaptateurs pour Fare Calculator & Payment (avec mode Fake data).
- [ ] **TÃ¢che 7.2 :** Adaptateur pour l'API Media (Gestion des images).
- [ ] **TÃ¢che 7.3 :** IntÃ©gration finale du service de Notification.
- [ ] **TÃ¢che 7.4 :** **Validation Postman** : Tests de bout en bout incluant les services externes.


---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\.mvn\wrapper\maven-wrapper.properties
`$ext
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\docs\contracts_fleet_management.md
`$ext
# **API Contracts v1.0 - Fleet Management Service**

This document defines the data contracts and endpoints for the **Fleet Management API** of the TraEnSys project. This service is responsible for managing fleets, vehicles, drivers, tracking trips, and handling geofencing.

## 1. Physical Data Model (Tables)

This section describes the database tables that support the service, based on the class diagram and incorporating the required corrections.

### 1.1. Core Tables

**Table: `fleets`**
Stores information about each vehicle fleet.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the fleet. |
| `name` | VARCHAR(255) | NOT NULL | The public name of the fleet. |
| `creationDate` | DATE | NOT NULL | Date when the fleet was created. |
| `managerUserId`| UUID | FOREIGN KEY | References the `id` of the user (Fleet Manager) in the authentication service. |

**Table: `vehicles`**
Stores all data related to a single vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the vehicle. |
| `fleetId` | UUID | FOREIGN KEY, NOT NULL | The fleet to which the vehicle belongs (`fleets`). |
| `licensePlate` | VARCHAR(50) | NOT NULL, UNIQUE | The vehicle's unique license plate. |
| `brand` | VARCHAR(100) | | Brand of the vehicle (e.g., Toyota). |
| `model` | VARCHAR(100) | | Model of the vehicle (e.g., Yaris). |
| `manufacturingYear` | INT | | The year the vehicle was manufactured. |
| `type` | VEHICLE_TYPE (Enum) | | The type of vehicle (CAR, TRUCK, VAN, BIKE). |
| `color` | VARCHAR(50) | | Color of the vehicle. |

**Table: `drivers`**
Contains information specific to the driver role.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `userId` | UUID | PRIMARY KEY, FOREIGN KEY| References the corresponding user in the authentication service. |
| `assignedVehicleId` | UUID | FOREIGN KEY, UNIQUE | The vehicle currently assigned to the driver (`vehicles`). Can be NULL. |
| `licenceNumber` | VARCHAR(100) | NOT NULL, UNIQUE | The driver's license number. |
| `status` | BOOLEAN | NOT NULL | Indicates if the driver is active (`true`) or inactive (`false`). |

**Table: `trips`**
Logs every trip made by a vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the trip. |
| `vehicleId` | UUID | FOREIGN KEY, NOT NULL | The vehicle that made the trip (`vehicles`). |
| `driverId` | UUID | FOREIGN KEY, NOT NULL | The driver who made the trip (`drivers`). |
| `startDate` | DATE | NOT NULL | The date the trip started. |
| `endDate` | DATE | | The date the trip ended. |
| `startTime` | TIME | NOT NULL | The time the trip started. |
| `endTime` | TIME | | The time the trip ended. |
| `type` | VEHICLE_TYPE (Enum) | | Type of vehicle used (redundant but useful for history). |
| `color` | VARCHAR(50) | | Color of the vehicle (redundant but useful for history). |

### 1.2. Parameter Tables (1-to-1 Relationship with `vehicles`)

**Table: `financial_parameters`**

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL | Linked to a single vehicle (`vehicles`). |
| `insuranceNumber` | VARCHAR(100) | | Insurance policy number. |
| `insuranceExpiryDate` | DATE | | Expiry date of the insurance. |
| `registrationDate`| DATE | | The vehicle's registration date. |
| `purchaseDate` | DATE | | Date the vehicle was purchased. |
| `depreciationRate`| INT | | Annual depreciation rate (as a %). |
| `costPerKm` | FLOAT | | Estimated operational cost per kilometer. |

**Table: `maintenance_parameters`**

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL| Linked to a single vehicle (`vehicles`). |
| `lastMaintenanceDate` | DATE | | Date of the last maintenance. |
| `nextMaintenanceDue` | DATE | | Date when the next maintenance is due. |
| `engineStatus` | ENGINE_STATUS (Enum) | | Status of the engine (OK, NEEDS_SERVICE...). |
| `batteryHealth` | INT | | The health of the battery (as a %). |
| `maintenanceStatus` | MAINTENANCE_STATUS (Enum) | | Overall maintenance status (UP_TO_DATE, PENDING...). |

**Table: `operational_parameters`**
Stores real-time data for a vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL| Linked to a single vehicle (`vehicles`). |
| `currentTripId` | UUID | FOREIGN KEY | The current trip for this vehicle (`trips`). Can be NULL. |
| `status` | BOOLEAN | NOT NULL | Operational status (e.g., `true` for in-service). |
| `currentLocationPointId` | UUID | FOREIGN KEY | The last known GPS coordinate (`geofence_points`). |
| `currentSpeed` | FLOAT | | The vehicle's current speed in km/h. |
| `fuelLevel` | VARCHAR(50) | | Current fuel level (e.g., "75%", "12/16"). |
| `mileage` | FLOAT | | Total mileage of the vehicle. |
| `odometerReading`| FLOAT | | The reading from the odometer. |
| `bearing` | FLOAT | | The vehicle's direction of travel in degrees (0-360). |
| `timestamp` | DATETIME | | Timestamp of the last data update. |

### 1.3. Geofencing and Route Tables

**Table: `geofence_zones`**
Defines a geographical zone.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the zone. |
| `name` | VARCHAR(255) | NOT NULL | Name of the zone (e.g., "Mokolo Market Area"). |
| `surfaceArea` | INT | | Area of the zone. |
| `perimeter` | INT | | Perimeter of the zone. |

**Table: `geofence_points`**
Stores the coordinates that define the vertices of geofence zones or points on a route.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the point. |
| `latitude` | FLOAT | NOT NULL | Latitude coordinate. |
| `longitude` | FLOAT | NOT NULL | Longitude coordinate. |

**Table: `geofence_zone_vertices` (Pivot Table)**
Associates points with a zone to form a polygon.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `zoneId` | UUID | FOREIGN KEY, PK | References the zone (`geofence_zones`). |
| `pointId` | UUID | FOREIGN KEY, PK | References the point (`geofence_points`). |
| `vertexOrder` | INT | NOT NULL | The order of the point in the polygon sequence. |

**Table: `routes`**
Defines a route with a start and end point.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the route. |
| `startPointId` | UUID | FOREIGN KEY | The starting point (`geofence_points`). |
| `endPointId` | UUID | FOREIGN KEY | The ending point (`geofence_points`). |

**Table: `trip_routes` (Pivot Table)**
Junction table for the N-N relationship between `trips` and `routes`.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `tripId` | UUID | FOREIGN KEY, PK | References the trip (`trips`). |
| `routeId` | UUID | FOREIGN KEY, PK | References the route (`routes`). |

**Table: `geofence_events`**
Logs every time a vehicle enters or exits a zone.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the event. |
| `zoneId` | UUID | FOREIGN KEY, NOT NULL | The zone involved (`geofence_zones`). |
| `vehicleId` | UUID | FOREIGN KEY, NOT NULL | The vehicle involved (`vehicles`). |
| `timestamp` | DATETIME | NOT NULL | The exact time of the event. |
| `type` | EVENT_TYPE (Enum) | NOT NULL | Type of event (ENTRY or EXIT). |

---


## 2. Data Representation

### 2.1. Fleet Model
Represents a collection of vehicles managed by a Fleet Manager.

```json
{
  "id": "f1a2b3c4-fleet-0001-d5e6f7g8h9i0",
  "name": "YaoundÃ© Express Voyage",
  "creationDate": "2025-01-15",
  "manager": {
    "userId": "7b2e3f4a-1c9d-4b8a-8e6f-2d3c4b5a6d7e",
    "name": "Gabriel Nomo"
  },
  "vehicleCount": 15
}
```

### 2.2. Vehicle Model (Detailed)
Represents a single vehicle with all its associated parameters.

```json
{
  "id": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
  "fleetId": "f1a2b3c4-fleet-0001-d5e6f7g8h9i0",
  "licensePlate": "CE 123 AB",
  "brand": "Toyota",
  "model": "Yaris",
  "manufacturingYear": 2022,
  "type": "CAR",
  "color": "White",
  "assignedDriver": {
    "userId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
    "name": "Aissatou Bello"
  },
  "financialParameters": {
    "insuranceNumber": "INS-YDE-2025-8843",
    "insuranceExpiryDate": "2026-06-30",
    "registrationDate": "2022-07-15",
    "purchaseDate": "2022-07-01",
    "depreciationRate": 15,
    "costPerKm": 125.5
  },
  "maintenanceParameters": {
    "lastMaintenanceDate": "2025-09-10",
    "nextMaintenanceDue": "2026-03-10",
    "engineStatus": "OK",
    "batteryHealth": 92,
    "maintenanceStatus": "UP_TO_DATE"
  },
  "operationalParameters": {
    "status": true,
    "currentSpeed": 45.5,
    "fuelLevel": "65%",
    "mileage": 45012.8,
    "odometerReading": 45012.8,
    "bearing": 182.5,
    "timestamp": "2025-10-30T14:22:10.000Z",
    "currentLocation": {
      "latitude": 3.8667,
      "longitude": 11.5167
    }
  }
}
```

### 2.3. Driver Model
Represents the fleet-specific information of a driver.

```json
{
  "userId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
  "licenceNumber": "YDE/DR/2018/98765",
  "status": true,
  "assignedVehicle": {
    "vehicleId": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
    "licensePlate": "CE 123 AB"
  },
  "userProfile": {
    "name": "Aissatou Bello",
    "phone": "+237699112233"
  }
}
```

### 2.4. Trip Model

```json
{
  "id": "t1r2i3p4-a5b6-4c7d-8e9f-a0b1c2d3e4f5",
  "vehicleId": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
  "driverId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
  "startDate": "2025-10-30",
  "startTime": "08:15:00",
  "endDate": "2025-10-30",
  "endTime": "09:05:00",
  "routes": [
    {
      "routeId": "r1o2u3t4e-001",
      "startPoint": { "latitude": 3.8721, "longitude": 11.5173 },
      "endPoint": { "latitude": 3.8472, "longitude": 11.5015 }
    }
  ]
}
```

### 2.5. Geofence Zone Model

```json
{
  "id": "z1o2n3e4-a5b6-4c7d-8e9f-a0b1c2d3e4f5",
  "name": "Mokolo Market Area",
  "surfaceArea": 1.5,
  "perimeter": 5.2,
  "vertices": [
    { "latitude": 3.8750, "longitude": 11.5000, "order": 1 },
    { "latitude": 3.8790, "longitude": 11.5050, "order": 2 },
    { "latitude": 3.8760, "longitude": 11.5080, "order": 3 },
    { "latitude": 3.8710, "longitude": 11.5030, "order": 4 }
  ]
}
```
---

## 3. General API Rules

-   **Base URL**: `/api/v1`
-   **Data Format**: `application/json`
-   **Authentication**: Header `Authorization: Bearer <JWT_TOKEN>`
-   **Error Handling**:
    ```json
    {
      "timestamp": "2025-10-30T10:30:00.000Z",
      "status": 404,
      "error": "Not Found",
      "message": "Vehicle with ID 'v-invalid-id' not found.",
      "path": "/api/v1/vehicles/v-invalid-id"
    }
    ```
---

## 4. Fleet Management API Endpoints

### 4.1. Fleets (`/fleets`)

#### `POST /fleets`
-   **Description**: Creates a new fleet.
-   **Access**: Authenticated (`fleet:fleet:create`).
-   **Request (Body)**: `{"name": "Douala City Transports", "managerUserId": "a9b8c7d6..."}`
-   **Response (`201 Created`)**: The newly created Fleet object.

#### `GET /fleets`
-   **Description**: Retrieves a list of fleets. For a Fleet Manager, returns only their fleets. For an Admin, returns all fleets.
-   **Access**: Authenticated (`fleet:fleet:read`).
-   **Response (`200 OK`)**: An array of Fleet objects.

#### `GET /fleets/{fleetId}`
-   **Description**: Retrieves detailed information for a specific fleet.
-   **Access**: Authenticated (`fleet:fleet:read`).
-   **Response (`200 OK`)**: A single detailed Fleet object.

#### `PUT /fleets/{fleetId}`
-   **Description**: Updates the details of an existing fleet.
-   **Access**: Authenticated (`fleet:fleet:update`).
-   **Request (Body)**: `{"name": "Douala Premium Transports", "managerUserId": "a9b8c7d6..."}`
-   **Response (`200 OK`)**: The updated Fleet object.

#### `DELETE /fleets/{fleetId}`
-   **Description**: Deletes a fleet. Business logic should prevent deletion if the fleet still contains vehicles.
-   **Access**: Authenticated (`fleet:fleet:delete`).
-   **Response (`204 No Content`)**.

### 4.2. Vehicles (`/vehicles`)

#### `POST /fleets/{fleetId}/vehicles`
-   **Description**: Adds a new vehicle to a specified fleet.
-   **Access**: Authenticated (`fleet:vehicle:create`).
-   **Request (Body)**: `{ "licensePlate": "CE 789 EF", "brand": "Toyota", "model": "RAV4", ... }`
-   **Response (`201 Created`)**: The full detailed Vehicle Model.

#### `GET /vehicles`
-   **Description**: Retrieves a paginated list of all vehicles accessible to the user.
-   **Access**: Authenticated (`fleet:vehicle:read`).
-   **Query Parameters**: `?fleetId={id}&type=CAR&status=true`
-   **Response (`200 OK`)**: An array of Vehicle objects.

#### `GET /vehicles/{vehicleId}`
-   **Description**: Retrieves the complete details of a single vehicle.
-   **Access**: Authenticated (`fleet:vehicle:read`).
-   **Response (`200 OK`)**: The full Vehicle Model JSON.

#### `PUT /vehicles/{vehicleId}`
-   **Description**: Updates the core details of a vehicle (brand, model, color, etc.).
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "model": "Corolla", "color": "Blue", "manufacturingYear": 2021 }`
-   **Response (`200 OK`)**: The updated full Vehicle Model.

#### `DELETE /vehicles/{vehicleId}`
-   **Description**: Deletes a vehicle from the system.
-   **Access**: Authenticated (`fleet:vehicle:delete`).
-   **Response (`204 No Content`)**.

#### `PUT /vehicles/{vehicleId}/financial-parameters`
-   **Description**: Updates the financial parameters for a specific vehicle.
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "insuranceNumber": "INS-NEW-2025-1111", "costPerKm": 130.0 }`
-   **Response (`200 OK`)**: The updated Financial Parameters object.

#### `PUT /vehicles/{vehicleId}/maintenance-parameters`
-   **Description**: Updates the maintenance parameters for a specific vehicle.
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "lastMaintenanceDate": "2025-10-28", "engineStatus": "NEEDS_SERVICE" }`
-   **Response (`200 OK`)**: The updated Maintenance Parameters object.

### 4.3. Drivers (`/drivers`)

#### `POST /drivers`
-   **Description**: Registers an existing system user as a driver.
-   **Access**: Authenticated (`fleet:driver:create`).
-   **Request (Body)**: `{ "userId": "u1s2e3r4...", "licenceNumber": "LT/DR/2020/11223" }`
-   **Response (`201 Created`)**: The full Driver Model.

#### `GET /drivers`
-   **Description**: Retrieves a list of all drivers.
-   **Access**: Authenticated (`fleet:driver:read`).
-   **Query Parameters**: `?status=true`
-   **Response (`200 OK`)**: An array of Driver objects.

#### `GET /drivers/{driverUserId}`
-   **Description**: Retrieves the profile for a specific driver.
-   **Access**: Authenticated (`fleet:driver:read`).
-   **Response (`200 OK`)**: A single Driver Model object.

#### `PUT /drivers/{driverUserId}`
-   **Description**: Updates a driver's fleet-specific information.
-   **Access**: Authenticated (`fleet:driver:update`).
-   **Request (Body)**: `{ "licenceNumber": "YDE/DR/2022/55443", "status": false }`
-   **Response (`200 OK`)**: The updated Driver Model.

#### `DELETE /drivers/{driverUserId}`
-   **Description**: De-registers a user as a driver (does not delete the user account).
-   **Access**: Authenticated (`fleet:driver:delete`).
-   **Response (`204 No Content`)**.

#### `POST /drivers/{driverUserId}/assign-vehicle`
-   **Description**: Assigns a vehicle to a driver.
-   **Access**: Authenticated (`fleet:driver:assign`).
-   **Request (Body)**: `{ "vehicleId": "v1e2h3c4..." }`
-   **Response (`200 OK`)**: `{ "message": "Vehicle assigned successfully." }`

#### `POST /drivers/{driverUserId}/unassign-vehicle`
-   **Description**: Unassigns the current vehicle from a driver.
-   **Access**: Authenticated (`fleet:driver:assign`).
-   **Response (`200 OK`)**: `{ "message": "Vehicle unassigned successfully." }`

### 4.4. Trips (`/trips`)

#### `POST /trips`
-   **Description**: Starts a new trip for a vehicle.
-   **Access**: Authenticated (`fleet:trip:create`).
-   **Request (Body)**: `{ "vehicleId": "v1e2h3c4...", "driverId": "d1r2i3v4...", "startDate": "2025-10-31", "startTime": "09:00:00" }`
-   **Response (`201 Created`)**: The new Trip object.

#### `GET /trips`
-   **Description**: Retrieves a list of trips, with filtering options.
-   **Access**: Authenticated (`fleet:trip:read`).
-   **Query Parameters**: `?vehicleId={id}&driverId={id}&startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`
-   **Response (`200 OK`)**: An array of Trip objects.

#### `GET /trips/{tripId}`
-   **Description**: Retrieves the details of a single trip.
-   **Access**: Authenticated (`fleet:trip:read`).
-   **Response (`200 OK`)**: A single Trip Model object.

#### `POST /trips/{tripId}/end`
-   **Description**: Ends an active trip.
-   **Access**: Authenticated (`fleet:trip:update`).
-   **Request (Body)**: `{ "endDate": "2025-10-31", "endTime": "11:30:00" }`
-   **Response (`200 OK`)**: The updated Trip object.

### 4.5. Geofencing (`/geofence`)

#### `POST /geofence/zones`
-   **Description**: Creates a new geofence zone.
-   **Access**: Authenticated (`fleet:geofence:create`).
-   **Request (Body)**: `{ "name": "Bastos Residential Area", "vertices": [...] }`
-   **Response (`201 Created`)**: The full Geofence Zone Model.

#### `GET /geofence/zones`
-   **Description**: Retrieves a list of all defined geofence zones.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Response (`200 OK`)**: An array of Geofence Zone objects.

#### `GET /geofence/zones/{zoneId}`
-   **Description**: Retrieves the details of a single geofence zone.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Response (`200 OK`)**: A single Geofence Zone Model object.

#### `PUT /geofence/zones/{zoneId}`
-   **Description**: Updates a geofence zone's name or vertices.
-   **Access**: Authenticated (`fleet:geofence:update`).
-   **Request (Body)**: `{ "name": "Bastos VIP Area", "vertices": [...] }`
-   **Response (`200 OK`)**: The updated Geofence Zone Model.

#### `DELETE /geofence/zones/{zoneId}`
-   **Description**: Deletes a geofence zone.
-   **Access**: Authenticated (`fleet:geofence:delete`).
-   **Response (`204 No Content`)**.

#### `GET /geofence/events`
-   **Description**: Retrieves a log of geofence events, with optional filters.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Query Parameters**: `?vehicleId={id}&zoneId={id}&type=ENTRY&startDate=YYYY-MM-DD`
-   **Response (`200 OK`)**: An array of geofence event objects.

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\docs\database_setup.md
`$ext
# ðŸ—„ï¸ Database Setup Guide (Local Development)

This guide explains how to set up and initialize the Fleet Management database on your local machine. This process is fully automated for both **Linux** and **Windows**.

## ðŸ“‹ Prerequisites

Ensure you have the following installed:
- **Docker** & **Docker Compose**
  - *Linux*: `sudo apt install docker-compose`
  - *Windows*: Install [Docker Desktop](https://www.docker.com/products/docker-desktop/)

## ðŸš€ Step 1: Start the Database Container

Open a terminal at the root of the project and run:

```bash
# Start the PostgreSQL 16 container in the background
docker-compose up -d
```

*Note: This will automatically pull the official Postgres 16 image and create a database named `yowyob_db`.*

## âš™ï¸ Step 2: Configure the Application

The application is configured to use a **Hybrid Mode** (Local DB + Remote Kafka/Redis).

1. Open `src/main/resources/application.yml`.
2. Ensure the active profile is set to `local`:
   ```yaml
   spring:
     profiles:
       active: local
   ```
3. (Optional) In the `LOCAL CONFIGURATION` block, verify that the credentials match those in `docker-compose.yml` (default: `fleet_admin` / `fleet_password`).

## ðŸ› ï¸ Step 3: Run and Auto-Initialize

Simply start the application. The system will detect the local environment and automatically:
1. Create all tables and ENUM types (from `resources/local/schema.sql`).
2. Inject 100 test users and sample data (from `resources/local/data.sql`).

**Run Command:**
```bash
# Linux / macOS
./mvnw clean spring-boot:run

# Windows (CMD / PowerShell)
mvnw.cmd clean spring-boot:run
```

## âœ… Step 4: Verify the Setup

Once the log shows `ðŸš€ LOCAL DATABASE READY!`, open your browser:

- **Swagger UI**: [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **Check Data**: Find the `health-check-controller` and execute `/api/v1/health/users-count`. You should see `users_in_db: 100`.

## âŒ Troubleshooting

- **Port 5432 already in use**: If you have a local PostgreSQL installed outside of Docker, stop it or change the port mapping in `docker-compose.yml`.
- **DNS/Pull Issues**: If Docker fails to pull the image, try:
  ```bash
  docker pull postgres:16
  ```

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\docs\remarks_of_conception.md
`$ext
# Remarques cahier d'analyse et conception

# Objectif
L'objectif de ce document est de fournir des remarques pour le cahier d'analyse et conception du projet Fleet management et geofence s'integrant dans le projet synthese de 5Gi: Trans Ens

# Liste des remarques

Chaque remarque sera constitue d'un page du titre de la remarque et de la description

---
## R1: raphael au feminin 

**page**: 2

**descripion**:  
Bihai rapahel
rapahel est ecrit au feminin,est-ce normal?

---
## R2: utilisation de FareCalculator

**page** : 14

**description** : Notre systeme utilisera t'il reellement farecalculator ? si oui dans quel cas d'utilisation ?

---

## R3: Absence de Navigoo dans le diagarmme de contexte

**page** : 14

**description** : Notre systeme utilisera certainement l'api des cartes pour montrer au client,chauffeur,fleet amanager mais notre diagaramme de contexte de le met pas en evidence

---

## R4: fautre d'orthographe

**page** : 14

**description** : les acteurs (qui utilise le systÃ¨me),le verbe utiliser doit etre a la 3e personne du pluriel(`avec ent`)

---

## R5: Probleme de coherence entre les diagrammes de cas d'utilisation et de contexte

**page** : 14 et 15

**description** : sur le diagramme de contexte,on voit bien que farecalculator fait partie des acteurs externes et le customer aussi mais dans le diagramme de cas d'utilisation,on ne les retrpiuve pas. De plus,on retrouve navigoo qui n'etait pas dans le diagramme de contexte. 

---

## R6: diagramme de use case,coherence dans le regroupement des use case

**page** : 15

**description** : 
Je remarque la factorisation qui est regroupage elegant des cas d'utilisation dans ce diagramme par l'heritage,ce qui est une bnne chose mais pour l'acteur fleet manager,je trouve que ce n'est pas suffisemment regroupe pour le management des vehicule(je parle de track vehicule,view vehicule statictics qui selpon moi sont des sous-cas de manage vehicule)

---
## R7: diagramme de sequence systeme
**page** : 29

**description** : 
- la methode valider identifiant que le systeme envoir a l'api d'auth doit etre une fonction ayant pour parametre les identifiants(email,mot de passe)

- Il y'a egalement un probleme de coherence linguistique,depuis le debut tous les diagrammes sont en anglais,mais celui ci est en francais.il nous faut une seule langue.

- est ce que le token est un message ou une variable? je crois aussi qu'ici c'est une fontion que l'api d'auth utilise pour envoyer le token et le role...aussi le role 
---

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\docs\data\YOWYOB_DB\README.md
`$ext
# Yowyob Database - Instructions

Ce dossier contient les scripts SQL nÃ©cessaires pour initialiser, peupler et tester la base de donnÃ©es PostgreSQL du projet Yowyob. Le projet a Ã©tÃ© principalement testÃ© en local.

## [Contenu des fichiers]

1. **`yowyob_db_init.sql`** : 
   - CrÃ©e le schÃ©ma (tables, types ENUM, triggers).
   - **Note :** Ce script commence par un `DROP SCHEMA public CASCADE`. Il effacera toutes les donnÃ©es existantes.

2. **`yowyob_db_seed.sql`** : 
   - Remplit la base avec des **donnÃ©es factices (Fake Data)** pour le dÃ©veloppement.

3. **`yowyob_db_test.sql`** : 
   - Contient des requÃªtes de lecture pour vÃ©rifier la cohÃ©rence des relations et des donnÃ©es sur **certaines relations** de la base de donnÃ©es. *Chaque jeu de test doit renvoyer **au moins une ligne de donnÃ©es.***

## [Guide d'installation]

### PrÃ©-requis
- PostgreSQL 16 ou supÃ©rieur.
- Un utilisateur PostgreSQL ayant les droits de crÃ©ation de tables.

### Ã‰tape 1 : CrÃ©ation de la base (si elle n'existe pas)
```bash
createdb -U <user> yowyob_db
```

### Ã‰tape 2 : Initialisation de la structure
```bash
psql -U <user> -d yowyob_db -f yowyob_db_init.sql
```

### Ã‰tape 3 : Peuplement des donnÃ©es (DEV / STAGING UNIQUEMENT)
```bash
psql -U <user> -d yowyob_db -f yowyob_db_seed.sql
```

### Ã‰tape 4 : VÃ©rification
```bash
psql -U <user> -d yowyob_db -f yowyob_db_test.sql
```

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\docs\data\YOWYOB_DB\yowyob_db_init.sql
`$ext
-- =====================================================
-- YOWYOB DB - INIT SCRIPT
-- PostgreSQL
-- Structure: Core -> Organization -> RBAC
-- =====================================================

-- Start a transaction for safety
BEGIN;

-- Fresh start
DROP SCHEMA IF EXISTS public CASCADE;
CREATE SCHEMA public;

-- Publish query paths
SET search_path TO public;

-- Extension for UUID generation
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =====================================================
-- ENUM TYPES
-- =====================================================

CREATE TYPE status_enum AS ENUM (
  'DRAFT', 'WAITING_CONFIRMATION', 'PUBLISHED', 'IN_PROGRESS', 'CANCELLED', 'EXPIRED'
);

CREATE TYPE category_enum AS ENUM (
  'ANNOUNCE', 'PLANNING', 'VEHICLE', 'ADDRESS', 'EXPERIENCE'
);

CREATE TYPE action_enum AS ENUM (
  'CREATE', 'UPDATE', 'READ', 'DELETE'
);

CREATE TYPE vehicle_type_enum AS ENUM (
  'CAR', 'VAN', 'TRUCK', 'BIKE'
);

CREATE TYPE offer_state_enum AS ENUM (
  'NEW', 'PENDING', 'CHOSEN', 'TERMINATED', 'CANCELED'
);

CREATE TYPE ride_state_enum AS ENUM (
  'CONFIRMED', 'ONGOING', 'COMPLETED', 'CANCELED'
);

CREATE TYPE event_type_enum AS ENUM (
  'ENTRY', 'EXIT'
);

CREATE TYPE maintenance_status_enum AS ENUM (
  'UP_TO_DATE', 'PENDING', 'OVERDUE'
);

CREATE TYPE engine_status_enum AS ENUM (
  'OK', 'NEED_SERVICE', 'OUT_OF_SERVICE'
);

CREATE TYPE role_type_enum AS ENUM (
  'CUSTOMER', 'DRIVER', 'FLEET_MANAGER', 'ADMIN', 'PASSENGER', 'PRESIDENT', 'MODERATOR', 'CLIENT'
);

CREATE TYPE type_enum AS ENUM (
  'NOTIFICATION', 'CHAT', 'PAYMENT', 'MEDIA'
);

CREATE TYPE reaction_type_enum AS ENUM (
  'LIKE', 'LOVE', 'HAHA', 'WOW', 'SAD', 'ANGRY'
);

-- =====================================================
-- CORE TABLES
-- =====================================================

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  phone_number TEXT,
  email_address TEXT UNIQUE
);

CREATE TABLE images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url TEXT NOT NULL,
  alt_text TEXT,
  uploaded_at TIMESTAMP DEFAULT now()
);

CREATE TABLE countries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE business_actors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT,
  phone_number TEXT,
  email_address TEXT,
  CONSTRAINT fk_business_actor_user
    FOREIGN KEY (id) REFERENCES users(id)
    ON DELETE CASCADE
);

-- =====================================================
-- ORGANIZATION TABLES
-- =====================================================

CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_actor_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  email TEXT,
  short_name TEXT,
  long_name TEXT,
  description TEXT,
  logo_uri TEXT,
  website_url TEXT,
  social_network TEXT,
  business_registration_number TEXT,
  tax_number TEXT,
  capital_share NUMERIC,
  ceo_name TEXT,
  year_founded INT,
  keywords TEXT,
  number_of_employees INT,
  legal_form TEXT,
  is_active BOOLEAN DEFAULT true,
  status status_enum DEFAULT 'DRAFT',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, -- Must belong to an org

  owner_id UUID REFERENCES business_actors(id),
  manager_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  name TEXT,
  location TEXT,
  description TEXT,
  transferable BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  logo_uri TEXT,
  short_name TEXT,
  long_name TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  is_headquarter BOOLEAN DEFAULT false,
  country TEXT,
  city TEXT,
  latitude NUMERIC,
  longitude NUMERIC,
  open_time TIME,
  close_time TIME,
  phone TEXT,
  email TEXT,
  whatsapp TEXT,
  greeting_message TEXT,
  average_revenue NUMERIC,
  capital_share NUMERIC,
  registration_number TEXT,
  social_network TEXT,
  tax_number TEXT,
  keywords TEXT,
  is_public BOOLEAN DEFAULT false,
  is_business BOOLEAN DEFAULT true,
  total_affiliated_customers INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE business_domains (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL, -- optional link to organization
  parent_id UUID REFERENCES business_domains(id) ON DELETE SET NULL,   -- self-referential for hierarchy
  image_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  name TEXT,
  image_uri TEXT,
  type TEXT,
  type_label TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE organization_business_domains (
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  business_domain_id UUID REFERENCES business_domains(id) ON DELETE CASCADE,
  PRIMARY KEY (organization_id, business_domain_id)
);

CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  contactable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  contactable_type TEXT,
  first_name TEXT,
  last_name TEXT,
  title TEXT,
  is_email_verified BOOLEAN DEFAULT false,
  is_phone_number_verified BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  phone_number TEXT,
  secondary_phone_number TEXT,
  fax_number TEXT,
  email TEXT,
  secondary_email TEXT,
  email_verified_at TIMESTAMP,
  phone_verified_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE certifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  description TEXT,
  obtainment_date DATE,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE third_parties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  logo_id UUID REFERENCES images(id),

  code TEXT,
  type TEXT,
  legal_form TEXT,
  unique_identification_number TEXT,
  trade_registration_number TEXT,
  name TEXT,
  acronym TEXT,
  long_name TEXT,
  logo_uri TEXT,
  accounting_account_numbers TEXT,
  authorized_payment_methods TEXT,
  authorized_credit_limit NUMERIC,
  max_discount_rate NUMERIC,
  vat_subject BOOLEAN,
  operations_balance NUMERIC,
  opening_balance NUMERIC,
  pay_term_number INT,
  pay_term_type TEXT,
  third_party_family TEXT,
  classification TEXT,
  tax_number TEXT,
  loyalty_points NUMERIC,
  loyalty_points_used NUMERIC,
  loyalty_points_expired NUMERIC,
  enabled BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE settings (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  theme TEXT,
  language TEXT,
  long_ride_enabled BOOLEAN DEFAULT false,
  short_ride_enabled BOOLEAN DEFAULT false,
  privacy_enable BOOLEAN DEFAULT true,
  allow_calls BOOLEAN DEFAULT true,
  allow_messages BOOLEAN DEFAULT true,
  notify_new_rides BOOLEAN DEFAULT true,
  notify_ratings BOOLEAN DEFAULT true,
  notify_practical_tips BOOLEAN DEFAULT true,
  notify_promotions BOOLEAN DEFAULT true,
  notify_policy_updates BOOLEAN DEFAULT true,
  notify_peak_hour_recommendations BOOLEAN DEFAULT true,
  receive_email BOOLEAN DEFAULT true,
  receive_sms BOOLEAN DEFAULT true,
  receive_push_notifications BOOLEAN DEFAULT true,
  receive_whatsapp BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE proposed_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  rate NUMERIC,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE addresses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  addressable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  country_id UUID REFERENCES countries(id) ON DELETE SET NULL,

  addressable_type TEXT,
  type TEXT,
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  state TEXT,
  locality TEXT,
  zip_code TEXT,
  postal_code TEXT,
  po_box TEXT,
  is_default BOOLEAN DEFAULT false,
  neighbor_hood TEXT,
  informal_description TEXT,
  latitude NUMERIC,
  longitude NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

-- =====================================================
-- USERS EXTENDED
-- =====================================================

CREATE TABLE providers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  contact_info TEXT,
  address TEXT,
  is_active BOOLEAN DEFAULT true,
  product_service_type TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE employees (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  is_manager BOOLEAN DEFAULT false,
  role TEXT,
  department TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE prospects (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,
  interest_level TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE sales_persons (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  commission_rate NUMERIC,
  credit NUMERIC,
  current_balance NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE customers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

-- =====================================================
-- RIDE & FLEET MANAGEMENT
-- =====================================================

CREATE TABLE drivers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  status TEXT,
  license_number TEXT,
  has_car BOOLEAN DEFAULT false
);

CREATE TABLE offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  passenger_id UUID REFERENCES customers(id) ON DELETE CASCADE,

  start_point TEXT,
  end_point TEXT,
  price NUMERIC,
  state offer_state_enum DEFAULT 'NEW',
  ids_interested_drivers TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE rides (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  offer_id UUID REFERENCES offers(id) ON DELETE SET NULL,
  passenger_id UUID REFERENCES users(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  distance NUMERIC,
  time_estimation NUMERIC,
  real_time NUMERIC,
  state ride_state_enum DEFAULT 'CONFIRMED',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet_managers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE fleets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fleet_manager_id UUID REFERENCES fleet_managers(id) ON DELETE SET NULL,

  name TEXT,
  phone_number TEXT,
  email_address TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE geofence_zones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  surface_area NUMERIC,
  perimeter NUMERIC
);

CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  fleet_id UUID REFERENCES fleets(id) ON DELETE SET NULL,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,

  license_plate TEXT,
  model TEXT,
  brand TEXT,
  manufacturing_year INT,
  type vehicle_type_enum,
  color TEXT
);

CREATE TABLE roads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  start_point TEXT,
  end_point TEXT
);

CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  road_id UUID REFERENCES roads(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  start_date DATE,
  end_date DATE,
  start_time TIME,
  end_time TIME,
  type TEXT,
  color TEXT
);

CREATE TABLE operational_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  statut TEXT,
  current_location TEXT,
  current_speed NUMERIC,
  fuel_level NUMERIC,
  mileage NUMERIC,
  odometer_reading NUMERIC,
  bearing NUMERIC,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE financial_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  insurance_number TEXT,
  insurance_expired_at DATE,
  registered_at DATE,
  purchased_at DATE,
  depreciation_rate NUMERIC,
  cost_per_km NUMERIC
);

CREATE TABLE maintenance_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  last_maintenance_at DATE,
  next_maintenance_at DATE,
  engine_status engine_status_enum DEFAULT 'OK',
  battery_health TEXT,
  maintenance_status maintenance_status_enum DEFAULT 'UP_TO_DATE'
);

CREATE TABLE geofence_points (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  latitude NUMERIC,
  longitude NUMERIC
);

CREATE TABLE geofence_point_zone_linkages (
  point_id UUID REFERENCES geofence_points(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE CASCADE,
  PRIMARY KEY (point_id, zone_id)
);

CREATE TABLE geofence_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,
  point_id UUID REFERENCES geofence_points(id) ON DELETE SET NULL,

  type event_type_enum,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE offer_driver_linkages (
  offer_id UUID REFERENCES offers(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE CASCADE,
  PRIMARY KEY (offer_id, driver_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- OTHERS: PRODUCTS, SYNDICATS, PUBLICATIONS & REVIEWS
-- =====================================================

CREATE TABLE syndicats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  is_approved BOOLEAN DEFAULT false,
  name TEXT,
  description TEXT,
  domain TEXT,
  type TEXT,
  charte_url TEXT,
  status_url TEXT,
  members_list_url TEXT,
  commitment_certificate_url TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE abstract_products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  abstract_product_id UUID REFERENCES abstract_products(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  standard_price NUMERIC,
  departure_location TEXT,
  arrival_location TEXT,
  start_date DATE,
  start_time TIME,
  end_date DATE,
  end_time TIME,
  baggage_info TEXT,
  is_negotiable BOOLEAN DEFAULT false,
  payment_method TEXT,
  title TEXT,
  status status_enum DEFAULT 'DRAFT',
  product_urls TEXT,
  regular_amount NUMERIC,
  discount_percentage NUMERIC,
  discounted_amount NUMERIC,
  metadata JSONB,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  title TEXT,
  description TEXT,
  closing_at TIMESTAMP,
  type category_enum
);

CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  publication_vote_id UUID REFERENCES publication_votes(id) ON DELETE CASCADE,

  label TEXT
);

CREATE TABLE avis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  comment TEXT,
  number INT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE branches (
  id UUID PRIMARY KEY REFERENCES agencies(id),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  location TEXT,
  contact TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  content TEXT,
  status status_enum DEFAULT 'DRAFT',
  n_likes INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_images (
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (publication_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,

  title TEXT,
  description TEXT,
  location TEXT,
  date DATE,
  start_time TIME,
  end_time TIME,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE event_images (
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (event_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  type reaction_type_enum,

  reacted_at TIMESTAMP DEFAULT now()
);

CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES comments(id) ON DELETE SET NULL,
  image_id UUID REFERENCES images(id) ON DELETE SET NULL,

  content TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  first_name TEXT,
  last_name TEXT,
  nickname TEXT,
  profile_image_url TEXT,
  birth_date DATE,
  nationality TEXT,
  gender TEXT,
  language TEXT,
  company_name TEXT,
  biography TEXT,
  rating NUMERIC,
  total_trips INT,
  is_available BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- PAYMENTS & SUBSCRIPTIONS
-- =====================================================

CREATE TABLE admins (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  admin_id UUID REFERENCES admins(id) ON DELETE SET NULL,

  label TEXT,
  price NUMERIC,
  duration_in_days INT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,
  user_id UUID REFERENCES business_actors(id) ON DELETE SET NULL,

  amount_paid NUMERIC,
  status TEXT,
  id_provider_transaction TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ride_id UUID REFERENCES rides(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  subject TEXT,
  comment TEXT,
  rating NUMERIC,

  created_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- ROLE-BASED ACCESS CONTROL (RBAC)
-- =====================================================

CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE role_has_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE user_has_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Commit the transaction
COMMIT;

-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\docs\data\YOWYOB_DB\yowyob_db_seed.sql
`$ext
-- =====================================================
-- YOWYOB DB - DATA SEEDING SCRIPT
-- PostgreSQL
-- =====================================================

BEGIN;

-- =====================================================
-- 1. CLEANUP EXISTING DATA
-- =====================================================
TRUNCATE TABLE 
    users, images, countries, business_actors, 
    admins, fleet_managers, drivers, customers, 
    providers, employees, prospects, sales_persons,
    profiles, settings, addresses, contacts,
    roles, permissions, role_has_permissions, user_has_roles,
    organizations, agencies, business_domains, organization_business_domains,
    certifications, third_parties, proposed_activities, services, branches,
    fleets, vehicles, geofence_zones, geofence_points, geofence_events,
    roads, trips, offers, rides, reviews, offer_driver_linkages,
    operational_parameters, financial_parameters, maintenance_parameters,
    geofence_point_zone_linkages,
    syndicats, abstract_products, products, 
    publications, publication_images, publication_votes, votes,
    events, event_images, reactions, comments, avis,
    subscriptions, payments
    RESTART IDENTITY CASCADE;

-- =====================================================
-- 2. STATIC REFERENCE DATA
-- =====================================================

-- Countries
INSERT INTO countries (name, code) VALUES
('Cameroun', 'CM'), ('SÃ©nÃ©gal', 'SN'), ('CÃ´te d''Ivoire', 'CI'), 
('Gabon', 'GA'), ('NigÃ©ria', 'NG'), ('Togo', 'TG');

-- Roles
INSERT INTO roles (name, guard_name) VALUES
('ADMIN', 'web'), ('FLEET_MANAGER', 'web'), ('DRIVER', 'web'), ('CUSTOMER', 'web');

-- Images (Random placeholders from Picsum)
INSERT INTO images (url, alt_text) 
SELECT 
    'https://picsum.photos/seed/' || i || '/800/600', 
    'Image alÃ©atoire ' || i
FROM generate_series(1, 50) as i;

-- =====================================================
-- 3. USERS GENERATION (100 users)
-- =====================================================

INSERT INTO users (name, phone_number, email_address)
SELECT 
    (ARRAY['Mamadou', 'Jean-Pierre', 'Ibrahim', 'Fatou', 'Aminata', 'Ngolo', 'Aboubakar', 'Clarisse', 'Samuel', 'KouamÃ©', 'Aissatou', 'Bachelard', 'Landry', 'ThÃ©rÃ¨se'])[floor(random()*14)+1] 
    || ' ' || 
    (ARRAY['Diop', 'Njoya', 'Mbarga', 'Kone', 'Sow', 'Etoundi', 'Kamga', 'TraorÃ©', 'Diallo', 'Fofana', 'Mensah', 'Atangana', 'Eto''o', 'Drogba'])[floor(random()*14)+1],
    (ARRAY['+237', '+221', '+225'])[floor(random()*3)+1] || (600000000 + floor(random()*99999999)::int),
    'user_' || i || '@yowyob.test'
FROM generate_series(1, 100) as i;

-- Settings & Profiles
INSERT INTO settings (user_id, theme, language, receive_push_notifications)
SELECT id, 'LIGHT', 'fr', true FROM users;

INSERT INTO profiles (user_id, first_name, nationality, is_verified)
SELECT id, split_part(name, ' ', 1), 'Camerounais', (random() > 0.5) FROM users;

-- =====================================================
-- 4. ACTORS DISPATCHING
-- User -> BusinessActor -> SpecificActor
-- =====================================================

-- 4.1 Admins (First 5 users)
INSERT INTO admins (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5;

-- 4.2 Fleet Managers (Next 5 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- STEP 2: Insert into CHILD (FleetManager)
INSERT INTO fleet_managers (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- 4.3 Drivers (Next 30 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- STEP 2: Insert into CHILD (Driver)
INSERT INTO drivers (id, status, license_number, has_car)
SELECT 
    id, 
    (ARRAY['AVAILABLE', 'BUSY', 'OFFLINE'])[floor(random()*3)+1], 
    'LIC-' || floor(random()*100000) || '-CM',
    (random() > 0.3)
FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- 4.4 Customers (Remaining 60 users)
INSERT INTO customers (id, code, payment_method)
SELECT 
    id, 
    'CUST-' || substr(id::text, 1, 8),
    (ARRAY['CASH', 'MOBILE_MONEY', 'CARD'])[floor(random()*3)+1]
FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- Assign Roles
INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'ADMIN') FROM users ORDER BY email_address LIMIT 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'FLEET_MANAGER') FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'DRIVER') FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'CUSTOMER') FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- =====================================================
-- 5. ORGANIZATIONS & AGENCIES
-- =====================================================

INSERT INTO organizations (
    business_actor_id, logo_id, code, short_name, long_name, 
    description, tax_number, is_active, status
)
SELECT
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    (SELECT id FROM images ORDER BY random() LIMIT 1),
    'ORG-' || i,
    'Transport ' || i,
    'SociÃ©tÃ© de Transport ' || i,
    'Description ' || i,
    'TAX-' || floor(random()*1000000),
    true,
    'PUBLISHED'
FROM generate_series(1, 35) as i;

INSERT INTO agencies (
    organization_id, manager_id, name, city, location, is_headquarter
)
SELECT 
    id, 
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    'Agence Centrale',
    (ARRAY['Douala', 'YaoundÃ©', 'Abidjan'])[floor(random()*3)+1],
    'Rue Principale',
    true
FROM organizations;

-- =====================================================
-- 6. FLEETS & VEHICLES
-- =====================================================

INSERT INTO fleets (fleet_manager_id, name, phone_number)
SELECT 
    id, 'Flotte de ' || name, '+237699000000'
FROM fleet_managers;

-- Vehicles
INSERT INTO vehicles (
    fleet_id, user_id, driver_id, license_plate, brand, model, type, color, manufacturing_year
)
SELECT 
    f.id,
    f.fleet_manager_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    'LT-' || floor(random()*999)::text || '-AA',
    (ARRAY['Toyota', 'Peugeot'])[floor(random()*2)+1],
    (ARRAY['Yaris', 'Partner'])[floor(random()*2)+1],
    (ARRAY['CAR', 'VAN'])[floor(random()*2)+1]::vehicle_type_enum,
    'Jaune',
    2020
FROM fleets f;

-- =====================================================
-- 7. OFFERS & RIDES
-- =====================================================

INSERT INTO offers (
    passenger_id, start_point, end_point, price, state, created_at
)
SELECT 
    (SELECT id FROM customers ORDER BY random() LIMIT 1),
    'Point A', 'Point B', 
    2000, 
    'CHOSEN',
    NOW()
FROM generate_series(1, 60) as i;

-- Rides
INSERT INTO rides (
    offer_id, passenger_id, driver_id, 
    distance, time_estimation, real_time, state, created_at
)
SELECT 
    id, -- offer_id
    passenger_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    15.5, 30, 35,
    'COMPLETED',
    created_at
FROM offers 
LIMIT 40;

-- Reviews
INSERT INTO reviews (ride_id, author_id, subject, comment, rating)
SELECT 
    id,
    passenger_id,
    'Chauffeur',
    'Bonne course, chauffeur ponctuel',
    5
FROM rides
WHERE state = 'COMPLETED';

-- =====================================================
-- 8. PRODUCTS
-- =====================================================

INSERT INTO products (
    organization_id, name, description, standard_price, 
    status, is_active, departure_location
)
SELECT 
    (SELECT id FROM organizations ORDER BY random() LIMIT 1),
    'Trajet SpÃ©cial ' || i,
    'Description produit',
    5000,
    'PUBLISHED',
    true,
    'Douala'
FROM generate_series(1, 40) as i;

-- =====================================================
-- 9. SUBSCRIPTIONS & PAYMENTS
-- =====================================================

INSERT INTO subscriptions (
    admin_id, label, price, duration_in_days, description, is_active
) VALUES 
((SELECT id FROM admins LIMIT 1), 'Pack Hebdo', 2500, 7, 'Standard', true),
((SELECT id FROM admins LIMIT 1), 'Pack Mensuel', 10000, 30, 'Pro', true),
((SELECT id FROM admins LIMIT 1), 'Pack Annuel', 100000, 365, 'VIP', true);

INSERT INTO payments (
    driver_id, user_id, subscription_id, amount_paid, status, id_provider_transaction, created_at
)
SELECT 
    d.id, -- Driver ID
    d.id, -- Payer ID
    s.id, -- Subscription ID
    s.price,
    'SUCCESS',
    'TXN-' || floor(random()*10000000),
    NOW()
FROM drivers d
CROSS JOIN subscriptions s
ORDER BY random()
LIMIT 50;

-- =====================================================
-- 10. SOCIAL & ADDRESSES
-- =====================================================

INSERT INTO syndicats (organization_id, name, is_approved)
SELECT id, 'Syndicat Transports', true FROM organizations LIMIT 1;

INSERT INTO branches (id, syndicat_id, name, location)
SELECT 
    ag.id,
    (SELECT id FROM syndicats LIMIT 1),
    'Branche ' || ag.name, 
    ag.location 
FROM agencies ag 
LIMIT 10;

INSERT INTO publications (branch_id, author_id, content, status, n_likes)
SELECT 
    (SELECT id FROM branches ORDER BY random() LIMIT 1),
    (SELECT id FROM admins ORDER BY random() LIMIT 1),
    'Info Trafic ' || i,
    'PUBLISHED',
    floor(random() * 50)::int
FROM generate_series(1, 40) as i;

COMMIT;

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\docs\data\YOWYOB_DB\yowyob_db_test.sql
`$ext
-- =====================================================
-- YOWYOB DB - TEST QUERIES (SEMI-VALIDATION)
-- PostgreSQL
-- =====================================================

-- Summary Table to display what will be tested
SELECT * FROM (VALUES
    ('Test 1.1', 'Check Driver Inheritance (Name, Status, Car)'),
    ('Test 1.2', 'Check Customers Specific Data (Code, Payment)'),
    ('Test 2.1', 'User Role Assignments'),
    ('Test 3.1', 'Agency Locations & Headquarter Status'),
    ('Test 4.1', 'Vehicle Inventory (Fleet vs Independent)'),
    ('Test 5.1', 'Full Ride History (Passenger + Driver + Price)'),
    ('Test 5.2', 'Pending Offers (No Ride Created Yet)'),
    ('Test 6.1', 'Active Products by Organization'),
    ('Test 7.1', 'Publications Feed with Likes'),
    ('Test 7.2', 'Customer Reviews on Rides'),
    ('Test 8.1', 'Payment & Subscription Log')
) AS summary_table (Test_ID, Test_Description);

-- =====================================================
-- BLOCK 1: CORE & INHERITANCE VERIFICATION
-- =====================================================

-- 1.1. Check Driver Inheritance
SELECT 'Check Driver Inheritance (Name, Status, Car)' AS "TEST 1.1";
SELECT 
    u.id,
    u.name AS full_name,
    u.phone_number,
    d.status AS driver_status,
    d.license_number,
    d.has_car
FROM drivers d
JOIN business_actors ba ON d.id = ba.id
JOIN users u ON ba.id = u.id
LIMIT 5;

-- 1.2. Check Customers and Payment Methods
SELECT 'Check Customers Specific Data' AS "TEST 1.2";
SELECT 
    u.name AS customer_name,
    c.code AS customer_code,
    c.payment_method
FROM customers c
JOIN users u ON c.id = u.id
LIMIT 5;

-- =====================================================
-- BLOCK 2: RBAC (ROLES & SECURITY)
-- =====================================================

-- 2.1. Who has which role?
SELECT 'User Role Assignments' AS "TEST 2.1";
SELECT 
    u.name AS user_name,
    u.email_address,
    r.name AS assigned_role
FROM users u
JOIN user_has_roles uhr ON u.id = uhr.user_id
JOIN roles r ON uhr.role_id = r.id
ORDER BY u.name ASC
LIMIT 5;

-- =====================================================
-- BLOCK 3: ORGANIZATION & HIERARCHY
-- =====================================================

-- 3.1. Hierarchy Organization -> Agencies
SELECT 'Agency Locations & Headquarter Status' AS "TEST 3.1";
SELECT 
    org.short_name AS organization,
    a.name AS agency_name,
    a.city,
    a.is_headquarter
FROM agencies a
JOIN organizations org ON a.organization_id = org.id
ORDER BY org.short_name
LIMIT 5;

-- =====================================================
-- BLOCK 4: FLEET MANAGEMENT
-- =====================================================

-- 4.1. Vehicle Inventory
SELECT 'Vehicle Inventory (Fleet vs Independent)' AS "TEST 4.1";
SELECT 
    v.license_plate,
    v.brand || ' ' || v.model AS vehicle_model,
    v.type,
    f.name AS fleet_owner,
    u_owner.name AS independent_owner
FROM vehicles v
LEFT JOIN fleets f ON v.fleet_id = f.id
LEFT JOIN users u_owner ON v.user_id = u_owner.id
LIMIT 5;

-- =====================================================
-- BLOCK 5: RIDES & OFFERS (CORE BUSINESS)
-- =====================================================

-- 5.1. Full Ride Details
SELECT 'Full Ride History (Passenger + Driver + Price)' AS "TEST 5.1";
SELECT 
    r.id AS ride_id,
    r.state AS ride_state,
    passenger_u.name AS passenger,
    driver_u.name AS driver,
    o.start_point,
    o.end_point,
    o.price AS agreed_price,
    r.distance || ' km' AS real_distance
FROM rides r
JOIN offers o ON r.offer_id = o.id
JOIN customers c ON r.passenger_id = c.id
JOIN users passenger_u ON c.id = passenger_u.id
JOIN drivers d ON r.driver_id = d.id
JOIN users driver_u ON d.id = driver_u.id
WHERE r.state = 'COMPLETED'
LIMIT 5;

-- 5.2. Offers without Drivers
SELECT 'Pending Offers (No Ride Created Yet)' AS "TEST 5.2";
SELECT 
    o.id,
    o.state,
    o.price,
    o.created_at
FROM offers o
LEFT JOIN rides r ON o.id = r.offer_id
WHERE r.id IS NULL
LIMIT 5;

-- =====================================================
-- BLOCK 6: PRODUCTS & SERVICES
-- =====================================================

-- 6.1. Product Catalog by Organization
SELECT 'Active Products by Organization' AS "TEST 6.1";
SELECT 
    org.short_name AS seller,
    p.name AS product_name,
    p.standard_price AS price,
    p.status
FROM products p
JOIN organizations org ON p.organization_id = org.id
WHERE p.is_active = true
LIMIT 5;

-- =====================================================
-- BLOCK 7: SOCIAL (PUBLICATIONS & REVIEWS)
-- =====================================================

-- 7.1. Branch News Feed
SELECT 'Publications Feed with Likes' AS "TEST 7.1";
SELECT 
    b.name AS source_branch,
    u.name AS author,
    pub.content AS message,
    pub.n_likes AS likes
FROM publications pub
JOIN branches b ON pub.branch_id = b.id
JOIN users u ON pub.author_id = u.id
ORDER BY pub.created_at DESC
LIMIT 5;

-- 7.2. Ride Reviews
SELECT 'Customer Reviews on Rides' AS "TEST 7.2";
SELECT 
    rev.rating,
    rev.comment,
    u.name AS author
FROM reviews rev
JOIN users u ON rev.author_id = u.id
LIMIT 5;

-- =====================================================
-- BLOCK 8: FINANCE (SUBSCRIPTIONS & PAYMENTS)
-- =====================================================

-- 8.1. Payment History
SELECT 'Payment & Subscription Log' AS "TEST 8.1";
SELECT 
    pay.id AS payment_id,
    u.name AS payer,
    sub.label AS subscription_plan,
    pay.amount_paid,
    pay.status,
    pay.created_at
FROM payments pay
JOIN users u ON pay.user_id = u.id
JOIN subscriptions sub ON pay.subscription_id = sub.id
ORDER BY pay.created_at DESC
LIMIT 5;

-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\docs\prompts\master_pair_programmer.md
`$ext
# ðŸ¤– Master Prompt : Senior Pair Programmer WebFlux

Tu es mon Senior Pair Programmer expert en Java **Spring Boot WebFlux (RÃ©actif)**.
Nous dÃ©veloppons l'API **Fleet Management et Geofencing** (Projet TraEnSys).

### ðŸ“‹ Ta MÃ©thode de Travail (IMPÃ‰RATIF)
Pour chaque tÃ¢che demandÃ©e, tu dois obligatoirement suivre ces Ã©tapes :

**Ã‰tape 1 : Conception fonctionnelle**
- Analyse du besoin, user stories et ajustement du modÃ¨le de donnÃ©es.
- **Attente de ma validation explicite avant d'aller plus loin.**

**Ã‰tape 2 : Explication du Concept RÃ©actif**
- Avant de coder, explique briÃ¨vement comment le flux rÃ©actif (`Mono`/`Flux`) sera gÃ©rÃ© pour cette tÃ¢che.

**Ã‰tape 3 : ImplÃ©mentation**
- Fournis le code complet par blocs Markdown copiables.
- Respecte l'architecture hexagonale du projet.

**Ã‰tape 4 : Tests & Validation**
- Instructions pour tester via Postman ou logs.

### ðŸš« Tes RÃ¨gles de Conduite
1. **ZÃ©ro code non sollicitÃ©** : Ne propose aucune solution technique avant l'Ã‰tape 3.
2. **Focus** : RÃ©ponds uniquement Ã  la question posÃ©e, de maniÃ¨re synthÃ©tique et prÃ©cise.
3. **Fichiers complets** : Sauf mention contraire, donne toujours le code complet du fichier pour Ã©viter les erreurs de copier-coller.
4. **PÃ©dagogie** : Si une opÃ©ration risque de bloquer un thread (ex: JDBC classique, thread sleep), arrÃªte-moi et propose l'alternative non-bloquante.

### ðŸ“‚ Contexte
Le code source complet est disponible dans le fichier `project_context.txt`.
La roadmap est suivie dans `todo.md`.

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\src\main\resources\application.yml
`$ext
server:
  port: 8080

spring:
  application:
    name: fleet-management

  # THE "TOGGLE": Change 'local' to 'remote' to switch databases
  profiles:
    active: local 
    
  docker:
    compose:
      enabled: false

  # POSTGRESQL (R2DBC)
  r2dbc:
    url: r2dbc:postgresql://168.119.122.86:5432/yowyob
    username: master
    password: Azerty1234*

  sql:
    init:
      mode: always

  # REDIS CLUSTER 
  data:
    redis:
      host: 168.119.122.86
      port: 7000
      password: Azerty1234*
      cluster:
        enabled: false 

  # KAFKA 
  kafka:
    bootstrap-servers: 168.119.122.86:9092
    consumer:
      group-id: fleet-management-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CUSTOM CONFIG 
application:
  external:
    stock-service-url: http://168.119.122.86:8081

  kafka:
    topics:
      product-events: test-topic

# RESILIENCE4J 
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5

---
# LOCAL CONFIGURATION
spring:
  config:
    activate:
      on-profile: local
  r2dbc:
    url: r2dbc:postgresql://localhost:5432/yowyob_db
    username: fleet_admin
    password: fleet_password
  sql:
    init:
      mode: never

---
# REMOTE CONFIGURATION (Server)
spring:
  config:
    activate:
      on-profile: remote
  r2dbc:
    url: r2dbc:postgresql://168.119.122.86:5432/yowyob
    username: master
    password: Azerty1234*
  sql:
    init:
      mode: never # SAFETY: Never run the destructive schema.sql on the remote server

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\src\main\resources\prod.application.yml
`$ext
server:
  port: 8080

spring:
  application:
    name: reactive-hexagonal
    
  docker:
    compose:
      enabled: false

  # POSTGRESQL (R2DBC)
  r2dbc:
    url: r2dbc:postgresql://168.119.122.86:5432/yowyob
    username: master
    password: Azerty1234*

  sql:
    init:
      mode: always

  # REDIS CLUSTER 
  data:
    redis:
      password: Azerty1234*
      cluster:
        nodes:
          - 168.119.122.86:7001
          - 168.119.122.86:7002
          - 168.119.122.86:7003
          - 168.119.122.86:7004
          - 168.119.122.86:7005
          - 168.119.122.86:7006

  # KAFKA 
  kafka:
    bootstrap-servers: 168.119.122.86:9092
    consumer:
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CUSTOM CONFIG 
application:
  external:
    stock-service-url: http://168.119.122.86:8081

  kafka:
    topics:
      product-events: test-topic

# RESILIENCE4J 
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\src\main\resources\local\data.sql
`$ext
-- =====================================================
-- YOWYOB DB - DATA SEEDING SCRIPT
-- PostgreSQL
-- =====================================================


-- =====================================================
-- 1. CLEANUP EXISTING DATA
-- =====================================================
TRUNCATE TABLE 
    users, images, countries, business_actors, 
    admins, fleet_managers, drivers, customers, 
    providers, employees, prospects, sales_persons,
    profiles, settings, addresses, contacts,
    roles, permissions, role_has_permissions, user_has_roles,
    organizations, agencies, business_domains, organization_business_domains,
    certifications, third_parties, proposed_activities, services, branches,
    fleets, vehicles, geofence_zones, geofence_points, geofence_events,
    roads, trips, offers, rides, reviews, offer_driver_linkages,
    operational_parameters, financial_parameters, maintenance_parameters,
    geofence_point_zone_linkages,
    syndicats, abstract_products, products, 
    publications, publication_images, publication_votes, votes,
    events, event_images, reactions, comments, avis,
    subscriptions, payments
    RESTART IDENTITY CASCADE;

-- =====================================================
-- 2. STATIC REFERENCE DATA
-- =====================================================

-- Countries
INSERT INTO countries (name, code) VALUES
('Cameroun', 'CM'), ('SÃ©nÃ©gal', 'SN'), ('CÃ´te d''Ivoire', 'CI'), 
('Gabon', 'GA'), ('NigÃ©ria', 'NG'), ('Togo', 'TG');

-- Roles
INSERT INTO roles (name, guard_name) VALUES
('ADMIN', 'web'), ('FLEET_MANAGER', 'web'), ('DRIVER', 'web'), ('CUSTOMER', 'web');

-- Images (Random placeholders from Picsum)
INSERT INTO images (url, alt_text) 
SELECT 
    'https://picsum.photos/seed/' || i || '/800/600', 
    'Image alÃ©atoire ' || i
FROM generate_series(1, 50) as i;

-- =====================================================
-- 3. USERS GENERATION (100 users)
-- =====================================================

INSERT INTO users (name, phone_number, email_address)
SELECT 
    (ARRAY['Mamadou', 'Jean-Pierre', 'Ibrahim', 'Fatou', 'Aminata', 'Ngolo', 'Aboubakar', 'Clarisse', 'Samuel', 'KouamÃ©', 'Aissatou', 'Bachelard', 'Landry', 'ThÃ©rÃ¨se'])[floor(random()*14)+1] 
    || ' ' || 
    (ARRAY['Diop', 'Njoya', 'Mbarga', 'Kone', 'Sow', 'Etoundi', 'Kamga', 'TraorÃ©', 'Diallo', 'Fofana', 'Mensah', 'Atangana', 'Eto''o', 'Drogba'])[floor(random()*14)+1],
    (ARRAY['+237', '+221', '+225'])[floor(random()*3)+1] || (600000000 + floor(random()*99999999)::int),
    'user_' || i || '@yowyob.test'
FROM generate_series(1, 100) as i;

-- Settings & Profiles
INSERT INTO settings (user_id, theme, language, receive_push_notifications)
SELECT id, 'LIGHT', 'fr', true FROM users;

INSERT INTO profiles (user_id, first_name, nationality, is_verified)
SELECT id, split_part(name, ' ', 1), 'Camerounais', (random() > 0.5) FROM users;

-- =====================================================
-- 4. ACTORS DISPATCHING
-- User -> BusinessActor -> SpecificActor
-- =====================================================

-- 4.1 Admins (First 5 users)
INSERT INTO admins (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5;

-- 4.2 Fleet Managers (Next 5 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- STEP 2: Insert into CHILD (FleetManager)
INSERT INTO fleet_managers (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- 4.3 Drivers (Next 30 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- STEP 2: Insert into CHILD (Driver)
INSERT INTO drivers (id, status, license_number, has_car)
SELECT 
    id, 
    (ARRAY['AVAILABLE', 'BUSY', 'OFFLINE'])[floor(random()*3)+1], 
    'LIC-' || floor(random()*100000) || '-CM',
    (random() > 0.3)
FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- 4.4 Customers (Remaining 60 users)
INSERT INTO customers (id, code, payment_method)
SELECT 
    id, 
    'CUST-' || substr(id::text, 1, 8),
    (ARRAY['CASH', 'MOBILE_MONEY', 'CARD'])[floor(random()*3)+1]
FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- Assign Roles
INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'ADMIN') FROM users ORDER BY email_address LIMIT 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'FLEET_MANAGER') FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'DRIVER') FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'CUSTOMER') FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- =====================================================
-- 5. ORGANIZATIONS & AGENCIES
-- =====================================================

INSERT INTO organizations (
    business_actor_id, logo_id, code, short_name, long_name, 
    description, tax_number, is_active, status
)
SELECT
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    (SELECT id FROM images ORDER BY random() LIMIT 1),
    'ORG-' || i,
    'Transport ' || i,
    'SociÃ©tÃ© de Transport ' || i,
    'Description ' || i,
    'TAX-' || floor(random()*1000000),
    true,
    'PUBLISHED'
FROM generate_series(1, 35) as i;

INSERT INTO agencies (
    organization_id, manager_id, name, city, location, is_headquarter
)
SELECT 
    id, 
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    'Agence Centrale',
    (ARRAY['Douala', 'YaoundÃ©', 'Abidjan'])[floor(random()*3)+1],
    'Rue Principale',
    true
FROM organizations;

-- =====================================================
-- 6. FLEETS & VEHICLES
-- =====================================================

INSERT INTO fleets (fleet_manager_id, name, phone_number)
SELECT 
    id, 'Flotte de ' || name, '+237699000000'
FROM fleet_managers;

-- Vehicles
INSERT INTO vehicles (
    fleet_id, user_id, driver_id, license_plate, brand, model, type, color, manufacturing_year
)
SELECT 
    f.id,
    f.fleet_manager_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    'LT-' || floor(random()*999)::text || '-AA',
    (ARRAY['Toyota', 'Peugeot'])[floor(random()*2)+1],
    (ARRAY['Yaris', 'Partner'])[floor(random()*2)+1],
    (ARRAY['CAR', 'VAN'])[floor(random()*2)+1]::vehicle_type_enum,
    'Jaune',
    2020
FROM fleets f;

-- =====================================================
-- 7. OFFERS & RIDES
-- =====================================================

INSERT INTO offers (
    passenger_id, start_point, end_point, price, state, created_at
)
SELECT 
    (SELECT id FROM customers ORDER BY random() LIMIT 1),
    'Point A', 'Point B', 
    2000, 
    'CHOSEN',
    NOW()
FROM generate_series(1, 60) as i;

-- Rides
INSERT INTO rides (
    offer_id, passenger_id, driver_id, 
    distance, time_estimation, real_time, state, created_at
)
SELECT 
    id, -- offer_id
    passenger_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    15.5, 30, 35,
    'COMPLETED',
    created_at
FROM offers 
LIMIT 40;

-- Reviews
INSERT INTO reviews (ride_id, author_id, subject, comment, rating)
SELECT 
    id,
    passenger_id,
    'Chauffeur',
    'Bonne course, chauffeur ponctuel',
    5
FROM rides
WHERE state = 'COMPLETED';

-- =====================================================
-- 8. PRODUCTS
-- =====================================================

INSERT INTO products (
    organization_id, name, description, standard_price, 
    status, is_active, departure_location
)
SELECT 
    (SELECT id FROM organizations ORDER BY random() LIMIT 1),
    'Trajet SpÃ©cial ' || i,
    'Description produit',
    5000,
    'PUBLISHED',
    true,
    'Douala'
FROM generate_series(1, 40) as i;

-- =====================================================
-- 9. SUBSCRIPTIONS & PAYMENTS
-- =====================================================

INSERT INTO subscriptions (
    admin_id, label, price, duration_in_days, description, is_active
) VALUES 
((SELECT id FROM admins LIMIT 1), 'Pack Hebdo', 2500, 7, 'Standard', true),
((SELECT id FROM admins LIMIT 1), 'Pack Mensuel', 10000, 30, 'Pro', true),
((SELECT id FROM admins LIMIT 1), 'Pack Annuel', 100000, 365, 'VIP', true);

INSERT INTO payments (
    driver_id, user_id, subscription_id, amount_paid, status, id_provider_transaction, created_at
)
SELECT 
    d.id, -- Driver ID
    d.id, -- Payer ID
    s.id, -- Subscription ID
    s.price,
    'SUCCESS',
    'TXN-' || floor(random()*10000000),
    NOW()
FROM drivers d
CROSS JOIN subscriptions s
ORDER BY random()
LIMIT 50;

-- =====================================================
-- 10. SOCIAL & ADDRESSES
-- =====================================================

INSERT INTO syndicats (organization_id, name, is_approved)
SELECT id, 'Syndicat Transports', true FROM organizations LIMIT 1;

INSERT INTO branches (id, syndicat_id, name, location)
SELECT 
    ag.id,
    (SELECT id FROM syndicats LIMIT 1),
    'Branche ' || ag.name, 
    ag.location 
FROM agencies ag 
LIMIT 10;

INSERT INTO publications (branch_id, author_id, content, status, n_likes)
SELECT 
    (SELECT id FROM branches ORDER BY random() LIMIT 1),
    (SELECT id FROM admins ORDER BY random() LIMIT 1),
    'Info Trafic ' || i,
    'PUBLISHED',
    floor(random() * 50)::int
FROM generate_series(1, 40) as i;


---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\bin\src\main\resources\local\schema.sql
`$ext
-- =====================================================
-- YOWYOB DB - INIT SCRIPT
-- PostgreSQL
-- Structure: Core -> Organization -> RBAC
-- =====================================================

-- Clean up existing tables and types to ensure a fresh start
-- We drop them in reverse order of dependency
DROP TABLE IF EXISTS user_has_roles CASCADE;
DROP TABLE IF EXISTS role_has_permissions CASCADE;
DROP TABLE IF EXISTS permissions CASCADE;
DROP TABLE IF EXISTS roles CASCADE;
DROP TABLE IF EXISTS reviews CASCADE;
DROP TABLE IF EXISTS payments CASCADE;
DROP TABLE IF EXISTS subscriptions CASCADE;
DROP TABLE IF EXISTS admins CASCADE;
DROP TABLE IF EXISTS profiles CASCADE;
DROP TABLE IF EXISTS comments CASCADE;
DROP TABLE IF EXISTS reactions CASCADE;
DROP TABLE IF EXISTS event_images CASCADE;
DROP TABLE IF EXISTS events CASCADE;
DROP TABLE IF EXISTS publication_images CASCADE;
DROP TABLE IF EXISTS publications CASCADE;
DROP TABLE IF EXISTS branches CASCADE;
DROP TABLE IF EXISTS avis CASCADE;
DROP TABLE IF EXISTS votes CASCADE;
DROP TABLE IF EXISTS publication_votes CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS abstract_products CASCADE;
DROP TABLE IF EXISTS syndicats CASCADE;
DROP TABLE IF EXISTS offer_driver_linkages CASCADE;
DROP TABLE IF EXISTS geofence_events CASCADE;
DROP TABLE IF EXISTS geofence_point_zone_linkages CASCADE;
DROP TABLE IF EXISTS geofence_points CASCADE;
DROP TABLE IF EXISTS maintenance_parameters CASCADE;
DROP TABLE IF EXISTS financial_parameters CASCADE;
DROP TABLE IF EXISTS operational_parameters CASCADE;
DROP TABLE IF EXISTS trips CASCADE;
DROP TABLE IF EXISTS roads CASCADE;
DROP TABLE IF EXISTS vehicles CASCADE;
DROP TABLE IF EXISTS geofence_zones CASCADE;
DROP TABLE IF EXISTS fleets CASCADE;
DROP TABLE IF EXISTS fleet_managers CASCADE;
DROP TABLE IF EXISTS rides CASCADE;
DROP TABLE IF EXISTS offers CASCADE;
DROP TABLE IF EXISTS drivers CASCADE;
DROP TABLE IF EXISTS services CASCADE;
DROP TABLE IF EXISTS customers CASCADE;
DROP TABLE IF EXISTS sales_persons CASCADE;
DROP TABLE IF EXISTS prospects CASCADE;
DROP TABLE IF EXISTS employees CASCADE;
DROP TABLE IF EXISTS providers CASCADE;
DROP TABLE IF EXISTS addresses CASCADE;
DROP TABLE IF EXISTS proposed_activities CASCADE;
DROP TABLE IF EXISTS settings CASCADE;
DROP TABLE IF EXISTS third_parties CASCADE;
DROP TABLE IF EXISTS certifications CASCADE;
DROP TABLE IF EXISTS organization_business_domains CASCADE;
DROP TABLE IF EXISTS contacts CASCADE;
DROP TABLE IF EXISTS business_domains CASCADE;
DROP TABLE IF EXISTS agencies CASCADE;
DROP TABLE IF EXISTS organizations CASCADE;
DROP TABLE IF EXISTS business_actors CASCADE;
DROP TABLE IF EXISTS countries CASCADE;
DROP TABLE IF EXISTS images CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- Drop existing types
DROP TYPE IF EXISTS reaction_type_enum CASCADE;
DROP TYPE IF EXISTS type_enum CASCADE;
DROP TYPE IF EXISTS role_type_enum CASCADE;
DROP TYPE IF EXISTS engine_status_enum CASCADE;
DROP TYPE IF EXISTS maintenance_status_enum CASCADE;
DROP TYPE IF EXISTS event_type_enum CASCADE;
DROP TYPE IF EXISTS ride_state_enum CASCADE;
DROP TYPE IF EXISTS offer_state_enum CASCADE;
DROP TYPE IF EXISTS vehicle_type_enum CASCADE;
DROP TYPE IF EXISTS action_enum CASCADE;
DROP TYPE IF EXISTS category_enum CASCADE;
DROP TYPE IF EXISTS status_enum CASCADE;

-- Re-enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";


-- =====================================================
-- ENUM TYPES
-- =====================================================

CREATE TYPE status_enum AS ENUM (
  'DRAFT', 'WAITING_CONFIRMATION', 'PUBLISHED', 'IN_PROGRESS', 'CANCELLED', 'EXPIRED'
);

CREATE TYPE category_enum AS ENUM (
  'ANNOUNCE', 'PLANNING', 'VEHICLE', 'ADDRESS', 'EXPERIENCE'
);

CREATE TYPE action_enum AS ENUM (
  'CREATE', 'UPDATE', 'READ', 'DELETE'
);

CREATE TYPE vehicle_type_enum AS ENUM (
  'CAR', 'VAN', 'TRUCK', 'BIKE'
);

CREATE TYPE offer_state_enum AS ENUM (
  'NEW', 'PENDING', 'CHOSEN', 'TERMINATED', 'CANCELED'
);

CREATE TYPE ride_state_enum AS ENUM (
  'CONFIRMED', 'ONGOING', 'COMPLETED', 'CANCELED'
);

CREATE TYPE event_type_enum AS ENUM (
  'ENTRY', 'EXIT'
);

CREATE TYPE maintenance_status_enum AS ENUM (
  'UP_TO_DATE', 'PENDING', 'OVERDUE'
);

CREATE TYPE engine_status_enum AS ENUM (
  'OK', 'NEED_SERVICE', 'OUT_OF_SERVICE'
);

CREATE TYPE role_type_enum AS ENUM (
  'CUSTOMER', 'DRIVER', 'FLEET_MANAGER', 'ADMIN', 'PASSENGER', 'PRESIDENT', 'MODERATOR', 'CLIENT'
);

CREATE TYPE type_enum AS ENUM (
  'NOTIFICATION', 'CHAT', 'PAYMENT', 'MEDIA'
);

CREATE TYPE reaction_type_enum AS ENUM (
  'LIKE', 'LOVE', 'HAHA', 'WOW', 'SAD', 'ANGRY'
);

-- =====================================================
-- CORE TABLES
-- =====================================================

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  phone_number TEXT,
  email_address TEXT UNIQUE
);

CREATE TABLE images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url TEXT NOT NULL,
  alt_text TEXT,
  uploaded_at TIMESTAMP DEFAULT now()
);

CREATE TABLE countries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE business_actors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT,
  phone_number TEXT,
  email_address TEXT,
  CONSTRAINT fk_business_actor_user
    FOREIGN KEY (id) REFERENCES users(id)
    ON DELETE CASCADE
);

-- =====================================================
-- ORGANIZATION TABLES
-- =====================================================

CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_actor_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  email TEXT,
  short_name TEXT,
  long_name TEXT,
  description TEXT,
  logo_uri TEXT,
  website_url TEXT,
  social_network TEXT,
  business_registration_number TEXT,
  tax_number TEXT,
  capital_share NUMERIC,
  ceo_name TEXT,
  year_founded INT,
  keywords TEXT,
  number_of_employees INT,
  legal_form TEXT,
  is_active BOOLEAN DEFAULT true,
  status status_enum DEFAULT 'DRAFT',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, -- Must belong to an org

  owner_id UUID REFERENCES business_actors(id),
  manager_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  name TEXT,
  location TEXT,
  description TEXT,
  transferable BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  logo_uri TEXT,
  short_name TEXT,
  long_name TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  is_headquarter BOOLEAN DEFAULT false,
  country TEXT,
  city TEXT,
  latitude NUMERIC,
  longitude NUMERIC,
  open_time TIME,
  close_time TIME,
  phone TEXT,
  email TEXT,
  whatsapp TEXT,
  greeting_message TEXT,
  average_revenue NUMERIC,
  capital_share NUMERIC,
  registration_number TEXT,
  social_network TEXT,
  tax_number TEXT,
  keywords TEXT,
  is_public BOOLEAN DEFAULT false,
  is_business BOOLEAN DEFAULT true,
  total_affiliated_customers INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE business_domains (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL, -- optional link to organization
  parent_id UUID REFERENCES business_domains(id) ON DELETE SET NULL,   -- self-referential for hierarchy
  image_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  name TEXT,
  image_uri TEXT,
  type TEXT,
  type_label TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE organization_business_domains (
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  business_domain_id UUID REFERENCES business_domains(id) ON DELETE CASCADE,
  PRIMARY KEY (organization_id, business_domain_id)
);

CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  contactable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  contactable_type TEXT,
  first_name TEXT,
  last_name TEXT,
  title TEXT,
  is_email_verified BOOLEAN DEFAULT false,
  is_phone_number_verified BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  phone_number TEXT,
  secondary_phone_number TEXT,
  fax_number TEXT,
  email TEXT,
  secondary_email TEXT,
  email_verified_at TIMESTAMP,
  phone_verified_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE certifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  description TEXT,
  obtainment_date DATE,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE third_parties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  logo_id UUID REFERENCES images(id),

  code TEXT,
  type TEXT,
  legal_form TEXT,
  unique_identification_number TEXT,
  trade_registration_number TEXT,
  name TEXT,
  acronym TEXT,
  long_name TEXT,
  logo_uri TEXT,
  accounting_account_numbers TEXT,
  authorized_payment_methods TEXT,
  authorized_credit_limit NUMERIC,
  max_discount_rate NUMERIC,
  vat_subject BOOLEAN,
  operations_balance NUMERIC,
  opening_balance NUMERIC,
  pay_term_number INT,
  pay_term_type TEXT,
  third_party_family TEXT,
  classification TEXT,
  tax_number TEXT,
  loyalty_points NUMERIC,
  loyalty_points_used NUMERIC,
  loyalty_points_expired NUMERIC,
  enabled BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE settings (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  theme TEXT,
  language TEXT,
  long_ride_enabled BOOLEAN DEFAULT false,
  short_ride_enabled BOOLEAN DEFAULT false,
  privacy_enable BOOLEAN DEFAULT true,
  allow_calls BOOLEAN DEFAULT true,
  allow_messages BOOLEAN DEFAULT true,
  notify_new_rides BOOLEAN DEFAULT true,
  notify_ratings BOOLEAN DEFAULT true,
  notify_practical_tips BOOLEAN DEFAULT true,
  notify_promotions BOOLEAN DEFAULT true,
  notify_policy_updates BOOLEAN DEFAULT true,
  notify_peak_hour_recommendations BOOLEAN DEFAULT true,
  receive_email BOOLEAN DEFAULT true,
  receive_sms BOOLEAN DEFAULT true,
  receive_push_notifications BOOLEAN DEFAULT true,
  receive_whatsapp BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE proposed_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  rate NUMERIC,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE addresses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  addressable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  country_id UUID REFERENCES countries(id) ON DELETE SET NULL,

  addressable_type TEXT,
  type TEXT,
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  state TEXT,
  locality TEXT,
  zip_code TEXT,
  postal_code TEXT,
  po_box TEXT,
  is_default BOOLEAN DEFAULT false,
  neighbor_hood TEXT,
  informal_description TEXT,
  latitude NUMERIC,
  longitude NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

-- =====================================================
-- USERS EXTENDED
-- =====================================================

CREATE TABLE providers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  contact_info TEXT,
  address TEXT,
  is_active BOOLEAN DEFAULT true,
  product_service_type TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE employees (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  is_manager BOOLEAN DEFAULT false,
  role TEXT,
  department TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE prospects (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,
  interest_level TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE sales_persons (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  commission_rate NUMERIC,
  credit NUMERIC,
  current_balance NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE customers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

-- =====================================================
-- RIDE & FLEET MANAGEMENT
-- =====================================================

CREATE TABLE drivers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  status TEXT,
  license_number TEXT,
  has_car BOOLEAN DEFAULT false
);

CREATE TABLE offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  passenger_id UUID REFERENCES customers(id) ON DELETE CASCADE,

  start_point TEXT,
  end_point TEXT,
  price NUMERIC,
  state offer_state_enum DEFAULT 'NEW',
  ids_interested_drivers TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE rides (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  offer_id UUID REFERENCES offers(id) ON DELETE SET NULL,
  passenger_id UUID REFERENCES users(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  distance NUMERIC,
  time_estimation NUMERIC,
  real_time NUMERIC,
  state ride_state_enum DEFAULT 'CONFIRMED',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet_managers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE fleets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fleet_manager_id UUID REFERENCES fleet_managers(id) ON DELETE SET NULL,

  name TEXT,
  phone_number TEXT,
  email_address TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE geofence_zones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  surface_area NUMERIC,
  perimeter NUMERIC
);

CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  fleet_id UUID REFERENCES fleets(id) ON DELETE SET NULL,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,

  license_plate TEXT,
  model TEXT,
  brand TEXT,
  manufacturing_year INT,
  type vehicle_type_enum,
  color TEXT
);

CREATE TABLE roads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  start_point TEXT,
  end_point TEXT
);

CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  road_id UUID REFERENCES roads(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  start_date DATE,
  end_date DATE,
  start_time TIME,
  end_time TIME,
  type TEXT,
  color TEXT
);

CREATE TABLE operational_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  statut TEXT,
  current_location TEXT,
  current_speed NUMERIC,
  fuel_level NUMERIC,
  mileage NUMERIC,
  odometer_reading NUMERIC,
  bearing NUMERIC,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE financial_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  insurance_number TEXT,
  insurance_expired_at DATE,
  registered_at DATE,
  purchased_at DATE,
  depreciation_rate NUMERIC,
  cost_per_km NUMERIC
);

CREATE TABLE maintenance_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  last_maintenance_at DATE,
  next_maintenance_at DATE,
  engine_status engine_status_enum DEFAULT 'OK',
  battery_health TEXT,
  maintenance_status maintenance_status_enum DEFAULT 'UP_TO_DATE'
);

CREATE TABLE geofence_points (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  latitude NUMERIC,
  longitude NUMERIC
);

CREATE TABLE geofence_point_zone_linkages (
  point_id UUID REFERENCES geofence_points(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE CASCADE,
  PRIMARY KEY (point_id, zone_id)
);

CREATE TABLE geofence_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,
  point_id UUID REFERENCES geofence_points(id) ON DELETE SET NULL,

  type event_type_enum,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE offer_driver_linkages (
  offer_id UUID REFERENCES offers(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE CASCADE,
  PRIMARY KEY (offer_id, driver_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- OTHERS: PRODUCTS, SYNDICATS, PUBLICATIONS & REVIEWS
-- =====================================================

CREATE TABLE syndicats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  is_approved BOOLEAN DEFAULT false,
  name TEXT,
  description TEXT,
  domain TEXT,
  type TEXT,
  charte_url TEXT,
  status_url TEXT,
  members_list_url TEXT,
  commitment_certificate_url TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE abstract_products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  abstract_product_id UUID REFERENCES abstract_products(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  standard_price NUMERIC,
  departure_location TEXT,
  arrival_location TEXT,
  start_date DATE,
  start_time TIME,
  end_date DATE,
  end_time TIME,
  baggage_info TEXT,
  is_negotiable BOOLEAN DEFAULT false,
  payment_method TEXT,
  title TEXT,
  status status_enum DEFAULT 'DRAFT',
  product_urls TEXT,
  regular_amount NUMERIC,
  discount_percentage NUMERIC,
  discounted_amount NUMERIC,
  metadata JSONB,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  title TEXT,
  description TEXT,
  closing_at TIMESTAMP,
  type category_enum
);

CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  publication_vote_id UUID REFERENCES publication_votes(id) ON DELETE CASCADE,

  label TEXT
);

CREATE TABLE avis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  comment TEXT,
  number INT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE branches (
  id UUID PRIMARY KEY REFERENCES agencies(id),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  location TEXT,
  contact TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  content TEXT,
  status status_enum DEFAULT 'DRAFT',
  n_likes INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_images (
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (publication_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,

  title TEXT,
  description TEXT,
  location TEXT,
  date DATE,
  start_time TIME,
  end_time TIME,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE event_images (
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (event_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  type reaction_type_enum,

  reacted_at TIMESTAMP DEFAULT now()
);

CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES comments(id) ON DELETE SET NULL,
  image_id UUID REFERENCES images(id) ON DELETE SET NULL,

  content TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  first_name TEXT,
  last_name TEXT,
  nickname TEXT,
  profile_image_url TEXT,
  birth_date DATE,
  nationality TEXT,
  gender TEXT,
  language TEXT,
  company_name TEXT,
  biography TEXT,
  rating NUMERIC,
  total_trips INT,
  is_available BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- PAYMENTS & SUBSCRIPTIONS
-- =====================================================

CREATE TABLE admins (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  admin_id UUID REFERENCES admins(id) ON DELETE SET NULL,

  label TEXT,
  price NUMERIC,
  duration_in_days INT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,
  user_id UUID REFERENCES business_actors(id) ON DELETE SET NULL,

  amount_paid NUMERIC,
  status TEXT,
  id_provider_transaction TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ride_id UUID REFERENCES rides(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  subject TEXT,
  comment TEXT,
  rating NUMERIC,

  created_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- ROLE-BASED ACCESS CONTROL (RBAC)
-- =====================================================

CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE role_has_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE user_has_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Commit the transaction


-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\docs\contracts_fleet_management.md
`$ext
# **API Contracts v1.0 - Fleet Management Service**

This document defines the data contracts and endpoints for the **Fleet Management API** of the TraEnSys project. This service is responsible for managing fleets, vehicles, drivers, tracking trips, and handling geofencing.

## 1. Physical Data Model (Tables)

This section describes the database tables that support the service, based on the class diagram and incorporating the required corrections.

### 1.1. Core Tables

**Table: `fleets`**
Stores information about each vehicle fleet.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the fleet. |
| `name` | VARCHAR(255) | NOT NULL | The public name of the fleet. |
| `creationDate` | DATE | NOT NULL | Date when the fleet was created. |
| `managerUserId`| UUID | FOREIGN KEY | References the `id` of the user (Fleet Manager) in the authentication service. |

**Table: `vehicles`**
Stores all data related to a single vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the vehicle. |
| `fleetId` | UUID | FOREIGN KEY, NOT NULL | The fleet to which the vehicle belongs (`fleets`). |
| `licensePlate` | VARCHAR(50) | NOT NULL, UNIQUE | The vehicle's unique license plate. |
| `brand` | VARCHAR(100) | | Brand of the vehicle (e.g., Toyota). |
| `model` | VARCHAR(100) | | Model of the vehicle (e.g., Yaris). |
| `manufacturingYear` | INT | | The year the vehicle was manufactured. |
| `type` | VEHICLE_TYPE (Enum) | | The type of vehicle (CAR, TRUCK, VAN, BIKE). |
| `color` | VARCHAR(50) | | Color of the vehicle. |

**Table: `drivers`**
Contains information specific to the driver role.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `userId` | UUID | PRIMARY KEY, FOREIGN KEY| References the corresponding user in the authentication service. |
| `assignedVehicleId` | UUID | FOREIGN KEY, UNIQUE | The vehicle currently assigned to the driver (`vehicles`). Can be NULL. |
| `licenceNumber` | VARCHAR(100) | NOT NULL, UNIQUE | The driver's license number. |
| `status` | BOOLEAN | NOT NULL | Indicates if the driver is active (`true`) or inactive (`false`). |

**Table: `trips`**
Logs every trip made by a vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the trip. |
| `vehicleId` | UUID | FOREIGN KEY, NOT NULL | The vehicle that made the trip (`vehicles`). |
| `driverId` | UUID | FOREIGN KEY, NOT NULL | The driver who made the trip (`drivers`). |
| `startDate` | DATE | NOT NULL | The date the trip started. |
| `endDate` | DATE | | The date the trip ended. |
| `startTime` | TIME | NOT NULL | The time the trip started. |
| `endTime` | TIME | | The time the trip ended. |
| `type` | VEHICLE_TYPE (Enum) | | Type of vehicle used (redundant but useful for history). |
| `color` | VARCHAR(50) | | Color of the vehicle (redundant but useful for history). |

### 1.2. Parameter Tables (1-to-1 Relationship with `vehicles`)

**Table: `financial_parameters`**

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL | Linked to a single vehicle (`vehicles`). |
| `insuranceNumber` | VARCHAR(100) | | Insurance policy number. |
| `insuranceExpiryDate` | DATE | | Expiry date of the insurance. |
| `registrationDate`| DATE | | The vehicle's registration date. |
| `purchaseDate` | DATE | | Date the vehicle was purchased. |
| `depreciationRate`| INT | | Annual depreciation rate (as a %). |
| `costPerKm` | FLOAT | | Estimated operational cost per kilometer. |

**Table: `maintenance_parameters`**

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL| Linked to a single vehicle (`vehicles`). |
| `lastMaintenanceDate` | DATE | | Date of the last maintenance. |
| `nextMaintenanceDue` | DATE | | Date when the next maintenance is due. |
| `engineStatus` | ENGINE_STATUS (Enum) | | Status of the engine (OK, NEEDS_SERVICE...). |
| `batteryHealth` | INT | | The health of the battery (as a %). |
| `maintenanceStatus` | MAINTENANCE_STATUS (Enum) | | Overall maintenance status (UP_TO_DATE, PENDING...). |

**Table: `operational_parameters`**
Stores real-time data for a vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL| Linked to a single vehicle (`vehicles`). |
| `currentTripId` | UUID | FOREIGN KEY | The current trip for this vehicle (`trips`). Can be NULL. |
| `status` | BOOLEAN | NOT NULL | Operational status (e.g., `true` for in-service). |
| `currentLocationPointId` | UUID | FOREIGN KEY | The last known GPS coordinate (`geofence_points`). |
| `currentSpeed` | FLOAT | | The vehicle's current speed in km/h. |
| `fuelLevel` | VARCHAR(50) | | Current fuel level (e.g., "75%", "12/16"). |
| `mileage` | FLOAT | | Total mileage of the vehicle. |
| `odometerReading`| FLOAT | | The reading from the odometer. |
| `bearing` | FLOAT | | The vehicle's direction of travel in degrees (0-360). |
| `timestamp` | DATETIME | | Timestamp of the last data update. |

### 1.3. Geofencing and Route Tables

**Table: `geofence_zones`**
Defines a geographical zone.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the zone. |
| `name` | VARCHAR(255) | NOT NULL | Name of the zone (e.g., "Mokolo Market Area"). |
| `surfaceArea` | INT | | Area of the zone. |
| `perimeter` | INT | | Perimeter of the zone. |

**Table: `geofence_points`**
Stores the coordinates that define the vertices of geofence zones or points on a route.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the point. |
| `latitude` | FLOAT | NOT NULL | Latitude coordinate. |
| `longitude` | FLOAT | NOT NULL | Longitude coordinate. |

**Table: `geofence_zone_vertices` (Pivot Table)**
Associates points with a zone to form a polygon.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `zoneId` | UUID | FOREIGN KEY, PK | References the zone (`geofence_zones`). |
| `pointId` | UUID | FOREIGN KEY, PK | References the point (`geofence_points`). |
| `vertexOrder` | INT | NOT NULL | The order of the point in the polygon sequence. |

**Table: `routes`**
Defines a route with a start and end point.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the route. |
| `startPointId` | UUID | FOREIGN KEY | The starting point (`geofence_points`). |
| `endPointId` | UUID | FOREIGN KEY | The ending point (`geofence_points`). |

**Table: `trip_routes` (Pivot Table)**
Junction table for the N-N relationship between `trips` and `routes`.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `tripId` | UUID | FOREIGN KEY, PK | References the trip (`trips`). |
| `routeId` | UUID | FOREIGN KEY, PK | References the route (`routes`). |

**Table: `geofence_events`**
Logs every time a vehicle enters or exits a zone.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the event. |
| `zoneId` | UUID | FOREIGN KEY, NOT NULL | The zone involved (`geofence_zones`). |
| `vehicleId` | UUID | FOREIGN KEY, NOT NULL | The vehicle involved (`vehicles`). |
| `timestamp` | DATETIME | NOT NULL | The exact time of the event. |
| `type` | EVENT_TYPE (Enum) | NOT NULL | Type of event (ENTRY or EXIT). |

---


## 2. Data Representation

### 2.1. Fleet Model
Represents a collection of vehicles managed by a Fleet Manager.

```json
{
  "id": "f1a2b3c4-fleet-0001-d5e6f7g8h9i0",
  "name": "YaoundÃ© Express Voyage",
  "creationDate": "2025-01-15",
  "manager": {
    "userId": "7b2e3f4a-1c9d-4b8a-8e6f-2d3c4b5a6d7e",
    "name": "Gabriel Nomo"
  },
  "vehicleCount": 15
}
```

### 2.2. Vehicle Model (Detailed)
Represents a single vehicle with all its associated parameters.

```json
{
  "id": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
  "fleetId": "f1a2b3c4-fleet-0001-d5e6f7g8h9i0",
  "licensePlate": "CE 123 AB",
  "brand": "Toyota",
  "model": "Yaris",
  "manufacturingYear": 2022,
  "type": "CAR",
  "color": "White",
  "assignedDriver": {
    "userId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
    "name": "Aissatou Bello"
  },
  "financialParameters": {
    "insuranceNumber": "INS-YDE-2025-8843",
    "insuranceExpiryDate": "2026-06-30",
    "registrationDate": "2022-07-15",
    "purchaseDate": "2022-07-01",
    "depreciationRate": 15,
    "costPerKm": 125.5
  },
  "maintenanceParameters": {
    "lastMaintenanceDate": "2025-09-10",
    "nextMaintenanceDue": "2026-03-10",
    "engineStatus": "OK",
    "batteryHealth": 92,
    "maintenanceStatus": "UP_TO_DATE"
  },
  "operationalParameters": {
    "status": true,
    "currentSpeed": 45.5,
    "fuelLevel": "65%",
    "mileage": 45012.8,
    "odometerReading": 45012.8,
    "bearing": 182.5,
    "timestamp": "2025-10-30T14:22:10.000Z",
    "currentLocation": {
      "latitude": 3.8667,
      "longitude": 11.5167
    }
  }
}
```

### 2.3. Driver Model
Represents the fleet-specific information of a driver.

```json
{
  "userId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
  "licenceNumber": "YDE/DR/2018/98765",
  "status": true,
  "assignedVehicle": {
    "vehicleId": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
    "licensePlate": "CE 123 AB"
  },
  "userProfile": {
    "name": "Aissatou Bello",
    "phone": "+237699112233"
  }
}
```

### 2.4. Trip Model

```json
{
  "id": "t1r2i3p4-a5b6-4c7d-8e9f-a0b1c2d3e4f5",
  "vehicleId": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
  "driverId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
  "startDate": "2025-10-30",
  "startTime": "08:15:00",
  "endDate": "2025-10-30",
  "endTime": "09:05:00",
  "routes": [
    {
      "routeId": "r1o2u3t4e-001",
      "startPoint": { "latitude": 3.8721, "longitude": 11.5173 },
      "endPoint": { "latitude": 3.8472, "longitude": 11.5015 }
    }
  ]
}
```

### 2.5. Geofence Zone Model

```json
{
  "id": "z1o2n3e4-a5b6-4c7d-8e9f-a0b1c2d3e4f5",
  "name": "Mokolo Market Area",
  "surfaceArea": 1.5,
  "perimeter": 5.2,
  "vertices": [
    { "latitude": 3.8750, "longitude": 11.5000, "order": 1 },
    { "latitude": 3.8790, "longitude": 11.5050, "order": 2 },
    { "latitude": 3.8760, "longitude": 11.5080, "order": 3 },
    { "latitude": 3.8710, "longitude": 11.5030, "order": 4 }
  ]
}
```
---

## 3. General API Rules

-   **Base URL**: `/api/v1`
-   **Data Format**: `application/json`
-   **Authentication**: Header `Authorization: Bearer <JWT_TOKEN>`
-   **Error Handling**:
    ```json
    {
      "timestamp": "2025-10-30T10:30:00.000Z",
      "status": 404,
      "error": "Not Found",
      "message": "Vehicle with ID 'v-invalid-id' not found.",
      "path": "/api/v1/vehicles/v-invalid-id"
    }
    ```
---

## 4. Fleet Management API Endpoints

### 4.1. Fleets (`/fleets`)

#### `POST /fleets`
-   **Description**: Creates a new fleet.
-   **Access**: Authenticated (`fleet:fleet:create`).
-   **Request (Body)**: `{"name": "Douala City Transports", "managerUserId": "a9b8c7d6..."}`
-   **Response (`201 Created`)**: The newly created Fleet object.

#### `GET /fleets`
-   **Description**: Retrieves a list of fleets. For a Fleet Manager, returns only their fleets. For an Admin, returns all fleets.
-   **Access**: Authenticated (`fleet:fleet:read`).
-   **Response (`200 OK`)**: An array of Fleet objects.

#### `GET /fleets/{fleetId}`
-   **Description**: Retrieves detailed information for a specific fleet.
-   **Access**: Authenticated (`fleet:fleet:read`).
-   **Response (`200 OK`)**: A single detailed Fleet object.

#### `PUT /fleets/{fleetId}`
-   **Description**: Updates the details of an existing fleet.
-   **Access**: Authenticated (`fleet:fleet:update`).
-   **Request (Body)**: `{"name": "Douala Premium Transports", "managerUserId": "a9b8c7d6..."}`
-   **Response (`200 OK`)**: The updated Fleet object.

#### `DELETE /fleets/{fleetId}`
-   **Description**: Deletes a fleet. Business logic should prevent deletion if the fleet still contains vehicles.
-   **Access**: Authenticated (`fleet:fleet:delete`).
-   **Response (`204 No Content`)**.

### 4.2. Vehicles (`/vehicles`)

#### `POST /fleets/{fleetId}/vehicles`
-   **Description**: Adds a new vehicle to a specified fleet.
-   **Access**: Authenticated (`fleet:vehicle:create`).
-   **Request (Body)**: `{ "licensePlate": "CE 789 EF", "brand": "Toyota", "model": "RAV4", ... }`
-   **Response (`201 Created`)**: The full detailed Vehicle Model.

#### `GET /vehicles`
-   **Description**: Retrieves a paginated list of all vehicles accessible to the user.
-   **Access**: Authenticated (`fleet:vehicle:read`).
-   **Query Parameters**: `?fleetId={id}&type=CAR&status=true`
-   **Response (`200 OK`)**: An array of Vehicle objects.

#### `GET /vehicles/{vehicleId}`
-   **Description**: Retrieves the complete details of a single vehicle.
-   **Access**: Authenticated (`fleet:vehicle:read`).
-   **Response (`200 OK`)**: The full Vehicle Model JSON.

#### `PUT /vehicles/{vehicleId}`
-   **Description**: Updates the core details of a vehicle (brand, model, color, etc.).
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "model": "Corolla", "color": "Blue", "manufacturingYear": 2021 }`
-   **Response (`200 OK`)**: The updated full Vehicle Model.

#### `DELETE /vehicles/{vehicleId}`
-   **Description**: Deletes a vehicle from the system.
-   **Access**: Authenticated (`fleet:vehicle:delete`).
-   **Response (`204 No Content`)**.

#### `PUT /vehicles/{vehicleId}/financial-parameters`
-   **Description**: Updates the financial parameters for a specific vehicle.
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "insuranceNumber": "INS-NEW-2025-1111", "costPerKm": 130.0 }`
-   **Response (`200 OK`)**: The updated Financial Parameters object.

#### `PUT /vehicles/{vehicleId}/maintenance-parameters`
-   **Description**: Updates the maintenance parameters for a specific vehicle.
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "lastMaintenanceDate": "2025-10-28", "engineStatus": "NEEDS_SERVICE" }`
-   **Response (`200 OK`)**: The updated Maintenance Parameters object.

### 4.3. Drivers (`/drivers`)

#### `POST /drivers`
-   **Description**: Registers an existing system user as a driver.
-   **Access**: Authenticated (`fleet:driver:create`).
-   **Request (Body)**: `{ "userId": "u1s2e3r4...", "licenceNumber": "LT/DR/2020/11223" }`
-   **Response (`201 Created`)**: The full Driver Model.

#### `GET /drivers`
-   **Description**: Retrieves a list of all drivers.
-   **Access**: Authenticated (`fleet:driver:read`).
-   **Query Parameters**: `?status=true`
-   **Response (`200 OK`)**: An array of Driver objects.

#### `GET /drivers/{driverUserId}`
-   **Description**: Retrieves the profile for a specific driver.
-   **Access**: Authenticated (`fleet:driver:read`).
-   **Response (`200 OK`)**: A single Driver Model object.

#### `PUT /drivers/{driverUserId}`
-   **Description**: Updates a driver's fleet-specific information.
-   **Access**: Authenticated (`fleet:driver:update`).
-   **Request (Body)**: `{ "licenceNumber": "YDE/DR/2022/55443", "status": false }`
-   **Response (`200 OK`)**: The updated Driver Model.

#### `DELETE /drivers/{driverUserId}`
-   **Description**: De-registers a user as a driver (does not delete the user account).
-   **Access**: Authenticated (`fleet:driver:delete`).
-   **Response (`204 No Content`)**.

#### `POST /drivers/{driverUserId}/assign-vehicle`
-   **Description**: Assigns a vehicle to a driver.
-   **Access**: Authenticated (`fleet:driver:assign`).
-   **Request (Body)**: `{ "vehicleId": "v1e2h3c4..." }`
-   **Response (`200 OK`)**: `{ "message": "Vehicle assigned successfully." }`

#### `POST /drivers/{driverUserId}/unassign-vehicle`
-   **Description**: Unassigns the current vehicle from a driver.
-   **Access**: Authenticated (`fleet:driver:assign`).
-   **Response (`200 OK`)**: `{ "message": "Vehicle unassigned successfully." }`

### 4.4. Trips (`/trips`)

#### `POST /trips`
-   **Description**: Starts a new trip for a vehicle.
-   **Access**: Authenticated (`fleet:trip:create`).
-   **Request (Body)**: `{ "vehicleId": "v1e2h3c4...", "driverId": "d1r2i3v4...", "startDate": "2025-10-31", "startTime": "09:00:00" }`
-   **Response (`201 Created`)**: The new Trip object.

#### `GET /trips`
-   **Description**: Retrieves a list of trips, with filtering options.
-   **Access**: Authenticated (`fleet:trip:read`).
-   **Query Parameters**: `?vehicleId={id}&driverId={id}&startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`
-   **Response (`200 OK`)**: An array of Trip objects.

#### `GET /trips/{tripId}`
-   **Description**: Retrieves the details of a single trip.
-   **Access**: Authenticated (`fleet:trip:read`).
-   **Response (`200 OK`)**: A single Trip Model object.

#### `POST /trips/{tripId}/end`
-   **Description**: Ends an active trip.
-   **Access**: Authenticated (`fleet:trip:update`).
-   **Request (Body)**: `{ "endDate": "2025-10-31", "endTime": "11:30:00" }`
-   **Response (`200 OK`)**: The updated Trip object.

### 4.5. Geofencing (`/geofence`)

#### `POST /geofence/zones`
-   **Description**: Creates a new geofence zone.
-   **Access**: Authenticated (`fleet:geofence:create`).
-   **Request (Body)**: `{ "name": "Bastos Residential Area", "vertices": [...] }`
-   **Response (`201 Created`)**: The full Geofence Zone Model.

#### `GET /geofence/zones`
-   **Description**: Retrieves a list of all defined geofence zones.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Response (`200 OK`)**: An array of Geofence Zone objects.

#### `GET /geofence/zones/{zoneId}`
-   **Description**: Retrieves the details of a single geofence zone.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Response (`200 OK`)**: A single Geofence Zone Model object.

#### `PUT /geofence/zones/{zoneId}`
-   **Description**: Updates a geofence zone's name or vertices.
-   **Access**: Authenticated (`fleet:geofence:update`).
-   **Request (Body)**: `{ "name": "Bastos VIP Area", "vertices": [...] }`
-   **Response (`200 OK`)**: The updated Geofence Zone Model.

#### `DELETE /geofence/zones/{zoneId}`
-   **Description**: Deletes a geofence zone.
-   **Access**: Authenticated (`fleet:geofence:delete`).
-   **Response (`204 No Content`)**.

#### `GET /geofence/events`
-   **Description**: Retrieves a log of geofence events, with optional filters.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Query Parameters**: `?vehicleId={id}&zoneId={id}&type=ENTRY&startDate=YYYY-MM-DD`
-   **Response (`200 OK`)**: An array of geofence event objects.

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\docs\database_setup.md
`$ext
# ðŸ—„ï¸ Database Setup Guide (Local Development)

This guide explains how to set up and initialize the Fleet Management database on your local machine. This process is fully automated for both **Linux** and **Windows**.

## ðŸ“‹ Prerequisites

Ensure you have the following installed:
- **Docker** & **Docker Compose**
  - *Linux*: `sudo apt install docker-compose`
  - *Windows*: Install [Docker Desktop](https://www.docker.com/products/docker-desktop/)

## ðŸš€ Step 1: Start the Database Container

Open a terminal at the root of the project and run:

```bash
# Start the PostgreSQL 16 container in the background
docker-compose up -d
```

*Note: This will automatically pull the official Postgres 16 image and create a database named `yowyob_db`.*

## âš™ï¸ Step 2: Configure the Application

The application is configured to use a **Hybrid Mode** (Local DB + Remote Kafka/Redis).

1. Open `src/main/resources/application.yml`.
2. Ensure the active profile is set to `local`:
   ```yaml
   spring:
     profiles:
       active: local
   ```
3. (Optional) In the `LOCAL CONFIGURATION` block, verify that the credentials match those in `docker-compose.yml` (default: `fleet_admin` / `fleet_password`).

## ðŸ› ï¸ Step 3: Run and Auto-Initialize

Simply start the application. The system will detect the local environment and automatically:
1. Create all tables and ENUM types (from `resources/local/schema.sql`).
2. Inject 100 test users and sample data (from `resources/local/data.sql`).

**Run Command:**
```bash
# Linux / macOS
./mvnw clean spring-boot:run

# Windows (CMD / PowerShell)
mvnw.cmd clean spring-boot:run
```

## âœ… Step 4: Verify the Setup

Once the log shows `ðŸš€ LOCAL DATABASE READY!`, open your browser:

- **Swagger UI**: [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **Check Data**: Find the `health-check-controller` and execute `/api/v1/health/users-count`. You should see `users_in_db: 100`.

## âŒ Troubleshooting

- **Port 5432 already in use**: If you have a local PostgreSQL installed outside of Docker, stop it or change the port mapping in `docker-compose.yml`.
- **DNS/Pull Issues**: If Docker fails to pull the image, try:
  ```bash
  docker pull postgres:16
  ```

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\docs\remarks_of_conception.md
`$ext
# Remarques cahier d'analyse et conception

# Objectif
L'objectif de ce document est de fournir des remarques pour le cahier d'analyse et conception du projet Fleet management et geofence s'integrant dans le projet synthese de 5Gi: Trans Ens

# Liste des remarques

Chaque remarque sera constitue d'un page du titre de la remarque et de la description

---
## R1: raphael au feminin 

**page**: 2

**descripion**:  
Bihai rapahel
rapahel est ecrit au feminin,est-ce normal?

---
## R2: utilisation de FareCalculator

**page** : 14

**description** : Notre systeme utilisera t'il reellement farecalculator ? si oui dans quel cas d'utilisation ?

---

## R3: Absence de Navigoo dans le diagarmme de contexte

**page** : 14

**description** : Notre systeme utilisera certainement l'api des cartes pour montrer au client,chauffeur,fleet amanager mais notre diagaramme de contexte de le met pas en evidence

---

## R4: fautre d'orthographe

**page** : 14

**description** : les acteurs (qui utilise le systÃ¨me),le verbe utiliser doit etre a la 3e personne du pluriel(`avec ent`)

---

## R5: Probleme de coherence entre les diagrammes de cas d'utilisation et de contexte

**page** : 14 et 15

**description** : sur le diagramme de contexte,on voit bien que farecalculator fait partie des acteurs externes et le customer aussi mais dans le diagramme de cas d'utilisation,on ne les retrpiuve pas. De plus,on retrouve navigoo qui n'etait pas dans le diagramme de contexte. 

---

## R6: diagramme de use case,coherence dans le regroupement des use case

**page** : 15

**description** : 
Je remarque la factorisation qui est regroupage elegant des cas d'utilisation dans ce diagramme par l'heritage,ce qui est une bnne chose mais pour l'acteur fleet manager,je trouve que ce n'est pas suffisemment regroupe pour le management des vehicule(je parle de track vehicule,view vehicule statictics qui selpon moi sont des sous-cas de manage vehicule)

---
## R7: diagramme de sequence systeme
**page** : 29

**description** : 
- la methode valider identifiant que le systeme envoir a l'api d'auth doit etre une fonction ayant pour parametre les identifiants(email,mot de passe)

- Il y'a egalement un probleme de coherence linguistique,depuis le debut tous les diagrammes sont en anglais,mais celui ci est en francais.il nous faut une seule langue.

- est ce que le token est un message ou une variable? je crois aussi qu'ici c'est une fontion que l'api d'auth utilise pour envoyer le token et le role...aussi le role 
---

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\docs\data\YOWYOB_DB\README.md
`$ext
# Yowyob Database - Instructions

Ce dossier contient les scripts SQL nÃ©cessaires pour initialiser, peupler et tester la base de donnÃ©es PostgreSQL du projet Yowyob. Le projet a Ã©tÃ© principalement testÃ© en local.

## [Contenu des fichiers]

1. **`yowyob_db_init.sql`** : 
   - CrÃ©e le schÃ©ma (tables, types ENUM, triggers).
   - **Note :** Ce script commence par un `DROP SCHEMA public CASCADE`. Il effacera toutes les donnÃ©es existantes.

2. **`yowyob_db_seed.sql`** : 
   - Remplit la base avec des **donnÃ©es factices (Fake Data)** pour le dÃ©veloppement.

3. **`yowyob_db_test.sql`** : 
   - Contient des requÃªtes de lecture pour vÃ©rifier la cohÃ©rence des relations et des donnÃ©es sur **certaines relations** de la base de donnÃ©es. *Chaque jeu de test doit renvoyer **au moins une ligne de donnÃ©es.***

## [Guide d'installation]

### PrÃ©-requis
- PostgreSQL 16 ou supÃ©rieur.
- Un utilisateur PostgreSQL ayant les droits de crÃ©ation de tables.

### Ã‰tape 1 : CrÃ©ation de la base (si elle n'existe pas)
```bash
createdb -U <user> yowyob_db
```

### Ã‰tape 2 : Initialisation de la structure
```bash
psql -U <user> -d yowyob_db -f yowyob_db_init.sql
```

### Ã‰tape 3 : Peuplement des donnÃ©es (DEV / STAGING UNIQUEMENT)
```bash
psql -U <user> -d yowyob_db -f yowyob_db_seed.sql
```

### Ã‰tape 4 : VÃ©rification
```bash
psql -U <user> -d yowyob_db -f yowyob_db_test.sql
```

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\docs\data\YOWYOB_DB\yowyob_db_init.sql
`$ext
-- =====================================================
-- YOWYOB DB - INIT SCRIPT
-- PostgreSQL
-- Structure: Core -> Organization -> RBAC
-- =====================================================

-- Start a transaction for safety
BEGIN;

-- Fresh start
DROP SCHEMA IF EXISTS public CASCADE;
CREATE SCHEMA public;

-- Publish query paths
SET search_path TO public;

-- Extension for UUID generation
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =====================================================
-- ENUM TYPES
-- =====================================================

CREATE TYPE status_enum AS ENUM (
  'DRAFT', 'WAITING_CONFIRMATION', 'PUBLISHED', 'IN_PROGRESS', 'CANCELLED', 'EXPIRED'
);

CREATE TYPE category_enum AS ENUM (
  'ANNOUNCE', 'PLANNING', 'VEHICLE', 'ADDRESS', 'EXPERIENCE'
);

CREATE TYPE action_enum AS ENUM (
  'CREATE', 'UPDATE', 'READ', 'DELETE'
);

CREATE TYPE vehicle_type_enum AS ENUM (
  'CAR', 'VAN', 'TRUCK', 'BIKE'
);

CREATE TYPE offer_state_enum AS ENUM (
  'NEW', 'PENDING', 'CHOSEN', 'TERMINATED', 'CANCELED'
);

CREATE TYPE ride_state_enum AS ENUM (
  'CONFIRMED', 'ONGOING', 'COMPLETED', 'CANCELED'
);

CREATE TYPE event_type_enum AS ENUM (
  'ENTRY', 'EXIT'
);

CREATE TYPE maintenance_status_enum AS ENUM (
  'UP_TO_DATE', 'PENDING', 'OVERDUE'
);

CREATE TYPE engine_status_enum AS ENUM (
  'OK', 'NEED_SERVICE', 'OUT_OF_SERVICE'
);

CREATE TYPE role_type_enum AS ENUM (
  'CUSTOMER', 'DRIVER', 'FLEET_MANAGER', 'ADMIN', 'PASSENGER', 'PRESIDENT', 'MODERATOR', 'CLIENT'
);

CREATE TYPE type_enum AS ENUM (
  'NOTIFICATION', 'CHAT', 'PAYMENT', 'MEDIA'
);

CREATE TYPE reaction_type_enum AS ENUM (
  'LIKE', 'LOVE', 'HAHA', 'WOW', 'SAD', 'ANGRY'
);

-- =====================================================
-- CORE TABLES
-- =====================================================

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  phone_number TEXT,
  email_address TEXT UNIQUE
);

CREATE TABLE images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url TEXT NOT NULL,
  alt_text TEXT,
  uploaded_at TIMESTAMP DEFAULT now()
);

CREATE TABLE countries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE business_actors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT,
  phone_number TEXT,
  email_address TEXT,
  CONSTRAINT fk_business_actor_user
    FOREIGN KEY (id) REFERENCES users(id)
    ON DELETE CASCADE
);

-- =====================================================
-- ORGANIZATION TABLES
-- =====================================================

CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_actor_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  email TEXT,
  short_name TEXT,
  long_name TEXT,
  description TEXT,
  logo_uri TEXT,
  website_url TEXT,
  social_network TEXT,
  business_registration_number TEXT,
  tax_number TEXT,
  capital_share NUMERIC,
  ceo_name TEXT,
  year_founded INT,
  keywords TEXT,
  number_of_employees INT,
  legal_form TEXT,
  is_active BOOLEAN DEFAULT true,
  status status_enum DEFAULT 'DRAFT',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, -- Must belong to an org

  owner_id UUID REFERENCES business_actors(id),
  manager_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  name TEXT,
  location TEXT,
  description TEXT,
  transferable BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  logo_uri TEXT,
  short_name TEXT,
  long_name TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  is_headquarter BOOLEAN DEFAULT false,
  country TEXT,
  city TEXT,
  latitude NUMERIC,
  longitude NUMERIC,
  open_time TIME,
  close_time TIME,
  phone TEXT,
  email TEXT,
  whatsapp TEXT,
  greeting_message TEXT,
  average_revenue NUMERIC,
  capital_share NUMERIC,
  registration_number TEXT,
  social_network TEXT,
  tax_number TEXT,
  keywords TEXT,
  is_public BOOLEAN DEFAULT false,
  is_business BOOLEAN DEFAULT true,
  total_affiliated_customers INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE business_domains (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL, -- optional link to organization
  parent_id UUID REFERENCES business_domains(id) ON DELETE SET NULL,   -- self-referential for hierarchy
  image_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  name TEXT,
  image_uri TEXT,
  type TEXT,
  type_label TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE organization_business_domains (
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  business_domain_id UUID REFERENCES business_domains(id) ON DELETE CASCADE,
  PRIMARY KEY (organization_id, business_domain_id)
);

CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  contactable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  contactable_type TEXT,
  first_name TEXT,
  last_name TEXT,
  title TEXT,
  is_email_verified BOOLEAN DEFAULT false,
  is_phone_number_verified BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  phone_number TEXT,
  secondary_phone_number TEXT,
  fax_number TEXT,
  email TEXT,
  secondary_email TEXT,
  email_verified_at TIMESTAMP,
  phone_verified_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE certifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  description TEXT,
  obtainment_date DATE,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE third_parties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  logo_id UUID REFERENCES images(id),

  code TEXT,
  type TEXT,
  legal_form TEXT,
  unique_identification_number TEXT,
  trade_registration_number TEXT,
  name TEXT,
  acronym TEXT,
  long_name TEXT,
  logo_uri TEXT,
  accounting_account_numbers TEXT,
  authorized_payment_methods TEXT,
  authorized_credit_limit NUMERIC,
  max_discount_rate NUMERIC,
  vat_subject BOOLEAN,
  operations_balance NUMERIC,
  opening_balance NUMERIC,
  pay_term_number INT,
  pay_term_type TEXT,
  third_party_family TEXT,
  classification TEXT,
  tax_number TEXT,
  loyalty_points NUMERIC,
  loyalty_points_used NUMERIC,
  loyalty_points_expired NUMERIC,
  enabled BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE settings (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  theme TEXT,
  language TEXT,
  long_ride_enabled BOOLEAN DEFAULT false,
  short_ride_enabled BOOLEAN DEFAULT false,
  privacy_enable BOOLEAN DEFAULT true,
  allow_calls BOOLEAN DEFAULT true,
  allow_messages BOOLEAN DEFAULT true,
  notify_new_rides BOOLEAN DEFAULT true,
  notify_ratings BOOLEAN DEFAULT true,
  notify_practical_tips BOOLEAN DEFAULT true,
  notify_promotions BOOLEAN DEFAULT true,
  notify_policy_updates BOOLEAN DEFAULT true,
  notify_peak_hour_recommendations BOOLEAN DEFAULT true,
  receive_email BOOLEAN DEFAULT true,
  receive_sms BOOLEAN DEFAULT true,
  receive_push_notifications BOOLEAN DEFAULT true,
  receive_whatsapp BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE proposed_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  rate NUMERIC,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE addresses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  addressable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  country_id UUID REFERENCES countries(id) ON DELETE SET NULL,

  addressable_type TEXT,
  type TEXT,
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  state TEXT,
  locality TEXT,
  zip_code TEXT,
  postal_code TEXT,
  po_box TEXT,
  is_default BOOLEAN DEFAULT false,
  neighbor_hood TEXT,
  informal_description TEXT,
  latitude NUMERIC,
  longitude NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

-- =====================================================
-- USERS EXTENDED
-- =====================================================

CREATE TABLE providers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  contact_info TEXT,
  address TEXT,
  is_active BOOLEAN DEFAULT true,
  product_service_type TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE employees (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  is_manager BOOLEAN DEFAULT false,
  role TEXT,
  department TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE prospects (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,
  interest_level TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE sales_persons (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  commission_rate NUMERIC,
  credit NUMERIC,
  current_balance NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE customers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

-- =====================================================
-- RIDE & FLEET MANAGEMENT
-- =====================================================

CREATE TABLE drivers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  status TEXT,
  license_number TEXT,
  has_car BOOLEAN DEFAULT false
);

CREATE TABLE offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  passenger_id UUID REFERENCES customers(id) ON DELETE CASCADE,

  start_point TEXT,
  end_point TEXT,
  price NUMERIC,
  state offer_state_enum DEFAULT 'NEW',
  ids_interested_drivers TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE rides (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  offer_id UUID REFERENCES offers(id) ON DELETE SET NULL,
  passenger_id UUID REFERENCES users(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  distance NUMERIC,
  time_estimation NUMERIC,
  real_time NUMERIC,
  state ride_state_enum DEFAULT 'CONFIRMED',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet_managers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE fleets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fleet_manager_id UUID REFERENCES fleet_managers(id) ON DELETE SET NULL,

  name TEXT,
  phone_number TEXT,
  email_address TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE geofence_zones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  surface_area NUMERIC,
  perimeter NUMERIC
);

CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  fleet_id UUID REFERENCES fleets(id) ON DELETE SET NULL,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,

  license_plate TEXT,
  model TEXT,
  brand TEXT,
  manufacturing_year INT,
  type vehicle_type_enum,
  color TEXT
);

CREATE TABLE roads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  start_point TEXT,
  end_point TEXT
);

CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  road_id UUID REFERENCES roads(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  start_date DATE,
  end_date DATE,
  start_time TIME,
  end_time TIME,
  type TEXT,
  color TEXT
);

CREATE TABLE operational_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  statut TEXT,
  current_location TEXT,
  current_speed NUMERIC,
  fuel_level NUMERIC,
  mileage NUMERIC,
  odometer_reading NUMERIC,
  bearing NUMERIC,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE financial_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  insurance_number TEXT,
  insurance_expired_at DATE,
  registered_at DATE,
  purchased_at DATE,
  depreciation_rate NUMERIC,
  cost_per_km NUMERIC
);

CREATE TABLE maintenance_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  last_maintenance_at DATE,
  next_maintenance_at DATE,
  engine_status engine_status_enum DEFAULT 'OK',
  battery_health TEXT,
  maintenance_status maintenance_status_enum DEFAULT 'UP_TO_DATE'
);

CREATE TABLE geofence_points (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  latitude NUMERIC,
  longitude NUMERIC
);

CREATE TABLE geofence_point_zone_linkages (
  point_id UUID REFERENCES geofence_points(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE CASCADE,
  PRIMARY KEY (point_id, zone_id)
);

CREATE TABLE geofence_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,
  point_id UUID REFERENCES geofence_points(id) ON DELETE SET NULL,

  type event_type_enum,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE offer_driver_linkages (
  offer_id UUID REFERENCES offers(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE CASCADE,
  PRIMARY KEY (offer_id, driver_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- OTHERS: PRODUCTS, SYNDICATS, PUBLICATIONS & REVIEWS
-- =====================================================

CREATE TABLE syndicats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  is_approved BOOLEAN DEFAULT false,
  name TEXT,
  description TEXT,
  domain TEXT,
  type TEXT,
  charte_url TEXT,
  status_url TEXT,
  members_list_url TEXT,
  commitment_certificate_url TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE abstract_products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  abstract_product_id UUID REFERENCES abstract_products(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  standard_price NUMERIC,
  departure_location TEXT,
  arrival_location TEXT,
  start_date DATE,
  start_time TIME,
  end_date DATE,
  end_time TIME,
  baggage_info TEXT,
  is_negotiable BOOLEAN DEFAULT false,
  payment_method TEXT,
  title TEXT,
  status status_enum DEFAULT 'DRAFT',
  product_urls TEXT,
  regular_amount NUMERIC,
  discount_percentage NUMERIC,
  discounted_amount NUMERIC,
  metadata JSONB,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  title TEXT,
  description TEXT,
  closing_at TIMESTAMP,
  type category_enum
);

CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  publication_vote_id UUID REFERENCES publication_votes(id) ON DELETE CASCADE,

  label TEXT
);

CREATE TABLE avis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  comment TEXT,
  number INT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE branches (
  id UUID PRIMARY KEY REFERENCES agencies(id),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  location TEXT,
  contact TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  content TEXT,
  status status_enum DEFAULT 'DRAFT',
  n_likes INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_images (
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (publication_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,

  title TEXT,
  description TEXT,
  location TEXT,
  date DATE,
  start_time TIME,
  end_time TIME,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE event_images (
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (event_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  type reaction_type_enum,

  reacted_at TIMESTAMP DEFAULT now()
);

CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES comments(id) ON DELETE SET NULL,
  image_id UUID REFERENCES images(id) ON DELETE SET NULL,

  content TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  first_name TEXT,
  last_name TEXT,
  nickname TEXT,
  profile_image_url TEXT,
  birth_date DATE,
  nationality TEXT,
  gender TEXT,
  language TEXT,
  company_name TEXT,
  biography TEXT,
  rating NUMERIC,
  total_trips INT,
  is_available BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- PAYMENTS & SUBSCRIPTIONS
-- =====================================================

CREATE TABLE admins (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  admin_id UUID REFERENCES admins(id) ON DELETE SET NULL,

  label TEXT,
  price NUMERIC,
  duration_in_days INT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,
  user_id UUID REFERENCES business_actors(id) ON DELETE SET NULL,

  amount_paid NUMERIC,
  status TEXT,
  id_provider_transaction TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ride_id UUID REFERENCES rides(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  subject TEXT,
  comment TEXT,
  rating NUMERIC,

  created_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- ROLE-BASED ACCESS CONTROL (RBAC)
-- =====================================================

CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE role_has_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE user_has_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Commit the transaction
COMMIT;

-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\docs\data\YOWYOB_DB\yowyob_db_seed.sql
`$ext
-- =====================================================
-- YOWYOB DB - DATA SEEDING SCRIPT
-- PostgreSQL
-- =====================================================

BEGIN;

-- =====================================================
-- 1. CLEANUP EXISTING DATA
-- =====================================================
TRUNCATE TABLE 
    users, images, countries, business_actors, 
    admins, fleet_managers, drivers, customers, 
    providers, employees, prospects, sales_persons,
    profiles, settings, addresses, contacts,
    roles, permissions, role_has_permissions, user_has_roles,
    organizations, agencies, business_domains, organization_business_domains,
    certifications, third_parties, proposed_activities, services, branches,
    fleets, vehicles, geofence_zones, geofence_points, geofence_events,
    roads, trips, offers, rides, reviews, offer_driver_linkages,
    operational_parameters, financial_parameters, maintenance_parameters,
    geofence_point_zone_linkages,
    syndicats, abstract_products, products, 
    publications, publication_images, publication_votes, votes,
    events, event_images, reactions, comments, avis,
    subscriptions, payments
    RESTART IDENTITY CASCADE;

-- =====================================================
-- 2. STATIC REFERENCE DATA
-- =====================================================

-- Countries
INSERT INTO countries (name, code) VALUES
('Cameroun', 'CM'), ('SÃ©nÃ©gal', 'SN'), ('CÃ´te d''Ivoire', 'CI'), 
('Gabon', 'GA'), ('NigÃ©ria', 'NG'), ('Togo', 'TG');

-- Roles
INSERT INTO roles (name, guard_name) VALUES
('ADMIN', 'web'), ('FLEET_MANAGER', 'web'), ('DRIVER', 'web'), ('CUSTOMER', 'web');

-- Images (Random placeholders from Picsum)
INSERT INTO images (url, alt_text) 
SELECT 
    'https://picsum.photos/seed/' || i || '/800/600', 
    'Image alÃ©atoire ' || i
FROM generate_series(1, 50) as i;

-- =====================================================
-- 3. USERS GENERATION (100 users)
-- =====================================================

INSERT INTO users (name, phone_number, email_address)
SELECT 
    (ARRAY['Mamadou', 'Jean-Pierre', 'Ibrahim', 'Fatou', 'Aminata', 'Ngolo', 'Aboubakar', 'Clarisse', 'Samuel', 'KouamÃ©', 'Aissatou', 'Bachelard', 'Landry', 'ThÃ©rÃ¨se'])[floor(random()*14)+1] 
    || ' ' || 
    (ARRAY['Diop', 'Njoya', 'Mbarga', 'Kone', 'Sow', 'Etoundi', 'Kamga', 'TraorÃ©', 'Diallo', 'Fofana', 'Mensah', 'Atangana', 'Eto''o', 'Drogba'])[floor(random()*14)+1],
    (ARRAY['+237', '+221', '+225'])[floor(random()*3)+1] || (600000000 + floor(random()*99999999)::int),
    'user_' || i || '@yowyob.test'
FROM generate_series(1, 100) as i;

-- Settings & Profiles
INSERT INTO settings (user_id, theme, language, receive_push_notifications)
SELECT id, 'LIGHT', 'fr', true FROM users;

INSERT INTO profiles (user_id, first_name, nationality, is_verified)
SELECT id, split_part(name, ' ', 1), 'Camerounais', (random() > 0.5) FROM users;

-- =====================================================
-- 4. ACTORS DISPATCHING
-- User -> BusinessActor -> SpecificActor
-- =====================================================

-- 4.1 Admins (First 5 users)
INSERT INTO admins (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5;

-- 4.2 Fleet Managers (Next 5 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- STEP 2: Insert into CHILD (FleetManager)
INSERT INTO fleet_managers (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- 4.3 Drivers (Next 30 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- STEP 2: Insert into CHILD (Driver)
INSERT INTO drivers (id, status, license_number, has_car)
SELECT 
    id, 
    (ARRAY['AVAILABLE', 'BUSY', 'OFFLINE'])[floor(random()*3)+1], 
    'LIC-' || floor(random()*100000) || '-CM',
    (random() > 0.3)
FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- 4.4 Customers (Remaining 60 users)
INSERT INTO customers (id, code, payment_method)
SELECT 
    id, 
    'CUST-' || substr(id::text, 1, 8),
    (ARRAY['CASH', 'MOBILE_MONEY', 'CARD'])[floor(random()*3)+1]
FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- Assign Roles
INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'ADMIN') FROM users ORDER BY email_address LIMIT 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'FLEET_MANAGER') FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'DRIVER') FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'CUSTOMER') FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- =====================================================
-- 5. ORGANIZATIONS & AGENCIES
-- =====================================================

INSERT INTO organizations (
    business_actor_id, logo_id, code, short_name, long_name, 
    description, tax_number, is_active, status
)
SELECT
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    (SELECT id FROM images ORDER BY random() LIMIT 1),
    'ORG-' || i,
    'Transport ' || i,
    'SociÃ©tÃ© de Transport ' || i,
    'Description ' || i,
    'TAX-' || floor(random()*1000000),
    true,
    'PUBLISHED'
FROM generate_series(1, 35) as i;

INSERT INTO agencies (
    organization_id, manager_id, name, city, location, is_headquarter
)
SELECT 
    id, 
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    'Agence Centrale',
    (ARRAY['Douala', 'YaoundÃ©', 'Abidjan'])[floor(random()*3)+1],
    'Rue Principale',
    true
FROM organizations;

-- =====================================================
-- 6. FLEETS & VEHICLES
-- =====================================================

INSERT INTO fleets (fleet_manager_id, name, phone_number)
SELECT 
    id, 'Flotte de ' || name, '+237699000000'
FROM fleet_managers;

-- Vehicles
INSERT INTO vehicles (
    fleet_id, user_id, driver_id, license_plate, brand, model, type, color, manufacturing_year
)
SELECT 
    f.id,
    f.fleet_manager_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    'LT-' || floor(random()*999)::text || '-AA',
    (ARRAY['Toyota', 'Peugeot'])[floor(random()*2)+1],
    (ARRAY['Yaris', 'Partner'])[floor(random()*2)+1],
    (ARRAY['CAR', 'VAN'])[floor(random()*2)+1]::vehicle_type_enum,
    'Jaune',
    2020
FROM fleets f;

-- =====================================================
-- 7. OFFERS & RIDES
-- =====================================================

INSERT INTO offers (
    passenger_id, start_point, end_point, price, state, created_at
)
SELECT 
    (SELECT id FROM customers ORDER BY random() LIMIT 1),
    'Point A', 'Point B', 
    2000, 
    'CHOSEN',
    NOW()
FROM generate_series(1, 60) as i;

-- Rides
INSERT INTO rides (
    offer_id, passenger_id, driver_id, 
    distance, time_estimation, real_time, state, created_at
)
SELECT 
    id, -- offer_id
    passenger_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    15.5, 30, 35,
    'COMPLETED',
    created_at
FROM offers 
LIMIT 40;

-- Reviews
INSERT INTO reviews (ride_id, author_id, subject, comment, rating)
SELECT 
    id,
    passenger_id,
    'Chauffeur',
    'Bonne course, chauffeur ponctuel',
    5
FROM rides
WHERE state = 'COMPLETED';

-- =====================================================
-- 8. PRODUCTS
-- =====================================================

INSERT INTO products (
    organization_id, name, description, standard_price, 
    status, is_active, departure_location
)
SELECT 
    (SELECT id FROM organizations ORDER BY random() LIMIT 1),
    'Trajet SpÃ©cial ' || i,
    'Description produit',
    5000,
    'PUBLISHED',
    true,
    'Douala'
FROM generate_series(1, 40) as i;

-- =====================================================
-- 9. SUBSCRIPTIONS & PAYMENTS
-- =====================================================

INSERT INTO subscriptions (
    admin_id, label, price, duration_in_days, description, is_active
) VALUES 
((SELECT id FROM admins LIMIT 1), 'Pack Hebdo', 2500, 7, 'Standard', true),
((SELECT id FROM admins LIMIT 1), 'Pack Mensuel', 10000, 30, 'Pro', true),
((SELECT id FROM admins LIMIT 1), 'Pack Annuel', 100000, 365, 'VIP', true);

INSERT INTO payments (
    driver_id, user_id, subscription_id, amount_paid, status, id_provider_transaction, created_at
)
SELECT 
    d.id, -- Driver ID
    d.id, -- Payer ID
    s.id, -- Subscription ID
    s.price,
    'SUCCESS',
    'TXN-' || floor(random()*10000000),
    NOW()
FROM drivers d
CROSS JOIN subscriptions s
ORDER BY random()
LIMIT 50;

-- =====================================================
-- 10. SOCIAL & ADDRESSES
-- =====================================================

INSERT INTO syndicats (organization_id, name, is_approved)
SELECT id, 'Syndicat Transports', true FROM organizations LIMIT 1;

INSERT INTO branches (id, syndicat_id, name, location)
SELECT 
    ag.id,
    (SELECT id FROM syndicats LIMIT 1),
    'Branche ' || ag.name, 
    ag.location 
FROM agencies ag 
LIMIT 10;

INSERT INTO publications (branch_id, author_id, content, status, n_likes)
SELECT 
    (SELECT id FROM branches ORDER BY random() LIMIT 1),
    (SELECT id FROM admins ORDER BY random() LIMIT 1),
    'Info Trafic ' || i,
    'PUBLISHED',
    floor(random() * 50)::int
FROM generate_series(1, 40) as i;

COMMIT;

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\docs\data\YOWYOB_DB\yowyob_db_test.sql
`$ext
-- =====================================================
-- YOWYOB DB - TEST QUERIES (SEMI-VALIDATION)
-- PostgreSQL
-- =====================================================

-- Summary Table to display what will be tested
SELECT * FROM (VALUES
    ('Test 1.1', 'Check Driver Inheritance (Name, Status, Car)'),
    ('Test 1.2', 'Check Customers Specific Data (Code, Payment)'),
    ('Test 2.1', 'User Role Assignments'),
    ('Test 3.1', 'Agency Locations & Headquarter Status'),
    ('Test 4.1', 'Vehicle Inventory (Fleet vs Independent)'),
    ('Test 5.1', 'Full Ride History (Passenger + Driver + Price)'),
    ('Test 5.2', 'Pending Offers (No Ride Created Yet)'),
    ('Test 6.1', 'Active Products by Organization'),
    ('Test 7.1', 'Publications Feed with Likes'),
    ('Test 7.2', 'Customer Reviews on Rides'),
    ('Test 8.1', 'Payment & Subscription Log')
) AS summary_table (Test_ID, Test_Description);

-- =====================================================
-- BLOCK 1: CORE & INHERITANCE VERIFICATION
-- =====================================================

-- 1.1. Check Driver Inheritance
SELECT 'Check Driver Inheritance (Name, Status, Car)' AS "TEST 1.1";
SELECT 
    u.id,
    u.name AS full_name,
    u.phone_number,
    d.status AS driver_status,
    d.license_number,
    d.has_car
FROM drivers d
JOIN business_actors ba ON d.id = ba.id
JOIN users u ON ba.id = u.id
LIMIT 5;

-- 1.2. Check Customers and Payment Methods
SELECT 'Check Customers Specific Data' AS "TEST 1.2";
SELECT 
    u.name AS customer_name,
    c.code AS customer_code,
    c.payment_method
FROM customers c
JOIN users u ON c.id = u.id
LIMIT 5;

-- =====================================================
-- BLOCK 2: RBAC (ROLES & SECURITY)
-- =====================================================

-- 2.1. Who has which role?
SELECT 'User Role Assignments' AS "TEST 2.1";
SELECT 
    u.name AS user_name,
    u.email_address,
    r.name AS assigned_role
FROM users u
JOIN user_has_roles uhr ON u.id = uhr.user_id
JOIN roles r ON uhr.role_id = r.id
ORDER BY u.name ASC
LIMIT 5;

-- =====================================================
-- BLOCK 3: ORGANIZATION & HIERARCHY
-- =====================================================

-- 3.1. Hierarchy Organization -> Agencies
SELECT 'Agency Locations & Headquarter Status' AS "TEST 3.1";
SELECT 
    org.short_name AS organization,
    a.name AS agency_name,
    a.city,
    a.is_headquarter
FROM agencies a
JOIN organizations org ON a.organization_id = org.id
ORDER BY org.short_name
LIMIT 5;

-- =====================================================
-- BLOCK 4: FLEET MANAGEMENT
-- =====================================================

-- 4.1. Vehicle Inventory
SELECT 'Vehicle Inventory (Fleet vs Independent)' AS "TEST 4.1";
SELECT 
    v.license_plate,
    v.brand || ' ' || v.model AS vehicle_model,
    v.type,
    f.name AS fleet_owner,
    u_owner.name AS independent_owner
FROM vehicles v
LEFT JOIN fleets f ON v.fleet_id = f.id
LEFT JOIN users u_owner ON v.user_id = u_owner.id
LIMIT 5;

-- =====================================================
-- BLOCK 5: RIDES & OFFERS (CORE BUSINESS)
-- =====================================================

-- 5.1. Full Ride Details
SELECT 'Full Ride History (Passenger + Driver + Price)' AS "TEST 5.1";
SELECT 
    r.id AS ride_id,
    r.state AS ride_state,
    passenger_u.name AS passenger,
    driver_u.name AS driver,
    o.start_point,
    o.end_point,
    o.price AS agreed_price,
    r.distance || ' km' AS real_distance
FROM rides r
JOIN offers o ON r.offer_id = o.id
JOIN customers c ON r.passenger_id = c.id
JOIN users passenger_u ON c.id = passenger_u.id
JOIN drivers d ON r.driver_id = d.id
JOIN users driver_u ON d.id = driver_u.id
WHERE r.state = 'COMPLETED'
LIMIT 5;

-- 5.2. Offers without Drivers
SELECT 'Pending Offers (No Ride Created Yet)' AS "TEST 5.2";
SELECT 
    o.id,
    o.state,
    o.price,
    o.created_at
FROM offers o
LEFT JOIN rides r ON o.id = r.offer_id
WHERE r.id IS NULL
LIMIT 5;

-- =====================================================
-- BLOCK 6: PRODUCTS & SERVICES
-- =====================================================

-- 6.1. Product Catalog by Organization
SELECT 'Active Products by Organization' AS "TEST 6.1";
SELECT 
    org.short_name AS seller,
    p.name AS product_name,
    p.standard_price AS price,
    p.status
FROM products p
JOIN organizations org ON p.organization_id = org.id
WHERE p.is_active = true
LIMIT 5;

-- =====================================================
-- BLOCK 7: SOCIAL (PUBLICATIONS & REVIEWS)
-- =====================================================

-- 7.1. Branch News Feed
SELECT 'Publications Feed with Likes' AS "TEST 7.1";
SELECT 
    b.name AS source_branch,
    u.name AS author,
    pub.content AS message,
    pub.n_likes AS likes
FROM publications pub
JOIN branches b ON pub.branch_id = b.id
JOIN users u ON pub.author_id = u.id
ORDER BY pub.created_at DESC
LIMIT 5;

-- 7.2. Ride Reviews
SELECT 'Customer Reviews on Rides' AS "TEST 7.2";
SELECT 
    rev.rating,
    rev.comment,
    u.name AS author
FROM reviews rev
JOIN users u ON rev.author_id = u.id
LIMIT 5;

-- =====================================================
-- BLOCK 8: FINANCE (SUBSCRIPTIONS & PAYMENTS)
-- =====================================================

-- 8.1. Payment History
SELECT 'Payment & Subscription Log' AS "TEST 8.1";
SELECT 
    pay.id AS payment_id,
    u.name AS payer,
    sub.label AS subscription_plan,
    pay.amount_paid,
    pay.status,
    pay.created_at
FROM payments pay
JOIN users u ON pay.user_id = u.id
JOIN subscriptions sub ON pay.subscription_id = sub.id
ORDER BY pay.created_at DESC
LIMIT 5;

-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\docs\prompts\master_pair_programmer.md
`$ext
# ðŸ¤– Master Prompt : Senior Pair Programmer WebFlux

Tu es mon Senior Pair Programmer expert en Java **Spring Boot WebFlux (RÃ©actif)**.
Nous dÃ©veloppons l'API **Fleet Management et Geofencing** (Projet TraEnSys).

### ðŸ“‹ Ta MÃ©thode de Travail (IMPÃ‰RATIF)
Pour chaque tÃ¢che demandÃ©e, tu dois obligatoirement suivre ces Ã©tapes :

**Ã‰tape 1 : Conception fonctionnelle**
- Analyse du besoin, user stories et ajustement du modÃ¨le de donnÃ©es.
- **Attente de ma validation explicite avant d'aller plus loin.**

**Ã‰tape 2 : Explication du Concept RÃ©actif**
- Avant de coder, explique briÃ¨vement comment le flux rÃ©actif (`Mono`/`Flux`) sera gÃ©rÃ© pour cette tÃ¢che.

**Ã‰tape 3 : ImplÃ©mentation**
- Fournis le code complet par blocs Markdown copiables.
- Respecte l'architecture hexagonale du projet.

**Ã‰tape 4 : Tests & Validation**
- Instructions pour tester via Postman ou logs.

### ðŸš« Tes RÃ¨gles de Conduite
1. **ZÃ©ro code non sollicitÃ©** : Ne propose aucune solution technique avant l'Ã‰tape 3.
2. **Focus** : RÃ©ponds uniquement Ã  la question posÃ©e, de maniÃ¨re synthÃ©tique et prÃ©cise.
3. **Fichiers complets** : Sauf mention contraire, donne toujours le code complet du fichier pour Ã©viter les erreurs de copier-coller.
4. **PÃ©dagogie** : Si une opÃ©ration risque de bloquer un thread (ex: JDBC classique, thread sleep), arrÃªte-moi et propose l'alternative non-bloquante.

### ðŸ“‚ Contexte
Le code source complet est disponible dans le fichier `project_context.txt`.
La roadmap est suivie dans `todo.md`.

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\FleetManagementApplication.java
`$ext
package com.yowyob.fleet;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class FleetManagementApplication {

	public static void main(String[] args) {
		SpringApplication.run(FleetManagementApplication.class, args);
	}

}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\application\service\AuthService.java
`$ext
package com.yowyob.fleet.application.service;

import com.yowyob.fleet.domain.ports.in.AuthUseCase;
import com.yowyob.fleet.domain.ports.out.AuthPort;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

@Service
@RequiredArgsConstructor
public class AuthService implements AuthUseCase {

    private final AuthPort authPort;

    @Override
    public Mono<AuthPort.AuthResponse> login(String identifier, String password) {
        return authPort.login(identifier, password);
    }

    @Override
    public Mono<AuthPort.AuthResponse> register(String username, String email, String password, String phone, String firstName, String lastName) {
        return authPort.register(username, email, password, phone, firstName, lastName);
    }

    @Override
    public Mono<Void> resetPassword(String email) {
        return authPort.forgotPassword(email);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\application\service\ProductService.java
`$ext
package com.yowyob.fleet.application.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import com.yowyob.fleet.domain.exception.StockFullException;
import com.yowyob.fleet.domain.model.Product;
import com.yowyob.fleet.domain.ports.in.CreateProductUseCase;
import com.yowyob.fleet.domain.ports.out.ProductCachePort;
import com.yowyob.fleet.domain.ports.out.ProductEventPublisherPort;
import com.yowyob.fleet.domain.ports.out.ProductRepositoryPort;
import com.yowyob.fleet.domain.ports.out.StockClientPort;

import reactor.core.publisher.Mono;

// import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class ProductService implements CreateProductUseCase {

    private final ProductRepositoryPort repository;
    private final StockClientPort stockClient;
    private final ProductCachePort cache;
    private final ProductEventPublisherPort publisher;

    @Override
    public Mono<Product> createProduct(Product product) {
        return stockClient.isStockFull(product.name())
                .flatMap(isFull -> {
                    if (isFull) {
                        return Mono.error(new StockFullException("Stock is full for the product : " + product.name()));
                    }
                    return Mono.just(product);
                })
                .map(p -> new Product(null, p.name(), p.price(), "CREATED"))
                .flatMap(repository::save)
                .flatMap(savedProduct -> 
                    // We cache and publish asynchronously, then return the object
                    Mono.when(
                        cache.saveInCache(savedProduct),
                        publisher.publishProductCreated(savedProduct)
                    ).thenReturn(savedProduct)
                )
                .doOnSuccess(p -> log.info("Product successfully created : {}", p.id()));
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\domain\exception\StockFullException.java
`$ext
package com.yowyob.fleet.domain.exception;

public class StockFullException extends RuntimeException {
    public StockFullException(String message) {
        super(message);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\domain\model\Product.java
`$ext
package com.yowyob.fleet.domain.model;

import java.math.BigDecimal;
import java.util.UUID;

public record Product(UUID id, String name, BigDecimal price, String status) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\domain\ports\in\AuthUseCase.java
`$ext
package com.yowyob.fleet.domain.ports.in;

import com.yowyob.fleet.domain.ports.out.AuthPort;
import reactor.core.publisher.Mono;

public interface AuthUseCase {
    Mono<AuthPort.AuthResponse> login(String identifier, String password);
    Mono<Void> resetPassword(String email);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\domain\ports\in\CreateProductUseCase.java
`$ext
package com.yowyob.fleet.domain.ports.in;

import com.yowyob.fleet.domain.model.Product;

import reactor.core.publisher.Mono;

public interface CreateProductUseCase {
    Mono<Product> createProduct(Product product);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\domain\ports\out\AuthPort.java
`$ext
package com.yowyob.fleet.domain.ports.out;

import reactor.core.publisher.Mono;

import java.util.List;
import java.util.Map;

public interface AuthPort {
    Mono<AuthResponse> login(String email, String password);
    
    Mono<Void> forgotPassword(String email);

    Mono<AuthResponse> register(
        String username, 
        String email, 
        String password, 
        String phone, 
        String firstName, 
        String lastName);

    
    record AuthResponse(
        String accessToken, 
        String refreshToken, 
        String username, 
        List<String> roles,
        List<String> permissions
    ) {}
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\domain\ports\out\ProductCachePort.java
`$ext
package com.yowyob.fleet.domain.ports.out;

import com.yowyob.fleet.domain.model.Product;

import reactor.core.publisher.Mono;

public interface ProductCachePort {
    Mono<Boolean> saveInCache(Product product);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\domain\ports\out\ProductEventPublisherPort.java
`$ext
package com.yowyob.fleet.domain.ports.out;

import com.yowyob.fleet.domain.model.Product;

import reactor.core.publisher.Mono;

public interface ProductEventPublisherPort {
    Mono<Void> publishProductCreated(Product product);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\domain\ports\out\ProductRepositoryPort.java
`$ext
package com.yowyob.fleet.domain.ports.out;

import com.yowyob.fleet.domain.model.Product;

import reactor.core.publisher.Mono;

public interface ProductRepositoryPort {
    Mono<Product> save(Product product);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\domain\ports\out\StockClientPort.java
`$ext
package com.yowyob.fleet.domain.ports.out;

import reactor.core.publisher.Mono;

public interface StockClientPort {
    /**
     * Verify if te stock is full.
     * @return true full, false otherwise
     */
    Mono<Boolean> isStockFull(String productName);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\inbound\kafka\ProductEventConsumer.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.inbound.kafka;

import lombok.extern.slf4j.Slf4j;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import com.yowyob.fleet.domain.model.Product;

@Slf4j
@Component
public class ProductEventConsumer {

    @Value("${application.kafka.topics.product-events}")
    private String productEventsTopic;

    @KafkaListener(topics = "${application.kafka.topics.product-events}", groupId = "template-group")
    public void consume(Product product) {
        log.info("CONSUMER: I received an event for product with id : {} and price : {}", 
                 product.name(), product.price());
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\inbound\rest\AuthController.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import com.yowyob.fleet.domain.ports.in.AuthUseCase;
import com.yowyob.fleet.domain.ports.out.AuthPort;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;

@RestController
@RequestMapping("/api/v1/auth")
@RequiredArgsConstructor
@Tag(name = "Authentication", description = "Endpoints pour l'authentification via TraMaSys")
public class AuthController {

    private final AuthUseCase authUseCase;

    @PostMapping("/login")
    @Operation(summary = "Se connecter", description = "Accepte email, username ou tÃ©lÃ©phone")
    public Mono<AuthPort.AuthResponse> login(@RequestBody LoginRequest request) {
        return authUseCase.login(request.identifier(), request.password());
    }

    @PostMapping("/forgot-password")
    @Operation(summary = "Mot de passe oubliÃ©")
    public Mono<Void> forgotPassword(@RequestParam String email) {
        return authUseCase.resetPassword(email);
    }

    public record LoginRequest(String identifier, String password) {}
    @PostMapping("/register")
    @Operation(summary = "Inscription sur TraMaSys Auth")
    public Mono<AuthPort.AuthResponse> register(@RequestBody RegisterDto dto) {
        return authUseCase.register(
            dto.username(), dto.email(), dto.password(), 
            dto.phone(), dto.firstName(), dto.lastName()
        );
    }

    public record RegisterDto(
        String username, String email, String password, 
        String phone, String firstName, String lastName
    ) {}
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\inbound\rest\GlobalExceptionHandler.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import org.springframework.http.HttpStatus;
import org.springframework.http.ProblemDetail;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import com.yowyob.fleet.domain.exception.StockFullException;

import java.net.URI;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(StockFullException.class)
    public ProblemDetail handleStockException(StockFullException ex) {
        ProblemDetail problem = ProblemDetail.forStatusAndDetail(HttpStatus.CONFLICT, ex.getMessage());
        problem.setTitle("Stock Overflow");
        problem.setType(URI.create("errors/stock-full"));
        return problem;
    }

    // Ajoutez cette mÃ©thode Ã  votre classe existante
    @ExceptionHandler(org.springframework.web.reactive.function.client.WebClientResponseException.Unauthorized.class)
    public ProblemDetail handleUnauthorized(org.springframework.web.reactive.function.client.WebClientResponseException.Unauthorized ex) {
        ProblemDetail problem = ProblemDetail.forStatusAndDetail(HttpStatus.UNAUTHORIZED, "Identifiants TraMaSys invalides");
        problem.setTitle("Ã‰chec d'authentification");
        return problem;
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\inbound\rest\HealthCheckController.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import lombok.RequiredArgsConstructor;
import org.springframework.r2dbc.core.DatabaseClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import reactor.core.publisher.Mono;

import java.util.Map;

@RestController
@RequestMapping("/api/v1/health")
@RequiredArgsConstructor
public class HealthCheckController {

    private final DatabaseClient databaseClient;

    /**
     * Checks the number of users in the local database to validate seeding.
     */
    @GetMapping("/users-count")
    public Mono<Map<String, Object>> getUserCount() {
        return databaseClient.sql("SELECT COUNT(*) FROM users")
                .map((row, metadata) -> row.get(0, Long.class))
                .first()
                .map(count -> Map.of(
                        "status", "UP",
                        "database", "CONNECTED",
                        "users_in_db", count
                ));
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\inbound\rest\ProductController.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import com.yowyob.fleet.domain.ports.in.CreateProductUseCase;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.ProductRequest;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.ProductResponse;
import com.yowyob.fleet.infrastructure.mappers.ProductMapper;

import reactor.core.publisher.Mono;

@RestController
@RequestMapping("/api/v1/products")
@RequiredArgsConstructor
public class ProductController {

    private final CreateProductUseCase useCase;
    private final ProductMapper mapper;

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "CrÃ©er un produit", description = "VÃ©rifie le stock distant et sauvegarde le produit.")
    @ApiResponses(value = {
        @ApiResponse(responseCode = "201", description = "Produit crÃ©Ã© avec succÃ¨s"),
        @ApiResponse(responseCode = "400", description = "DonnÃ©es invalides")
    })
    public Mono<ProductResponse> create(@RequestBody @Valid Mono<ProductRequest> requestMono) {
        return requestMono
                .map(mapper::toDomain)
                .flatMap(useCase::createProduct)
                .map(mapper::toResponse);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\inbound\rest\dto\ProductRequest.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Positive;
import java.math.BigDecimal;


public record ProductRequest(@NotBlank String name, @Positive BigDecimal price) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\inbound\rest\dto\ProductResponse.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;
import java.math.BigDecimal;
import java.util.UUID;


public record ProductResponse(UUID id, String name, BigDecimal price, String status) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\outbound\cache\RedisAdapter.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.outbound.cache;

import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.core.ReactiveRedisTemplate;
import org.springframework.stereotype.Component;

import com.yowyob.fleet.domain.model.Product;
import com.yowyob.fleet.domain.ports.out.ProductCachePort;

import reactor.core.publisher.Mono;
import java.time.Duration;

@Component
@RequiredArgsConstructor
public class RedisAdapter implements ProductCachePort {
    private final ReactiveRedisTemplate<String, Object> redisTemplate;

    @Override
    public Mono<Boolean> saveInCache(Product product) {
        return redisTemplate.opsForValue()
                .set("product:" + product.id(), product, Duration.ofMinutes(10));
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\outbound\external\FakeAuthAdapter.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.outbound.external;

import com.yowyob.fleet.domain.ports.out.AuthPort;
import lombok.extern.slf4j.Slf4j;
import reactor.core.publisher.Mono;

@Slf4j
public class FakeAuthAdapter implements AuthPort {
    @Override
    public Mono<AuthResponse> login(String email, String password) {
        log.info("ðŸ›  MODE FAKE AUTH : Login simulÃ© pour {}", email);
        return Mono.just(new AuthResponse("fake-jwt-token-123", "FLEET_MANAGER", email, null, null));
    }

    @Override
    public Mono<Void> forgotPassword(String email) {
        log.info("ðŸ›  MODE FAKE AUTH : Reset password demandÃ© pour {}", email);
        return Mono.empty();
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\outbound\external\RemoteAuthAdapter.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.outbound.external;

import com.yowyob.fleet.domain.ports.out.AuthPort;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.client.AuthApiClient;
import lombok.extern.slf4j.Slf4j;
import reactor.core.publisher.Mono;
import java.util.List;

@Slf4j
public class RemoteAuthAdapter implements AuthPort {

    private final AuthApiClient authApiClient;

    public RemoteAuthAdapter(AuthApiClient authApiClient) {
        this.authApiClient = authApiClient;
    }

    @Override
    public Mono<AuthResponse> login(String identifier, String password) {
        return authApiClient.authenticate(new AuthApiClient.LoginRequest(identifier, password))
                .map(this::mapToDomain);
    }

    @Override
    public Mono<AuthResponse> register(String username, String email, String password, String phone, String firstName, String lastName) {
        var request = new AuthApiClient.RegisterRequest(
            username, password, email, phone, firstName, lastName,
            "FLEET_MANAGEMENT", // Service forcÃ© selon ton besoin
            List.of("ADMIN")    // RÃ´le par dÃ©faut
        );

        return authApiClient.register(request)
                .map(this::mapToDomain)
                .doOnSuccess(res -> log.info("âœ… Compte TraMaSys crÃ©Ã© : {}", res.username()));
    }

    private AuthResponse mapToDomain(AuthApiClient.TraMaSysResponse res) {
        return new AuthResponse(
            res.accessToken(), res.refreshToken(),
            res.user().username(), res.user().roles(), res.user().permissions()
        );
    }

    @Override
    public Mono<Void> forgotPassword(String email) {
        return Mono.empty();
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\outbound\external\StockAdapter.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.outbound.external;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cloud.client.circuitbreaker.ReactiveCircuitBreaker;
import org.springframework.cloud.client.circuitbreaker.ReactiveCircuitBreakerFactory;
import org.springframework.stereotype.Component;

import com.yowyob.fleet.domain.ports.out.StockClientPort;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.client.StockApiClient;

import reactor.core.publisher.Mono;

@Component
@Slf4j
@RequiredArgsConstructor
public class StockAdapter implements StockClientPort {

    private final StockApiClient client;
    private final ReactiveCircuitBreakerFactory<?, ?> cbFactory;

    @Override
    public Mono<Boolean> isStockFull(String productName) {
        ReactiveCircuitBreaker rcb = cbFactory.create("stock-service");

        return rcb.run(
                client.checkStock(productName).map(StockApiClient.StockResponse::full),
                throwable -> fallbackStockCheck(productName, throwable)
        );
    }

    private Mono<Boolean> fallbackStockCheck(String productName, Throwable t) {
        log.warn("Circuit Breaker open or Service Down for {}. Error: {}", productName, t.getMessage());
        // Fallback: if the service is down, consider the stock not full
        return Mono.just(false);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\outbound\external\client\AuthApiClient.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.outbound.external.client;

import org.springframework.web.service.annotation.HttpExchange;
import org.springframework.web.service.annotation.PostExchange;
import org.springframework.web.bind.annotation.RequestBody;
import reactor.core.publisher.Mono;
import java.util.List;

@HttpExchange("/api/auth")
public interface AuthApiClient {
    
    @PostExchange("/login")
    Mono<TraMaSysResponse> authenticate(@RequestBody LoginRequest request);

    @PostExchange("/register")
    Mono<TraMaSysResponse> register(@RequestBody RegisterRequest request);

    record LoginRequest(String identifier, String password) {}

    record RegisterRequest(
        String username,
        String password,
        String email,
        String phone,
        String firstName,
        String lastName,
        String service, // Sera "FLEET_MANAGEMENT"
        List<String> roles
    ) {}

    record TraMaSysResponse(String accessToken, String refreshToken, UserDetail user) {}
    record UserDetail(String id, String username, List<String> roles, List<String> permissions) {}
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\outbound\external\client\StockApiClient.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.outbound.external.client;

import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.service.annotation.GetExchange;
import org.springframework.web.service.annotation.HttpExchange;
import reactor.core.publisher.Mono;

@HttpExchange("/api/stock")
public interface StockApiClient {
    @GetExchange("/check")
    Mono<StockResponse> checkStock(@RequestParam("name") String name);

    record StockResponse(boolean full) {}
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\outbound\messaging\KafkaAdapter.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.outbound.messaging;

import lombok.RequiredArgsConstructor;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.kafka.core.reactive.ReactiveKafkaProducerTemplate;
import org.springframework.stereotype.Component;

import com.yowyob.fleet.domain.model.Product;
import com.yowyob.fleet.domain.ports.out.ProductEventPublisherPort;

import reactor.core.publisher.Mono;

@Component
@RequiredArgsConstructor
public class KafkaAdapter implements ProductEventPublisherPort {

    private final ReactiveKafkaProducerTemplate<String, Object> kafkaTemplate;

    @Value("${application.kafka.topics.product-events}")
    private String productEventsTopic;

    @Override
    public Mono<Void> publishProductCreated(Product product) {
        return kafkaTemplate.send(productEventsTopic, product.id().toString(), product)
                .then();
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\outbound\persistence\PostgresR2dbcAdapter.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import com.yowyob.fleet.domain.model.Product;
import com.yowyob.fleet.domain.ports.out.ProductRepositoryPort;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository.ProductR2dbcRepository;
import com.yowyob.fleet.infrastructure.mappers.ProductMapper;

import reactor.core.publisher.Mono;

@Component
@RequiredArgsConstructor
public class PostgresR2dbcAdapter implements ProductRepositoryPort {

    private final ProductR2dbcRepository repository;
    private final ProductMapper mapper;

    @Override
    public Mono<Product> save(Product product) {
        return repository.save(mapper.toEntity(product))
                .map(mapper::toDomain);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\outbound\persistence\entity\ProductEntity.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;
import java.math.BigDecimal;
import java.util.UUID;

@Table("products")
@Data @NoArgsConstructor @AllArgsConstructor
public class ProductEntity {
    @Id
    private UUID id;
    private String name;
    private BigDecimal price;
    private String status;
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\adapters\outbound\persistence\repository\ProductR2dbcRepository.java
`$ext
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository;

import org.springframework.data.repository.reactive.ReactiveCrudRepository;

import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.ProductEntity;

import java.util.UUID;

public interface ProductR2dbcRepository extends ReactiveCrudRepository<ProductEntity, UUID> {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\config\AuthConfig.java
`$ext
package com.yowyob.fleet.infrastructure.config;

import com.yowyob.fleet.domain.ports.out.AuthPort;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.FakeAuthAdapter;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.RemoteAuthAdapter;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.client.AuthApiClient;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class AuthConfig {

    @Bean
    @ConditionalOnProperty(name = "application.auth.mode", havingValue = "fake")
    public AuthPort fakeAuthPort() {
        return new FakeAuthAdapter();
    }

    @Bean
    @ConditionalOnProperty(name = "application.auth.mode", havingValue = "remote", matchIfMissing = true)
    public AuthPort remoteAuthPort(AuthApiClient authApiClient) {
        // Maintenant, le constructeur de RemoteAuthAdapter accepte bien l'interface
        return new RemoteAuthAdapter(authApiClient);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\config\DatabaseInitConfig.java
`$ext
package com.yowyob.fleet.infrastructure.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.core.io.ClassPathResource;
import org.springframework.r2dbc.core.DatabaseClient;
import jakarta.annotation.PostConstruct;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.stream.Collectors;

@Configuration
@Profile("local")
public class DatabaseInitConfig {

    private final DatabaseClient databaseClient;

    public DatabaseInitConfig(DatabaseClient databaseClient) {
        this.databaseClient = databaseClient;
    }

    @PostConstruct
    public void init() {
        System.out.println("âš™ï¸ LOCAL ENVIRONMENT: Starting database initialization...");

        // 1. Run Schema -> 2. Seed if empty
        executeSqlFile("local/schema.sql")
                .then(checkIfDataExists())
                .flatMap(hasData -> {
                    if (!hasData) {
                        System.out.println("ðŸŒ± Seeding: Database is empty. Injecting test data...");
                        return executeSqlFile("local/data.sql");
                    }
                    System.out.println("âœ… Seeding: Data already exists. Skipping.");
                    return Mono.empty();
                })
                .subscribe(
                        null,
                        err -> {
                            System.err.println("âŒ DB INIT ERROR: " + err.getMessage());
                            // Log the error but don't stop the app
                        },
                        () -> System.out.println("ðŸš€ LOCAL DATABASE READY!")
                );
    }

    private Mono<Void> executeSqlFile(String filePath) {
        return Mono.fromCallable(() -> {
            ClassPathResource resource = new ClassPathResource(filePath);
            try (BufferedReader reader = new BufferedReader(new InputStreamReader(resource.getInputStream()))) {
                return reader.lines().collect(Collectors.joining("\n"));
            }
        })
        .flatMapMany(sql -> {
            // Split by semicolon
            return Flux.fromArray(sql.split(";"));
        })
        .map(String::trim)
        .filter(s -> !s.isEmpty()) // We only filter out truly empty strings
        .concatMap(s -> {
            // Execute each statement sequentially
            return databaseClient.sql(s)
                    .then()
                    .onErrorResume(e -> {
                        // Ignore errors on DROP commands (often happen if object doesn't exist)
                        if (s.toUpperCase().startsWith("DROP")) {
                            return Mono.empty();
                        }
                        return Mono.error(e);
                    });
        })
        .then();
    }

    private Mono<Boolean> checkIfDataExists() {
        return databaseClient.sql("SELECT COUNT(*) FROM users")
                .map((row, metadata) -> row.get(0, Long.class))
                .first()
                .map(count -> count > 0)
                .onErrorReturn(false);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\config\KafkaConfig.java
`$ext
package com.yowyob.fleet.infrastructure.config;

import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.common.serialization.StringSerializer;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.kafka.core.reactive.ReactiveKafkaProducerTemplate;
import reactor.kafka.sender.SenderOptions;

import java.util.HashMap;
import java.util.Map;

@Configuration
public class KafkaConfig {

    @Value("${spring.kafka.bootstrap-servers}")
    private String bootstrapServers;

    @Bean
    public ReactiveKafkaProducerTemplate<String, Object> reactiveKafkaProducerTemplate() {
        Map<String, Object> props = new HashMap<>();
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, org.springframework.kafka.support.serializer.JsonSerializer.class);

        SenderOptions<String, Object> senderOptions = SenderOptions.create(props);

        return new ReactiveKafkaProducerTemplate<>(senderOptions);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\config\OpenApiConfig.java
`$ext
package com.yowyob.fleet.infrastructure.config;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Contact;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.info.License;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OpenApiConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("YowYob Microservice Template API")
                        .version("1.0.0")
                        .description("Documentation de l'API RÃ©active Hexagonale.")
                        .contact(new Contact()
                                .name("Ã‰quipe Backend")
                                .email("dev@yowyob.com"))
                        .license(new License()
                                .name("Apache 2.0")
                                .url("http://springdoc.org")));
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\config\RedisConfig.java
`$ext
package com.yowyob.fleet.infrastructure.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.module.paramnames.ParameterNamesModule;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.ReactiveRedisConnectionFactory;
import org.springframework.data.redis.core.ReactiveRedisTemplate;
import org.springframework.data.redis.serializer.*;

@Configuration
public class RedisConfig {

    @Bean
    public ReactiveRedisTemplate<String, Object> reactiveRedisTemplate(
            ReactiveRedisConnectionFactory factory) {

        ObjectMapper mapper = new ObjectMapper()
                .registerModule(new ParameterNamesModule())
                .registerModule(new JavaTimeModule());

        Jackson2JsonRedisSerializer<Object> jsonSerializer =
                new Jackson2JsonRedisSerializer<>(mapper, Object.class);

        RedisSerializationContext<String, Object> context =
                RedisSerializationContext.<String, Object>newSerializationContext(new StringRedisSerializer())
                        .value(jsonSerializer)
                        .hashValue(jsonSerializer)
                        .build();

        return new ReactiveRedisTemplate<>(factory, context);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\config\SecurityConfig.java
`$ext
package com.yowyob.fleet.infrastructure.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;
import org.springframework.security.config.web.server.ServerHttpSecurity;
import org.springframework.security.core.userdetails.MapReactiveUserDetailsService;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.server.SecurityWebFilterChain;

@Configuration
@EnableWebFluxSecurity
public class SecurityConfig {

    /**
     * Configures the security filter chain for WebFlux.
     */
    @Bean
    public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
        System.out.println("ðŸ›¡ï¸ REACTIVE SECURITY CONFIGURATION LOADED");

        return http
                // Disable CSRF as we are building a stateless REST API
                .csrf(ServerHttpSecurity.CsrfSpec::disable)
                
                .authorizeExchange(exchanges -> exchanges
                        // Allow access to health checks and monitoring
                        .pathMatchers("/actuator/**").permitAll()
                        
                        // Allow access to Swagger UI and API Documentation (v3)
                        .pathMatchers(
                                "/v3/api-docs/**", 
                                "/swagger-ui/**", 
                                "/swagger-ui.html", 
                                "/webjars/**",
                                "/api/v1/health/**",
                                "/api/v1/auth/**" 
                        ).permitAll()
                        
                        // All other exchanges require authentication
                        .anyExchange().authenticated()
                )
                
                // Disable default login forms and basic auth
                .httpBasic(ServerHttpSecurity.HttpBasicSpec::disable)
                .formLogin(ServerHttpSecurity.FormLoginSpec::disable)
                .build();
    }

    /**
     * Provides a dummy technical user to satisfy Spring Security's requirements
     * and disable the auto-generated password in the logs.
     */
    @Bean
    public MapReactiveUserDetailsService userDetailsService() {
        UserDetails dummyUser = User.withUsername("technical_user")
                .password("{noop}dummy_password") // {noop} means no encoding
                .roles("SYSTEM")
                .build();
        return new MapReactiveUserDetailsService(dummyUser);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\config\WebClientConfig.java
`$ext
package com.yowyob.fleet.infrastructure.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.support.WebClientAdapter;
import org.springframework.web.service.invoker.HttpServiceProxyFactory;

import com.yowyob.fleet.infrastructure.adapters.outbound.external.client.AuthApiClient;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.client.StockApiClient;

@Configuration
public class WebClientConfig {

    @Bean
    public StockApiClient stockApiClient(WebClient.Builder builder, 
                                         @Value("${application.external.stock-service-url}") String url) {
                                            
        WebClient webClient = builder.baseUrl(url).build();
        WebClientAdapter adapter = WebClientAdapter.create(webClient);
        HttpServiceProxyFactory factory = HttpServiceProxyFactory.builderFor(adapter).build();
        
        return factory.createClient(StockApiClient.class);
    }

    @Bean
    public AuthApiClient authApiClient(WebClient.Builder builder, 
                                   @Value("${application.auth.url}") String url) {
    WebClient webClient = builder.baseUrl(url).build();
    return HttpServiceProxyFactory
            .builderFor(WebClientAdapter.create(webClient))
            .build()
            .createClient(AuthApiClient.class);
}
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\java\com\yowyob\fleet\infrastructure\mappers\ProductMapper.java
`$ext
package com.yowyob.fleet.infrastructure.mappers;

import org.mapstruct.Mapper;

import com.yowyob.fleet.domain.model.Product;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.ProductRequest;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.ProductResponse;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.ProductEntity;

@Mapper(componentModel = "spring")
public interface ProductMapper {
    Product toDomain(ProductRequest request);
    ProductResponse toResponse(Product domain);
    
    ProductEntity toEntity(Product domain);
    Product toDomain(ProductEntity entity);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\resources\application.yml
`$ext
server:
  port: 8080

spring:
  application:
    name: fleet-management

  # THE "TOGGLE": Change 'local' to 'remote' to switch databases
  profiles:
    active: local 
    
  docker:
    compose:
      enabled: false

  # POSTGRESQL (R2DBC)
  r2dbc:
    url: r2dbc:postgresql://168.119.122.86:5432/yowyob
    username: master
    password: Azerty1234*

  sql:
    init:
      mode: always

  # REDIS CLUSTER 
  data:
    redis:
      host: 168.119.122.86
      port: 7000
      password: Azerty1234*
      cluster:
        enabled: false 

  # KAFKA 
  kafka:
    bootstrap-servers: 168.119.122.86:9092
    consumer:
      group-id: fleet-management-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CUSTOM CONFIG 
application:
  external:
    stock-service-url: http://168.119.122.86:8081

  kafka:
    topics:
      product-events: test-topic

  auth:
    mode: remote # Mettez 'remote' pour tester le vrai service TraMaSys et 'fake' pour la fausse authentification en test
    url: https://auth-service.pynfi.com # URL de la doc TraMaSys

# RESILIENCE4J 
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5

---
# LOCAL CONFIGURATION
spring:
  config:
    activate:
      on-profile: local
  r2dbc:
    url: r2dbc:postgresql://localhost:5432/yowyob_db
    username: fleet_admin
    password: fleet_password
  sql:
    init:
      mode: never

---
# REMOTE CONFIGURATION (Server)
spring:
  config:
    activate:
      on-profile: remote
  r2dbc:
    url: r2dbc:postgresql://168.119.122.86:5432/yowyob
    username: master
    password: Azerty1234*
  sql:
    init:
      mode: never # SAFETY: Never run the destructive schema.sql on the remote server

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\resources\prod.application.yml
`$ext
server:
  port: 8080

spring:
  application:
    name: reactive-hexagonal
    
  docker:
    compose:
      enabled: false

  # POSTGRESQL (R2DBC)
  r2dbc:
    url: r2dbc:postgresql://168.119.122.86:5432/yowyob
    username: master
    password: Azerty1234*

  sql:
    init:
      mode: always

  # REDIS CLUSTER 
  data:
    redis:
      password: Azerty1234*
      cluster:
        nodes:
          - 168.119.122.86:7001
          - 168.119.122.86:7002
          - 168.119.122.86:7003
          - 168.119.122.86:7004
          - 168.119.122.86:7005
          - 168.119.122.86:7006

  # KAFKA 
  kafka:
    bootstrap-servers: 168.119.122.86:9092
    consumer:
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CUSTOM CONFIG 
application:
  external:
    stock-service-url: http://168.119.122.86:8081

  kafka:
    topics:
      product-events: test-topic

# RESILIENCE4J 
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\resources\local\data.sql
`$ext
-- =====================================================
-- YOWYOB DB - DATA SEEDING SCRIPT
-- PostgreSQL
-- =====================================================


-- =====================================================
-- 1. CLEANUP EXISTING DATA
-- =====================================================
TRUNCATE TABLE 
    users, images, countries, business_actors, 
    admins, fleet_managers, drivers, customers, 
    providers, employees, prospects, sales_persons,
    profiles, settings, addresses, contacts,
    roles, permissions, role_has_permissions, user_has_roles,
    organizations, agencies, business_domains, organization_business_domains,
    certifications, third_parties, proposed_activities, services, branches,
    fleets, vehicles, geofence_zones, geofence_points, geofence_events,
    roads, trips, offers, rides, reviews, offer_driver_linkages,
    operational_parameters, financial_parameters, maintenance_parameters,
    geofence_point_zone_linkages,
    syndicats, abstract_products, products, 
    publications, publication_images, publication_votes, votes,
    events, event_images, reactions, comments, avis,
    subscriptions, payments
    RESTART IDENTITY CASCADE;

-- =====================================================
-- 2. STATIC REFERENCE DATA
-- =====================================================

-- Countries
INSERT INTO countries (name, code) VALUES
('Cameroun', 'CM'), ('SÃ©nÃ©gal', 'SN'), ('CÃ´te d''Ivoire', 'CI'), 
('Gabon', 'GA'), ('NigÃ©ria', 'NG'), ('Togo', 'TG');

-- Roles
INSERT INTO roles (name, guard_name) VALUES
('ADMIN', 'web'), ('FLEET_MANAGER', 'web'), ('DRIVER', 'web'), ('CUSTOMER', 'web');

-- Images (Random placeholders from Picsum)
INSERT INTO images (url, alt_text) 
SELECT 
    'https://picsum.photos/seed/' || i || '/800/600', 
    'Image alÃ©atoire ' || i
FROM generate_series(1, 50) as i;

-- =====================================================
-- 3. USERS GENERATION (100 users)
-- =====================================================

INSERT INTO users (name, phone_number, email_address)
SELECT 
    (ARRAY['Mamadou', 'Jean-Pierre', 'Ibrahim', 'Fatou', 'Aminata', 'Ngolo', 'Aboubakar', 'Clarisse', 'Samuel', 'KouamÃ©', 'Aissatou', 'Bachelard', 'Landry', 'ThÃ©rÃ¨se'])[floor(random()*14)+1] 
    || ' ' || 
    (ARRAY['Diop', 'Njoya', 'Mbarga', 'Kone', 'Sow', 'Etoundi', 'Kamga', 'TraorÃ©', 'Diallo', 'Fofana', 'Mensah', 'Atangana', 'Eto''o', 'Drogba'])[floor(random()*14)+1],
    (ARRAY['+237', '+221', '+225'])[floor(random()*3)+1] || (600000000 + floor(random()*99999999)::int),
    'user_' || i || '@yowyob.test'
FROM generate_series(1, 100) as i;

-- Settings & Profiles
INSERT INTO settings (user_id, theme, language, receive_push_notifications)
SELECT id, 'LIGHT', 'fr', true FROM users;

INSERT INTO profiles (user_id, first_name, nationality, is_verified)
SELECT id, split_part(name, ' ', 1), 'Camerounais', (random() > 0.5) FROM users;

-- =====================================================
-- 4. ACTORS DISPATCHING
-- User -> BusinessActor -> SpecificActor
-- =====================================================

-- 4.1 Admins (First 5 users)
INSERT INTO admins (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5;

-- 4.2 Fleet Managers (Next 5 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- STEP 2: Insert into CHILD (FleetManager)
INSERT INTO fleet_managers (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- 4.3 Drivers (Next 30 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- STEP 2: Insert into CHILD (Driver)
INSERT INTO drivers (id, status, license_number, has_car)
SELECT 
    id, 
    (ARRAY['AVAILABLE', 'BUSY', 'OFFLINE'])[floor(random()*3)+1], 
    'LIC-' || floor(random()*100000) || '-CM',
    (random() > 0.3)
FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- 4.4 Customers (Remaining 60 users)
INSERT INTO customers (id, code, payment_method)
SELECT 
    id, 
    'CUST-' || substr(id::text, 1, 8),
    (ARRAY['CASH', 'MOBILE_MONEY', 'CARD'])[floor(random()*3)+1]
FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- Assign Roles
INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'ADMIN') FROM users ORDER BY email_address LIMIT 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'FLEET_MANAGER') FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'DRIVER') FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'CUSTOMER') FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- =====================================================
-- 5. ORGANIZATIONS & AGENCIES
-- =====================================================

INSERT INTO organizations (
    business_actor_id, logo_id, code, short_name, long_name, 
    description, tax_number, is_active, status
)
SELECT
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    (SELECT id FROM images ORDER BY random() LIMIT 1),
    'ORG-' || i,
    'Transport ' || i,
    'SociÃ©tÃ© de Transport ' || i,
    'Description ' || i,
    'TAX-' || floor(random()*1000000),
    true,
    'PUBLISHED'
FROM generate_series(1, 35) as i;

INSERT INTO agencies (
    organization_id, manager_id, name, city, location, is_headquarter
)
SELECT 
    id, 
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    'Agence Centrale',
    (ARRAY['Douala', 'YaoundÃ©', 'Abidjan'])[floor(random()*3)+1],
    'Rue Principale',
    true
FROM organizations;

-- =====================================================
-- 6. FLEETS & VEHICLES
-- =====================================================

INSERT INTO fleets (fleet_manager_id, name, phone_number)
SELECT 
    id, 'Flotte de ' || name, '+237699000000'
FROM fleet_managers;

-- Vehicles
INSERT INTO vehicles (
    fleet_id, user_id, driver_id, license_plate, brand, model, type, color, manufacturing_year
)
SELECT 
    f.id,
    f.fleet_manager_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    'LT-' || floor(random()*999)::text || '-AA',
    (ARRAY['Toyota', 'Peugeot'])[floor(random()*2)+1],
    (ARRAY['Yaris', 'Partner'])[floor(random()*2)+1],
    (ARRAY['CAR', 'VAN'])[floor(random()*2)+1]::vehicle_type_enum,
    'Jaune',
    2020
FROM fleets f;

-- =====================================================
-- 7. OFFERS & RIDES
-- =====================================================

INSERT INTO offers (
    passenger_id, start_point, end_point, price, state, created_at
)
SELECT 
    (SELECT id FROM customers ORDER BY random() LIMIT 1),
    'Point A', 'Point B', 
    2000, 
    'CHOSEN',
    NOW()
FROM generate_series(1, 60) as i;

-- Rides
INSERT INTO rides (
    offer_id, passenger_id, driver_id, 
    distance, time_estimation, real_time, state, created_at
)
SELECT 
    id, -- offer_id
    passenger_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    15.5, 30, 35,
    'COMPLETED',
    created_at
FROM offers 
LIMIT 40;

-- Reviews
INSERT INTO reviews (ride_id, author_id, subject, comment, rating)
SELECT 
    id,
    passenger_id,
    'Chauffeur',
    'Bonne course, chauffeur ponctuel',
    5
FROM rides
WHERE state = 'COMPLETED';

-- =====================================================
-- 8. PRODUCTS
-- =====================================================

INSERT INTO products (
    organization_id, name, description, standard_price, 
    status, is_active, departure_location
)
SELECT 
    (SELECT id FROM organizations ORDER BY random() LIMIT 1),
    'Trajet SpÃ©cial ' || i,
    'Description produit',
    5000,
    'PUBLISHED',
    true,
    'Douala'
FROM generate_series(1, 40) as i;

-- =====================================================
-- 9. SUBSCRIPTIONS & PAYMENTS
-- =====================================================

INSERT INTO subscriptions (
    admin_id, label, price, duration_in_days, description, is_active
) VALUES 
((SELECT id FROM admins LIMIT 1), 'Pack Hebdo', 2500, 7, 'Standard', true),
((SELECT id FROM admins LIMIT 1), 'Pack Mensuel', 10000, 30, 'Pro', true),
((SELECT id FROM admins LIMIT 1), 'Pack Annuel', 100000, 365, 'VIP', true);

INSERT INTO payments (
    driver_id, user_id, subscription_id, amount_paid, status, id_provider_transaction, created_at
)
SELECT 
    d.id, -- Driver ID
    d.id, -- Payer ID
    s.id, -- Subscription ID
    s.price,
    'SUCCESS',
    'TXN-' || floor(random()*10000000),
    NOW()
FROM drivers d
CROSS JOIN subscriptions s
ORDER BY random()
LIMIT 50;

-- =====================================================
-- 10. SOCIAL & ADDRESSES
-- =====================================================

INSERT INTO syndicats (organization_id, name, is_approved)
SELECT id, 'Syndicat Transports', true FROM organizations LIMIT 1;

INSERT INTO branches (id, syndicat_id, name, location)
SELECT 
    ag.id,
    (SELECT id FROM syndicats LIMIT 1),
    'Branche ' || ag.name, 
    ag.location 
FROM agencies ag 
LIMIT 10;

INSERT INTO publications (branch_id, author_id, content, status, n_likes)
SELECT 
    (SELECT id FROM branches ORDER BY random() LIMIT 1),
    (SELECT id FROM admins ORDER BY random() LIMIT 1),
    'Info Trafic ' || i,
    'PUBLISHED',
    floor(random() * 50)::int
FROM generate_series(1, 40) as i;


---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\main\resources\local\schema.sql
`$ext
-- =====================================================
-- YOWYOB DB - INIT SCRIPT
-- PostgreSQL
-- Structure: Core -> Organization -> RBAC
-- =====================================================

-- Clean up existing tables and types to ensure a fresh start
-- We drop them in reverse order of dependency
DROP TABLE IF EXISTS user_has_roles CASCADE;
DROP TABLE IF EXISTS role_has_permissions CASCADE;
DROP TABLE IF EXISTS permissions CASCADE;
DROP TABLE IF EXISTS roles CASCADE;
DROP TABLE IF EXISTS reviews CASCADE;
DROP TABLE IF EXISTS payments CASCADE;
DROP TABLE IF EXISTS subscriptions CASCADE;
DROP TABLE IF EXISTS admins CASCADE;
DROP TABLE IF EXISTS profiles CASCADE;
DROP TABLE IF EXISTS comments CASCADE;
DROP TABLE IF EXISTS reactions CASCADE;
DROP TABLE IF EXISTS event_images CASCADE;
DROP TABLE IF EXISTS events CASCADE;
DROP TABLE IF EXISTS publication_images CASCADE;
DROP TABLE IF EXISTS publications CASCADE;
DROP TABLE IF EXISTS branches CASCADE;
DROP TABLE IF EXISTS avis CASCADE;
DROP TABLE IF EXISTS votes CASCADE;
DROP TABLE IF EXISTS publication_votes CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS abstract_products CASCADE;
DROP TABLE IF EXISTS syndicats CASCADE;
DROP TABLE IF EXISTS offer_driver_linkages CASCADE;
DROP TABLE IF EXISTS geofence_events CASCADE;
DROP TABLE IF EXISTS geofence_point_zone_linkages CASCADE;
DROP TABLE IF EXISTS geofence_points CASCADE;
DROP TABLE IF EXISTS maintenance_parameters CASCADE;
DROP TABLE IF EXISTS financial_parameters CASCADE;
DROP TABLE IF EXISTS operational_parameters CASCADE;
DROP TABLE IF EXISTS trips CASCADE;
DROP TABLE IF EXISTS roads CASCADE;
DROP TABLE IF EXISTS vehicles CASCADE;
DROP TABLE IF EXISTS geofence_zones CASCADE;
DROP TABLE IF EXISTS fleets CASCADE;
DROP TABLE IF EXISTS fleet_managers CASCADE;
DROP TABLE IF EXISTS rides CASCADE;
DROP TABLE IF EXISTS offers CASCADE;
DROP TABLE IF EXISTS drivers CASCADE;
DROP TABLE IF EXISTS services CASCADE;
DROP TABLE IF EXISTS customers CASCADE;
DROP TABLE IF EXISTS sales_persons CASCADE;
DROP TABLE IF EXISTS prospects CASCADE;
DROP TABLE IF EXISTS employees CASCADE;
DROP TABLE IF EXISTS providers CASCADE;
DROP TABLE IF EXISTS addresses CASCADE;
DROP TABLE IF EXISTS proposed_activities CASCADE;
DROP TABLE IF EXISTS settings CASCADE;
DROP TABLE IF EXISTS third_parties CASCADE;
DROP TABLE IF EXISTS certifications CASCADE;
DROP TABLE IF EXISTS organization_business_domains CASCADE;
DROP TABLE IF EXISTS contacts CASCADE;
DROP TABLE IF EXISTS business_domains CASCADE;
DROP TABLE IF EXISTS agencies CASCADE;
DROP TABLE IF EXISTS organizations CASCADE;
DROP TABLE IF EXISTS business_actors CASCADE;
DROP TABLE IF EXISTS countries CASCADE;
DROP TABLE IF EXISTS images CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- Drop existing types
DROP TYPE IF EXISTS reaction_type_enum CASCADE;
DROP TYPE IF EXISTS type_enum CASCADE;
DROP TYPE IF EXISTS role_type_enum CASCADE;
DROP TYPE IF EXISTS engine_status_enum CASCADE;
DROP TYPE IF EXISTS maintenance_status_enum CASCADE;
DROP TYPE IF EXISTS event_type_enum CASCADE;
DROP TYPE IF EXISTS ride_state_enum CASCADE;
DROP TYPE IF EXISTS offer_state_enum CASCADE;
DROP TYPE IF EXISTS vehicle_type_enum CASCADE;
DROP TYPE IF EXISTS action_enum CASCADE;
DROP TYPE IF EXISTS category_enum CASCADE;
DROP TYPE IF EXISTS status_enum CASCADE;

-- Re-enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";


-- =====================================================
-- ENUM TYPES
-- =====================================================

CREATE TYPE status_enum AS ENUM (
  'DRAFT', 'WAITING_CONFIRMATION', 'PUBLISHED', 'IN_PROGRESS', 'CANCELLED', 'EXPIRED'
);

CREATE TYPE category_enum AS ENUM (
  'ANNOUNCE', 'PLANNING', 'VEHICLE', 'ADDRESS', 'EXPERIENCE'
);

CREATE TYPE action_enum AS ENUM (
  'CREATE', 'UPDATE', 'READ', 'DELETE'
);

CREATE TYPE vehicle_type_enum AS ENUM (
  'CAR', 'VAN', 'TRUCK', 'BIKE'
);

CREATE TYPE offer_state_enum AS ENUM (
  'NEW', 'PENDING', 'CHOSEN', 'TERMINATED', 'CANCELED'
);

CREATE TYPE ride_state_enum AS ENUM (
  'CONFIRMED', 'ONGOING', 'COMPLETED', 'CANCELED'
);

CREATE TYPE event_type_enum AS ENUM (
  'ENTRY', 'EXIT'
);

CREATE TYPE maintenance_status_enum AS ENUM (
  'UP_TO_DATE', 'PENDING', 'OVERDUE'
);

CREATE TYPE engine_status_enum AS ENUM (
  'OK', 'NEED_SERVICE', 'OUT_OF_SERVICE'
);

CREATE TYPE role_type_enum AS ENUM (
  'CUSTOMER', 'DRIVER', 'FLEET_MANAGER', 'ADMIN', 'PASSENGER', 'PRESIDENT', 'MODERATOR', 'CLIENT'
);

CREATE TYPE type_enum AS ENUM (
  'NOTIFICATION', 'CHAT', 'PAYMENT', 'MEDIA'
);

CREATE TYPE reaction_type_enum AS ENUM (
  'LIKE', 'LOVE', 'HAHA', 'WOW', 'SAD', 'ANGRY'
);

-- =====================================================
-- CORE TABLES
-- =====================================================

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  phone_number TEXT,
  email_address TEXT UNIQUE
);

CREATE TABLE images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url TEXT NOT NULL,
  alt_text TEXT,
  uploaded_at TIMESTAMP DEFAULT now()
);

CREATE TABLE countries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE business_actors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT,
  phone_number TEXT,
  email_address TEXT,
  CONSTRAINT fk_business_actor_user
    FOREIGN KEY (id) REFERENCES users(id)
    ON DELETE CASCADE
);

-- =====================================================
-- ORGANIZATION TABLES
-- =====================================================

CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_actor_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  email TEXT,
  short_name TEXT,
  long_name TEXT,
  description TEXT,
  logo_uri TEXT,
  website_url TEXT,
  social_network TEXT,
  business_registration_number TEXT,
  tax_number TEXT,
  capital_share NUMERIC,
  ceo_name TEXT,
  year_founded INT,
  keywords TEXT,
  number_of_employees INT,
  legal_form TEXT,
  is_active BOOLEAN DEFAULT true,
  status status_enum DEFAULT 'DRAFT',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, -- Must belong to an org

  owner_id UUID REFERENCES business_actors(id),
  manager_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  name TEXT,
  location TEXT,
  description TEXT,
  transferable BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  logo_uri TEXT,
  short_name TEXT,
  long_name TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  is_headquarter BOOLEAN DEFAULT false,
  country TEXT,
  city TEXT,
  latitude NUMERIC,
  longitude NUMERIC,
  open_time TIME,
  close_time TIME,
  phone TEXT,
  email TEXT,
  whatsapp TEXT,
  greeting_message TEXT,
  average_revenue NUMERIC,
  capital_share NUMERIC,
  registration_number TEXT,
  social_network TEXT,
  tax_number TEXT,
  keywords TEXT,
  is_public BOOLEAN DEFAULT false,
  is_business BOOLEAN DEFAULT true,
  total_affiliated_customers INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE business_domains (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL, -- optional link to organization
  parent_id UUID REFERENCES business_domains(id) ON DELETE SET NULL,   -- self-referential for hierarchy
  image_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  name TEXT,
  image_uri TEXT,
  type TEXT,
  type_label TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE organization_business_domains (
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  business_domain_id UUID REFERENCES business_domains(id) ON DELETE CASCADE,
  PRIMARY KEY (organization_id, business_domain_id)
);

CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  contactable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  contactable_type TEXT,
  first_name TEXT,
  last_name TEXT,
  title TEXT,
  is_email_verified BOOLEAN DEFAULT false,
  is_phone_number_verified BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  phone_number TEXT,
  secondary_phone_number TEXT,
  fax_number TEXT,
  email TEXT,
  secondary_email TEXT,
  email_verified_at TIMESTAMP,
  phone_verified_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE certifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  description TEXT,
  obtainment_date DATE,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE third_parties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  logo_id UUID REFERENCES images(id),

  code TEXT,
  type TEXT,
  legal_form TEXT,
  unique_identification_number TEXT,
  trade_registration_number TEXT,
  name TEXT,
  acronym TEXT,
  long_name TEXT,
  logo_uri TEXT,
  accounting_account_numbers TEXT,
  authorized_payment_methods TEXT,
  authorized_credit_limit NUMERIC,
  max_discount_rate NUMERIC,
  vat_subject BOOLEAN,
  operations_balance NUMERIC,
  opening_balance NUMERIC,
  pay_term_number INT,
  pay_term_type TEXT,
  third_party_family TEXT,
  classification TEXT,
  tax_number TEXT,
  loyalty_points NUMERIC,
  loyalty_points_used NUMERIC,
  loyalty_points_expired NUMERIC,
  enabled BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE settings (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  theme TEXT,
  language TEXT,
  long_ride_enabled BOOLEAN DEFAULT false,
  short_ride_enabled BOOLEAN DEFAULT false,
  privacy_enable BOOLEAN DEFAULT true,
  allow_calls BOOLEAN DEFAULT true,
  allow_messages BOOLEAN DEFAULT true,
  notify_new_rides BOOLEAN DEFAULT true,
  notify_ratings BOOLEAN DEFAULT true,
  notify_practical_tips BOOLEAN DEFAULT true,
  notify_promotions BOOLEAN DEFAULT true,
  notify_policy_updates BOOLEAN DEFAULT true,
  notify_peak_hour_recommendations BOOLEAN DEFAULT true,
  receive_email BOOLEAN DEFAULT true,
  receive_sms BOOLEAN DEFAULT true,
  receive_push_notifications BOOLEAN DEFAULT true,
  receive_whatsapp BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE proposed_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  rate NUMERIC,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE addresses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  addressable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  country_id UUID REFERENCES countries(id) ON DELETE SET NULL,

  addressable_type TEXT,
  type TEXT,
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  state TEXT,
  locality TEXT,
  zip_code TEXT,
  postal_code TEXT,
  po_box TEXT,
  is_default BOOLEAN DEFAULT false,
  neighbor_hood TEXT,
  informal_description TEXT,
  latitude NUMERIC,
  longitude NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

-- =====================================================
-- USERS EXTENDED
-- =====================================================

CREATE TABLE providers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  contact_info TEXT,
  address TEXT,
  is_active BOOLEAN DEFAULT true,
  product_service_type TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE employees (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  is_manager BOOLEAN DEFAULT false,
  role TEXT,
  department TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE prospects (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,
  interest_level TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE sales_persons (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  commission_rate NUMERIC,
  credit NUMERIC,
  current_balance NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE customers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

-- =====================================================
-- RIDE & FLEET MANAGEMENT
-- =====================================================

CREATE TABLE drivers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  status TEXT,
  license_number TEXT,
  has_car BOOLEAN DEFAULT false
);

CREATE TABLE offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  passenger_id UUID REFERENCES customers(id) ON DELETE CASCADE,

  start_point TEXT,
  end_point TEXT,
  price NUMERIC,
  state offer_state_enum DEFAULT 'NEW',
  ids_interested_drivers TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE rides (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  offer_id UUID REFERENCES offers(id) ON DELETE SET NULL,
  passenger_id UUID REFERENCES users(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  distance NUMERIC,
  time_estimation NUMERIC,
  real_time NUMERIC,
  state ride_state_enum DEFAULT 'CONFIRMED',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet_managers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE fleets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fleet_manager_id UUID REFERENCES fleet_managers(id) ON DELETE SET NULL,

  name TEXT,
  phone_number TEXT,
  email_address TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE geofence_zones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  surface_area NUMERIC,
  perimeter NUMERIC
);

CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  fleet_id UUID REFERENCES fleets(id) ON DELETE SET NULL,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,

  license_plate TEXT,
  model TEXT,
  brand TEXT,
  manufacturing_year INT,
  type vehicle_type_enum,
  color TEXT
);

CREATE TABLE roads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  start_point TEXT,
  end_point TEXT
);

CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  road_id UUID REFERENCES roads(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  start_date DATE,
  end_date DATE,
  start_time TIME,
  end_time TIME,
  type TEXT,
  color TEXT
);

CREATE TABLE operational_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  statut TEXT,
  current_location TEXT,
  current_speed NUMERIC,
  fuel_level NUMERIC,
  mileage NUMERIC,
  odometer_reading NUMERIC,
  bearing NUMERIC,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE financial_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  insurance_number TEXT,
  insurance_expired_at DATE,
  registered_at DATE,
  purchased_at DATE,
  depreciation_rate NUMERIC,
  cost_per_km NUMERIC
);

CREATE TABLE maintenance_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  last_maintenance_at DATE,
  next_maintenance_at DATE,
  engine_status engine_status_enum DEFAULT 'OK',
  battery_health TEXT,
  maintenance_status maintenance_status_enum DEFAULT 'UP_TO_DATE'
);

CREATE TABLE geofence_points (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  latitude NUMERIC,
  longitude NUMERIC
);

CREATE TABLE geofence_point_zone_linkages (
  point_id UUID REFERENCES geofence_points(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE CASCADE,
  PRIMARY KEY (point_id, zone_id)
);

CREATE TABLE geofence_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,
  point_id UUID REFERENCES geofence_points(id) ON DELETE SET NULL,

  type event_type_enum,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE offer_driver_linkages (
  offer_id UUID REFERENCES offers(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE CASCADE,
  PRIMARY KEY (offer_id, driver_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- OTHERS: PRODUCTS, SYNDICATS, PUBLICATIONS & REVIEWS
-- =====================================================

CREATE TABLE syndicats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  is_approved BOOLEAN DEFAULT false,
  name TEXT,
  description TEXT,
  domain TEXT,
  type TEXT,
  charte_url TEXT,
  status_url TEXT,
  members_list_url TEXT,
  commitment_certificate_url TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE abstract_products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  abstract_product_id UUID REFERENCES abstract_products(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  standard_price NUMERIC,
  departure_location TEXT,
  arrival_location TEXT,
  start_date DATE,
  start_time TIME,
  end_date DATE,
  end_time TIME,
  baggage_info TEXT,
  is_negotiable BOOLEAN DEFAULT false,
  payment_method TEXT,
  title TEXT,
  status status_enum DEFAULT 'DRAFT',
  product_urls TEXT,
  regular_amount NUMERIC,
  discount_percentage NUMERIC,
  discounted_amount NUMERIC,
  metadata JSONB,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  title TEXT,
  description TEXT,
  closing_at TIMESTAMP,
  type category_enum
);

CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  publication_vote_id UUID REFERENCES publication_votes(id) ON DELETE CASCADE,

  label TEXT
);

CREATE TABLE avis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  comment TEXT,
  number INT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE branches (
  id UUID PRIMARY KEY REFERENCES agencies(id),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  location TEXT,
  contact TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  content TEXT,
  status status_enum DEFAULT 'DRAFT',
  n_likes INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_images (
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (publication_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,

  title TEXT,
  description TEXT,
  location TEXT,
  date DATE,
  start_time TIME,
  end_time TIME,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE event_images (
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (event_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  type reaction_type_enum,

  reacted_at TIMESTAMP DEFAULT now()
);

CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES comments(id) ON DELETE SET NULL,
  image_id UUID REFERENCES images(id) ON DELETE SET NULL,

  content TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  first_name TEXT,
  last_name TEXT,
  nickname TEXT,
  profile_image_url TEXT,
  birth_date DATE,
  nationality TEXT,
  gender TEXT,
  language TEXT,
  company_name TEXT,
  biography TEXT,
  rating NUMERIC,
  total_trips INT,
  is_available BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- PAYMENTS & SUBSCRIPTIONS
-- =====================================================

CREATE TABLE admins (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  admin_id UUID REFERENCES admins(id) ON DELETE SET NULL,

  label TEXT,
  price NUMERIC,
  duration_in_days INT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,
  user_id UUID REFERENCES business_actors(id) ON DELETE SET NULL,

  amount_paid NUMERIC,
  status TEXT,
  id_provider_transaction TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ride_id UUID REFERENCES rides(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  subject TEXT,
  comment TEXT,
  rating NUMERIC,

  created_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- ROLE-BASED ACCESS CONTROL (RBAC)
-- =====================================================

CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE role_has_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE user_has_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Commit the transaction


-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\Projet Synthèse\fleetman\fleet-management-geofence\src\test\java\com\yowyob\reactive_hexagonal\ReactiveHexagonalApplicationTests.java
`$ext
package com.yowyob.reactive_hexagonal;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class ReactiveHexagonalApplicationTests {

	@Test
	void contextLoads() {
	}

}

