# Contexte du Projet : Fleet & Geofence API
Généré le : Wed 21 Jan 2026 10:06:46 AM WAT
Framework : Spring Boot WebFlux (Reactive)

## 1. Arborescence du Projet
```
.
├── docker-compose.yml
├── Dockerfile
├── docs
│   ├── contracts_fleet_management.md
│   ├── data
│   │   └── YOWYOB_DB
│   │       ├── last_schema
│   │       │   ├── data.sql
│   │       │   ├── guide_database_setup.md
│   │       │   └── schema.sql
│   │       ├── README.md
│   │       ├── yowyob_db_init.sql
│   │       ├── yowyob_db_seed.sql
│   │       └── yowyob_db_test.sql
│   ├── database_setup.md
│   ├── fleet-management.pdf
│   ├── prompts
│   │   └── master_pair_programmer.md
│   ├── refactor
│   │   ├── 1_analysis_of_needs.md
│   │   ├── 2_database_structure.md
│   │   ├── 3_scenarios_and_endpoints.md
│   │   ├── 4_api_general_rules.md
│   │   ├── 5_dynamic_data_model.md
│   │   └── bd.png
│   └── remarks_of_conception.md
├── .gitattributes
├── .github
│   └── workflows
│       └── ci-cd.yml
├── .gitignore
├── import_context.sh
├── import_context_window.ps1
├── mvnw
├── mvnw.cmd
├── pom.xml
├── project_context.txt
├── Readme.md
├── reset_db.bat
├── reset_db.sh
├── run_local.bat
├── run_local.sh
├── src
│   ├── main
│   │   ├── java
│   │   │   └── com
│   │   │       └── yowyob
│   │   │           └── fleet
│   │   │               ├── application
│   │   │               │   └── service
│   │   │               │       ├── AuthService.java
│   │   │               │       ├── DriverService.java
│   │   │               │       ├── FleetService.java
│   │   │               │       └── VehicleService.java
│   │   │               ├── domain
│   │   │               │   ├── model
│   │   │               │   │   ├── Driver.java
│   │   │               │   │   ├── Fleet.java
│   │   │               │   │   ├── FleetManager.java
│   │   │               │   │   ├── Vehicle.java
│   │   │               │   │   └── VehicleParameters.java
│   │   │               │   └── ports
│   │   │               │       ├── in
│   │   │               │       │   ├── AuthUseCase.java
│   │   │               │       │   ├── ManageDriverUseCase.java
│   │   │               │       │   ├── ManageFleetUseCase.java
│   │   │               │       │   └── ManageVehicleUseCase.java
│   │   │               │       └── out
│   │   │               │           ├── AuthPort.java
│   │   │               │           ├── DriverPersistencePort.java
│   │   │               │           ├── ExternalVehiclePort.java
│   │   │               │           ├── FleetManagerPersistencePort.java
│   │   │               │           ├── FleetRepositoryPort.java
│   │   │               │           └── VehiclePersistencePort.java
│   │   │               ├── FleetManagementApplication.java
│   │   │               └── infrastructure
│   │   │                   ├── adapters
│   │   │                   │   ├── inbound
│   │   │                   │   │   └── rest
│   │   │                   │   │       ├── AccountController.java
│   │   │                   │   │       ├── AuthController.java
│   │   │                   │   │       ├── DriverController.java
│   │   │                   │   │       ├── dto
│   │   │                   │   │       │   ├── ChangePasswordRequest.java
│   │   │                   │   │       │   ├── DriverRegistrationRequest.java
│   │   │                   │   │       │   ├── FinancialUpdateRequest.java
│   │   │                   │   │       │   ├── FleetRequest.java
│   │   │                   │   │       │   ├── FleetResponse.java
│   │   │                   │   │       │   ├── LoginRequest.java
│   │   │                   │   │       │   ├── MaintenanceUpdateRequest.java
│   │   │                   │   │       │   ├── RegisterRequest.java
│   │   │                   │   │       │   ├── UpdateProfileRequest.java
│   │   │                   │   │       │   └── VehicleRegistrationRequest.java
│   │   │                   │   │       ├── FleetController.java
│   │   │                   │   │       ├── GlobalExceptionHandler.java
│   │   │                   │   │       ├── HealthCheckController.java
│   │   │                   │   │       └── VehicleController.java
│   │   │                   │   └── outbound
│   │   │                   │       ├── external
│   │   │                   │       │   ├── client
│   │   │                   │       │   │   ├── AuthApiClient.java
│   │   │                   │       │   │   └── VehicleApiClient.java
│   │   │                   │       │   ├── dto
│   │   │                   │       │   │   └── VehicleExternalResponse.java
│   │   │                   │       │   ├── FakeAuthAdapter.java
│   │   │                   │       │   ├── RemoteAuthAdapter.java
│   │   │                   │       │   └── VehicleApiAdapter.java
│   │   │                   │       └── persistence
│   │   │                   │           ├── DriverPersistenceAdapter.java
│   │   │                   │           ├── entity
│   │   │                   │           │   ├── DriverEntity.java
│   │   │                   │           │   ├── FinancialParameterEntity.java
│   │   │                   │           │   ├── FleetEntity.java
│   │   │                   │           │   ├── FleetManagerEntity.java
│   │   │                   │           │   ├── MaintenanceParameterEntity.java
│   │   │                   │           │   ├── OperationalParameterEntity.java
│   │   │                   │           │   └── VehicleLocalEntity.java
│   │   │                   │           ├── FleetManagerPersistenceAdapter.java
│   │   │                   │           ├── FleetPersistenceAdapter.java
│   │   │                   │           ├── repository
│   │   │                   │           │   ├── DriverR2dbcRepository.java
│   │   │                   │           │   ├── FinancialParameterR2dbcRepository.java
│   │   │                   │           │   ├── FleetManagerR2dbcRepository.java
│   │   │                   │           │   ├── FleetR2dbcRepository.java
│   │   │                   │           │   ├── MaintenanceParameterR2dbcRepository.java
│   │   │                   │           │   └── VehicleLocalR2dbcRepository.java
│   │   │                   │           └── VehiclePersistenceAdapter.java
│   │   │                   ├── config
│   │   │                   │   ├── AuthConfig.java
│   │   │                   │   ├── KafkaConfig.java
│   │   │                   │   ├── OpenApiConfig.java
│   │   │                   │   ├── RedisConfig.java
│   │   │                   │   ├── SecurityConfig.java
│   │   │                   │   └── WebClientConfig.java
│   │   │                   └── mappers
│   │   │                       ├── DriverMapper.java
│   │   │                       ├── FleetMapper.java
│   │   │                       └── VehicleLocalMapper.java
│   │   └── resources
│   │       ├── application.yml
│   │       ├── db
│   │       │   └── changelog
│   │       │       ├── changes
│   │       │       │   ├── 001-init-schemas.sql
│   │       │       │   └── 002-fleet-tables.sql
│   │       │       ├── data
│   │       │       │   └── 001-local-public-mock.sql
│   │       │       └── db.changelog-master.yaml
│   │       ├── db_updates_by_gabriel.zip
│   │       ├── prod.application.yml
│   │       └── schema.sql.bak
│   └── test
│       └── java
│           └── com
│               └── yowyob
│                   └── reactive_hexagonal
│                       └── ReactiveHexagonalApplicationTests.java
├── sync_auth.sh
└── todo.md

45 directories, 114 files
```
## 2. Contenu des Fichiers

---
### Fichier : `./bin/docs/contracts_fleet_management.md`
```md
# **API Contracts v1.0 - Fleet Management Service**

This document defines the data contracts and endpoints for the **Fleet Management API** of the TraEnSys project. This service is responsible for managing fleets, vehicles, drivers, tracking trips, and handling geofencing.

## 1. Physical Data Model (Tables)

This section describes the database tables that support the service, based on the class diagram and incorporating the required corrections.

### 1.1. Core Tables

**Table: `fleets`**
Stores information about each vehicle fleet.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the fleet. |
| `name` | VARCHAR(255) | NOT NULL | The public name of the fleet. |
| `creationDate` | DATE | NOT NULL | Date when the fleet was created. |
| `managerUserId`| UUID | FOREIGN KEY | References the `id` of the user (Fleet Manager) in the authentication service. |

**Table: `vehicles`**
Stores all data related to a single vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the vehicle. |
| `fleetId` | UUID | FOREIGN KEY, NOT NULL | The fleet to which the vehicle belongs (`fleets`). |
| `licensePlate` | VARCHAR(50) | NOT NULL, UNIQUE | The vehicle's unique license plate. |
| `brand` | VARCHAR(100) | | Brand of the vehicle (e.g., Toyota). |
| `model` | VARCHAR(100) | | Model of the vehicle (e.g., Yaris). |
| `manufacturingYear` | INT | | The year the vehicle was manufactured. |
| `type` | VEHICLE_TYPE (Enum) | | The type of vehicle (CAR, TRUCK, VAN, BIKE). |
| `color` | VARCHAR(50) | | Color of the vehicle. |

**Table: `drivers`**
Contains information specific to the driver role.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `userId` | UUID | PRIMARY KEY, FOREIGN KEY| References the corresponding user in the authentication service. |
| `assignedVehicleId` | UUID | FOREIGN KEY, UNIQUE | The vehicle currently assigned to the driver (`vehicles`). Can be NULL. |
| `licenceNumber` | VARCHAR(100) | NOT NULL, UNIQUE | The driver's license number. |
| `status` | BOOLEAN | NOT NULL | Indicates if the driver is active (`true`) or inactive (`false`). |

**Table: `trips`**
Logs every trip made by a vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the trip. |
| `vehicleId` | UUID | FOREIGN KEY, NOT NULL | The vehicle that made the trip (`vehicles`). |
| `driverId` | UUID | FOREIGN KEY, NOT NULL | The driver who made the trip (`drivers`). |
| `startDate` | DATE | NOT NULL | The date the trip started. |
| `endDate` | DATE | | The date the trip ended. |
| `startTime` | TIME | NOT NULL | The time the trip started. |
| `endTime` | TIME | | The time the trip ended. |
| `type` | VEHICLE_TYPE (Enum) | | Type of vehicle used (redundant but useful for history). |
| `color` | VARCHAR(50) | | Color of the vehicle (redundant but useful for history). |

### 1.2. Parameter Tables (1-to-1 Relationship with `vehicles`)

**Table: `financial_parameters`**

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL | Linked to a single vehicle (`vehicles`). |
| `insuranceNumber` | VARCHAR(100) | | Insurance policy number. |
| `insuranceExpiryDate` | DATE | | Expiry date of the insurance. |
| `registrationDate`| DATE | | The vehicle's registration date. |
| `purchaseDate` | DATE | | Date the vehicle was purchased. |
| `depreciationRate`| INT | | Annual depreciation rate (as a %). |
| `costPerKm` | FLOAT | | Estimated operational cost per kilometer. |

**Table: `maintenance_parameters`**

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL| Linked to a single vehicle (`vehicles`). |
| `lastMaintenanceDate` | DATE | | Date of the last maintenance. |
| `nextMaintenanceDue` | DATE | | Date when the next maintenance is due. |
| `engineStatus` | ENGINE_STATUS (Enum) | | Status of the engine (OK, NEEDS_SERVICE...). |
| `batteryHealth` | INT | | The health of the battery (as a %). |
| `maintenanceStatus` | MAINTENANCE_STATUS (Enum) | | Overall maintenance status (UP_TO_DATE, PENDING...). |

**Table: `operational_parameters`**
Stores real-time data for a vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL| Linked to a single vehicle (`vehicles`). |
| `currentTripId` | UUID | FOREIGN KEY | The current trip for this vehicle (`trips`). Can be NULL. |
| `status` | BOOLEAN | NOT NULL | Operational status (e.g., `true` for in-service). |
| `currentLocationPointId` | UUID | FOREIGN KEY | The last known GPS coordinate (`geofence_points`). |
| `currentSpeed` | FLOAT | | The vehicle's current speed in km/h. |
| `fuelLevel` | VARCHAR(50) | | Current fuel level (e.g., "75%", "12/16"). |
| `mileage` | FLOAT | | Total mileage of the vehicle. |
| `odometerReading`| FLOAT | | The reading from the odometer. |
| `bearing` | FLOAT | | The vehicle's direction of travel in degrees (0-360). |
| `timestamp` | DATETIME | | Timestamp of the last data update. |

### 1.3. Geofencing and Route Tables

**Table: `geofence_zones`**
Defines a geographical zone.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the zone. |
| `name` | VARCHAR(255) | NOT NULL | Name of the zone (e.g., "Mokolo Market Area"). |
| `surfaceArea` | INT | | Area of the zone. |
| `perimeter` | INT | | Perimeter of the zone. |

**Table: `geofence_points`**
Stores the coordinates that define the vertices of geofence zones or points on a route.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the point. |
| `latitude` | FLOAT | NOT NULL | Latitude coordinate. |
| `longitude` | FLOAT | NOT NULL | Longitude coordinate. |

**Table: `geofence_zone_vertices` (Pivot Table)**
Associates points with a zone to form a polygon.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `zoneId` | UUID | FOREIGN KEY, PK | References the zone (`geofence_zones`). |
| `pointId` | UUID | FOREIGN KEY, PK | References the point (`geofence_points`). |
| `vertexOrder` | INT | NOT NULL | The order of the point in the polygon sequence. |

**Table: `routes`**
Defines a route with a start and end point.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the route. |
| `startPointId` | UUID | FOREIGN KEY | The starting point (`geofence_points`). |
| `endPointId` | UUID | FOREIGN KEY | The ending point (`geofence_points`). |

**Table: `trip_routes` (Pivot Table)**
Junction table for the N-N relationship between `trips` and `routes`.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `tripId` | UUID | FOREIGN KEY, PK | References the trip (`trips`). |
| `routeId` | UUID | FOREIGN KEY, PK | References the route (`routes`). |

**Table: `geofence_events`**
Logs every time a vehicle enters or exits a zone.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the event. |
| `zoneId` | UUID | FOREIGN KEY, NOT NULL | The zone involved (`geofence_zones`). |
| `vehicleId` | UUID | FOREIGN KEY, NOT NULL | The vehicle involved (`vehicles`). |
| `timestamp` | DATETIME | NOT NULL | The exact time of the event. |
| `type` | EVENT_TYPE (Enum) | NOT NULL | Type of event (ENTRY or EXIT). |

---


## 2. Data Representation

### 2.1. Fleet Model
Represents a collection of vehicles managed by a Fleet Manager.

```json
{
  "id": "f1a2b3c4-fleet-0001-d5e6f7g8h9i0",
  "name": "Yaoundé Express Voyage",
  "creationDate": "2025-01-15",
  "manager": {
    "userId": "7b2e3f4a-1c9d-4b8a-8e6f-2d3c4b5a6d7e",
    "name": "Gabriel Nomo"
  },
  "vehicleCount": 15
}
```

### 2.2. Vehicle Model (Detailed)
Represents a single vehicle with all its associated parameters.

```json
{
  "id": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
  "fleetId": "f1a2b3c4-fleet-0001-d5e6f7g8h9i0",
  "licensePlate": "CE 123 AB",
  "brand": "Toyota",
  "model": "Yaris",
  "manufacturingYear": 2022,
  "type": "CAR",
  "color": "White",
  "assignedDriver": {
    "userId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
    "name": "Aissatou Bello"
  },
  "financialParameters": {
    "insuranceNumber": "INS-YDE-2025-8843",
    "insuranceExpiryDate": "2026-06-30",
    "registrationDate": "2022-07-15",
    "purchaseDate": "2022-07-01",
    "depreciationRate": 15,
    "costPerKm": 125.5
  },
  "maintenanceParameters": {
    "lastMaintenanceDate": "2025-09-10",
    "nextMaintenanceDue": "2026-03-10",
    "engineStatus": "OK",
    "batteryHealth": 92,
    "maintenanceStatus": "UP_TO_DATE"
  },
  "operationalParameters": {
    "status": true,
    "currentSpeed": 45.5,
    "fuelLevel": "65%",
    "mileage": 45012.8,
    "odometerReading": 45012.8,
    "bearing": 182.5,
    "timestamp": "2025-10-30T14:22:10.000Z",
    "currentLocation": {
      "latitude": 3.8667,
      "longitude": 11.5167
    }
  }
}
```

### 2.3. Driver Model
Represents the fleet-specific information of a driver.

```json
{
  "userId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
  "licenceNumber": "YDE/DR/2018/98765",
  "status": true,
  "assignedVehicle": {
    "vehicleId": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
    "licensePlate": "CE 123 AB"
  },
  "userProfile": {
    "name": "Aissatou Bello",
    "phone": "+237699112233"
  }
}
```

### 2.4. Trip Model

```json
{
  "id": "t1r2i3p4-a5b6-4c7d-8e9f-a0b1c2d3e4f5",
  "vehicleId": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
  "driverId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
  "startDate": "2025-10-30",
  "startTime": "08:15:00",
  "endDate": "2025-10-30",
  "endTime": "09:05:00",
  "routes": [
    {
      "routeId": "r1o2u3t4e-001",
      "startPoint": { "latitude": 3.8721, "longitude": 11.5173 },
      "endPoint": { "latitude": 3.8472, "longitude": 11.5015 }
    }
  ]
}
```

### 2.5. Geofence Zone Model

```json
{
  "id": "z1o2n3e4-a5b6-4c7d-8e9f-a0b1c2d3e4f5",
  "name": "Mokolo Market Area",
  "surfaceArea": 1.5,
  "perimeter": 5.2,
  "vertices": [
    { "latitude": 3.8750, "longitude": 11.5000, "order": 1 },
    { "latitude": 3.8790, "longitude": 11.5050, "order": 2 },
    { "latitude": 3.8760, "longitude": 11.5080, "order": 3 },
    { "latitude": 3.8710, "longitude": 11.5030, "order": 4 }
  ]
}
```
---

## 3. General API Rules

-   **Base URL**: `/api/v1`
-   **Data Format**: `application/json`
-   **Authentication**: Header `Authorization: Bearer <JWT_TOKEN>`
-   **Error Handling**:
    ```json
    {
      "timestamp": "2025-10-30T10:30:00.000Z",
      "status": 404,
      "error": "Not Found",
      "message": "Vehicle with ID 'v-invalid-id' not found.",
      "path": "/api/v1/vehicles/v-invalid-id"
    }
    ```
---

## 4. Fleet Management API Endpoints

### 4.1. Fleets (`/fleets`)

#### `POST /fleets`
-   **Description**: Creates a new fleet.
-   **Access**: Authenticated (`fleet:fleet:create`).
-   **Request (Body)**: `{"name": "Douala City Transports", "managerUserId": "a9b8c7d6..."}`
-   **Response (`201 Created`)**: The newly created Fleet object.

#### `GET /fleets`
-   **Description**: Retrieves a list of fleets. For a Fleet Manager, returns only their fleets. For an Admin, returns all fleets.
-   **Access**: Authenticated (`fleet:fleet:read`).
-   **Response (`200 OK`)**: An array of Fleet objects.

#### `GET /fleets/{fleetId}`
-   **Description**: Retrieves detailed information for a specific fleet.
-   **Access**: Authenticated (`fleet:fleet:read`).
-   **Response (`200 OK`)**: A single detailed Fleet object.

#### `PUT /fleets/{fleetId}`
-   **Description**: Updates the details of an existing fleet.
-   **Access**: Authenticated (`fleet:fleet:update`).
-   **Request (Body)**: `{"name": "Douala Premium Transports", "managerUserId": "a9b8c7d6..."}`
-   **Response (`200 OK`)**: The updated Fleet object.

#### `DELETE /fleets/{fleetId}`
-   **Description**: Deletes a fleet. Business logic should prevent deletion if the fleet still contains vehicles.
-   **Access**: Authenticated (`fleet:fleet:delete`).
-   **Response (`204 No Content`)**.

### 4.2. Vehicles (`/vehicles`)

#### `POST /fleets/{fleetId}/vehicles`
-   **Description**: Adds a new vehicle to a specified fleet.
-   **Access**: Authenticated (`fleet:vehicle:create`).
-   **Request (Body)**: `{ "licensePlate": "CE 789 EF", "brand": "Toyota", "model": "RAV4", ... }`
-   **Response (`201 Created`)**: The full detailed Vehicle Model.

#### `GET /vehicles`
-   **Description**: Retrieves a paginated list of all vehicles accessible to the user.
-   **Access**: Authenticated (`fleet:vehicle:read`).
-   **Query Parameters**: `?fleetId={id}&type=CAR&status=true`
-   **Response (`200 OK`)**: An array of Vehicle objects.

#### `GET /vehicles/{vehicleId}`
-   **Description**: Retrieves the complete details of a single vehicle.
-   **Access**: Authenticated (`fleet:vehicle:read`).
-   **Response (`200 OK`)**: The full Vehicle Model JSON.

#### `PUT /vehicles/{vehicleId}`
-   **Description**: Updates the core details of a vehicle (brand, model, color, etc.).
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "model": "Corolla", "color": "Blue", "manufacturingYear": 2021 }`
-   **Response (`200 OK`)**: The updated full Vehicle Model.

#### `DELETE /vehicles/{vehicleId}`
-   **Description**: Deletes a vehicle from the system.
-   **Access**: Authenticated (`fleet:vehicle:delete`).
-   **Response (`204 No Content`)**.

#### `PUT /vehicles/{vehicleId}/financial-parameters`
-   **Description**: Updates the financial parameters for a specific vehicle.
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "insuranceNumber": "INS-NEW-2025-1111", "costPerKm": 130.0 }`
-   **Response (`200 OK`)**: The updated Financial Parameters object.

#### `PUT /vehicles/{vehicleId}/maintenance-parameters`
-   **Description**: Updates the maintenance parameters for a specific vehicle.
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "lastMaintenanceDate": "2025-10-28", "engineStatus": "NEEDS_SERVICE" }`
-   **Response (`200 OK`)**: The updated Maintenance Parameters object.

### 4.3. Drivers (`/drivers`)

#### `POST /drivers`
-   **Description**: Registers an existing system user as a driver.
-   **Access**: Authenticated (`fleet:driver:create`).
-   **Request (Body)**: `{ "userId": "u1s2e3r4...", "licenceNumber": "LT/DR/2020/11223" }`
-   **Response (`201 Created`)**: The full Driver Model.

#### `GET /drivers`
-   **Description**: Retrieves a list of all drivers.
-   **Access**: Authenticated (`fleet:driver:read`).
-   **Query Parameters**: `?status=true`
-   **Response (`200 OK`)**: An array of Driver objects.

#### `GET /drivers/{driverUserId}`
-   **Description**: Retrieves the profile for a specific driver.
-   **Access**: Authenticated (`fleet:driver:read`).
-   **Response (`200 OK`)**: A single Driver Model object.

#### `PUT /drivers/{driverUserId}`
-   **Description**: Updates a driver's fleet-specific information.
-   **Access**: Authenticated (`fleet:driver:update`).
-   **Request (Body)**: `{ "licenceNumber": "YDE/DR/2022/55443", "status": false }`
-   **Response (`200 OK`)**: The updated Driver Model.

#### `DELETE /drivers/{driverUserId}`
-   **Description**: De-registers a user as a driver (does not delete the user account).
-   **Access**: Authenticated (`fleet:driver:delete`).
-   **Response (`204 No Content`)**.

#### `POST /drivers/{driverUserId}/assign-vehicle`
-   **Description**: Assigns a vehicle to a driver.
-   **Access**: Authenticated (`fleet:driver:assign`).
-   **Request (Body)**: `{ "vehicleId": "v1e2h3c4..." }`
-   **Response (`200 OK`)**: `{ "message": "Vehicle assigned successfully." }`

#### `POST /drivers/{driverUserId}/unassign-vehicle`
-   **Description**: Unassigns the current vehicle from a driver.
-   **Access**: Authenticated (`fleet:driver:assign`).
-   **Response (`200 OK`)**: `{ "message": "Vehicle unassigned successfully." }`

### 4.4. Trips (`/trips`)

#### `POST /trips`
-   **Description**: Starts a new trip for a vehicle.
-   **Access**: Authenticated (`fleet:trip:create`).
-   **Request (Body)**: `{ "vehicleId": "v1e2h3c4...", "driverId": "d1r2i3v4...", "startDate": "2025-10-31", "startTime": "09:00:00" }`
-   **Response (`201 Created`)**: The new Trip object.

#### `GET /trips`
-   **Description**: Retrieves a list of trips, with filtering options.
-   **Access**: Authenticated (`fleet:trip:read`).
-   **Query Parameters**: `?vehicleId={id}&driverId={id}&startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`
-   **Response (`200 OK`)**: An array of Trip objects.

#### `GET /trips/{tripId}`
-   **Description**: Retrieves the details of a single trip.
-   **Access**: Authenticated (`fleet:trip:read`).
-   **Response (`200 OK`)**: A single Trip Model object.

#### `POST /trips/{tripId}/end`
-   **Description**: Ends an active trip.
-   **Access**: Authenticated (`fleet:trip:update`).
-   **Request (Body)**: `{ "endDate": "2025-10-31", "endTime": "11:30:00" }`
-   **Response (`200 OK`)**: The updated Trip object.

### 4.5. Geofencing (`/geofence`)

#### `POST /geofence/zones`
-   **Description**: Creates a new geofence zone.
-   **Access**: Authenticated (`fleet:geofence:create`).
-   **Request (Body)**: `{ "name": "Bastos Residential Area", "vertices": [...] }`
-   **Response (`201 Created`)**: The full Geofence Zone Model.

#### `GET /geofence/zones`
-   **Description**: Retrieves a list of all defined geofence zones.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Response (`200 OK`)**: An array of Geofence Zone objects.

#### `GET /geofence/zones/{zoneId}`
-   **Description**: Retrieves the details of a single geofence zone.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Response (`200 OK`)**: A single Geofence Zone Model object.

#### `PUT /geofence/zones/{zoneId}`
-   **Description**: Updates a geofence zone's name or vertices.
-   **Access**: Authenticated (`fleet:geofence:update`).
-   **Request (Body)**: `{ "name": "Bastos VIP Area", "vertices": [...] }`
-   **Response (`200 OK`)**: The updated Geofence Zone Model.

#### `DELETE /geofence/zones/{zoneId}`
-   **Description**: Deletes a geofence zone.
-   **Access**: Authenticated (`fleet:geofence:delete`).
-   **Response (`204 No Content`)**.

#### `GET /geofence/events`
-   **Description**: Retrieves a log of geofence events, with optional filters.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Query Parameters**: `?vehicleId={id}&zoneId={id}&type=ENTRY&startDate=YYYY-MM-DD`
-   **Response (`200 OK`)**: An array of geofence event objects.```

---
### Fichier : `./bin/docs/remarks_of_conception.md`
```md
# Remarques cahier d'analyse et conception

# Objectif
L'objectif de ce document est de fournir des remarques pour le cahier d'analyse et conception du projet Fleet management et geofence s'integrant dans le projet synthese de 5Gi: Trans Ens

# Liste des remarques

Chaque remarque sera constitue d'un page du titre de la remarque et de la description

---
## R1: raphael au feminin 

**page**: 2

**descripion**:  
Bihai rapahel
rapahel est ecrit au feminin,est-ce normal?

---
## R2: utilisation de FareCalculator

**page** : 14

**description** : Notre systeme utilisera t'il reellement farecalculator ? si oui dans quel cas d'utilisation ?

---

## R3: Absence de Navigoo dans le diagarmme de contexte

**page** : 14

**description** : Notre systeme utilisera certainement l'api des cartes pour montrer au client,chauffeur,fleet amanager mais notre diagaramme de contexte de le met pas en evidence

---

## R4: fautre d'orthographe

**page** : 14

**description** : les acteurs (qui utilise le système),le verbe utiliser doit etre a la 3e personne du pluriel(`avec ent`)

---

## R5: Probleme de coherence entre les diagrammes de cas d'utilisation et de contexte

**page** : 14 et 15

**description** : sur le diagramme de contexte,on voit bien que farecalculator fait partie des acteurs externes et le customer aussi mais dans le diagramme de cas d'utilisation,on ne les retrpiuve pas. De plus,on retrouve navigoo qui n'etait pas dans le diagramme de contexte. 

---

## R6: diagramme de use case,coherence dans le regroupement des use case

**page** : 15

**description** : 
Je remarque la factorisation qui est regroupage elegant des cas d'utilisation dans ce diagramme par l'heritage,ce qui est une bnne chose mais pour l'acteur fleet manager,je trouve que ce n'est pas suffisemment regroupe pour le management des vehicule(je parle de track vehicule,view vehicule statictics qui selpon moi sont des sous-cas de manage vehicule)

---
## R7: diagramme de sequence systeme
**page** : 29

**description** : 
- la methode valider identifiant que le systeme envoir a l'api d'auth doit etre une fonction ayant pour parametre les identifiants(email,mot de passe)

- Il y'a egalement un probleme de coherence linguistique,depuis le debut tous les diagrammes sont en anglais,mais celui ci est en francais.il nous faut une seule langue.

- est ce que le token est un message ou une variable? je crois aussi qu'ici c'est une fontion que l'api d'auth utilise pour envoyer le token et le role...aussi le role 
---
```

---
### Fichier : `./bin/docs/data/YOWYOB_DB/yowyob_db_seed.sql`
```sql
-- =====================================================
-- YOWYOB DB - DATA SEEDING SCRIPT
-- PostgreSQL
-- =====================================================

BEGIN;

-- =====================================================
-- 1. CLEANUP EXISTING DATA
-- =====================================================
TRUNCATE TABLE 
    users, images, countries, business_actors, 
    admins, fleet_managers, drivers, customers, 
    providers, employees, prospects, sales_persons,
    profiles, settings, addresses, contacts,
    roles, permissions, role_has_permissions, user_has_roles,
    organizations, agencies, business_domains, organization_business_domains,
    certifications, third_parties, proposed_activities, services, branches,
    fleets, vehicles, geofence_zones, geofence_points, geofence_events,
    roads, trips, offers, rides, reviews, offer_driver_linkages,
    operational_parameters, financial_parameters, maintenance_parameters,
    geofence_point_zone_linkages,
    syndicats, abstract_products, products, 
    publications, publication_images, publication_votes, votes,
    events, event_images, reactions, comments, avis,
    subscriptions, payments
    RESTART IDENTITY CASCADE;

-- =====================================================
-- 2. STATIC REFERENCE DATA
-- =====================================================

-- Countries
INSERT INTO countries (name, code) VALUES
('Cameroun', 'CM'), ('Sénégal', 'SN'), ('Côte d''Ivoire', 'CI'), 
('Gabon', 'GA'), ('Nigéria', 'NG'), ('Togo', 'TG');

-- Roles
INSERT INTO roles (name, guard_name) VALUES
('ADMIN', 'web'), ('FLEET_MANAGER', 'web'), ('DRIVER', 'web'), ('CUSTOMER', 'web');

-- Images (Random placeholders from Picsum)
INSERT INTO images (url, alt_text) 
SELECT 
    'https://picsum.photos/seed/' || i || '/800/600', 
    'Image aléatoire ' || i
FROM generate_series(1, 50) as i;

-- =====================================================
-- 3. USERS GENERATION (100 users)
-- =====================================================

INSERT INTO users (name, phone_number, email_address)
SELECT 
    (ARRAY['Mamadou', 'Jean-Pierre', 'Ibrahim', 'Fatou', 'Aminata', 'Ngolo', 'Aboubakar', 'Clarisse', 'Samuel', 'Kouamé', 'Aissatou', 'Bachelard', 'Landry', 'Thérèse'])[floor(random()*14)+1] 
    || ' ' || 
    (ARRAY['Diop', 'Njoya', 'Mbarga', 'Kone', 'Sow', 'Etoundi', 'Kamga', 'Traoré', 'Diallo', 'Fofana', 'Mensah', 'Atangana', 'Eto''o', 'Drogba'])[floor(random()*14)+1],
    (ARRAY['+237', '+221', '+225'])[floor(random()*3)+1] || (600000000 + floor(random()*99999999)::int),
    'user_' || i || '@yowyob.test'
FROM generate_series(1, 100) as i;

-- Settings & Profiles
INSERT INTO settings (user_id, theme, language, receive_push_notifications)
SELECT id, 'LIGHT', 'fr', true FROM users;

INSERT INTO profiles (user_id, first_name, nationality, is_verified)
SELECT id, split_part(name, ' ', 1), 'Camerounais', (random() > 0.5) FROM users;

-- =====================================================
-- 4. ACTORS DISPATCHING
-- User -> BusinessActor -> SpecificActor
-- =====================================================

-- 4.1 Admins (First 5 users)
INSERT INTO admins (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5;

-- 4.2 Fleet Managers (Next 5 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- STEP 2: Insert into CHILD (FleetManager)
INSERT INTO fleet_managers (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- 4.3 Drivers (Next 30 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- STEP 2: Insert into CHILD (Driver)
INSERT INTO drivers (id, status, license_number, has_car)
SELECT 
    id, 
    (ARRAY['AVAILABLE', 'BUSY', 'OFFLINE'])[floor(random()*3)+1], 
    'LIC-' || floor(random()*100000) || '-CM',
    (random() > 0.3)
FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- 4.4 Customers (Remaining 60 users)
INSERT INTO customers (id, code, payment_method)
SELECT 
    id, 
    'CUST-' || substr(id::text, 1, 8),
    (ARRAY['CASH', 'MOBILE_MONEY', 'CARD'])[floor(random()*3)+1]
FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- Assign Roles
INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'ADMIN') FROM users ORDER BY email_address LIMIT 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'FLEET_MANAGER') FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'DRIVER') FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'CUSTOMER') FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- =====================================================
-- 5. ORGANIZATIONS & AGENCIES
-- =====================================================

INSERT INTO organizations (
    business_actor_id, logo_id, code, short_name, long_name, 
    description, tax_number, is_active, status
)
SELECT
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    (SELECT id FROM images ORDER BY random() LIMIT 1),
    'ORG-' || i,
    'Transport ' || i,
    'Société de Transport ' || i,
    'Description ' || i,
    'TAX-' || floor(random()*1000000),
    true,
    'PUBLISHED'
FROM generate_series(1, 35) as i;

INSERT INTO agencies (
    organization_id, manager_id, name, city, location, is_headquarter
)
SELECT 
    id, 
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    'Agence Centrale',
    (ARRAY['Douala', 'Yaoundé', 'Abidjan'])[floor(random()*3)+1],
    'Rue Principale',
    true
FROM organizations;

-- =====================================================
-- 6. FLEETS & VEHICLES
-- =====================================================

INSERT INTO fleets (fleet_manager_id, name, phone_number)
SELECT 
    id, 'Flotte de ' || name, '+237699000000'
FROM fleet_managers;

-- Vehicles
INSERT INTO vehicles (
    fleet_id, user_id, driver_id, license_plate, brand, model, type, color, manufacturing_year
)
SELECT 
    f.id,
    f.fleet_manager_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    'LT-' || floor(random()*999)::text || '-AA',
    (ARRAY['Toyota', 'Peugeot'])[floor(random()*2)+1],
    (ARRAY['Yaris', 'Partner'])[floor(random()*2)+1],
    (ARRAY['CAR', 'VAN'])[floor(random()*2)+1]::vehicle_type_enum,
    'Jaune',
    2020
FROM fleets f;

-- =====================================================
-- 7. OFFERS & RIDES
-- =====================================================

INSERT INTO offers (
    passenger_id, start_point, end_point, price, state, created_at
)
SELECT 
    (SELECT id FROM customers ORDER BY random() LIMIT 1),
    'Point A', 'Point B', 
    2000, 
    'CHOSEN',
    NOW()
FROM generate_series(1, 60) as i;

-- Rides
INSERT INTO rides (
    offer_id, passenger_id, driver_id, 
    distance, time_estimation, real_time, state, created_at
)
SELECT 
    id, -- offer_id
    passenger_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    15.5, 30, 35,
    'COMPLETED',
    created_at
FROM offers 
LIMIT 40;

-- Reviews
INSERT INTO reviews (ride_id, author_id, subject, comment, rating)
SELECT 
    id,
    passenger_id,
    'Chauffeur',
    'Bonne course, chauffeur ponctuel',
    5
FROM rides
WHERE state = 'COMPLETED';

-- =====================================================
-- 8. PRODUCTS
-- =====================================================

INSERT INTO products (
    organization_id, name, description, standard_price, 
    status, is_active, departure_location
)
SELECT 
    (SELECT id FROM organizations ORDER BY random() LIMIT 1),
    'Trajet Spécial ' || i,
    'Description produit',
    5000,
    'PUBLISHED',
    true,
    'Douala'
FROM generate_series(1, 40) as i;

-- =====================================================
-- 9. SUBSCRIPTIONS & PAYMENTS
-- =====================================================

INSERT INTO subscriptions (
    admin_id, label, price, duration_in_days, description, is_active
) VALUES 
((SELECT id FROM admins LIMIT 1), 'Pack Hebdo', 2500, 7, 'Standard', true),
((SELECT id FROM admins LIMIT 1), 'Pack Mensuel', 10000, 30, 'Pro', true),
((SELECT id FROM admins LIMIT 1), 'Pack Annuel', 100000, 365, 'VIP', true);

INSERT INTO payments (
    driver_id, user_id, subscription_id, amount_paid, status, id_provider_transaction, created_at
)
SELECT 
    d.id, -- Driver ID
    d.id, -- Payer ID
    s.id, -- Subscription ID
    s.price,
    'SUCCESS',
    'TXN-' || floor(random()*10000000),
    NOW()
FROM drivers d
CROSS JOIN subscriptions s
ORDER BY random()
LIMIT 50;

-- =====================================================
-- 10. SOCIAL & ADDRESSES
-- =====================================================

INSERT INTO syndicats (organization_id, name, is_approved)
SELECT id, 'Syndicat Transports', true FROM organizations LIMIT 1;

INSERT INTO branches (id, syndicat_id, name, location)
SELECT 
    ag.id,
    (SELECT id FROM syndicats LIMIT 1),
    'Branche ' || ag.name, 
    ag.location 
FROM agencies ag 
LIMIT 10;

INSERT INTO publications (branch_id, author_id, content, status, n_likes)
SELECT 
    (SELECT id FROM branches ORDER BY random() LIMIT 1),
    (SELECT id FROM admins ORDER BY random() LIMIT 1),
    'Info Trafic ' || i,
    'PUBLISHED',
    floor(random() * 50)::int
FROM generate_series(1, 40) as i;

COMMIT;```

---
### Fichier : `./bin/docs/data/YOWYOB_DB/yowyob_db_init.sql`
```sql
-- =====================================================
-- YOWYOB DB - INIT SCRIPT
-- PostgreSQL
-- Structure: Core -> Organization -> RBAC
-- =====================================================

-- Start a transaction for safety
BEGIN;

-- Fresh start
DROP SCHEMA IF EXISTS public CASCADE;
CREATE SCHEMA public;

-- Publish query paths
SET search_path TO public;

-- Extension for UUID generation
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =====================================================
-- ENUM TYPES
-- =====================================================

CREATE TYPE status_enum AS ENUM (
  'DRAFT', 'WAITING_CONFIRMATION', 'PUBLISHED', 'IN_PROGRESS', 'CANCELLED', 'EXPIRED'
);

CREATE TYPE category_enum AS ENUM (
  'ANNOUNCE', 'PLANNING', 'VEHICLE', 'ADDRESS', 'EXPERIENCE'
);

CREATE TYPE action_enum AS ENUM (
  'CREATE', 'UPDATE', 'READ', 'DELETE'
);

CREATE TYPE vehicle_type_enum AS ENUM (
  'CAR', 'VAN', 'TRUCK', 'BIKE'
);

CREATE TYPE offer_state_enum AS ENUM (
  'NEW', 'PENDING', 'CHOSEN', 'TERMINATED', 'CANCELED'
);

CREATE TYPE ride_state_enum AS ENUM (
  'CONFIRMED', 'ONGOING', 'COMPLETED', 'CANCELED'
);

CREATE TYPE event_type_enum AS ENUM (
  'ENTRY', 'EXIT'
);

CREATE TYPE maintenance_status_enum AS ENUM (
  'UP_TO_DATE', 'PENDING', 'OVERDUE'
);

CREATE TYPE engine_status_enum AS ENUM (
  'OK', 'NEED_SERVICE', 'OUT_OF_SERVICE'
);

CREATE TYPE role_type_enum AS ENUM (
  'CUSTOMER', 'DRIVER', 'FLEET_MANAGER', 'ADMIN', 'PASSENGER', 'PRESIDENT', 'MODERATOR', 'CLIENT'
);

CREATE TYPE type_enum AS ENUM (
  'NOTIFICATION', 'CHAT', 'PAYMENT', 'MEDIA'
);

CREATE TYPE reaction_type_enum AS ENUM (
  'LIKE', 'LOVE', 'HAHA', 'WOW', 'SAD', 'ANGRY'
);

-- =====================================================
-- CORE TABLES
-- =====================================================

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  phone_number TEXT,
  email_address TEXT UNIQUE
);

CREATE TABLE images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url TEXT NOT NULL,
  alt_text TEXT,
  uploaded_at TIMESTAMP DEFAULT now()
);

CREATE TABLE countries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE business_actors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT,
  phone_number TEXT,
  email_address TEXT,
  CONSTRAINT fk_business_actor_user
    FOREIGN KEY (id) REFERENCES users(id)
    ON DELETE CASCADE
);

-- =====================================================
-- ORGANIZATION TABLES
-- =====================================================

CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_actor_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  email TEXT,
  short_name TEXT,
  long_name TEXT,
  description TEXT,
  logo_uri TEXT,
  website_url TEXT,
  social_network TEXT,
  business_registration_number TEXT,
  tax_number TEXT,
  capital_share NUMERIC,
  ceo_name TEXT,
  year_founded INT,
  keywords TEXT,
  number_of_employees INT,
  legal_form TEXT,
  is_active BOOLEAN DEFAULT true,
  status status_enum DEFAULT 'DRAFT',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, -- Must belong to an org

  owner_id UUID REFERENCES business_actors(id),
  manager_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  name TEXT,
  location TEXT,
  description TEXT,
  transferable BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  logo_uri TEXT,
  short_name TEXT,
  long_name TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  is_headquarter BOOLEAN DEFAULT false,
  country TEXT,
  city TEXT,
  latitude NUMERIC,
  longitude NUMERIC,
  open_time TIME,
  close_time TIME,
  phone TEXT,
  email TEXT,
  whatsapp TEXT,
  greeting_message TEXT,
  average_revenue NUMERIC,
  capital_share NUMERIC,
  registration_number TEXT,
  social_network TEXT,
  tax_number TEXT,
  keywords TEXT,
  is_public BOOLEAN DEFAULT false,
  is_business BOOLEAN DEFAULT true,
  total_affiliated_customers INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE business_domains (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL, -- optional link to organization
  parent_id UUID REFERENCES business_domains(id) ON DELETE SET NULL,   -- self-referential for hierarchy
  image_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  name TEXT,
  image_uri TEXT,
  type TEXT,
  type_label TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE organization_business_domains (
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  business_domain_id UUID REFERENCES business_domains(id) ON DELETE CASCADE,
  PRIMARY KEY (organization_id, business_domain_id)
);

CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  contactable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  contactable_type TEXT,
  first_name TEXT,
  last_name TEXT,
  title TEXT,
  is_email_verified BOOLEAN DEFAULT false,
  is_phone_number_verified BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  phone_number TEXT,
  secondary_phone_number TEXT,
  fax_number TEXT,
  email TEXT,
  secondary_email TEXT,
  email_verified_at TIMESTAMP,
  phone_verified_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE certifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  description TEXT,
  obtainment_date DATE,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE third_parties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  logo_id UUID REFERENCES images(id),

  code TEXT,
  type TEXT,
  legal_form TEXT,
  unique_identification_number TEXT,
  trade_registration_number TEXT,
  name TEXT,
  acronym TEXT,
  long_name TEXT,
  logo_uri TEXT,
  accounting_account_numbers TEXT,
  authorized_payment_methods TEXT,
  authorized_credit_limit NUMERIC,
  max_discount_rate NUMERIC,
  vat_subject BOOLEAN,
  operations_balance NUMERIC,
  opening_balance NUMERIC,
  pay_term_number INT,
  pay_term_type TEXT,
  third_party_family TEXT,
  classification TEXT,
  tax_number TEXT,
  loyalty_points NUMERIC,
  loyalty_points_used NUMERIC,
  loyalty_points_expired NUMERIC,
  enabled BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE settings (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  theme TEXT,
  language TEXT,
  long_ride_enabled BOOLEAN DEFAULT false,
  short_ride_enabled BOOLEAN DEFAULT false,
  privacy_enable BOOLEAN DEFAULT true,
  allow_calls BOOLEAN DEFAULT true,
  allow_messages BOOLEAN DEFAULT true,
  notify_new_rides BOOLEAN DEFAULT true,
  notify_ratings BOOLEAN DEFAULT true,
  notify_practical_tips BOOLEAN DEFAULT true,
  notify_promotions BOOLEAN DEFAULT true,
  notify_policy_updates BOOLEAN DEFAULT true,
  notify_peak_hour_recommendations BOOLEAN DEFAULT true,
  receive_email BOOLEAN DEFAULT true,
  receive_sms BOOLEAN DEFAULT true,
  receive_push_notifications BOOLEAN DEFAULT true,
  receive_whatsapp BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE proposed_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  rate NUMERIC,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE addresses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  addressable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  country_id UUID REFERENCES countries(id) ON DELETE SET NULL,

  addressable_type TEXT,
  type TEXT,
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  state TEXT,
  locality TEXT,
  zip_code TEXT,
  postal_code TEXT,
  po_box TEXT,
  is_default BOOLEAN DEFAULT false,
  neighbor_hood TEXT,
  informal_description TEXT,
  latitude NUMERIC,
  longitude NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

-- =====================================================
-- USERS EXTENDED
-- =====================================================

CREATE TABLE providers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  contact_info TEXT,
  address TEXT,
  is_active BOOLEAN DEFAULT true,
  product_service_type TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE employees (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  is_manager BOOLEAN DEFAULT false,
  role TEXT,
  department TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE prospects (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,
  interest_level TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE sales_persons (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  commission_rate NUMERIC,
  credit NUMERIC,
  current_balance NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE customers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

-- =====================================================
-- RIDE & FLEET MANAGEMENT
-- =====================================================

CREATE TABLE drivers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  status TEXT,
  license_number TEXT,
  has_car BOOLEAN DEFAULT false
);

CREATE TABLE offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  passenger_id UUID REFERENCES customers(id) ON DELETE CASCADE,

  start_point TEXT,
  end_point TEXT,
  price NUMERIC,
  state offer_state_enum DEFAULT 'NEW',
  ids_interested_drivers TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE rides (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  offer_id UUID REFERENCES offers(id) ON DELETE SET NULL,
  passenger_id UUID REFERENCES users(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  distance NUMERIC,
  time_estimation NUMERIC,
  real_time NUMERIC,
  state ride_state_enum DEFAULT 'CONFIRMED',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet_managers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE fleets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fleet_manager_id UUID REFERENCES fleet_managers(id) ON DELETE SET NULL,

  name TEXT,
  phone_number TEXT,
  email_address TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE geofence_zones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  surface_area NUMERIC,
  perimeter NUMERIC
);

CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  fleet_id UUID REFERENCES fleets(id) ON DELETE SET NULL,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,

  license_plate TEXT,
  model TEXT,
  brand TEXT,
  manufacturing_year INT,
  type vehicle_type_enum,
  color TEXT
);

CREATE TABLE roads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  start_point TEXT,
  end_point TEXT
);

CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  road_id UUID REFERENCES roads(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  start_date DATE,
  end_date DATE,
  start_time TIME,
  end_time TIME,
  type TEXT,
  color TEXT
);

CREATE TABLE operational_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  statut TEXT,
  current_location TEXT,
  current_speed NUMERIC,
  fuel_level NUMERIC,
  mileage NUMERIC,
  odometer_reading NUMERIC,
  bearing NUMERIC,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE financial_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  insurance_number TEXT,
  insurance_expired_at DATE,
  registered_at DATE,
  purchased_at DATE,
  depreciation_rate NUMERIC,
  cost_per_km NUMERIC
);

CREATE TABLE maintenance_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  last_maintenance_at DATE,
  next_maintenance_at DATE,
  engine_status engine_status_enum DEFAULT 'OK',
  battery_health TEXT,
  maintenance_status maintenance_status_enum DEFAULT 'UP_TO_DATE'
);

CREATE TABLE geofence_points (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  latitude NUMERIC,
  longitude NUMERIC
);

CREATE TABLE geofence_point_zone_linkages (
  point_id UUID REFERENCES geofence_points(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE CASCADE,
  PRIMARY KEY (point_id, zone_id)
);

CREATE TABLE geofence_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,
  point_id UUID REFERENCES geofence_points(id) ON DELETE SET NULL,

  type event_type_enum,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE offer_driver_linkages (
  offer_id UUID REFERENCES offers(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE CASCADE,
  PRIMARY KEY (offer_id, driver_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- OTHERS: PRODUCTS, SYNDICATS, PUBLICATIONS & REVIEWS
-- =====================================================

CREATE TABLE syndicats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  is_approved BOOLEAN DEFAULT false,
  name TEXT,
  description TEXT,
  domain TEXT,
  type TEXT,
  charte_url TEXT,
  status_url TEXT,
  members_list_url TEXT,
  commitment_certificate_url TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE abstract_products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  abstract_product_id UUID REFERENCES abstract_products(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  standard_price NUMERIC,
  departure_location TEXT,
  arrival_location TEXT,
  start_date DATE,
  start_time TIME,
  end_date DATE,
  end_time TIME,
  baggage_info TEXT,
  is_negotiable BOOLEAN DEFAULT false,
  payment_method TEXT,
  title TEXT,
  status status_enum DEFAULT 'DRAFT',
  product_urls TEXT,
  regular_amount NUMERIC,
  discount_percentage NUMERIC,
  discounted_amount NUMERIC,
  metadata JSONB,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  title TEXT,
  description TEXT,
  closing_at TIMESTAMP,
  type category_enum
);

CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  publication_vote_id UUID REFERENCES publication_votes(id) ON DELETE CASCADE,

  label TEXT
);

CREATE TABLE avis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  comment TEXT,
  number INT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE branches (
  id UUID PRIMARY KEY REFERENCES agencies(id),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  location TEXT,
  contact TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  content TEXT,
  status status_enum DEFAULT 'DRAFT',
  n_likes INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_images (
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (publication_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,

  title TEXT,
  description TEXT,
  location TEXT,
  date DATE,
  start_time TIME,
  end_time TIME,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE event_images (
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (event_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  type reaction_type_enum,

  reacted_at TIMESTAMP DEFAULT now()
);

CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES comments(id) ON DELETE SET NULL,
  image_id UUID REFERENCES images(id) ON DELETE SET NULL,

  content TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  first_name TEXT,
  last_name TEXT,
  nickname TEXT,
  profile_image_url TEXT,
  birth_date DATE,
  nationality TEXT,
  gender TEXT,
  language TEXT,
  company_name TEXT,
  biography TEXT,
  rating NUMERIC,
  total_trips INT,
  is_available BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- PAYMENTS & SUBSCRIPTIONS
-- =====================================================

CREATE TABLE admins (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  admin_id UUID REFERENCES admins(id) ON DELETE SET NULL,

  label TEXT,
  price NUMERIC,
  duration_in_days INT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,
  user_id UUID REFERENCES business_actors(id) ON DELETE SET NULL,

  amount_paid NUMERIC,
  status TEXT,
  id_provider_transaction TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ride_id UUID REFERENCES rides(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  subject TEXT,
  comment TEXT,
  rating NUMERIC,

  created_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- ROLE-BASED ACCESS CONTROL (RBAC)
-- =====================================================

CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE role_has_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE user_has_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Commit the transaction
COMMIT;

-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================
```

---
### Fichier : `./bin/docs/data/YOWYOB_DB/README.md`
```md
# Yowyob Database - Instructions

Ce dossier contient les scripts SQL nécessaires pour initialiser, peupler et tester la base de données PostgreSQL du projet Yowyob. Le projet a été principalement testé en local.

## [Contenu des fichiers]

1. **`yowyob_db_init.sql`** : 
   - Crée le schéma (tables, types ENUM, triggers).
   - **Note :** Ce script commence par un `DROP SCHEMA public CASCADE`. Il effacera toutes les données existantes.

2. **`yowyob_db_seed.sql`** : 
   - Remplit la base avec des **données factices (Fake Data)** pour le développement.

3. **`yowyob_db_test.sql`** : 
   - Contient des requêtes de lecture pour vérifier la cohérence des relations et des données sur **certaines relations** de la base de données. *Chaque jeu de test doit renvoyer **au moins une ligne de données.***

## [Guide d'installation]

### Pré-requis
- PostgreSQL 16 ou supérieur.
- Un utilisateur PostgreSQL ayant les droits de création de tables.

### Étape 1 : Création de la base (si elle n'existe pas)
```bash
createdb -U <user> yowyob_db
```

### Étape 2 : Initialisation de la structure
```bash
psql -U <user> -d yowyob_db -f yowyob_db_init.sql
```

### Étape 3 : Peuplement des données (DEV / STAGING UNIQUEMENT)
```bash
psql -U <user> -d yowyob_db -f yowyob_db_seed.sql
```

### Étape 4 : Vérification
```bash
psql -U <user> -d yowyob_db -f yowyob_db_test.sql
``````

---
### Fichier : `./bin/docs/data/YOWYOB_DB/yowyob_db_test.sql`
```sql
-- =====================================================
-- YOWYOB DB - TEST QUERIES (SEMI-VALIDATION)
-- PostgreSQL
-- =====================================================

-- Summary Table to display what will be tested
SELECT * FROM (VALUES
    ('Test 1.1', 'Check Driver Inheritance (Name, Status, Car)'),
    ('Test 1.2', 'Check Customers Specific Data (Code, Payment)'),
    ('Test 2.1', 'User Role Assignments'),
    ('Test 3.1', 'Agency Locations & Headquarter Status'),
    ('Test 4.1', 'Vehicle Inventory (Fleet vs Independent)'),
    ('Test 5.1', 'Full Ride History (Passenger + Driver + Price)'),
    ('Test 5.2', 'Pending Offers (No Ride Created Yet)'),
    ('Test 6.1', 'Active Products by Organization'),
    ('Test 7.1', 'Publications Feed with Likes'),
    ('Test 7.2', 'Customer Reviews on Rides'),
    ('Test 8.1', 'Payment & Subscription Log')
) AS summary_table (Test_ID, Test_Description);

-- =====================================================
-- BLOCK 1: CORE & INHERITANCE VERIFICATION
-- =====================================================

-- 1.1. Check Driver Inheritance
SELECT 'Check Driver Inheritance (Name, Status, Car)' AS "TEST 1.1";
SELECT 
    u.id,
    u.name AS full_name,
    u.phone_number,
    d.status AS driver_status,
    d.license_number,
    d.has_car
FROM drivers d
JOIN business_actors ba ON d.id = ba.id
JOIN users u ON ba.id = u.id
LIMIT 5;

-- 1.2. Check Customers and Payment Methods
SELECT 'Check Customers Specific Data' AS "TEST 1.2";
SELECT 
    u.name AS customer_name,
    c.code AS customer_code,
    c.payment_method
FROM customers c
JOIN users u ON c.id = u.id
LIMIT 5;

-- =====================================================
-- BLOCK 2: RBAC (ROLES & SECURITY)
-- =====================================================

-- 2.1. Who has which role?
SELECT 'User Role Assignments' AS "TEST 2.1";
SELECT 
    u.name AS user_name,
    u.email_address,
    r.name AS assigned_role
FROM users u
JOIN user_has_roles uhr ON u.id = uhr.user_id
JOIN roles r ON uhr.role_id = r.id
ORDER BY u.name ASC
LIMIT 5;

-- =====================================================
-- BLOCK 3: ORGANIZATION & HIERARCHY
-- =====================================================

-- 3.1. Hierarchy Organization -> Agencies
SELECT 'Agency Locations & Headquarter Status' AS "TEST 3.1";
SELECT 
    org.short_name AS organization,
    a.name AS agency_name,
    a.city,
    a.is_headquarter
FROM agencies a
JOIN organizations org ON a.organization_id = org.id
ORDER BY org.short_name
LIMIT 5;

-- =====================================================
-- BLOCK 4: FLEET MANAGEMENT
-- =====================================================

-- 4.1. Vehicle Inventory
SELECT 'Vehicle Inventory (Fleet vs Independent)' AS "TEST 4.1";
SELECT 
    v.license_plate,
    v.brand || ' ' || v.model AS vehicle_model,
    v.type,
    f.name AS fleet_owner,
    u_owner.name AS independent_owner
FROM vehicles v
LEFT JOIN fleets f ON v.fleet_id = f.id
LEFT JOIN users u_owner ON v.user_id = u_owner.id
LIMIT 5;

-- =====================================================
-- BLOCK 5: RIDES & OFFERS (CORE BUSINESS)
-- =====================================================

-- 5.1. Full Ride Details
SELECT 'Full Ride History (Passenger + Driver + Price)' AS "TEST 5.1";
SELECT 
    r.id AS ride_id,
    r.state AS ride_state,
    passenger_u.name AS passenger,
    driver_u.name AS driver,
    o.start_point,
    o.end_point,
    o.price AS agreed_price,
    r.distance || ' km' AS real_distance
FROM rides r
JOIN offers o ON r.offer_id = o.id
JOIN customers c ON r.passenger_id = c.id
JOIN users passenger_u ON c.id = passenger_u.id
JOIN drivers d ON r.driver_id = d.id
JOIN users driver_u ON d.id = driver_u.id
WHERE r.state = 'COMPLETED'
LIMIT 5;

-- 5.2. Offers without Drivers
SELECT 'Pending Offers (No Ride Created Yet)' AS "TEST 5.2";
SELECT 
    o.id,
    o.state,
    o.price,
    o.created_at
FROM offers o
LEFT JOIN rides r ON o.id = r.offer_id
WHERE r.id IS NULL
LIMIT 5;

-- =====================================================
-- BLOCK 6: PRODUCTS & SERVICES
-- =====================================================

-- 6.1. Product Catalog by Organization
SELECT 'Active Products by Organization' AS "TEST 6.1";
SELECT 
    org.short_name AS seller,
    p.name AS product_name,
    p.standard_price AS price,
    p.status
FROM products p
JOIN organizations org ON p.organization_id = org.id
WHERE p.is_active = true
LIMIT 5;

-- =====================================================
-- BLOCK 7: SOCIAL (PUBLICATIONS & REVIEWS)
-- =====================================================

-- 7.1. Branch News Feed
SELECT 'Publications Feed with Likes' AS "TEST 7.1";
SELECT 
    b.name AS source_branch,
    u.name AS author,
    pub.content AS message,
    pub.n_likes AS likes
FROM publications pub
JOIN branches b ON pub.branch_id = b.id
JOIN users u ON pub.author_id = u.id
ORDER BY pub.created_at DESC
LIMIT 5;

-- 7.2. Ride Reviews
SELECT 'Customer Reviews on Rides' AS "TEST 7.2";
SELECT 
    rev.rating,
    rev.comment,
    u.name AS author
FROM reviews rev
JOIN users u ON rev.author_id = u.id
LIMIT 5;

-- =====================================================
-- BLOCK 8: FINANCE (SUBSCRIPTIONS & PAYMENTS)
-- =====================================================

-- 8.1. Payment History
SELECT 'Payment & Subscription Log' AS "TEST 8.1";
SELECT 
    pay.id AS payment_id,
    u.name AS payer,
    sub.label AS subscription_plan,
    pay.amount_paid,
    pay.status,
    pay.created_at
FROM payments pay
JOIN users u ON pay.user_id = u.id
JOIN subscriptions sub ON pay.subscription_id = sub.id
ORDER BY pay.created_at DESC
LIMIT 5;

-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================```

---
### Fichier : `./bin/docs/prompts/master_pair_programmer.md`
```md
# 🤖 Master Prompt : Senior Pair Programmer WebFlux

Tu es mon Senior Pair Programmer expert en Java **Spring Boot WebFlux (Réactif)**.
Nous développons l'API **Fleet Management et Geofencing** (Projet TraEnSys).

### 📋 Ta Méthode de Travail (IMPÉRATIF)
Pour chaque tâche demandée, tu dois obligatoirement suivre ces étapes :

**Étape 1 : Conception fonctionnelle**
- Analyse du besoin, user stories et ajustement du modèle de données.
- **Attente de ma validation explicite avant d'aller plus loin.**

**Étape 2 : Explication du Concept Réactif**
- Avant de coder, explique brièvement comment le flux réactif (`Mono`/`Flux`) sera géré pour cette tâche.

**Étape 3 : Implémentation**
- Fournis le code complet par blocs Markdown copiables.
- Respecte l'architecture hexagonale du projet.

**Étape 4 : Tests & Validation**
- Instructions pour tester via Postman ou logs.

### 🚫 Tes Règles de Conduite
1. **Zéro code non sollicité** : Ne propose aucune solution technique avant l'Étape 3.
2. **Focus** : Réponds uniquement à la question posée, de manière synthétique et précise.
3. **Fichiers complets** : Sauf mention contraire, donne toujours le code complet du fichier pour éviter les erreurs de copier-coller.
4. **Pédagogie** : Si une opération risque de bloquer un thread (ex: JDBC classique, thread sleep), arrête-moi et propose l'alternative non-bloquante.

### 📂 Contexte
Le code source complet est disponible dans le fichier `project_context.txt`.
La roadmap est suivie dans `todo.md`.
```

---
### Fichier : `./bin/docs/database_setup.md`
```md
# 🗄️ Database Setup Guide (Local Development)

This guide explains how to set up and initialize the Fleet Management database on your local machine. This process is fully automated for both **Linux** and **Windows**.

## 📋 Prerequisites

Ensure you have the following installed:
- **Docker** & **Docker Compose**
  - *Linux*: `sudo apt install docker-compose`
  - *Windows*: Install [Docker Desktop](https://www.docker.com/products/docker-desktop/)

## 🚀 Step 1: Start the Database Container

Open a terminal at the root of the project and run:

```bash
# Start the PostgreSQL 16 container in the background
docker-compose up -d
```

*Note: This will automatically pull the official Postgres 16 image and create a database named `yowyob_db`.*

## ⚙️ Step 2: Configure the Application

The application is configured to use a **Hybrid Mode** (Local DB + Remote Kafka/Redis).

1. Open `src/main/resources/application.yml`.
2. Ensure the active profile is set to `local`:
   ```yaml
   spring:
     profiles:
       active: local
   ```
3. (Optional) In the `LOCAL CONFIGURATION` block, verify that the credentials match those in `docker-compose.yml` (default: `fleet_admin` / `fleet_password`).

## 🛠️ Step 3: Run and Auto-Initialize

Simply start the application. The system will detect the local environment and automatically:
1. Create all tables and ENUM types (from `resources/local/schema.sql`).
2. Inject 100 test users and sample data (from `resources/local/data.sql`).

**Run Command:**
```bash
# Linux / macOS
./mvnw clean spring-boot:run

# Windows (CMD / PowerShell)
mvnw.cmd clean spring-boot:run
```

## ✅ Step 4: Verify the Setup

Once the log shows `🚀 LOCAL DATABASE READY!`, open your browser:

- **Swagger UI**: [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **Check Data**: Find the `health-check-controller` and execute `/api/v1/health/users-count`. You should see `users_in_db: 100`.

## ❌ Troubleshooting

- **Port 5432 already in use**: If you have a local PostgreSQL installed outside of Docker, stop it or change the port mapping in `docker-compose.yml`.
- **DNS/Pull Issues**: If Docker fails to pull the image, try:
  ```bash
  docker pull postgres:16
  ```
```

---
### Fichier : `./bin/todo.md`
```md
### 📋 Roadmap Macro : API Fleet & Geofence

#### Jalon 1 : Initialisation, Structure & Persistence (Fondations)
- [x] **Tâche 1.1 :** Nettoyage et Refactoring du template (Renommage packages, suppression de la logique "Product").
- [x] **Tâche 1.2 :** Implémentation du Schéma de données (Traduction du contrat v1.0 en SQL pour PostgreSQL).
- [x] **Tâche 1.3 :** Mise en place du mécanisme de **Seeding** (Génération automatique de données de test au démarrage).
- [x] **Tâche 1.4 :** **Validation swagger** : Vérification de l'état de la base de données via un endpoint de santé (Health Check).
- [x] **Tâche 1.5:** *Guide*: Elaboration d'un guide pour que les collaborateurs puissent initialiser la bd sans probleme et la seed en mode local.(le plus facilement possible) 

#### Jalon 2 : Authentification & Accès (CU1)
- [x] **Tâche 2.1 :** Configuration de la Sécurité Réactive (Spring Security).
- [ ] **Tâche 2.2 :** Intégration du Service d'Authentification externe (Adaptateur WebClient).
- [ ] **Tâche 2.3 :** Implémentation du **Mode Dégradé (Fake Auth)** pour le développement local.
- [ ] **Tâche 2.4 :** **Validation Postman** : Tests de login, génération de token et accès restreint par rôles (RBAC).
- [ ] **Tâche 2.5 :** Intégration des routes "mot de passe oublié" et autres via l'API d'authentification externe.

#### Jalon 3 : Gestion de la Flotte (CU17, CU18, CU19)
- [ ] **Tâche 3.1 :** Use-Case : Créer / Modifier / Supprimer une Flotte (Fleets).
- [ ] **Tâche 3.2 :** Use-Case : Créer / Modifier / Supprimer un Véhicule (Vehicles).
- [ ] **Tâche 3.3 :** Gestion des paramètres détaillés (Financial & Maintenance parameters).
- [ ] **Tâche 3.4 :** **Validation Postman** : CRUD complet des véhicules et flottes.

#### Jalon 4 : Gestion des Chauffeurs & Assignations (CU21, CU24)
- [ ] **Tâche 4.1 :** Use-Case : Créer / Gérer un profil Driver (lié à l'utilisateur distant).
- [ ] **Tâche 4.2 :** Use-Case : Assigner / Libérer un véhicule à un chauffeur.
- [ ] **Tâche 4.3 :** **Validation Postman** : Scénario complet d'enregistrement et d'affectation d'un chauffeur.

#### Jalon 5 : Gestion des Trajets & Temps Réel (CU4, CU5, CU2, CU14)
- [ ] **Tâche 5.1 :** Use-Case : Démarrer un trajet (Start Trip).
- [ ] **Tâche 5.2 :** Use-Case : Terminer un trajet (End Trip) et calcul des statistiques de fin de trajet.
- [ ] **Tâche 5.3 :** Mise à jour des paramètres opérationnels (Positions GPS, vitesse, fuel) en flux continu.
- [ ] **Tâche 5.4 :** **Validation Postman** : Simulation d'un trajet complet et vérification des logs.

#### Jalon 6 : Moteur de Geofencing & Alertes (CU10, CU11, CU12, CU13)
- [ ] **Tâche 6.1 :** Use-Case : Définir et gérer les zones (Geofence Zones).
- [ ] **Tâche 6.2 :** Moteur de détection réactif (Intersection position / zone).
- [ ] **Tâche 6.3 :** Publication des alertes dans Kafka.
- [ ] **Tâche 6.4 :** **Validation Postman** : Déclenchement manuel d'une alerte en injectant une position GPS hors zone.

#### Jalon 7 : Intégrations Services Périphériques (Fare, Payment, Medias, Notification)
- [ ] **Tâche 7.1 :** Adaptateurs pour Fare Calculator & Payment (avec mode Fake data).
- [ ] **Tâche 7.2 :** Adaptateur pour l'API Media (Gestion des images).
- [ ] **Tâche 7.3 :** Intégration finale du service de Notification.
- [ ] **Tâche 7.4 :** **Validation Postman** : Tests de bout en bout incluant les services externes.

```

---
### Fichier : `./bin/src/main/resources/local/data.sql`
```sql
-- =====================================================
-- YOWYOB DB - DATA SEEDING SCRIPT
-- PostgreSQL
-- =====================================================


-- =====================================================
-- 1. CLEANUP EXISTING DATA
-- =====================================================
TRUNCATE TABLE 
    users, images, countries, business_actors, 
    admins, fleet_managers, drivers, customers, 
    providers, employees, prospects, sales_persons,
    profiles, settings, addresses, contacts,
    roles, permissions, role_has_permissions, user_has_roles,
    organizations, agencies, business_domains, organization_business_domains,
    certifications, third_parties, proposed_activities, services, branches,
    fleets, vehicles, geofence_zones, geofence_points, geofence_events,
    roads, trips, offers, rides, reviews, offer_driver_linkages,
    operational_parameters, financial_parameters, maintenance_parameters,
    geofence_point_zone_linkages,
    syndicats, abstract_products, products, 
    publications, publication_images, publication_votes, votes,
    events, event_images, reactions, comments, avis,
    subscriptions, payments
    RESTART IDENTITY CASCADE;

-- =====================================================
-- 2. STATIC REFERENCE DATA
-- =====================================================

-- Countries
INSERT INTO countries (name, code) VALUES
('Cameroun', 'CM'), ('Sénégal', 'SN'), ('Côte d''Ivoire', 'CI'), 
('Gabon', 'GA'), ('Nigéria', 'NG'), ('Togo', 'TG');

-- Roles
INSERT INTO roles (name, guard_name) VALUES
('ADMIN', 'web'), ('FLEET_MANAGER', 'web'), ('DRIVER', 'web'), ('CUSTOMER', 'web');

-- Images (Random placeholders from Picsum)
INSERT INTO images (url, alt_text) 
SELECT 
    'https://picsum.photos/seed/' || i || '/800/600', 
    'Image aléatoire ' || i
FROM generate_series(1, 50) as i;

-- =====================================================
-- 3. USERS GENERATION (100 users)
-- =====================================================

INSERT INTO users (name, phone_number, email_address)
SELECT 
    (ARRAY['Mamadou', 'Jean-Pierre', 'Ibrahim', 'Fatou', 'Aminata', 'Ngolo', 'Aboubakar', 'Clarisse', 'Samuel', 'Kouamé', 'Aissatou', 'Bachelard', 'Landry', 'Thérèse'])[floor(random()*14)+1] 
    || ' ' || 
    (ARRAY['Diop', 'Njoya', 'Mbarga', 'Kone', 'Sow', 'Etoundi', 'Kamga', 'Traoré', 'Diallo', 'Fofana', 'Mensah', 'Atangana', 'Eto''o', 'Drogba'])[floor(random()*14)+1],
    (ARRAY['+237', '+221', '+225'])[floor(random()*3)+1] || (600000000 + floor(random()*99999999)::int),
    'user_' || i || '@yowyob.test'
FROM generate_series(1, 100) as i;

-- Settings & Profiles
INSERT INTO settings (user_id, theme, language, receive_push_notifications)
SELECT id, 'LIGHT', 'fr', true FROM users;

INSERT INTO profiles (user_id, first_name, nationality, is_verified)
SELECT id, split_part(name, ' ', 1), 'Camerounais', (random() > 0.5) FROM users;

-- =====================================================
-- 4. ACTORS DISPATCHING
-- User -> BusinessActor -> SpecificActor
-- =====================================================

-- 4.1 Admins (First 5 users)
INSERT INTO admins (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5;

-- 4.2 Fleet Managers (Next 5 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- STEP 2: Insert into CHILD (FleetManager)
INSERT INTO fleet_managers (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- 4.3 Drivers (Next 30 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- STEP 2: Insert into CHILD (Driver)
INSERT INTO drivers (id, status, license_number, has_car)
SELECT 
    id, 
    (ARRAY['AVAILABLE', 'BUSY', 'OFFLINE'])[floor(random()*3)+1], 
    'LIC-' || floor(random()*100000) || '-CM',
    (random() > 0.3)
FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- 4.4 Customers (Remaining 60 users)
INSERT INTO customers (id, code, payment_method)
SELECT 
    id, 
    'CUST-' || substr(id::text, 1, 8),
    (ARRAY['CASH', 'MOBILE_MONEY', 'CARD'])[floor(random()*3)+1]
FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- Assign Roles
INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'ADMIN') FROM users ORDER BY email_address LIMIT 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'FLEET_MANAGER') FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'DRIVER') FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'CUSTOMER') FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- =====================================================
-- 5. ORGANIZATIONS & AGENCIES
-- =====================================================

INSERT INTO organizations (
    business_actor_id, logo_id, code, short_name, long_name, 
    description, tax_number, is_active, status
)
SELECT
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    (SELECT id FROM images ORDER BY random() LIMIT 1),
    'ORG-' || i,
    'Transport ' || i,
    'Société de Transport ' || i,
    'Description ' || i,
    'TAX-' || floor(random()*1000000),
    true,
    'PUBLISHED'
FROM generate_series(1, 35) as i;

INSERT INTO agencies (
    organization_id, manager_id, name, city, location, is_headquarter
)
SELECT 
    id, 
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    'Agence Centrale',
    (ARRAY['Douala', 'Yaoundé', 'Abidjan'])[floor(random()*3)+1],
    'Rue Principale',
    true
FROM organizations;

-- =====================================================
-- 6. FLEETS & VEHICLES
-- =====================================================

INSERT INTO fleets (fleet_manager_id, name, phone_number)
SELECT 
    id, 'Flotte de ' || name, '+237699000000'
FROM fleet_managers;

-- Vehicles
INSERT INTO vehicles (
    fleet_id, user_id, driver_id, license_plate, brand, model, type, color, manufacturing_year
)
SELECT 
    f.id,
    f.fleet_manager_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    'LT-' || floor(random()*999)::text || '-AA',
    (ARRAY['Toyota', 'Peugeot'])[floor(random()*2)+1],
    (ARRAY['Yaris', 'Partner'])[floor(random()*2)+1],
    (ARRAY['CAR', 'VAN'])[floor(random()*2)+1]::vehicle_type_enum,
    'Jaune',
    2020
FROM fleets f;

-- =====================================================
-- 7. OFFERS & RIDES
-- =====================================================

INSERT INTO offers (
    passenger_id, start_point, end_point, price, state, created_at
)
SELECT 
    (SELECT id FROM customers ORDER BY random() LIMIT 1),
    'Point A', 'Point B', 
    2000, 
    'CHOSEN',
    NOW()
FROM generate_series(1, 60) as i;

-- Rides
INSERT INTO rides (
    offer_id, passenger_id, driver_id, 
    distance, time_estimation, real_time, state, created_at
)
SELECT 
    id, -- offer_id
    passenger_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    15.5, 30, 35,
    'COMPLETED',
    created_at
FROM offers 
LIMIT 40;

-- Reviews
INSERT INTO reviews (ride_id, author_id, subject, comment, rating)
SELECT 
    id,
    passenger_id,
    'Chauffeur',
    'Bonne course, chauffeur ponctuel',
    5
FROM rides
WHERE state = 'COMPLETED';

-- =====================================================
-- 8. PRODUCTS
-- =====================================================

INSERT INTO products (
    organization_id, name, description, standard_price, 
    status, is_active, departure_location
)
SELECT 
    (SELECT id FROM organizations ORDER BY random() LIMIT 1),
    'Trajet Spécial ' || i,
    'Description produit',
    5000,
    'PUBLISHED',
    true,
    'Douala'
FROM generate_series(1, 40) as i;

-- =====================================================
-- 9. SUBSCRIPTIONS & PAYMENTS
-- =====================================================

INSERT INTO subscriptions (
    admin_id, label, price, duration_in_days, description, is_active
) VALUES 
((SELECT id FROM admins LIMIT 1), 'Pack Hebdo', 2500, 7, 'Standard', true),
((SELECT id FROM admins LIMIT 1), 'Pack Mensuel', 10000, 30, 'Pro', true),
((SELECT id FROM admins LIMIT 1), 'Pack Annuel', 100000, 365, 'VIP', true);

INSERT INTO payments (
    driver_id, user_id, subscription_id, amount_paid, status, id_provider_transaction, created_at
)
SELECT 
    d.id, -- Driver ID
    d.id, -- Payer ID
    s.id, -- Subscription ID
    s.price,
    'SUCCESS',
    'TXN-' || floor(random()*10000000),
    NOW()
FROM drivers d
CROSS JOIN subscriptions s
ORDER BY random()
LIMIT 50;

-- =====================================================
-- 10. SOCIAL & ADDRESSES
-- =====================================================

INSERT INTO syndicats (organization_id, name, is_approved)
SELECT id, 'Syndicat Transports', true FROM organizations LIMIT 1;

INSERT INTO branches (id, syndicat_id, name, location)
SELECT 
    ag.id,
    (SELECT id FROM syndicats LIMIT 1),
    'Branche ' || ag.name, 
    ag.location 
FROM agencies ag 
LIMIT 10;

INSERT INTO publications (branch_id, author_id, content, status, n_likes)
SELECT 
    (SELECT id FROM branches ORDER BY random() LIMIT 1),
    (SELECT id FROM admins ORDER BY random() LIMIT 1),
    'Info Trafic ' || i,
    'PUBLISHED',
    floor(random() * 50)::int
FROM generate_series(1, 40) as i;

```

---
### Fichier : `./bin/src/main/resources/local/schema.sql`
```sql
-- =====================================================
-- YOWYOB DB - INIT SCRIPT
-- PostgreSQL
-- Structure: Core -> Organization -> RBAC
-- =====================================================

-- Clean up existing tables and types to ensure a fresh start
-- We drop them in reverse order of dependency
DROP TABLE IF EXISTS user_has_roles CASCADE;
DROP TABLE IF EXISTS role_has_permissions CASCADE;
DROP TABLE IF EXISTS permissions CASCADE;
DROP TABLE IF EXISTS roles CASCADE;
DROP TABLE IF EXISTS reviews CASCADE;
DROP TABLE IF EXISTS payments CASCADE;
DROP TABLE IF EXISTS subscriptions CASCADE;
DROP TABLE IF EXISTS admins CASCADE;
DROP TABLE IF EXISTS profiles CASCADE;
DROP TABLE IF EXISTS comments CASCADE;
DROP TABLE IF EXISTS reactions CASCADE;
DROP TABLE IF EXISTS event_images CASCADE;
DROP TABLE IF EXISTS events CASCADE;
DROP TABLE IF EXISTS publication_images CASCADE;
DROP TABLE IF EXISTS publications CASCADE;
DROP TABLE IF EXISTS branches CASCADE;
DROP TABLE IF EXISTS avis CASCADE;
DROP TABLE IF EXISTS votes CASCADE;
DROP TABLE IF EXISTS publication_votes CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS abstract_products CASCADE;
DROP TABLE IF EXISTS syndicats CASCADE;
DROP TABLE IF EXISTS offer_driver_linkages CASCADE;
DROP TABLE IF EXISTS geofence_events CASCADE;
DROP TABLE IF EXISTS geofence_point_zone_linkages CASCADE;
DROP TABLE IF EXISTS geofence_points CASCADE;
DROP TABLE IF EXISTS maintenance_parameters CASCADE;
DROP TABLE IF EXISTS financial_parameters CASCADE;
DROP TABLE IF EXISTS operational_parameters CASCADE;
DROP TABLE IF EXISTS trips CASCADE;
DROP TABLE IF EXISTS roads CASCADE;
DROP TABLE IF EXISTS vehicles CASCADE;
DROP TABLE IF EXISTS geofence_zones CASCADE;
DROP TABLE IF EXISTS fleets CASCADE;
DROP TABLE IF EXISTS fleet_managers CASCADE;
DROP TABLE IF EXISTS rides CASCADE;
DROP TABLE IF EXISTS offers CASCADE;
DROP TABLE IF EXISTS drivers CASCADE;
DROP TABLE IF EXISTS services CASCADE;
DROP TABLE IF EXISTS customers CASCADE;
DROP TABLE IF EXISTS sales_persons CASCADE;
DROP TABLE IF EXISTS prospects CASCADE;
DROP TABLE IF EXISTS employees CASCADE;
DROP TABLE IF EXISTS providers CASCADE;
DROP TABLE IF EXISTS addresses CASCADE;
DROP TABLE IF EXISTS proposed_activities CASCADE;
DROP TABLE IF EXISTS settings CASCADE;
DROP TABLE IF EXISTS third_parties CASCADE;
DROP TABLE IF EXISTS certifications CASCADE;
DROP TABLE IF EXISTS organization_business_domains CASCADE;
DROP TABLE IF EXISTS contacts CASCADE;
DROP TABLE IF EXISTS business_domains CASCADE;
DROP TABLE IF EXISTS agencies CASCADE;
DROP TABLE IF EXISTS organizations CASCADE;
DROP TABLE IF EXISTS business_actors CASCADE;
DROP TABLE IF EXISTS countries CASCADE;
DROP TABLE IF EXISTS images CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- Drop existing types
DROP TYPE IF EXISTS reaction_type_enum CASCADE;
DROP TYPE IF EXISTS type_enum CASCADE;
DROP TYPE IF EXISTS role_type_enum CASCADE;
DROP TYPE IF EXISTS engine_status_enum CASCADE;
DROP TYPE IF EXISTS maintenance_status_enum CASCADE;
DROP TYPE IF EXISTS event_type_enum CASCADE;
DROP TYPE IF EXISTS ride_state_enum CASCADE;
DROP TYPE IF EXISTS offer_state_enum CASCADE;
DROP TYPE IF EXISTS vehicle_type_enum CASCADE;
DROP TYPE IF EXISTS action_enum CASCADE;
DROP TYPE IF EXISTS category_enum CASCADE;
DROP TYPE IF EXISTS status_enum CASCADE;

-- Re-enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";


-- =====================================================
-- ENUM TYPES
-- =====================================================

CREATE TYPE status_enum AS ENUM (
  'DRAFT', 'WAITING_CONFIRMATION', 'PUBLISHED', 'IN_PROGRESS', 'CANCELLED', 'EXPIRED'
);

CREATE TYPE category_enum AS ENUM (
  'ANNOUNCE', 'PLANNING', 'VEHICLE', 'ADDRESS', 'EXPERIENCE'
);

CREATE TYPE action_enum AS ENUM (
  'CREATE', 'UPDATE', 'READ', 'DELETE'
);

CREATE TYPE vehicle_type_enum AS ENUM (
  'CAR', 'VAN', 'TRUCK', 'BIKE'
);

CREATE TYPE offer_state_enum AS ENUM (
  'NEW', 'PENDING', 'CHOSEN', 'TERMINATED', 'CANCELED'
);

CREATE TYPE ride_state_enum AS ENUM (
  'CONFIRMED', 'ONGOING', 'COMPLETED', 'CANCELED'
);

CREATE TYPE event_type_enum AS ENUM (
  'ENTRY', 'EXIT'
);

CREATE TYPE maintenance_status_enum AS ENUM (
  'UP_TO_DATE', 'PENDING', 'OVERDUE'
);

CREATE TYPE engine_status_enum AS ENUM (
  'OK', 'NEED_SERVICE', 'OUT_OF_SERVICE'
);

CREATE TYPE role_type_enum AS ENUM (
  'CUSTOMER', 'DRIVER', 'FLEET_MANAGER', 'ADMIN', 'PASSENGER', 'PRESIDENT', 'MODERATOR', 'CLIENT'
);

CREATE TYPE type_enum AS ENUM (
  'NOTIFICATION', 'CHAT', 'PAYMENT', 'MEDIA'
);

CREATE TYPE reaction_type_enum AS ENUM (
  'LIKE', 'LOVE', 'HAHA', 'WOW', 'SAD', 'ANGRY'
);

-- =====================================================
-- CORE TABLES
-- =====================================================

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  phone_number TEXT,
  email_address TEXT UNIQUE
);

CREATE TABLE images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url TEXT NOT NULL,
  alt_text TEXT,
  uploaded_at TIMESTAMP DEFAULT now()
);

CREATE TABLE countries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE business_actors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT,
  phone_number TEXT,
  email_address TEXT,
  CONSTRAINT fk_business_actor_user
    FOREIGN KEY (id) REFERENCES users(id)
    ON DELETE CASCADE
);

-- =====================================================
-- ORGANIZATION TABLES
-- =====================================================

CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_actor_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  email TEXT,
  short_name TEXT,
  long_name TEXT,
  description TEXT,
  logo_uri TEXT,
  website_url TEXT,
  social_network TEXT,
  business_registration_number TEXT,
  tax_number TEXT,
  capital_share NUMERIC,
  ceo_name TEXT,
  year_founded INT,
  keywords TEXT,
  number_of_employees INT,
  legal_form TEXT,
  is_active BOOLEAN DEFAULT true,
  status status_enum DEFAULT 'DRAFT',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, -- Must belong to an org

  owner_id UUID REFERENCES business_actors(id),
  manager_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  name TEXT,
  location TEXT,
  description TEXT,
  transferable BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  logo_uri TEXT,
  short_name TEXT,
  long_name TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  is_headquarter BOOLEAN DEFAULT false,
  country TEXT,
  city TEXT,
  latitude NUMERIC,
  longitude NUMERIC,
  open_time TIME,
  close_time TIME,
  phone TEXT,
  email TEXT,
  whatsapp TEXT,
  greeting_message TEXT,
  average_revenue NUMERIC,
  capital_share NUMERIC,
  registration_number TEXT,
  social_network TEXT,
  tax_number TEXT,
  keywords TEXT,
  is_public BOOLEAN DEFAULT false,
  is_business BOOLEAN DEFAULT true,
  total_affiliated_customers INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE business_domains (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL, -- optional link to organization
  parent_id UUID REFERENCES business_domains(id) ON DELETE SET NULL,   -- self-referential for hierarchy
  image_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  name TEXT,
  image_uri TEXT,
  type TEXT,
  type_label TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE organization_business_domains (
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  business_domain_id UUID REFERENCES business_domains(id) ON DELETE CASCADE,
  PRIMARY KEY (organization_id, business_domain_id)
);

CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  contactable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  contactable_type TEXT,
  first_name TEXT,
  last_name TEXT,
  title TEXT,
  is_email_verified BOOLEAN DEFAULT false,
  is_phone_number_verified BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  phone_number TEXT,
  secondary_phone_number TEXT,
  fax_number TEXT,
  email TEXT,
  secondary_email TEXT,
  email_verified_at TIMESTAMP,
  phone_verified_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE certifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  description TEXT,
  obtainment_date DATE,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE third_parties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  logo_id UUID REFERENCES images(id),

  code TEXT,
  type TEXT,
  legal_form TEXT,
  unique_identification_number TEXT,
  trade_registration_number TEXT,
  name TEXT,
  acronym TEXT,
  long_name TEXT,
  logo_uri TEXT,
  accounting_account_numbers TEXT,
  authorized_payment_methods TEXT,
  authorized_credit_limit NUMERIC,
  max_discount_rate NUMERIC,
  vat_subject BOOLEAN,
  operations_balance NUMERIC,
  opening_balance NUMERIC,
  pay_term_number INT,
  pay_term_type TEXT,
  third_party_family TEXT,
  classification TEXT,
  tax_number TEXT,
  loyalty_points NUMERIC,
  loyalty_points_used NUMERIC,
  loyalty_points_expired NUMERIC,
  enabled BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE settings (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  theme TEXT,
  language TEXT,
  long_ride_enabled BOOLEAN DEFAULT false,
  short_ride_enabled BOOLEAN DEFAULT false,
  privacy_enable BOOLEAN DEFAULT true,
  allow_calls BOOLEAN DEFAULT true,
  allow_messages BOOLEAN DEFAULT true,
  notify_new_rides BOOLEAN DEFAULT true,
  notify_ratings BOOLEAN DEFAULT true,
  notify_practical_tips BOOLEAN DEFAULT true,
  notify_promotions BOOLEAN DEFAULT true,
  notify_policy_updates BOOLEAN DEFAULT true,
  notify_peak_hour_recommendations BOOLEAN DEFAULT true,
  receive_email BOOLEAN DEFAULT true,
  receive_sms BOOLEAN DEFAULT true,
  receive_push_notifications BOOLEAN DEFAULT true,
  receive_whatsapp BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE proposed_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  rate NUMERIC,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE addresses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  addressable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  country_id UUID REFERENCES countries(id) ON DELETE SET NULL,

  addressable_type TEXT,
  type TEXT,
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  state TEXT,
  locality TEXT,
  zip_code TEXT,
  postal_code TEXT,
  po_box TEXT,
  is_default BOOLEAN DEFAULT false,
  neighbor_hood TEXT,
  informal_description TEXT,
  latitude NUMERIC,
  longitude NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

-- =====================================================
-- USERS EXTENDED
-- =====================================================

CREATE TABLE providers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  contact_info TEXT,
  address TEXT,
  is_active BOOLEAN DEFAULT true,
  product_service_type TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE employees (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  is_manager BOOLEAN DEFAULT false,
  role TEXT,
  department TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE prospects (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,
  interest_level TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE sales_persons (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  commission_rate NUMERIC,
  credit NUMERIC,
  current_balance NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE customers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

-- =====================================================
-- RIDE & FLEET MANAGEMENT
-- =====================================================

CREATE TABLE drivers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  status TEXT,
  license_number TEXT,
  has_car BOOLEAN DEFAULT false
);

CREATE TABLE offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  passenger_id UUID REFERENCES customers(id) ON DELETE CASCADE,

  start_point TEXT,
  end_point TEXT,
  price NUMERIC,
  state offer_state_enum DEFAULT 'NEW',
  ids_interested_drivers TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE rides (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  offer_id UUID REFERENCES offers(id) ON DELETE SET NULL,
  passenger_id UUID REFERENCES users(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  distance NUMERIC,
  time_estimation NUMERIC,
  real_time NUMERIC,
  state ride_state_enum DEFAULT 'CONFIRMED',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet_managers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE fleets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fleet_manager_id UUID REFERENCES fleet_managers(id) ON DELETE SET NULL,

  name TEXT,
  phone_number TEXT,
  email_address TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE geofence_zones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  surface_area NUMERIC,
  perimeter NUMERIC
);

CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  fleet_id UUID REFERENCES fleets(id) ON DELETE SET NULL,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,

  license_plate TEXT,
  model TEXT,
  brand TEXT,
  manufacturing_year INT,
  type vehicle_type_enum,
  color TEXT
);

CREATE TABLE roads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  start_point TEXT,
  end_point TEXT
);

CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  road_id UUID REFERENCES roads(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  start_date DATE,
  end_date DATE,
  start_time TIME,
  end_time TIME,
  type TEXT,
  color TEXT
);

CREATE TABLE operational_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  statut TEXT,
  current_location TEXT,
  current_speed NUMERIC,
  fuel_level NUMERIC,
  mileage NUMERIC,
  odometer_reading NUMERIC,
  bearing NUMERIC,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE financial_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  insurance_number TEXT,
  insurance_expired_at DATE,
  registered_at DATE,
  purchased_at DATE,
  depreciation_rate NUMERIC,
  cost_per_km NUMERIC
);

CREATE TABLE maintenance_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  last_maintenance_at DATE,
  next_maintenance_at DATE,
  engine_status engine_status_enum DEFAULT 'OK',
  battery_health TEXT,
  maintenance_status maintenance_status_enum DEFAULT 'UP_TO_DATE'
);

CREATE TABLE geofence_points (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  latitude NUMERIC,
  longitude NUMERIC
);

CREATE TABLE geofence_point_zone_linkages (
  point_id UUID REFERENCES geofence_points(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE CASCADE,
  PRIMARY KEY (point_id, zone_id)
);

CREATE TABLE geofence_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,
  point_id UUID REFERENCES geofence_points(id) ON DELETE SET NULL,

  type event_type_enum,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE offer_driver_linkages (
  offer_id UUID REFERENCES offers(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE CASCADE,
  PRIMARY KEY (offer_id, driver_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- OTHERS: PRODUCTS, SYNDICATS, PUBLICATIONS & REVIEWS
-- =====================================================

CREATE TABLE syndicats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  is_approved BOOLEAN DEFAULT false,
  name TEXT,
  description TEXT,
  domain TEXT,
  type TEXT,
  charte_url TEXT,
  status_url TEXT,
  members_list_url TEXT,
  commitment_certificate_url TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE abstract_products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  abstract_product_id UUID REFERENCES abstract_products(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  standard_price NUMERIC,
  departure_location TEXT,
  arrival_location TEXT,
  start_date DATE,
  start_time TIME,
  end_date DATE,
  end_time TIME,
  baggage_info TEXT,
  is_negotiable BOOLEAN DEFAULT false,
  payment_method TEXT,
  title TEXT,
  status status_enum DEFAULT 'DRAFT',
  product_urls TEXT,
  regular_amount NUMERIC,
  discount_percentage NUMERIC,
  discounted_amount NUMERIC,
  metadata JSONB,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  title TEXT,
  description TEXT,
  closing_at TIMESTAMP,
  type category_enum
);

CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  publication_vote_id UUID REFERENCES publication_votes(id) ON DELETE CASCADE,

  label TEXT
);

CREATE TABLE avis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  comment TEXT,
  number INT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE branches (
  id UUID PRIMARY KEY REFERENCES agencies(id),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  location TEXT,
  contact TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  content TEXT,
  status status_enum DEFAULT 'DRAFT',
  n_likes INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_images (
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (publication_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,

  title TEXT,
  description TEXT,
  location TEXT,
  date DATE,
  start_time TIME,
  end_time TIME,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE event_images (
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (event_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  type reaction_type_enum,

  reacted_at TIMESTAMP DEFAULT now()
);

CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES comments(id) ON DELETE SET NULL,
  image_id UUID REFERENCES images(id) ON DELETE SET NULL,

  content TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  first_name TEXT,
  last_name TEXT,
  nickname TEXT,
  profile_image_url TEXT,
  birth_date DATE,
  nationality TEXT,
  gender TEXT,
  language TEXT,
  company_name TEXT,
  biography TEXT,
  rating NUMERIC,
  total_trips INT,
  is_available BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- PAYMENTS & SUBSCRIPTIONS
-- =====================================================

CREATE TABLE admins (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  admin_id UUID REFERENCES admins(id) ON DELETE SET NULL,

  label TEXT,
  price NUMERIC,
  duration_in_days INT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,
  user_id UUID REFERENCES business_actors(id) ON DELETE SET NULL,

  amount_paid NUMERIC,
  status TEXT,
  id_provider_transaction TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ride_id UUID REFERENCES rides(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  subject TEXT,
  comment TEXT,
  rating NUMERIC,

  created_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- ROLE-BASED ACCESS CONTROL (RBAC)
-- =====================================================

CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE role_has_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE user_has_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Commit the transaction


-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================
```

---
### Fichier : `./bin/src/main/resources/application.yml`
```yaml
server:
  port: 8080

spring:
  application:
    name: fleet-management

  # THE "TOGGLE": Change 'local' to 'remote' to switch databases
  profiles:
    active: local 
    
  docker:
    compose:
      enabled: false

  # POSTGRESQL (R2DBC)
  r2dbc:
    url: r2dbc:postgresql://168.119.122.86:5432/yowyob
    username: master
    password: Azerty1234*

  sql:
    init:
      mode: always

  # REDIS CLUSTER 
  data:
    redis:
      host: 168.119.122.86
      port: 7000
      password: Azerty1234*
      cluster:
        enabled: false 

  # KAFKA 
  kafka:
    bootstrap-servers: 168.119.122.86:9092
    consumer:
      group-id: fleet-management-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CUSTOM CONFIG 
application:
  external:
    stock-service-url: http://168.119.122.86:8081

  kafka:
    topics:
      product-events: test-topic

# RESILIENCE4J 
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5

---
# LOCAL CONFIGURATION
spring:
  config:
    activate:
      on-profile: local
  r2dbc:
    url: r2dbc:postgresql://localhost:5432/yowyob_db
    username: fleet_admin
    password: fleet_password
  sql:
    init:
      mode: never

---
# REMOTE CONFIGURATION (Server)
spring:
  config:
    activate:
      on-profile: remote
  r2dbc:
    url: r2dbc:postgresql://168.119.122.86:5432/yowyob
    username: master
    password: Azerty1234*
  sql:
    init:
      mode: never # SAFETY: Never run the destructive schema.sql on the remote server```

---
### Fichier : `./bin/src/main/resources/prod.application.yml`
```yaml
server:
  port: 8080

spring:
  application:
    name: reactive-hexagonal
    
  docker:
    compose:
      enabled: false

  # POSTGRESQL (R2DBC)
  r2dbc:
    url: r2dbc:postgresql://168.119.122.86:5432/yowyob
    username: master
    password: Azerty1234*

  sql:
    init:
      mode: always

  # REDIS CLUSTER 
  data:
    redis:
      password: Azerty1234*
      cluster:
        nodes:
          - 168.119.122.86:7001
          - 168.119.122.86:7002
          - 168.119.122.86:7003
          - 168.119.122.86:7004
          - 168.119.122.86:7005
          - 168.119.122.86:7006

  # KAFKA 
  kafka:
    bootstrap-servers: 168.119.122.86:9092
    consumer:
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CUSTOM CONFIG 
application:
  external:
    stock-service-url: http://168.119.122.86:8081

  kafka:
    topics:
      product-events: test-topic

# RESILIENCE4J 
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5
```

---
### Fichier : `./bin/.mvn/wrapper/maven-wrapper.properties`
```properties
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip
```

---
### Fichier : `./bin/Readme.md`
```md
# Fleet Management & Geofencing API 🚚🛰️

Service backend réactif pour la gestion de flottes de véhicules et le géorepérage en temps réel.

## 🤝 Workflow de Collaboration IA

Ce projet est développé en mode **Pair Programming** avec une IA (Gemini/ChatGPT). Pour maintenir la cohérence :

1. **Roadmap** : Consultez le fichier `todo.md` pour voir la tâche en cours.
2. **Contextualisation** : L'IA a besoin du code source complet. Utilisez le script de synchronisation :
   ```bash
   chmod +x import_context.sh
   ./import_context.sh
   ```
   Cela génère/met à jour le fichier `project_context.txt`.
3. **Initialisation de l'IA** : Pour commencer une session, copiez-collez le contenu de `docs/prompts/master_pair_programmer.md` suivi du contenu de `project_context.txt`.

## 🛠️ Installation & Tests

### Prérequis
- Java 21
- PostgreSQL (avec accès aux serveurs distants configurés dans le `.yml`)

### Lancer l'application
```bash
./mvnw clean install
./mvnw spring-boot:run
```

### Valider les changements
- **Swagger UI** : [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **Santé de la DB** : Utilisez les endpoints définis dans chaque jalon (voir `todo.md`).
```

```

---
### Fichier : `./bin/pom.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.6</version>
        <relativePath/>
    </parent>
    
    <groupId>com.yowyob</groupId>
    <artifactId>reactive-hexagonal</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>reactive-hexagonal</name>
    <description>Template Hexagonal Reactive pour com.yowyob</description>
    
    <properties>
        <java.version>21</java.version>
        <spring-cloud.version>2023.0.0</spring-cloud.version>
        <mapstruct.version>1.5.5.Final</mapstruct.version>
    </properties>
    
    <dependencies>
        <!-- REACTIVE CORE -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <dependency>
             <groupId>org.springframework.boot</groupId>
             <artifactId>spring-boot-starter-actuator</artifactId>
	</dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>

  
	<dependency>
	   <groupId>io.micrometer</groupId>
	   <artifactId>micrometer-registry-prometheus</artifactId>
	</dependency>

        <!-- DATA (R2DBC & REDIS) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-r2dbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>r2dbc-postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
        </dependency>

        <!-- MESSAGING (KAFKA) -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>
        <dependency>
            <groupId>io.projectreactor.kafka</groupId>
            <artifactId>reactor-kafka</artifactId>
            <version>1.3.22</version>
        </dependency>

        <!-- CLOUD & RESILIENCE -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-circuitbreaker-reactor-resilience4j</artifactId>
        </dependency>

        <!-- TOOLS (Lombok & Mapstruct) -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>${mapstruct.version}</version>
        </dependency>
        
        <!-- Docker Compose Auto-setup -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-docker-compose</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        
        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.projectreactor</groupId>
            <artifactId>reactor-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Documentation API (Swagger/OpenAPI) -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webflux-ui</artifactId>
            <version>2.5.0</version>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${mapstruct.version}</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

---
### Fichier : `./bin/docker-compose.yml`
```yaml
services:
  fleet-db:
    image: postgres:16
    container_name: fleet-management-db
    environment:
      POSTGRES_DB: yowyob_db
      POSTGRES_USER: fleet_admin
      POSTGRES_PASSWORD: fleet_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:```

---
### Fichier : `./docs/contracts_fleet_management.md`
```md
# **API Contracts v1.0 - Fleet Management Service**

This document defines the data contracts and endpoints for the **Fleet Management API** of the TraEnSys project. This service is responsible for managing fleets, vehicles, drivers, tracking trips, and handling geofencing.

## 1. Physical Data Model (Tables)

This section describes the database tables that support the service, based on the class diagram and incorporating the required corrections.

### 1.1. Core Tables

**Table: `fleets`**
Stores information about each vehicle fleet.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the fleet. |
| `name` | VARCHAR(255) | NOT NULL | The public name of the fleet. |
| `creationDate` | DATE | NOT NULL | Date when the fleet was created. |
| `managerUserId`| UUID | FOREIGN KEY | References the `id` of the user (Fleet Manager) in the authentication service. |

**Table: `vehicles`**
Stores all data related to a single vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the vehicle. |
| `fleetId` | UUID | FOREIGN KEY, NOT NULL | The fleet to which the vehicle belongs (`fleets`). |
| `licensePlate` | VARCHAR(50) | NOT NULL, UNIQUE | The vehicle's unique license plate. |
| `brand` | VARCHAR(100) | | Brand of the vehicle (e.g., Toyota). |
| `model` | VARCHAR(100) | | Model of the vehicle (e.g., Yaris). |
| `manufacturingYear` | INT | | The year the vehicle was manufactured. |
| `type` | VEHICLE_TYPE (Enum) | | The type of vehicle (CAR, TRUCK, VAN, BIKE). |
| `color` | VARCHAR(50) | | Color of the vehicle. |

**Table: `drivers`**
Contains information specific to the driver role.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `userId` | UUID | PRIMARY KEY, FOREIGN KEY| References the corresponding user in the authentication service. |
| `assignedVehicleId` | UUID | FOREIGN KEY, UNIQUE | The vehicle currently assigned to the driver (`vehicles`). Can be NULL. |
| `licenceNumber` | VARCHAR(100) | NOT NULL, UNIQUE | The driver's license number. |
| `status` | BOOLEAN | NOT NULL | Indicates if the driver is active (`true`) or inactive (`false`). |

**Table: `trips`**
Logs every trip made by a vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the trip. |
| `vehicleId` | UUID | FOREIGN KEY, NOT NULL | The vehicle that made the trip (`vehicles`). |
| `driverId` | UUID | FOREIGN KEY, NOT NULL | The driver who made the trip (`drivers`). |
| `startDate` | DATE | NOT NULL | The date the trip started. |
| `endDate` | DATE | | The date the trip ended. |
| `startTime` | TIME | NOT NULL | The time the trip started. |
| `endTime` | TIME | | The time the trip ended. |
| `type` | VEHICLE_TYPE (Enum) | | Type of vehicle used (redundant but useful for history). |
| `color` | VARCHAR(50) | | Color of the vehicle (redundant but useful for history). |

### 1.2. Parameter Tables (1-to-1 Relationship with `vehicles`)

**Table: `financial_parameters`**

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL | Linked to a single vehicle (`vehicles`). |
| `insuranceNumber` | VARCHAR(100) | | Insurance policy number. |
| `insuranceExpiryDate` | DATE | | Expiry date of the insurance. |
| `registrationDate`| DATE | | The vehicle's registration date. |
| `purchaseDate` | DATE | | Date the vehicle was purchased. |
| `depreciationRate`| INT | | Annual depreciation rate (as a %). |
| `costPerKm` | FLOAT | | Estimated operational cost per kilometer. |

**Table: `maintenance_parameters`**

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL| Linked to a single vehicle (`vehicles`). |
| `lastMaintenanceDate` | DATE | | Date of the last maintenance. |
| `nextMaintenanceDue` | DATE | | Date when the next maintenance is due. |
| `engineStatus` | ENGINE_STATUS (Enum) | | Status of the engine (OK, NEEDS_SERVICE...). |
| `batteryHealth` | INT | | The health of the battery (as a %). |
| `maintenanceStatus` | MAINTENANCE_STATUS (Enum) | | Overall maintenance status (UP_TO_DATE, PENDING...). |

**Table: `operational_parameters`**
Stores real-time data for a vehicle.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the record. |
| `vehicleId` | UUID | FOREIGN KEY, UNIQUE, NOT NULL| Linked to a single vehicle (`vehicles`). |
| `currentTripId` | UUID | FOREIGN KEY | The current trip for this vehicle (`trips`). Can be NULL. |
| `status` | BOOLEAN | NOT NULL | Operational status (e.g., `true` for in-service). |
| `currentLocationPointId` | UUID | FOREIGN KEY | The last known GPS coordinate (`geofence_points`). |
| `currentSpeed` | FLOAT | | The vehicle's current speed in km/h. |
| `fuelLevel` | VARCHAR(50) | | Current fuel level (e.g., "75%", "12/16"). |
| `mileage` | FLOAT | | Total mileage of the vehicle. |
| `odometerReading`| FLOAT | | The reading from the odometer. |
| `bearing` | FLOAT | | The vehicle's direction of travel in degrees (0-360). |
| `timestamp` | DATETIME | | Timestamp of the last data update. |

### 1.3. Geofencing and Route Tables

**Table: `geofence_zones`**
Defines a geographical zone.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the zone. |
| `name` | VARCHAR(255) | NOT NULL | Name of the zone (e.g., "Mokolo Market Area"). |
| `surfaceArea` | INT | | Area of the zone. |
| `perimeter` | INT | | Perimeter of the zone. |

**Table: `geofence_points`**
Stores the coordinates that define the vertices of geofence zones or points on a route.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the point. |
| `latitude` | FLOAT | NOT NULL | Latitude coordinate. |
| `longitude` | FLOAT | NOT NULL | Longitude coordinate. |

**Table: `geofence_zone_vertices` (Pivot Table)**
Associates points with a zone to form a polygon.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `zoneId` | UUID | FOREIGN KEY, PK | References the zone (`geofence_zones`). |
| `pointId` | UUID | FOREIGN KEY, PK | References the point (`geofence_points`). |
| `vertexOrder` | INT | NOT NULL | The order of the point in the polygon sequence. |

**Table: `routes`**
Defines a route with a start and end point.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the route. |
| `startPointId` | UUID | FOREIGN KEY | The starting point (`geofence_points`). |
| `endPointId` | UUID | FOREIGN KEY | The ending point (`geofence_points`). |

**Table: `trip_routes` (Pivot Table)**
Junction table for the N-N relationship between `trips` and `routes`.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `tripId` | UUID | FOREIGN KEY, PK | References the trip (`trips`). |
| `routeId` | UUID | FOREIGN KEY, PK | References the route (`routes`). |

**Table: `geofence_events`**
Logs every time a vehicle enters or exits a zone.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | Unique identifier for the event. |
| `zoneId` | UUID | FOREIGN KEY, NOT NULL | The zone involved (`geofence_zones`). |
| `vehicleId` | UUID | FOREIGN KEY, NOT NULL | The vehicle involved (`vehicles`). |
| `timestamp` | DATETIME | NOT NULL | The exact time of the event. |
| `type` | EVENT_TYPE (Enum) | NOT NULL | Type of event (ENTRY or EXIT). |

---


## 2. Data Representation

### 2.1. Fleet Model
Represents a collection of vehicles managed by a Fleet Manager.

```json
{
  "id": "f1a2b3c4-fleet-0001-d5e6f7g8h9i0",
  "name": "Yaoundé Express Voyage",
  "creationDate": "2025-01-15",
  "manager": {
    "userId": "7b2e3f4a-1c9d-4b8a-8e6f-2d3c4b5a6d7e",
    "name": "Gabriel Nomo"
  },
  "vehicleCount": 15
}
```

### 2.2. Vehicle Model (Detailed)
Represents a single vehicle with all its associated parameters.

```json
{
  "id": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
  "fleetId": "f1a2b3c4-fleet-0001-d5e6f7g8h9i0",
  "licensePlate": "CE 123 AB",
  "brand": "Toyota",
  "model": "Yaris",
  "manufacturingYear": 2022,
  "type": "CAR",
  "color": "White",
  "assignedDriver": {
    "userId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
    "name": "Aissatou Bello"
  },
  "financialParameters": {
    "insuranceNumber": "INS-YDE-2025-8843",
    "insuranceExpiryDate": "2026-06-30",
    "registrationDate": "2022-07-15",
    "purchaseDate": "2022-07-01",
    "depreciationRate": 15,
    "costPerKm": 125.5
  },
  "maintenanceParameters": {
    "lastMaintenanceDate": "2025-09-10",
    "nextMaintenanceDue": "2026-03-10",
    "engineStatus": "OK",
    "batteryHealth": 92,
    "maintenanceStatus": "UP_TO_DATE"
  },
  "operationalParameters": {
    "status": true,
    "currentSpeed": 45.5,
    "fuelLevel": "65%",
    "mileage": 45012.8,
    "odometerReading": 45012.8,
    "bearing": 182.5,
    "timestamp": "2025-10-30T14:22:10.000Z",
    "currentLocation": {
      "latitude": 3.8667,
      "longitude": 11.5167
    }
  }
}
```

### 2.3. Driver Model
Represents the fleet-specific information of a driver.

```json
{
  "userId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
  "licenceNumber": "YDE/DR/2018/98765",
  "status": true,
  "assignedVehicle": {
    "vehicleId": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
    "licensePlate": "CE 123 AB"
  },
  "userProfile": {
    "name": "Aissatou Bello",
    "phone": "+237699112233"
  }
}
```

### 2.4. Trip Model

```json
{
  "id": "t1r2i3p4-a5b6-4c7d-8e9f-a0b1c2d3e4f5",
  "vehicleId": "v1e2h3c4-c5a6-4b7c-8d9e-f0g1h2i3j4k5",
  "driverId": "d1r2i3v4-e5f6-4a7b-8c9d-e0f1g2h3i4j5",
  "startDate": "2025-10-30",
  "startTime": "08:15:00",
  "endDate": "2025-10-30",
  "endTime": "09:05:00",
  "routes": [
    {
      "routeId": "r1o2u3t4e-001",
      "startPoint": { "latitude": 3.8721, "longitude": 11.5173 },
      "endPoint": { "latitude": 3.8472, "longitude": 11.5015 }
    }
  ]
}
```

### 2.5. Geofence Zone Model

```json
{
  "id": "z1o2n3e4-a5b6-4c7d-8e9f-a0b1c2d3e4f5",
  "name": "Mokolo Market Area",
  "surfaceArea": 1.5,
  "perimeter": 5.2,
  "vertices": [
    { "latitude": 3.8750, "longitude": 11.5000, "order": 1 },
    { "latitude": 3.8790, "longitude": 11.5050, "order": 2 },
    { "latitude": 3.8760, "longitude": 11.5080, "order": 3 },
    { "latitude": 3.8710, "longitude": 11.5030, "order": 4 }
  ]
}
```
---

## 3. General API Rules

-   **Base URL**: `/api/v1`
-   **Data Format**: `application/json`
-   **Authentication**: Header `Authorization: Bearer <JWT_TOKEN>`
-   **Error Handling**:
    ```json
    {
      "timestamp": "2025-10-30T10:30:00.000Z",
      "status": 404,
      "error": "Not Found",
      "message": "Vehicle with ID 'v-invalid-id' not found.",
      "path": "/api/v1/vehicles/v-invalid-id"
    }
    ```
---

## 4. Fleet Management API Endpoints

### 4.1. Fleets (`/fleets`)

#### `POST /fleets`
-   **Description**: Creates a new fleet.
-   **Access**: Authenticated (`fleet:fleet:create`).
-   **Request (Body)**: `{"name": "Douala City Transports", "managerUserId": "a9b8c7d6..."}`
-   **Response (`201 Created`)**: The newly created Fleet object.

#### `GET /fleets`
-   **Description**: Retrieves a list of fleets. For a Fleet Manager, returns only their fleets. For an Admin, returns all fleets.
-   **Access**: Authenticated (`fleet:fleet:read`).
-   **Response (`200 OK`)**: An array of Fleet objects.

#### `GET /fleets/{fleetId}`
-   **Description**: Retrieves detailed information for a specific fleet.
-   **Access**: Authenticated (`fleet:fleet:read`).
-   **Response (`200 OK`)**: A single detailed Fleet object.

#### `PUT /fleets/{fleetId}`
-   **Description**: Updates the details of an existing fleet.
-   **Access**: Authenticated (`fleet:fleet:update`).
-   **Request (Body)**: `{"name": "Douala Premium Transports", "managerUserId": "a9b8c7d6..."}`
-   **Response (`200 OK`)**: The updated Fleet object.

#### `DELETE /fleets/{fleetId}`
-   **Description**: Deletes a fleet. Business logic should prevent deletion if the fleet still contains vehicles.
-   **Access**: Authenticated (`fleet:fleet:delete`).
-   **Response (`204 No Content`)**.

### 4.2. Vehicles (`/vehicles`)

#### `POST /fleets/{fleetId}/vehicles`
-   **Description**: Adds a new vehicle to a specified fleet.
-   **Access**: Authenticated (`fleet:vehicle:create`).
-   **Request (Body)**: `{ "licensePlate": "CE 789 EF", "brand": "Toyota", "model": "RAV4", ... }`
-   **Response (`201 Created`)**: The full detailed Vehicle Model.

#### `GET /vehicles`
-   **Description**: Retrieves a paginated list of all vehicles accessible to the user.
-   **Access**: Authenticated (`fleet:vehicle:read`).
-   **Query Parameters**: `?fleetId={id}&type=CAR&status=true`
-   **Response (`200 OK`)**: An array of Vehicle objects.

#### `GET /vehicles/{vehicleId}`
-   **Description**: Retrieves the complete details of a single vehicle.
-   **Access**: Authenticated (`fleet:vehicle:read`).
-   **Response (`200 OK`)**: The full Vehicle Model JSON.

#### `PUT /vehicles/{vehicleId}`
-   **Description**: Updates the core details of a vehicle (brand, model, color, etc.).
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "model": "Corolla", "color": "Blue", "manufacturingYear": 2021 }`
-   **Response (`200 OK`)**: The updated full Vehicle Model.

#### `DELETE /vehicles/{vehicleId}`
-   **Description**: Deletes a vehicle from the system.
-   **Access**: Authenticated (`fleet:vehicle:delete`).
-   **Response (`204 No Content`)**.

#### `PUT /vehicles/{vehicleId}/financial-parameters`
-   **Description**: Updates the financial parameters for a specific vehicle.
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "insuranceNumber": "INS-NEW-2025-1111", "costPerKm": 130.0 }`
-   **Response (`200 OK`)**: The updated Financial Parameters object.

#### `PUT /vehicles/{vehicleId}/maintenance-parameters`
-   **Description**: Updates the maintenance parameters for a specific vehicle.
-   **Access**: Authenticated (`fleet:vehicle:update`).
-   **Request (Body)**: `{ "lastMaintenanceDate": "2025-10-28", "engineStatus": "NEEDS_SERVICE" }`
-   **Response (`200 OK`)**: The updated Maintenance Parameters object.

### 4.3. Drivers (`/drivers`)

#### `POST /drivers`
-   **Description**: Registers an existing system user as a driver.
-   **Access**: Authenticated (`fleet:driver:create`).
-   **Request (Body)**: `{ "userId": "u1s2e3r4...", "licenceNumber": "LT/DR/2020/11223" }`
-   **Response (`201 Created`)**: The full Driver Model.

#### `GET /drivers`
-   **Description**: Retrieves a list of all drivers.
-   **Access**: Authenticated (`fleet:driver:read`).
-   **Query Parameters**: `?status=true`
-   **Response (`200 OK`)**: An array of Driver objects.

#### `GET /drivers/{driverUserId}`
-   **Description**: Retrieves the profile for a specific driver.
-   **Access**: Authenticated (`fleet:driver:read`).
-   **Response (`200 OK`)**: A single Driver Model object.

#### `PUT /drivers/{driverUserId}`
-   **Description**: Updates a driver's fleet-specific information.
-   **Access**: Authenticated (`fleet:driver:update`).
-   **Request (Body)**: `{ "licenceNumber": "YDE/DR/2022/55443", "status": false }`
-   **Response (`200 OK`)**: The updated Driver Model.

#### `DELETE /drivers/{driverUserId}`
-   **Description**: De-registers a user as a driver (does not delete the user account).
-   **Access**: Authenticated (`fleet:driver:delete`).
-   **Response (`204 No Content`)**.

#### `POST /drivers/{driverUserId}/assign-vehicle`
-   **Description**: Assigns a vehicle to a driver.
-   **Access**: Authenticated (`fleet:driver:assign`).
-   **Request (Body)**: `{ "vehicleId": "v1e2h3c4..." }`
-   **Response (`200 OK`)**: `{ "message": "Vehicle assigned successfully." }`

#### `POST /drivers/{driverUserId}/unassign-vehicle`
-   **Description**: Unassigns the current vehicle from a driver.
-   **Access**: Authenticated (`fleet:driver:assign`).
-   **Response (`200 OK`)**: `{ "message": "Vehicle unassigned successfully." }`

### 4.4. Trips (`/trips`)

#### `POST /trips`
-   **Description**: Starts a new trip for a vehicle.
-   **Access**: Authenticated (`fleet:trip:create`).
-   **Request (Body)**: `{ "vehicleId": "v1e2h3c4...", "driverId": "d1r2i3v4...", "startDate": "2025-10-31", "startTime": "09:00:00" }`
-   **Response (`201 Created`)**: The new Trip object.

#### `GET /trips`
-   **Description**: Retrieves a list of trips, with filtering options.
-   **Access**: Authenticated (`fleet:trip:read`).
-   **Query Parameters**: `?vehicleId={id}&driverId={id}&startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`
-   **Response (`200 OK`)**: An array of Trip objects.

#### `GET /trips/{tripId}`
-   **Description**: Retrieves the details of a single trip.
-   **Access**: Authenticated (`fleet:trip:read`).
-   **Response (`200 OK`)**: A single Trip Model object.

#### `POST /trips/{tripId}/end`
-   **Description**: Ends an active trip.
-   **Access**: Authenticated (`fleet:trip:update`).
-   **Request (Body)**: `{ "endDate": "2025-10-31", "endTime": "11:30:00" }`
-   **Response (`200 OK`)**: The updated Trip object.

### 4.5. Geofencing (`/geofence`)

#### `POST /geofence/zones`
-   **Description**: Creates a new geofence zone.
-   **Access**: Authenticated (`fleet:geofence:create`).
-   **Request (Body)**: `{ "name": "Bastos Residential Area", "vertices": [...] }`
-   **Response (`201 Created`)**: The full Geofence Zone Model.

#### `GET /geofence/zones`
-   **Description**: Retrieves a list of all defined geofence zones.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Response (`200 OK`)**: An array of Geofence Zone objects.

#### `GET /geofence/zones/{zoneId}`
-   **Description**: Retrieves the details of a single geofence zone.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Response (`200 OK`)**: A single Geofence Zone Model object.

#### `PUT /geofence/zones/{zoneId}`
-   **Description**: Updates a geofence zone's name or vertices.
-   **Access**: Authenticated (`fleet:geofence:update`).
-   **Request (Body)**: `{ "name": "Bastos VIP Area", "vertices": [...] }`
-   **Response (`200 OK`)**: The updated Geofence Zone Model.

#### `DELETE /geofence/zones/{zoneId}`
-   **Description**: Deletes a geofence zone.
-   **Access**: Authenticated (`fleet:geofence:delete`).
-   **Response (`204 No Content`)**.

#### `GET /geofence/events`
-   **Description**: Retrieves a log of geofence events, with optional filters.
-   **Access**: Authenticated (`fleet:geofence:read`).
-   **Query Parameters**: `?vehicleId={id}&zoneId={id}&type=ENTRY&startDate=YYYY-MM-DD`
-   **Response (`200 OK`)**: An array of geofence event objects.```

---
### Fichier : `./docs/refactor/2_database_structure.md`
```md
# 🗄️ Documentation du Modèle Physique de Données (MPD)

**Projet :** Fleet Management & Geofencing System (TransEns)
**Date :** 18 Janvier 2026
**Version :** 1.0 (Validée)

---

## 1. Organisation Globale

La base de données est structurée en deux schémas distincts pour séparer les données transverses (Authentification) des données métier.

### 🔹 Schéma `public` (Identité & Accès)
Ce schéma contient les données partagées par l'écosystème TransEns. Il est principalement géré par le service d'Authentification externe, mais nous maintenons une copie locale pour l'intégrité référentielle.

*   **`users`** : Table mère contenant les identifiants (UUID), noms, emails et mots de passe.
*   **`roles` / `permissions`** : Gestion des droits d'accès (RBAC).

### 🔹 Schéma `fleet` (Cœur de Métier)
Ce schéma contient toutes les tables spécifiques à la gestion de flotte.

---

## 2. Description des Tables (Schéma `fleet`)

### 2.1. Les Acteurs
Ces tables étendent la table `public.users` (Héritage de données).

| Table | Description | Clé Primaire / Étrangère |
| :--- | :--- | :--- |
| **`fleet_managers`** | Profil métier du gestionnaire. Contient les infos d'entreprise et d'abonnement. | PK/FK : `user_id` (ref `users`) |
| **`drivers`** | Profil métier du chauffeur. Contient le permis et le statut d'activité. | PK/FK : `user_id` (ref `users`) <br> FK : `fleet_id` |

### 2.2. Organisation de la Flotte

| Table | Description | Relations |
| :--- | :--- | :--- |
| **`fleets`** | Représente une entité flotte (entreprise de transport). | FK : `manager_id` (Un manager gère une ou plusieurs flottes). |

### 2.3. Gestion des Véhicules
Le véhicule est une entité centrale composée de plusieurs tables pour séparer les responsabilités.

| Table | Description | Relations |
| :--- | :--- | :--- |
| **`vehicles`** | Table pivot. Contient les infos d'identification (Plaque, Marque, Modèle) et l'état d'assignation. | FK : `fleet_id`<br>FK : `current_driver_id` (Relation 1-1 temporaire) |
| **`financial_parameters`** | Données financières (Assurance, Coût/km, Achat). | FK : `vehicle_id` (1-1) |
| **`maintenance_parameters`** | État de santé (Moteur, Batterie, Dates de révision). | FK : `vehicle_id` (1-1) |
| **`operational_parameters`** | Données temps réel (Vitesse, Carburant, Kilométrage). | FK : `vehicle_id` (1-1)<br>FK : `current_location_point_id` |

### 2.4. Trajets et Géométrie

| Table | Description | Relations |
| :--- | :--- | :--- |
| **`trips`** | Enregistrement d'une course (Début, Fin, Statut). | FK : `vehicle_id`, `driver_id` |
| **`routes`** | Composition d'un trajet. Relie un trajet à ses points clés. | FK : `trip_id`, `start_point_id`, `end_point_id` |
| **`geofence_points`** | Coordonnées GPS brutes (Latitude, Longitude). | Utilisé par `routes` et `operational_parameters`. |

### 2.5. Geofencing (Zones et Alertes)

| Table | Description | Relations |
| :--- | :--- | :--- |
| **`geofence_zones`** | Définition des zones surveillées (Nom, Superficie). | FK : `fleet_id` |
| **`zone_points_link`** | Table de liaison pour construire la géométrie des zones (Polygone). | FK : `zone_id`, `point_id` |
| **`geofence_events`** | Historique des entrées/sorties de zone (Alertes). | FK : `vehicle_id`, `zone_id` |

---

## 3. Diagramme Relationnel (Visuel)

Voici la représentation visuelle du modèle validé :

![Modèle Physique de Données](bd.png)```

---
### Fichier : `./docs/refactor/3_scenarios_and_endpoints.md`
```md
# 📜 Scénarios Fonctionnels & Contrats d'API

**Projet :** Fleet Management System
**Version :** 2.1 (Validée)
**Objectif :** Définir toutes les interactions possibles entre le Frontend et le Backend.

---

## 1. Module : Authentification & Profils
*Gestion de l'identité et du compte personnel. L'application agit souvent comme un proxy vers le service Auth distant.*

| Acteur | Scénario | Méthode | Endpoint | Description |
| :--- | :--- | :---: | :--- | :--- |
| **Tous** | **S'inscrire** | `POST` | `/api/v1/auth/register` | Création de compte (User + Profil métier). Upload photo optionnel. |
| **Tous** | **Se connecter** | `POST` | `/api/v1/auth/login` | Récupération du Token JWT. |
| **Tous** | **Rafraîchir Token** | `POST` | `/api/v1/auth/refresh` | Renouvellement de session sans login. |
| **Tous** | **Voir mon profil** | `GET` | `/api/v1/auth/me` | Récupère les infos agrégées (Auth + Rôle local). |
| **Tous** | **Mettre à jour profil** | `PUT` | `/api/v1/auth/me` | Modification nom, téléphone, photo, etc. |
| **Tous** | **Supprimer mon compte** | `DELETE` | `/api/v1/auth/me` | Désactivation complète (Soft delete). |

---

## 2. Module : Administration (Super-User)
*Gestion des entreprises (Fleet Managers).*

| Acteur | Scénario | Méthode | Endpoint | Description |
| :--- | :--- | :---: | :--- | :--- |
| **Admin** | **Créer un Manager** | `POST` | `/api/v1/admin/managers` | Enrôlement manuel d'une entreprise. |
| **Admin** | **Lister les Managers** | `GET` | `/api/v1/admin/managers` | Liste paginée avec filtres (nom, statut). |
| **Admin** | **Détail d'un Manager** | `GET` | `/api/v1/admin/managers/{id}` | Infos complètes + Stats rapides. |
| **Admin** | **Modifier un Manager** | `PUT` | `/api/v1/admin/managers/{id}` | Mise à jour données administratives. |
| **Admin** | **Supprimer un Manager** | `DELETE` | `/api/v1/admin/managers/{id}` | Suppression définitive ou archivage. |
| **Admin** | **Suspendre/Activer** | `PATCH` | `/api/v1/admin/managers/{id}/status` | Bloque l'accès à la plateforme. |
| **Admin** | **Statistiques Globales**| `GET` | `/api/v1/admin/stats` | Vue d'ensemble (Nb Flottes, Véhicules, Users). |

---

## 3. Module : Gestion des Flottes
*Un Fleet Manager organise ses ressources en "Flottes".*

| Acteur | Scénario | Méthode | Endpoint | Description |
| :--- | :--- | :---: | :--- | :--- |
| **Manager** | **Créer une flotte** | `POST` | `/api/v1/fleets` | Création d'une entité organisationnelle. |
| **Manager** | **Lister mes flottes** | `GET` | `/api/v1/fleets` | Liste des flottes gérées par le user connecté. |
| **Manager** | **Détail d'une flotte** | `GET` | `/api/v1/fleets/{id}` | Infos + Synthèse (nb véhicules, nb drivers). |
| **Manager** | **Modifier une flotte** | `PUT` | `/api/v1/fleets/{id}` | Renommage, contact. |
| **Manager** | **Supprimer une flotte** | `DELETE` | `/api/v1/fleets/{id}` | Possible seulement si vide (ou cascade). |

---

## 4. Module : Gestion des Véhicules
*Cœur de l'inventaire. Le véhicule est une entité complexe composée.*

### 4.1. CRUD Véhicule (Base)
| Acteur | Scénario | Méthode | Endpoint | Description |
| :--- | :--- | :---: | :--- | :--- |
| **Manager** | **Ajouter un véhicule** | `POST` | `/api/v1/fleets/{id}/vehicles` | Création pivot (Plaque, Marque, Modèle). |
| **Manager** | **Lister les véhicules** | `GET` | `/api/v1/fleets/{id}/vehicles` | Filtres: Statut, Driver, Marque. |
| **Manager** | **Détail complet** | `GET` | `/api/v1/vehicles/{id}` | Agrège TOUT (Infos, Finance, Maint, Position). |
| **Manager** | **Modifier infos base** | `PUT` | `/api/v1/vehicles/{id}` | Marque, Modèle, Couleur, Année. |
| **Manager** | **Supprimer véhicule** | `DELETE` | `/api/v1/vehicles/{id}` | Retire le véhicule de la gestion. |

### 4.2. Gestion des Détails (Sous-ressources)
| Acteur | Scénario | Méthode | Endpoint | Description |
| :--- | :--- | :---: | :--- | :--- |
| **Manager** | **M.à.j Financier** | `PUT` | `/api/v1/vehicles/{id}/financial` | Assurance, Coût/km, Achat, Amortissement. |
| **Manager** | **M.à.j Maintenance** | `PUT` | `/api/v1/vehicles/{id}/maintenance` | Dates révision, État moteur, Santé batterie. |
| **Manager** | **Voir Opérationnel** | `GET` | `/api/v1/vehicles/{id}/operational` | Vue spécifique Télémétrie (Vitesse, Fuel, Km). |
| **Manager** | **Ajouter Photo** | `POST` | `/api/v1/vehicles/{id}/photos` | Upload image (Extérieur/Intérieur). |
| **Manager** | **Supprimer Photo** | `DELETE` | `/api/v1/vehicles/{id}/photos/{photoId}` | Suppression d'une image. |

---

## 5. Module : Gestion des Chauffeurs
*Le chauffeur est un Utilisateur avec des droits restreints et un permis.*

| Acteur | Scénario | Méthode | Endpoint | Description |
| :--- | :--- | :---: | :--- | :--- |
| **Manager** | **Enrôler un chauffeur** | `POST` | `/api/v1/drivers` | Crée le compte User + le Profil Driver. |
| **Manager** | **Lister mes chauffeurs**| `GET` | `/api/v1/drivers` | Liste filtrable (Actifs, En course, Libres). |
| **Manager** | **Détail Chauffeur** | `GET` | `/api/v1/drivers/{id}` | Profil, Permis, Véhicule actuel, Stats. |
| **Manager** | **Modifier Chauffeur** | `PUT` | `/api/v1/drivers/{id}` | Mise à jour infos, permis, photo. |
| **Manager** | **Désactiver Chauffeur** | `DELETE` | `/api/v1/drivers/{id}` | Désactive le compte (ne supprime pas l'historique). |
| **Manager** | **Assigner Véhicule** | `POST` | `/api/v1/drivers/{id}/assign` | Lie un véhicule libre à ce chauffeur. |
| **Manager** | **Libérer Chauffeur** | `POST` | `/api/v1/drivers/{id}/unassign` | Retire le véhicule (fin de quart). |

---

## 6. Module : Opérations & Trajets (Mobile)
*Utilisé par l'application Chauffeur.*

| Acteur | Scénario | Méthode | Endpoint | Description |
| :--- | :--- | :---: | :--- | :--- |
| **Driver** | **Mon Véhicule** | `GET` | `/api/v1/driver/vehicle` | Récupère le véhicule assigné au user connecté. |
| **Driver** | **Démarrer Course** | `POST` | `/api/v1/trips` | Initie un trajet. Start GPS. |
| **Driver** | **Envoyer Position** | `POST` | `/api/v1/trips/{id}/telemetry` | Envoi périodique (Lat, Lng, Vitesse). |
| **Driver** | **Terminer Course** | `POST` | `/api/v1/trips/{id}/end` | Clôture le trajet (Calcul distance/temps). |
| **Driver** | **Mes Trajets** | `GET` | `/api/v1/driver/trips` | Historique personnel. |
| **Manager**| **Tous les Trajets** | `GET` | `/api/v1/trips` | Historique global filtrable. |
| **Manager**| **Détail Trajet** | `GET` | `/api/v1/trips/{id}` | Tracé sur carte, timeline événements. |

---

## 7. Module : Geofencing
*Définition des zones de surveillance.*

| Acteur | Scénario | Méthode | Endpoint | Description |
| :--- | :--- | :---: | :--- | :--- |
| **Manager** | **Créer une Zone** | `POST` | `/api/v1/geofence/zones` | Envoi GeoJSON (Polygone/Cercle). |
| **Manager** | **Lister les Zones** | `GET` | `/api/v1/geofence/zones` | Récupère toutes les zones définies. |
| **Manager** | **Détail Zone** | `GET` | `/api/v1/geofence/zones/{id}` | Géométrie précise et règles. |
| **Manager** | **Modifier Zone** | `PUT` | `/api/v1/geofence/zones/{id}` | Ajustement des points ou du nom. |
| **Manager** | **Supprimer Zone** | `DELETE` | `/api/v1/geofence/zones/{id}` | Suppression logique. |
| **Manager** | **Historique Alertes** | `GET` | `/api/v1/geofence/events` | Liste des entrées/sorties détectées. |```

---
### Fichier : `./docs/refactor/5_dynamic_data_model.md`
```md
# 🔄 Modèle des Objets Dynamiques & Statiques

**Projet :** Fleet Management System
**Version :** 1.1 (Renommage Rôles)
**Date :** 18 Janvier 2026

Ce document définit la stratégie de gestion des données de référence.

## 1. Principes Directeurs
*   **Données Dynamiques (Tables) :** Ce sont des données métier que l'Administrateur doit pouvoir enrichir via le Dashboard sans intervention technique (ex: ajouter un type de véhicule).
*   **Données Statiques (Enums) :** Ce sont des états liés à la logique algorithmique du code (ex: un trajet est "En cours"). Les modifier implique une modification du code Java.

---

## 2. Objets Dynamiques (Tables de Référence)

Ces objets seront gérés via des **CRUD** dans le module Administration.

### 2.1. Types de Véhicules (`fleet.vehicle_types`)
*   **Besoin :** Flexibilité totale pour définir le parc (Voiture, Camion, Moto, Engin de chantier...).
*   **Structure :**
    *   `id` (UUID) : Clé primaire.
    *   `code` (VARCHAR unique) : Identifiant technique (ex: `HEAVY_TRUCK`, `MOTO`).
    *   `label` (VARCHAR) : Libellé affiché (ex: "Poids Lourd", "Moto Taxi").
    *   `description` (TEXT) : Détails facultatifs.

---

## 3. Objets Statiques (Enums PostgreSQL)

Ces listes sont figées dans la structure de la base de données et dans le code Java (Classes `Enum`).

### 3.1. Rôles Utilisateurs (Namespace `FLEET_`)
*Pour éviter les conflits avec d'autres microservices de l'écosystème TransEns.*

| Code (Enum) | Description | Périmètre |
| :--- | :--- | :--- |
| **`FLEET_ADMIN`** | Super-administrateur du module Fleet. | Gestion globale des comptes managers. |
| **`FLEET_MANAGER`** | Client B2B (Gestionnaire). | Gestion de sa flotte, ses véhicules, ses zones. |
| **`FLEET_DRIVER`** | Chauffeur / Employé mobile. | Utilisation de l'App Mobile, exécution des trajets. |

### 3.2. Statuts Opérationnels

#### Véhicule (`vehicle_status_enum`)
*   `AVAILABLE` : Prêt à être assigné ou conduit.
*   `ON_TRIP` : Actuellement en course (verrouillé).
*   `MAINTENANCE` : Indisponible pour cause technique.

#### Chauffeur (`driver_status_enum`)
*   `ACTIVE` : Peut se connecter et prendre des courses.
*   `INACTIVE` : Compte suspendu ou en congé.

#### Trajet (`trip_status_enum`)
*   `SCHEDULED` : Planifié (Futur).
*   `ONGOING` : En cours (GPS actif).
*   `COMPLETED` : Terminé avec succès.
*   `CANCELLED` : Annulé avant la fin.

### 3.3. Indicateurs Techniques & Alertes

#### Moteur (`engine_status_enum`)
*   `OK`
*   `NEEDS_SERVICE`
*   `OUT_OF_SERVICE`

#### Maintenance (`maintenance_status_enum`)
*   `UP_TO_DATE`
*   `PENDING`
*   `OVERDUE`

#### Geofencing (`event_type_enum`)
*   `ENTRY` : Entrée dans une zone.
*   `EXIT` : Sortie d'une zone.

---

## 4. Impact sur le Schéma SQL

1.  **Table `vehicles`** :
    *   La colonne `type` ne sera plus un `ENUM`.
    *   Elle devient `vehicle_type_id` (UUID), une **Clé Étrangère** vers la table `fleet.vehicle_types`.

2.  **Table `trips`** :
    *   Pour garder l'historique, un trajet stockera aussi `vehicle_type_id` (FK) pour savoir quel type de véhicule a été utilisé à ce moment-là.

3.  **Gestion des Rôles** :
    *   Les rôles sont stockés dans le schéma `public` (tables partagées), mais nous insèrerons spécifiquement les valeurs `FLEET_ADMIN`, `FLEET_MANAGER`, `FLEET_DRIVER` lors du seeding initial.

---```

---
### Fichier : `./docs/refactor/1_analysis_of_needs.md`
```md
# 📋 Analyse des Besoins : Fleet Management & Geofencing

**Projet :** TraEnSys - Module de Gestion de Flotte
**Date :** 18 Janvier 2026
**Version :** 1.0 (Validée)

---

## 1. Vision et Périmètre du Projet

### 1.1 Objectif Principal
Développer une plateforme B2B permettant aux entreprises de transport (taxis, logistique, livraisons) de **superviser** leurs flottes de véhicules en temps réel, de gérer leurs chauffeurs et de contrôler le respect des zones géographiques d'activité (**Geofencing**).

### 1.2 Clarification sur le "Client Final"
Conformément à l'analyse du métier, le rôle du **"Client Final"** (passager ou destinataire) est **exclu du périmètre fonctionnel principal**.
*   **Raison :** Le système est un outil de supervision interne (Manager <-> Chauffeur), et non une application de mise en relation de type VTC (Uber/Yango).
*   **Optionnel :** Une fonctionnalité de "Lien de suivi public" pourra être envisagée en bonus, mais aucune gestion de compte "Client" ne sera développée.

### 1.3 Matériel Cible
*   **Suivi GPS :** Assuré exclusivement par le **smartphone Android du chauffeur**. Aucun boîtier matériel (OBD/Tracker) n'est requis.
*   **Cartographie :** Utilisation de solutions Open Source (OpenStreetMap).

---

## 2. Acteurs du Système

| Acteur | Rôle | Plateforme |
| :--- | :--- | :--- |
| **Administrateur (Admin)** | Super-utilisateur technique. Gère l'accès au service pour les entreprises. | Web (Back-office) |
| **Gestionnaire (Fleet Manager)** | Utilisateur principal. Propriétaire d'une flotte. Supervise les opérations au quotidien. | Web (Dashboard) |
| **Chauffeur (Driver)** | Employé conduisant le véhicule. Source de la donnée GPS. | Mobile (Android) |

---

## 3. Besoins Fonctionnels par Acteur

### 👮‍♂️ 3.1 Pour l'Administrateur
1.  **Gestion des Comptes Managers :** Créer, modifier, suspendre ou supprimer les comptes des gestionnaires de flotte (Fleet Managers).
2.  **Supervision Globale :** Visualiser les statistiques d'utilisation de la plateforme (nombre total de flottes, véhicules connectés).
3.  **Diffusion de Messages :** Envoyer des notifications système (maintenance, infos) à tous les utilisateurs.

### 👔 3.2 Pour le Gestionnaire de Flotte (Fleet Manager)
*Le cœur de l'application métier.*

**A. Gestion des Ressources**
1.  **Véhicules :** Enregistrer les véhicules (Marque, Modèle, Plaque) et gérer leurs statuts (En service, En maintenance).
2.  **Chauffeurs :** Enregistrer les chauffeurs (Nom, Permis, Photo) et gérer leurs profils.
3.  **Assignation :** Associer un véhicule à un chauffeur pour une période donnée.

**B. Supervision & Géolocalisation**

4.  **Tracking Temps Réel :** Visualiser sur une carte interactive la position instantanée de tous les véhicules actifs.
5.  **Historique des Trajets :** Consulter les trajets passés (Tracé sur carte, Heure début/fin, Distance parcourue).

**C. Geofencing (Fonctionnalité Clé)**

6.  **Définition de Zones :** Dessiner des zones sur la carte (Polygones ou Cercles).
7.  **Règles d'Alerte :** Configurer des déclencheurs (ex: "Alerter si le véhicule sort de la zone Douala-Centre").
8.  **Réception d'Alertes :** Recevoir une notification (Push/In-App) immédiate en cas de violation d'une règle.

**D. Administratif**

9.  **Tableau de Bord :** Vue synthétique des performances (Km parcourus, temps de conduite).
10. **Abonnement :** Gérer son niveau de service (Premium) via un système de paiement.

### 🧢 3.3 Pour le Chauffeur (Driver)
*L'outil de terrain.*

1.  **Authentification :** Connexion sécurisée sur l'application mobile.
2.  **Gestion de la Course (Le "Switch") :**
    *   **Début de service (Start Trip) :** Active le GPS et commence la transmission des données au serveur.
    *   **Fin de service (End Trip) :** Arrête le GPS et clôture le trajet.
3.  **Mode Déconnecté (Offline) :** En cas de perte de réseau (fréquent), l'application doit stocker les points GPS localement et les synchroniser dès le retour de la connexion.
4.  **Réception d'Ordres :** Recevoir les notifications ou alertes envoyées par le Manager.

---

## 4. Exigences Non-Fonctionnelles (Contraintes)

1.  **Performance Temps Réel :** La latence entre la position réelle du véhicule et son affichage sur l'écran du manager ne doit pas excéder **5 secondes**.
2.  **Robustesse Réseau :** Le système doit être résilient aux coupures d'internet mobile (mécanisme de *Retry* et *Buffer*).
3.  **Sécurité des Données :** Les données de localisation sont sensibles. L'accès doit être strictement cloisonné (un Manager ne voit que SA flotte).
4.  **Intégration Externe :** Le système doit s'interfacer avec le Service d'Authentification Centralisé de l'écosystème TransEns (pas de gestion de mots de passe en local).

---

## 5. Synthèse des Priorités (Roadmap)

1.  **Priorité 1 (Core) :** Authentification, Gestion CRUD (Véhicules/Chauffeurs/Assignation), Démarrage/Fin de trajet simple.
2.  **Priorité 2 (Tracking) :** Remontée GPS fluide, Carte temps réel.
3.  **Priorité 3 (Geofencing) :** Dessin de zones, Moteur de détection Entrée/Sortie, Alertes.
4.  **Priorité 4 (Avancé) :** Statistiques, Mode Offline avancé, Paiements.```

---
### Fichier : `./docs/refactor/4_api_general_rules.md`
```md
# 🛡️ Règles Générales de l'API & Standards

**Projet :** Fleet Management System
**Version :** 2.0 (Consolidation)
**Framework :** Spring Boot WebFlux (Reactive)

Ce document définit les normes techniques, les formats d'échange, la sécurité et la gestion des erreurs pour tous les endpoints du microservice.

---

## 1. Principes Fondamentaux

*   **Protocole :** REST sur HTTP(S).
*   **Encodage :** UTF-8.
*   **Format de données :** `application/json` (Sauf pour l'upload de fichiers : `multipart/form-data`).
*   **Dates :** Format ISO 8601 UTC (ex: `2026-01-18T14:30:00Z`).
*   **Identifiants :** UUID v4 pour toutes les ressources (ex: `550e8400-e29b-41d4-a716-446655440000`).
*   **Stateless :** Aucune session serveur (utilisation de JWT).

---

## 2. Sécurité & Contrôle d'Accès

### 2.1. Authentification
L'API est sécurisée par **Bearer Token (JWT)**.
Le token doit être présent dans le header de chaque requête protégée :
```http
Authorization: Bearer <votre_token_jwt>
```

### 2.2. Classification des Routes

#### 🟢 Routes Publiques (Accessibles sans token)
Ces routes sont ouvertes pour permettre l'accès initial ou le monitoring.
*   `POST /api/v1/auth/login` : Connexion.
*   `POST /api/v1/auth/register` : Inscription.
*   `POST /api/v1/auth/refresh` : Rafraîchissement de token.
*   `GET /actuator/health` : Vérification de l'état du système (Health Check).
*   `GET /swagger-ui/**` & `/v3/api-docs/**` : Documentation API.

#### 🔒 Routes Protégées (Token Requis)
**Toutes les autres routes sont protégées par défaut.**
L'accès est ensuite affiné par **Rôle (RBAC)** :

*   **ADMIN** : Accès complet aux routes `/api/v1/admin/**`.
*   **FLEET_MANAGER** : Accès aux routes de gestion (`/fleets`, `/drivers`, `/vehicles`, `/geofence`).
    *   *Règle métier :* Un manager ne peut voir/modifier **que** les ressources de ses propres flottes.
*   **DRIVER** : Accès restreint aux routes opérationnelles (`/api/v1/driver/**`, `/trips`).

---

## 3. Codes de Statut HTTP (Standards)

L'API utilise les codes HTTP standards pour indiquer le succès ou l'échec d'une requête.

| Code | Signification | Contexte d'utilisation |
| :--- | :--- | :--- |
| **200** | `OK` | Requête traitée avec succès (Lecture, Modification). |
| **201** | `Created` | Ressource créée avec succès (ex: Création véhicule). |
| **204** | `No Content` | Action réussie mais pas de contenu à renvoyer (ex: Suppression). |
| **400** | `Bad Request` | Erreur client (Validation, format JSON invalide). |
| **401** | `Unauthorized` | Token manquant, invalide ou expiré. |
| **403** | `Forbidden` | Token valide, mais droits insuffisants pour cette action. |
| **404** | `Not Found` | Ressource introuvable (ID inexistant). |
| **409** | `Conflict` | Conflit métier (ex: Email déjà utilisé, Véhicule déjà assigné). |
| **422** | `Unprocessable` | Erreur sémantique (ex: Date de fin avant date de début). |
| **500** | `Server Error` | Bug serveur non géré (NullPointer, DB down). |

---

## 4. Gestion des Erreurs (Robustesse)

Pour faciliter le travail du Frontend, **toutes les erreurs** (4xx et 500) renverront un corps de réponse JSON uniformisé.

### 4.1. Structure de l'objet Erreur

```json
{
  "timestamp": "2026-01-18T14:45:00Z",
  "status": 409,
  "error": "Conflict",
  "message": "Ce véhicule est déjà assigné à un autre chauffeur.",
  "path": "/api/v1/drivers/assign-vehicle",
  "code": "VEHICLE_ALREADY_ASSIGNED" // (Optionnel) Code métier interne
}
```

### 4.2. Stratégie de Message

1.  **Erreur Métier Gérée (Business Exception) :**
    *   Si le code lève une exception métier (ex: `VehicleAlreadyAssignedException`), le `message` contiendra l'explication claire pour l'utilisateur.
    *   *Exemple :* "Impossible de supprimer cette flotte car elle contient encore des véhicules."

2.  **Erreur de Validation (Validation Exception) :**
    *   Si les données d'entrée sont invalides (`@Valid`), le `message` listera les champs en erreur.
    *   *Exemple :* "L'email est obligatoire, La plaque d'immatriculation est invalide."

3.  **Erreur Serveur Non Gérée (Internal Server Error) :**
    *   Si le serveur plante (bug, timeout DB), on **ne renvoie jamais** la stacktrace au client (sécurité).
    *   Le `message` sera générique et constant.
    *   *Exemple :* **"Un problème technique est survenu. Veuillez réessayer plus tard ou contacter le support."**

---

## 5. Formats de Réponse (Succès)

### 5.1. Ressource Unique
Retourne directement l'objet JSON.
```json
// GET /api/v1/vehicles/{id}
{
  "id": "uuid...",
  "licensePlate": "LT 123",
  "brand": "Toyota"
}
```

### 5.2. Liste (Collection)
Retourne un tableau JSON (si pas de pagination) ou un objet paginé.

**Format Paginé (Standard Spring Data) :**
```json
// GET /api/v1/vehicles?page=0&size=10
{
  "content": [
    { "id": "1", "model": "Yaris" },
    { "id": "2", "model": "Corolla" }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10
  },
  "totalElements": 45,
  "totalPages": 5,
  "last": false
}
```

---

## 6. Bonnes Pratiques pour les Développeurs

1.  **Validation :** Ne jamais faire confiance au frontend. Valider toutes les entrées (DTOs) avec des annotations (`@NotNull`, `@Email`, etc.).
2.  **Logging :**
    *   Logguer les erreurs 500 avec la stacktrace complète (pour nous).
    *   Ne pas logguer de données sensibles (mots de passe).
3.  **Idempotence :** Les requêtes `GET`, `PUT`, `DELETE` doivent pouvoir être relancées sans effet de bord indésirable.
4.  **Performance :** Utiliser les types réactifs (`Mono`, `Flux`) de bout en bout. Ne jamais bloquer un thread (`Thread.sleep`, JDBC classique dans le flux principal).```

---
### Fichier : `./docs/remarks_of_conception.md`
```md
# Remarques cahier d'analyse et conception

# Objectif
L'objectif de ce document est de fournir des remarques pour le cahier d'analyse et conception du projet Fleet management et geofence s'integrant dans le projet synthese de 5Gi: Trans Ens

# Liste des remarques

Chaque remarque sera constitue d'un page du titre de la remarque et de la description

---
## R1: raphael au feminin 

**page**: 2

**descripion**:  
Bihai rapahel
rapahel est ecrit au feminin,est-ce normal?

---
## R2: utilisation de FareCalculator

**page** : 14

**description** : Notre systeme utilisera t'il reellement farecalculator ? si oui dans quel cas d'utilisation ?

---

## R3: Absence de Navigoo dans le diagarmme de contexte

**page** : 14

**description** : Notre systeme utilisera certainement l'api des cartes pour montrer au client,chauffeur,fleet amanager mais notre diagaramme de contexte de le met pas en evidence

---

## R4: fautre d'orthographe

**page** : 14

**description** : les acteurs (qui utilise le système),le verbe utiliser doit etre a la 3e personne du pluriel(`avec ent`)

---

## R5: Probleme de coherence entre les diagrammes de cas d'utilisation et de contexte

**page** : 14 et 15

**description** : sur le diagramme de contexte,on voit bien que farecalculator fait partie des acteurs externes et le customer aussi mais dans le diagramme de cas d'utilisation,on ne les retrpiuve pas. De plus,on retrouve navigoo qui n'etait pas dans le diagramme de contexte. 

---

## R6: diagramme de use case,coherence dans le regroupement des use case

**page** : 15

**description** : 
Je remarque la factorisation qui est regroupage elegant des cas d'utilisation dans ce diagramme par l'heritage,ce qui est une bnne chose mais pour l'acteur fleet manager,je trouve que ce n'est pas suffisemment regroupe pour le management des vehicule(je parle de track vehicule,view vehicule statictics qui selpon moi sont des sous-cas de manage vehicule)

---
## R7: diagramme de sequence systeme
**page** : 29

**description** : 
- la methode valider identifiant que le systeme envoir a l'api d'auth doit etre une fonction ayant pour parametre les identifiants(email,mot de passe)

- Il y'a egalement un probleme de coherence linguistique,depuis le debut tous les diagrammes sont en anglais,mais celui ci est en francais.il nous faut une seule langue.

- est ce que le token est un message ou une variable? je crois aussi qu'ici c'est une fontion que l'api d'auth utilise pour envoyer le token et le role...aussi le role 
---
```

---
### Fichier : `./docs/data/YOWYOB_DB/yowyob_db_seed.sql`
```sql
-- =====================================================
-- YOWYOB DB - DATA SEEDING SCRIPT
-- PostgreSQL
-- =====================================================

BEGIN;

-- =====================================================
-- 1. CLEANUP EXISTING DATA
-- =====================================================
TRUNCATE TABLE 
    users, images, countries, business_actors, 
    admins, fleet_managers, drivers, customers, 
    providers, employees, prospects, sales_persons,
    profiles, settings, addresses, contacts,
    roles, permissions, role_has_permissions, user_has_roles,
    organizations, agencies, business_domains, organization_business_domains,
    certifications, third_parties, proposed_activities, services, branches,
    fleets, vehicles, geofence_zones, geofence_points, geofence_events,
    roads, trips, offers, rides, reviews, offer_driver_linkages,
    operational_parameters, financial_parameters, maintenance_parameters,
    geofence_point_zone_linkages,
    syndicats, abstract_products, products, 
    publications, publication_images, publication_votes, votes,
    events, event_images, reactions, comments, avis,
    subscriptions, payments
    RESTART IDENTITY CASCADE;

-- =====================================================
-- 2. STATIC REFERENCE DATA
-- =====================================================

-- Countries
INSERT INTO countries (name, code) VALUES
('Cameroun', 'CM'), ('Sénégal', 'SN'), ('Côte d''Ivoire', 'CI'), 
('Gabon', 'GA'), ('Nigéria', 'NG'), ('Togo', 'TG');

-- Roles
INSERT INTO roles (name, guard_name) VALUES
('ADMIN', 'web'), ('FLEET_MANAGER', 'web'), ('DRIVER', 'web'), ('CUSTOMER', 'web');

-- Images (Random placeholders from Picsum)
INSERT INTO images (url, alt_text) 
SELECT 
    'https://picsum.photos/seed/' || i || '/800/600', 
    'Image aléatoire ' || i
FROM generate_series(1, 50) as i;

-- =====================================================
-- 3. USERS GENERATION (100 users)
-- =====================================================

INSERT INTO users (name, phone_number, email_address)
SELECT 
    (ARRAY['Mamadou', 'Jean-Pierre', 'Ibrahim', 'Fatou', 'Aminata', 'Ngolo', 'Aboubakar', 'Clarisse', 'Samuel', 'Kouamé', 'Aissatou', 'Bachelard', 'Landry', 'Thérèse'])[floor(random()*14)+1] 
    || ' ' || 
    (ARRAY['Diop', 'Njoya', 'Mbarga', 'Kone', 'Sow', 'Etoundi', 'Kamga', 'Traoré', 'Diallo', 'Fofana', 'Mensah', 'Atangana', 'Eto''o', 'Drogba'])[floor(random()*14)+1],
    (ARRAY['+237', '+221', '+225'])[floor(random()*3)+1] || (600000000 + floor(random()*99999999)::int),
    'user_' || i || '@yowyob.test'
FROM generate_series(1, 100) as i;

-- Settings & Profiles
INSERT INTO settings (user_id, theme, language, receive_push_notifications)
SELECT id, 'LIGHT', 'fr', true FROM users;

INSERT INTO profiles (user_id, first_name, nationality, is_verified)
SELECT id, split_part(name, ' ', 1), 'Camerounais', (random() > 0.5) FROM users;

-- =====================================================
-- 4. ACTORS DISPATCHING
-- User -> BusinessActor -> SpecificActor
-- =====================================================

-- 4.1 Admins (First 5 users)
INSERT INTO admins (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5;

-- 4.2 Fleet Managers (Next 5 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- STEP 2: Insert into CHILD (FleetManager)
INSERT INTO fleet_managers (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- 4.3 Drivers (Next 30 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- STEP 2: Insert into CHILD (Driver)
INSERT INTO drivers (id, status, license_number, has_car)
SELECT 
    id, 
    (ARRAY['AVAILABLE', 'BUSY', 'OFFLINE'])[floor(random()*3)+1], 
    'LIC-' || floor(random()*100000) || '-CM',
    (random() > 0.3)
FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- 4.4 Customers (Remaining 60 users)
INSERT INTO customers (id, code, payment_method)
SELECT 
    id, 
    'CUST-' || substr(id::text, 1, 8),
    (ARRAY['CASH', 'MOBILE_MONEY', 'CARD'])[floor(random()*3)+1]
FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- Assign Roles
INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'ADMIN') FROM users ORDER BY email_address LIMIT 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'FLEET_MANAGER') FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'DRIVER') FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'CUSTOMER') FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- =====================================================
-- 5. ORGANIZATIONS & AGENCIES
-- =====================================================

INSERT INTO organizations (
    business_actor_id, logo_id, code, short_name, long_name, 
    description, tax_number, is_active, status
)
SELECT
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    (SELECT id FROM images ORDER BY random() LIMIT 1),
    'ORG-' || i,
    'Transport ' || i,
    'Société de Transport ' || i,
    'Description ' || i,
    'TAX-' || floor(random()*1000000),
    true,
    'PUBLISHED'
FROM generate_series(1, 35) as i;

INSERT INTO agencies (
    organization_id, manager_id, name, city, location, is_headquarter
)
SELECT 
    id, 
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    'Agence Centrale',
    (ARRAY['Douala', 'Yaoundé', 'Abidjan'])[floor(random()*3)+1],
    'Rue Principale',
    true
FROM organizations;

-- =====================================================
-- 6. FLEETS & VEHICLES
-- =====================================================

INSERT INTO fleets (fleet_manager_id, name, phone_number)
SELECT 
    id, 'Flotte de ' || name, '+237699000000'
FROM fleet_managers;

-- Vehicles
INSERT INTO vehicles (
    fleet_id, user_id, driver_id, license_plate, brand, model, type, color, manufacturing_year
)
SELECT 
    f.id,
    f.fleet_manager_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    'LT-' || floor(random()*999)::text || '-AA',
    (ARRAY['Toyota', 'Peugeot'])[floor(random()*2)+1],
    (ARRAY['Yaris', 'Partner'])[floor(random()*2)+1],
    (ARRAY['CAR', 'VAN'])[floor(random()*2)+1]::vehicle_type_enum,
    'Jaune',
    2020
FROM fleets f;

-- =====================================================
-- 7. OFFERS & RIDES
-- =====================================================

INSERT INTO offers (
    passenger_id, start_point, end_point, price, state, created_at
)
SELECT 
    (SELECT id FROM customers ORDER BY random() LIMIT 1),
    'Point A', 'Point B', 
    2000, 
    'CHOSEN',
    NOW()
FROM generate_series(1, 60) as i;

-- Rides
INSERT INTO rides (
    offer_id, passenger_id, driver_id, 
    distance, time_estimation, real_time, state, created_at
)
SELECT 
    id, -- offer_id
    passenger_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    15.5, 30, 35,
    'COMPLETED',
    created_at
FROM offers 
LIMIT 40;

-- Reviews
INSERT INTO reviews (ride_id, author_id, subject, comment, rating)
SELECT 
    id,
    passenger_id,
    'Chauffeur',
    'Bonne course, chauffeur ponctuel',
    5
FROM rides
WHERE state = 'COMPLETED';

-- =====================================================
-- 8. PRODUCTS
-- =====================================================

INSERT INTO products (
    organization_id, name, description, standard_price, 
    status, is_active, departure_location
)
SELECT 
    (SELECT id FROM organizations ORDER BY random() LIMIT 1),
    'Trajet Spécial ' || i,
    'Description produit',
    5000,
    'PUBLISHED',
    true,
    'Douala'
FROM generate_series(1, 40) as i;

-- =====================================================
-- 9. SUBSCRIPTIONS & PAYMENTS
-- =====================================================

INSERT INTO subscriptions (
    admin_id, label, price, duration_in_days, description, is_active
) VALUES 
((SELECT id FROM admins LIMIT 1), 'Pack Hebdo', 2500, 7, 'Standard', true),
((SELECT id FROM admins LIMIT 1), 'Pack Mensuel', 10000, 30, 'Pro', true),
((SELECT id FROM admins LIMIT 1), 'Pack Annuel', 100000, 365, 'VIP', true);

INSERT INTO payments (
    driver_id, user_id, subscription_id, amount_paid, status, id_provider_transaction, created_at
)
SELECT 
    d.id, -- Driver ID
    d.id, -- Payer ID
    s.id, -- Subscription ID
    s.price,
    'SUCCESS',
    'TXN-' || floor(random()*10000000),
    NOW()
FROM drivers d
CROSS JOIN subscriptions s
ORDER BY random()
LIMIT 50;

-- =====================================================
-- 10. SOCIAL & ADDRESSES
-- =====================================================

INSERT INTO syndicats (organization_id, name, is_approved)
SELECT id, 'Syndicat Transports', true FROM organizations LIMIT 1;

INSERT INTO branches (id, syndicat_id, name, location)
SELECT 
    ag.id,
    (SELECT id FROM syndicats LIMIT 1),
    'Branche ' || ag.name, 
    ag.location 
FROM agencies ag 
LIMIT 10;

INSERT INTO publications (branch_id, author_id, content, status, n_likes)
SELECT 
    (SELECT id FROM branches ORDER BY random() LIMIT 1),
    (SELECT id FROM admins ORDER BY random() LIMIT 1),
    'Info Trafic ' || i,
    'PUBLISHED',
    floor(random() * 50)::int
FROM generate_series(1, 40) as i;

COMMIT;```

---
### Fichier : `./docs/data/YOWYOB_DB/last_schema/data.sql`
```sql
-- =====================================================
-- YOWYOB DB - DATA SEEDING SCRIPT
-- PostgreSQL
-- =====================================================


-- =====================================================
-- 1. CLEANUP EXISTING DATA
-- =====================================================
TRUNCATE TABLE 
    users, images, countries, business_actors, 
    admins, fleet_managers, drivers, customers, 
    providers, employees, prospects, sales_persons,
    profiles, settings, addresses, contacts,
    roles, permissions, role_has_permissions,  user_has_permissions,user_has_roles,
    organizations, agencies, business_domains, organization_business_domains,
    certifications, third_parties, proposed_activities, services, branches,
    fleets, vehicles, geofence_zones, geofence_points, geofence_events,
    roads, trips, offers, rides, reviews, offer_driver_linkages,
    operational_parameters, financial_parameters, maintenance_parameters,
    geofence_point_zone_linkages,
    syndicats, abstract_products, products, 
    publications, publication_images, publication_votes, votes,
    events, event_images, reactions, comments, avis,
    subscriptions, payments
    RESTART IDENTITY CASCADE;

-- =====================================================
-- 2. STATIC REFERENCE DATA
-- =====================================================

-- Countries
INSERT INTO countries (name, code) VALUES
('Cameroun', 'CM'), ('Sénégal', 'SN'), ('Côte d''Ivoire', 'CI'), 
('Gabon', 'GA'), ('Nigéria', 'NG'), ('Togo', 'TG');

-- Roles
INSERT INTO roles (name, guard_name) VALUES
('ADMIN', 'web'), ('FLEET_MANAGER', 'web'), ('DRIVER', 'web'), ('CUSTOMER', 'web');

-- Images (Random placeholders from Picsum)
INSERT INTO images (url, alt_text) 
SELECT 
    'https://picsum.photos/seed/' || i || '/800/600', 
    'Image aléatoire ' || i
FROM generate_series(1, 50) as i;

-- =====================================================
-- 3. USERS GENERATION (100 users)
-- =====================================================

INSERT INTO users (name, phone_number, email_address)
SELECT 
    (ARRAY['Mamadou', 'Jean-Pierre', 'Ibrahim', 'Fatou', 'Aminata', 'Ngolo', 'Aboubakar', 'Clarisse', 'Samuel', 'Kouamé', 'Aissatou', 'Bachelard', 'Landry', 'Thérèse'])[floor(random()*14)+1] 
    || ' ' || 
    (ARRAY['Diop', 'Njoya', 'Mbarga', 'Kone', 'Sow', 'Etoundi', 'Kamga', 'Traoré', 'Diallo', 'Fofana', 'Mensah', 'Atangana', 'Eto''o', 'Drogba'])[floor(random()*14)+1],
    (ARRAY['+237', '+221', '+225'])[floor(random()*3)+1] || (600000000 + floor(random()*99999999)::int),
    'user_' || i || '@yowyob.test'
FROM generate_series(1, 100) as i;

-- Settings & Profiles
INSERT INTO settings (user_id, theme, language, receive_push_notifications)
SELECT id, 'LIGHT', 'fr', true FROM users;

INSERT INTO profiles (user_id, first_name, nationality, is_verified)
SELECT id, split_part(name, ' ', 1), 'Camerounais', (random() > 0.5) FROM users;

-- =====================================================
-- 4. ACTORS DISPATCHING
-- User -> BusinessActor -> SpecificActor
-- =====================================================

-- 4.1 Admins (First 5 users)
INSERT INTO admins (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5;

-- 4.2 Fleet Managers (Next 5 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- STEP 2: Insert into CHILD (FleetManager)
INSERT INTO fleet_managers (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- 4.3 Drivers (Next 30 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- STEP 2: Insert into CHILD (Driver)
INSERT INTO drivers (id, status, license_number, has_car)
SELECT 
    id, 
    (ARRAY['AVAILABLE', 'BUSY', 'OFFLINE'])[floor(random()*3)+1], 
    'LIC-' || floor(random()*100000) || '-CM',
    (random() > 0.3)
FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- 4.4 Customers (Remaining 60 users)
INSERT INTO customers (id, code, payment_method)
SELECT 
    id, 
    'CUST-' || substr(id::text, 1, 8),
    (ARRAY['CASH', 'MOBILE_MONEY', 'CARD'])[floor(random()*3)+1]
FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- Assign Roles
INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'ADMIN') FROM users ORDER BY email_address LIMIT 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'FLEET_MANAGER') FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'DRIVER') FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'CUSTOMER') FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- =====================================================
-- 5. ORGANIZATIONS & AGENCIES
-- =====================================================

INSERT INTO organizations (
    business_actor_id, logo_id, code, short_name, long_name, 
    description, tax_number, is_active, status
)
SELECT
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    (SELECT id FROM images ORDER BY random() LIMIT 1),
    'ORG-' || i,
    'Transport ' || i,
    'Société de Transport ' || i,
    'Description ' || i,
    'TAX-' || floor(random()*1000000),
    true,
    'PUBLISHED'
FROM generate_series(1, 35) as i;

INSERT INTO agencies (
    organization_id, manager_id, name, city, location, is_headquarter
)
SELECT 
    id, 
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    'Agence Centrale',
    (ARRAY['Douala', 'Yaoundé', 'Abidjan'])[floor(random()*3)+1],
    'Rue Principale',
    true
FROM organizations;

-- =====================================================
-- 6. FLEETS & VEHICLES
-- =====================================================

INSERT INTO fleets (fleet_manager_id, name, phone_number)
SELECT 
    id, 'Flotte de ' || name, '+237699000000'
FROM fleet_managers;

-- Vehicles
INSERT INTO vehicles (
    fleet_id, user_id, driver_id, license_plate, brand, model, type, color, manufacturing_year
)
SELECT 
    f.id,
    f.fleet_manager_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    'LT-' || floor(random()*999)::text || '-AA',
    (ARRAY['Toyota', 'Peugeot'])[floor(random()*2)+1],
    (ARRAY['Yaris', 'Partner'])[floor(random()*2)+1],
    (ARRAY['CAR', 'VAN'])[floor(random()*2)+1]::vehicle_type_enum,
    'Jaune',
    2020
FROM fleets f;

-- =====================================================
-- 7. OFFERS & RIDES
-- =====================================================

INSERT INTO offers (
    passenger_id, start_point, end_point, price, state, created_at
)
SELECT 
    (SELECT id FROM customers ORDER BY random() LIMIT 1),
    'Point A', 'Point B', 
    2000, 
    'CHOSEN',
    NOW()
FROM generate_series(1, 60) as i;

-- Rides
INSERT INTO rides (
    offer_id, passenger_id, driver_id, 
    distance, time_estimation, real_time, state, created_at
)
SELECT 
    id, -- offer_id
    passenger_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    15.5, 30, 35,
    'COMPLETED',
    created_at
FROM offers 
LIMIT 40;

-- Reviews
INSERT INTO reviews (ride_id, author_id, subject, comment, rating)
SELECT 
    id,
    passenger_id,
    'Chauffeur',
    'Bonne course, chauffeur ponctuel',
    5
FROM rides
WHERE state = 'COMPLETED';

-- =====================================================
-- 8. PRODUCTS
-- =====================================================

INSERT INTO products (
    organization_id, name, description, standard_price, 
    status, is_active, departure_location
)
SELECT 
    (SELECT id FROM organizations ORDER BY random() LIMIT 1),
    'Trajet Spécial ' || i,
    'Description produit',
    5000,
    'PUBLISHED',
    true,
    'Douala'
FROM generate_series(1, 40) as i;

-- =====================================================
-- 9. SUBSCRIPTIONS & PAYMENTS
-- =====================================================

INSERT INTO subscriptions (
    admin_id, label, price, duration_in_days, description, is_active
) VALUES 
((SELECT id FROM admins LIMIT 1), 'Pack Hebdo', 2500, 7, 'Standard', true),
((SELECT id FROM admins LIMIT 1), 'Pack Mensuel', 10000, 30, 'Pro', true),
((SELECT id FROM admins LIMIT 1), 'Pack Annuel', 100000, 365, 'VIP', true);

INSERT INTO payments (
    driver_id, user_id, subscription_id, amount_paid, status, id_provider_transaction, created_at
)
SELECT 
    d.id, -- Driver ID
    d.id, -- Payer ID
    s.id, -- Subscription ID
    s.price,
    'SUCCESS',
    'TXN-' || floor(random()*10000000),
    NOW()
FROM drivers d
CROSS JOIN subscriptions s
ORDER BY random()
LIMIT 50;

-- =====================================================
-- 10. SOCIAL & ADDRESSES
-- =====================================================

INSERT INTO syndicats (organization_id, name, is_approved)
SELECT id, 'Syndicat Transports', true FROM organizations LIMIT 1;

INSERT INTO branches (id, syndicat_id, name, location)
SELECT 
    ag.id,
    (SELECT id FROM syndicats LIMIT 1),
    'Branche ' || ag.name, 
    ag.location 
FROM agencies ag 
LIMIT 10;

INSERT INTO publications (branch_id, author_id, content, status, n_likes)
SELECT 
    (SELECT id FROM branches ORDER BY random() LIMIT 1),
    (SELECT id FROM admins ORDER BY random() LIMIT 1),
    'Info Trafic ' || i,
    'PUBLISHED',
    floor(random() * 50)::int
FROM generate_series(1, 40) as i;

-- =====================================================
-- SEEDING DIRECT PERMISSIONS (Test)
-- =====================================================

-- On crée quelques permissions
INSERT INTO permissions (id, name) VALUES 
(uuid_generate_v4(), 'extra:special_access'),
(uuid_generate_v4(), 'fleet:emergency_stop');

-- On donne la première permission au premier utilisateur (Admin 1)
INSERT INTO user_has_permissions (user_id, permission_id)
VALUES (
    (SELECT id FROM users ORDER BY email_address LIMIT 1),
    (SELECT id FROM permissions WHERE name = 'extra:special_access' LIMIT 1)
);
```

---
### Fichier : `./docs/data/YOWYOB_DB/last_schema/schema.sql`
```sql
-- =====================================================
-- YOWYOB DB - INIT SCRIPT
-- PostgreSQL
-- Structure: Core -> Organization -> RBAC
-- =====================================================

-- Clean up existing tables and types to ensure a fresh start
-- We drop them in reverse order of dependency
DROP TABLE IF EXISTS user_has_roles CASCADE;
DROP TABLE IF EXISTS role_has_permissions CASCADE;
DROP TABLE IF EXISTS permissions CASCADE;
DROP TABLE IF EXISTS roles CASCADE;
DROP TABLE IF EXISTS reviews CASCADE;
DROP TABLE IF EXISTS payments CASCADE;
DROP TABLE IF EXISTS subscriptions CASCADE;
DROP TABLE IF EXISTS admins CASCADE;
DROP TABLE IF EXISTS profiles CASCADE;
DROP TABLE IF EXISTS comments CASCADE;
DROP TABLE IF EXISTS reactions CASCADE;
DROP TABLE IF EXISTS event_images CASCADE;
DROP TABLE IF EXISTS events CASCADE;
DROP TABLE IF EXISTS publication_images CASCADE;
DROP TABLE IF EXISTS publications CASCADE;
DROP TABLE IF EXISTS branches CASCADE;
DROP TABLE IF EXISTS avis CASCADE;
DROP TABLE IF EXISTS votes CASCADE;
DROP TABLE IF EXISTS publication_votes CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS abstract_products CASCADE;
DROP TABLE IF EXISTS syndicats CASCADE;
DROP TABLE IF EXISTS offer_driver_linkages CASCADE;
DROP TABLE IF EXISTS geofence_events CASCADE;
DROP TABLE IF EXISTS geofence_point_zone_linkages CASCADE;
DROP TABLE IF EXISTS geofence_points CASCADE;
DROP TABLE IF EXISTS maintenance_parameters CASCADE;
DROP TABLE IF EXISTS financial_parameters CASCADE;
DROP TABLE IF EXISTS operational_parameters CASCADE;
DROP TABLE IF EXISTS trips CASCADE;
DROP TABLE IF EXISTS roads CASCADE;
DROP TABLE IF EXISTS vehicles CASCADE;
DROP TABLE IF EXISTS geofence_zones CASCADE;
DROP TABLE IF EXISTS fleets CASCADE;
DROP TABLE IF EXISTS fleet_managers CASCADE;
DROP TABLE IF EXISTS rides CASCADE;
DROP TABLE IF EXISTS offers CASCADE;
DROP TABLE IF EXISTS drivers CASCADE;
DROP TABLE IF EXISTS services CASCADE;
DROP TABLE IF EXISTS customers CASCADE;
DROP TABLE IF EXISTS sales_persons CASCADE;
DROP TABLE IF EXISTS prospects CASCADE;
DROP TABLE IF EXISTS employees CASCADE;
DROP TABLE IF EXISTS providers CASCADE;
DROP TABLE IF EXISTS addresses CASCADE;
DROP TABLE IF EXISTS proposed_activities CASCADE;
DROP TABLE IF EXISTS settings CASCADE;
DROP TABLE IF EXISTS third_parties CASCADE;
DROP TABLE IF EXISTS certifications CASCADE;
DROP TABLE IF EXISTS organization_business_domains CASCADE;
DROP TABLE IF EXISTS contacts CASCADE;
DROP TABLE IF EXISTS business_domains CASCADE;
DROP TABLE IF EXISTS agencies CASCADE;
DROP TABLE IF EXISTS organizations CASCADE;
DROP TABLE IF EXISTS business_actors CASCADE;
DROP TABLE IF EXISTS countries CASCADE;
DROP TABLE IF EXISTS images CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- Drop existing types
DROP TYPE IF EXISTS reaction_type_enum CASCADE;
DROP TYPE IF EXISTS type_enum CASCADE;
DROP TYPE IF EXISTS role_type_enum CASCADE;
DROP TYPE IF EXISTS engine_status_enum CASCADE;
DROP TYPE IF EXISTS maintenance_status_enum CASCADE;
DROP TYPE IF EXISTS event_type_enum CASCADE;
DROP TYPE IF EXISTS ride_state_enum CASCADE;
DROP TYPE IF EXISTS offer_state_enum CASCADE;
DROP TYPE IF EXISTS vehicle_type_enum CASCADE;
DROP TYPE IF EXISTS action_enum CASCADE;
DROP TYPE IF EXISTS category_enum CASCADE;
DROP TYPE IF EXISTS status_enum CASCADE;

-- Re-enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";


-- =====================================================
-- ENUM TYPES
-- =====================================================

CREATE TYPE status_enum AS ENUM (
  'DRAFT', 'WAITING_CONFIRMATION', 'PUBLISHED', 'IN_PROGRESS', 'CANCELLED', 'EXPIRED'
);

CREATE TYPE category_enum AS ENUM (
  'ANNOUNCE', 'PLANNING', 'VEHICLE', 'ADDRESS', 'EXPERIENCE'
);

CREATE TYPE action_enum AS ENUM (
  'CREATE', 'UPDATE', 'READ', 'DELETE'
);

CREATE TYPE vehicle_type_enum AS ENUM (
  'CAR', 'VAN', 'TRUCK', 'BIKE'
);

CREATE TYPE offer_state_enum AS ENUM (
  'NEW', 'PENDING', 'CHOSEN', 'TERMINATED', 'CANCELED'
);

CREATE TYPE ride_state_enum AS ENUM (
  'CONFIRMED', 'ONGOING', 'COMPLETED', 'CANCELED'
);

CREATE TYPE event_type_enum AS ENUM (
  'ENTRY', 'EXIT'
);

CREATE TYPE maintenance_status_enum AS ENUM (
  'UP_TO_DATE', 'PENDING', 'OVERDUE'
);

CREATE TYPE engine_status_enum AS ENUM (
  'OK', 'NEED_SERVICE', 'OUT_OF_SERVICE'
);

CREATE TYPE role_type_enum AS ENUM (
  'CUSTOMER', 'DRIVER', 'FLEET_MANAGER', 'ADMIN', 'PASSENGER', 'PRESIDENT', 'MODERATOR', 'CLIENT'
);

CREATE TYPE type_enum AS ENUM (
  'NOTIFICATION', 'CHAT', 'PAYMENT', 'MEDIA'
);

CREATE TYPE reaction_type_enum AS ENUM (
  'LIKE', 'LOVE', 'HAHA', 'WOW', 'SAD', 'ANGRY'
);

-- =====================================================
-- CORE TABLES
-- =====================================================

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  phone_number TEXT,
  email_address TEXT UNIQUE
);

CREATE TABLE images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url TEXT NOT NULL,
  alt_text TEXT,
  uploaded_at TIMESTAMP DEFAULT now()
);

CREATE TABLE countries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE business_actors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT,
  phone_number TEXT,
  email_address TEXT,
  CONSTRAINT fk_business_actor_user
    FOREIGN KEY (id) REFERENCES users(id)
    ON DELETE CASCADE
);

-- =====================================================
-- ORGANIZATION TABLES
-- =====================================================

CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_actor_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  email TEXT,
  short_name TEXT,
  long_name TEXT,
  description TEXT,
  logo_uri TEXT,
  website_url TEXT,
  social_network TEXT,
  business_registration_number TEXT,
  tax_number TEXT,
  capital_share NUMERIC,
  ceo_name TEXT,
  year_founded INT,
  keywords TEXT,
  number_of_employees INT,
  legal_form TEXT,
  is_active BOOLEAN DEFAULT true,
  status status_enum DEFAULT 'DRAFT',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, -- Must belong to an org

  owner_id UUID REFERENCES business_actors(id),
  manager_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  name TEXT,
  location TEXT,
  description TEXT,
  transferable BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  logo_uri TEXT,
  short_name TEXT,
  long_name TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  is_headquarter BOOLEAN DEFAULT false,
  country TEXT,
  city TEXT,
  latitude NUMERIC,
  longitude NUMERIC,
  open_time TIME,
  close_time TIME,
  phone TEXT,
  email TEXT,
  whatsapp TEXT,
  greeting_message TEXT,
  average_revenue NUMERIC,
  capital_share NUMERIC,
  registration_number TEXT,
  social_network TEXT,
  tax_number TEXT,
  keywords TEXT,
  is_public BOOLEAN DEFAULT false,
  is_business BOOLEAN DEFAULT true,
  total_affiliated_customers INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE business_domains (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL, -- optional link to organization
  parent_id UUID REFERENCES business_domains(id) ON DELETE SET NULL,   -- self-referential for hierarchy
  image_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  name TEXT,
  image_uri TEXT,
  type TEXT,
  type_label TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE organization_business_domains (
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  business_domain_id UUID REFERENCES business_domains(id) ON DELETE CASCADE,
  PRIMARY KEY (organization_id, business_domain_id)
);

CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  contactable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  contactable_type TEXT,
  first_name TEXT,
  last_name TEXT,
  title TEXT,
  is_email_verified BOOLEAN DEFAULT false,
  is_phone_number_verified BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  phone_number TEXT,
  secondary_phone_number TEXT,
  fax_number TEXT,
  email TEXT,
  secondary_email TEXT,
  email_verified_at TIMESTAMP,
  phone_verified_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE certifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  description TEXT,
  obtainment_date DATE,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE third_parties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  logo_id UUID REFERENCES images(id),

  code TEXT,
  type TEXT,
  legal_form TEXT,
  unique_identification_number TEXT,
  trade_registration_number TEXT,
  name TEXT,
  acronym TEXT,
  long_name TEXT,
  logo_uri TEXT,
  accounting_account_numbers TEXT,
  authorized_payment_methods TEXT,
  authorized_credit_limit NUMERIC,
  max_discount_rate NUMERIC,
  vat_subject BOOLEAN,
  operations_balance NUMERIC,
  opening_balance NUMERIC,
  pay_term_number INT,
  pay_term_type TEXT,
  third_party_family TEXT,
  classification TEXT,
  tax_number TEXT,
  loyalty_points NUMERIC,
  loyalty_points_used NUMERIC,
  loyalty_points_expired NUMERIC,
  enabled BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE settings (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  theme TEXT,
  language TEXT,
  long_ride_enabled BOOLEAN DEFAULT false,
  short_ride_enabled BOOLEAN DEFAULT false,
  privacy_enable BOOLEAN DEFAULT true,
  allow_calls BOOLEAN DEFAULT true,
  allow_messages BOOLEAN DEFAULT true,
  notify_new_rides BOOLEAN DEFAULT true,
  notify_ratings BOOLEAN DEFAULT true,
  notify_practical_tips BOOLEAN DEFAULT true,
  notify_promotions BOOLEAN DEFAULT true,
  notify_policy_updates BOOLEAN DEFAULT true,
  notify_peak_hour_recommendations BOOLEAN DEFAULT true,
  receive_email BOOLEAN DEFAULT true,
  receive_sms BOOLEAN DEFAULT true,
  receive_push_notifications BOOLEAN DEFAULT true,
  receive_whatsapp BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE proposed_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  rate NUMERIC,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE addresses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  addressable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  country_id UUID REFERENCES countries(id) ON DELETE SET NULL,

  addressable_type TEXT,
  type TEXT,
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  state TEXT,
  locality TEXT,
  zip_code TEXT,
  postal_code TEXT,
  po_box TEXT,
  is_default BOOLEAN DEFAULT false,
  neighbor_hood TEXT,
  informal_description TEXT,
  latitude NUMERIC,
  longitude NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

-- =====================================================
-- USERS EXTENDED
-- =====================================================

CREATE TABLE providers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  contact_info TEXT,
  address TEXT,
  is_active BOOLEAN DEFAULT true,
  product_service_type TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE employees (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  is_manager BOOLEAN DEFAULT false,
  role TEXT,
  department TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE prospects (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,
  interest_level TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE sales_persons (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  commission_rate NUMERIC,
  credit NUMERIC,
  current_balance NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE customers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

-- =====================================================
-- RIDE & FLEET MANAGEMENT
-- =====================================================

CREATE TABLE drivers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  status TEXT,
  license_number TEXT,
  has_car BOOLEAN DEFAULT false
);

CREATE TABLE offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  passenger_id UUID REFERENCES customers(id) ON DELETE CASCADE,

  start_point TEXT,
  end_point TEXT,
  price NUMERIC,
  state offer_state_enum DEFAULT 'NEW',
  ids_interested_drivers TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE rides (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  offer_id UUID REFERENCES offers(id) ON DELETE SET NULL,
  passenger_id UUID REFERENCES users(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  distance NUMERIC,
  time_estimation NUMERIC,
  real_time NUMERIC,
  state ride_state_enum DEFAULT 'CONFIRMED',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet_managers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE fleets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fleet_manager_id UUID REFERENCES fleet_managers(id) ON DELETE SET NULL,

  name TEXT,
  phone_number TEXT,
  email_address TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE geofence_zones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  surface_area NUMERIC,
  perimeter NUMERIC
);

CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  fleet_id UUID REFERENCES fleets(id) ON DELETE SET NULL,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,

  license_plate TEXT,
  model TEXT,
  brand TEXT,
  manufacturing_year INT,
  type vehicle_type_enum,
  color TEXT
);

CREATE TABLE roads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  start_point TEXT,
  end_point TEXT
);

CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  road_id UUID REFERENCES roads(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  start_date DATE,
  end_date DATE,
  start_time TIME,
  end_time TIME,
  type TEXT,
  color TEXT
);

CREATE TABLE operational_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  statut TEXT,
  current_location TEXT,
  current_speed NUMERIC,
  fuel_level NUMERIC,
  mileage NUMERIC,
  odometer_reading NUMERIC,
  bearing NUMERIC,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE financial_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  insurance_number TEXT,
  insurance_expired_at DATE,
  registered_at DATE,
  purchased_at DATE,
  depreciation_rate NUMERIC,
  cost_per_km NUMERIC
);

CREATE TABLE maintenance_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  last_maintenance_at DATE,
  next_maintenance_at DATE,
  engine_status engine_status_enum DEFAULT 'OK',
  battery_health TEXT,
  maintenance_status maintenance_status_enum DEFAULT 'UP_TO_DATE'
);

CREATE TABLE geofence_points (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  latitude NUMERIC,
  longitude NUMERIC
);

CREATE TABLE geofence_point_zone_linkages (
  point_id UUID REFERENCES geofence_points(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE CASCADE,
  PRIMARY KEY (point_id, zone_id)
);

CREATE TABLE geofence_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,
  point_id UUID REFERENCES geofence_points(id) ON DELETE SET NULL,

  type event_type_enum,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE offer_driver_linkages (
  offer_id UUID REFERENCES offers(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE CASCADE,
  PRIMARY KEY (offer_id, driver_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- OTHERS: PRODUCTS, SYNDICATS, PUBLICATIONS & REVIEWS
-- =====================================================

CREATE TABLE syndicats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  is_approved BOOLEAN DEFAULT false,
  name TEXT,
  description TEXT,
  domain TEXT,
  type TEXT,
  charte_url TEXT,
  status_url TEXT,
  members_list_url TEXT,
  commitment_certificate_url TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE abstract_products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  abstract_product_id UUID REFERENCES abstract_products(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  standard_price NUMERIC,
  departure_location TEXT,
  arrival_location TEXT,
  start_date DATE,
  start_time TIME,
  end_date DATE,
  end_time TIME,
  baggage_info TEXT,
  is_negotiable BOOLEAN DEFAULT false,
  payment_method TEXT,
  title TEXT,
  status status_enum DEFAULT 'DRAFT',
  product_urls TEXT,
  regular_amount NUMERIC,
  discount_percentage NUMERIC,
  discounted_amount NUMERIC,
  metadata JSONB,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  title TEXT,
  description TEXT,
  closing_at TIMESTAMP,
  type category_enum
);

CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  publication_vote_id UUID REFERENCES publication_votes(id) ON DELETE CASCADE,

  label TEXT
);

CREATE TABLE avis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  comment TEXT,
  number INT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE branches (
  id UUID PRIMARY KEY REFERENCES agencies(id),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  location TEXT,
  contact TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  content TEXT,
  status status_enum DEFAULT 'DRAFT',
  n_likes INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_images (
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (publication_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,

  title TEXT,
  description TEXT,
  location TEXT,
  date DATE,
  start_time TIME,
  end_time TIME,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE event_images (
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (event_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  type reaction_type_enum,

  reacted_at TIMESTAMP DEFAULT now()
);

CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES comments(id) ON DELETE SET NULL,
  image_id UUID REFERENCES images(id) ON DELETE SET NULL,

  content TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  first_name TEXT,
  last_name TEXT,
  nickname TEXT,
  profile_image_url TEXT,
  birth_date DATE,
  nationality TEXT,
  gender TEXT,
  language TEXT,
  company_name TEXT,
  biography TEXT,
  rating NUMERIC,
  total_trips INT,
  is_available BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- PAYMENTS & SUBSCRIPTIONS
-- =====================================================

CREATE TABLE admins (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  admin_id UUID REFERENCES admins(id) ON DELETE SET NULL,

  label TEXT,
  price NUMERIC,
  duration_in_days INT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,
  user_id UUID REFERENCES business_actors(id) ON DELETE SET NULL,

  amount_paid NUMERIC,
  status TEXT,
  id_provider_transaction TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ride_id UUID REFERENCES rides(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  subject TEXT,
  comment TEXT,
  rating NUMERIC,

  created_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- ROLE-BASED ACCESS CONTROL (RBAC)
-- =====================================================

CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE role_has_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE user_has_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- FIX: DIRECT PERMISSIONS (USER <-> PERMISSIONS)
-- =====================================================

-- Table de liaison pour les permissions accordées directement à un utilisateur
CREATE TABLE IF NOT EXISTS user_has_permissions (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Commit the transaction


-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================
```

---
### Fichier : `./docs/data/YOWYOB_DB/last_schema/guide_database_setup.md`
```md
# 🗄️ Database Setup Guide (Local Development)

This guide explains how to set up and initialize the Fleet Management database on your local machine. This process is fully automated for both **Linux** and **Windows**.

## 📋 Prerequisites

Ensure you have the following installed:
- **Docker** & **Docker Compose**
  - *Linux*: `sudo apt install docker-compose`
  - *Windows*: Install [Docker Desktop](https://www.docker.com/products/docker-desktop/)

## 🚀 Step 1: Start the Database Container

Open a terminal at the root of the project and run:

```bash
# Start the PostgreSQL 16 container in the background
docker-compose up -d
```

*Note: This will automatically pull the official Postgres 16 image and create a database named `yowyob_db`.*

## ⚙️ Step 2: Configure the Application

The application is configured to use a **Hybrid Mode** (Local DB + Remote Kafka/Redis).

1. Open `src/main/resources/application.yml`.
2. Ensure the active profile is set to `local`:
   ```yaml
   spring:
     profiles:
       active: local
   ```
3. (Optional) In the `LOCAL CONFIGURATION` block, verify that the credentials match those in `docker-compose.yml` (default: `fleet_admin` / `fleet_password`).

## 🛠️ Step 3: Run and Auto-Initialize

Simply start the application. The system will detect the local environment and automatically:
1. Create all tables and ENUM types (from `resources/local/schema.sql`).
2. Inject 100 test users and sample data (from `resources/local/data.sql`).

**Run Command:**
```bash
# Linux / macOS
./mvnw clean spring-boot:run

# Windows (CMD / PowerShell)
mvnw.cmd clean spring-boot:run
```

## ✅ Step 4: Verify the Setup

Once the log shows `🚀 LOCAL DATABASE READY!`, open your browser:

- **Swagger UI**: [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **Check Data**: Find the `health-check-controller` and execute `/api/v1/health/users-count`. You should see `users_in_db: 100`.

## ❌ Troubleshooting

- **Port 5432 already in use**: If you have a local PostgreSQL installed outside of Docker, stop it or change the port mapping in `docker-compose.yml`.
- **DNS/Pull Issues**: If Docker fails to pull the image, try:
  ```bash
  docker pull postgres:16
  ```
```

---
### Fichier : `./docs/data/YOWYOB_DB/yowyob_db_init.sql`
```sql
-- =====================================================
-- YOWYOB DB - INIT SCRIPT
-- PostgreSQL
-- Structure: Core -> Organization -> RBAC
-- =====================================================

-- Start a transaction for safety
BEGIN;

-- Fresh start
DROP SCHEMA IF EXISTS public CASCADE;
CREATE SCHEMA public;

-- Publish query paths
SET search_path TO public;

-- Extension for UUID generation
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =====================================================
-- ENUM TYPES
-- =====================================================

CREATE TYPE status_enum AS ENUM (
  'DRAFT', 'WAITING_CONFIRMATION', 'PUBLISHED', 'IN_PROGRESS', 'CANCELLED', 'EXPIRED'
);

CREATE TYPE category_enum AS ENUM (
  'ANNOUNCE', 'PLANNING', 'VEHICLE', 'ADDRESS', 'EXPERIENCE'
);

CREATE TYPE action_enum AS ENUM (
  'CREATE', 'UPDATE', 'READ', 'DELETE'
);

CREATE TYPE vehicle_type_enum AS ENUM (
  'CAR', 'VAN', 'TRUCK', 'BIKE'
);

CREATE TYPE offer_state_enum AS ENUM (
  'NEW', 'PENDING', 'CHOSEN', 'TERMINATED', 'CANCELED'
);

CREATE TYPE ride_state_enum AS ENUM (
  'CONFIRMED', 'ONGOING', 'COMPLETED', 'CANCELED'
);

CREATE TYPE event_type_enum AS ENUM (
  'ENTRY', 'EXIT'
);

CREATE TYPE maintenance_status_enum AS ENUM (
  'UP_TO_DATE', 'PENDING', 'OVERDUE'
);

CREATE TYPE engine_status_enum AS ENUM (
  'OK', 'NEED_SERVICE', 'OUT_OF_SERVICE'
);

CREATE TYPE role_type_enum AS ENUM (
  'CUSTOMER', 'DRIVER', 'FLEET_MANAGER', 'ADMIN', 'PASSENGER', 'PRESIDENT', 'MODERATOR', 'CLIENT'
);

CREATE TYPE type_enum AS ENUM (
  'NOTIFICATION', 'CHAT', 'PAYMENT', 'MEDIA'
);

CREATE TYPE reaction_type_enum AS ENUM (
  'LIKE', 'LOVE', 'HAHA', 'WOW', 'SAD', 'ANGRY'
);

-- =====================================================
-- CORE TABLES
-- =====================================================

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  phone_number TEXT,
  email_address TEXT UNIQUE
);

CREATE TABLE images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url TEXT NOT NULL,
  alt_text TEXT,
  uploaded_at TIMESTAMP DEFAULT now()
);

CREATE TABLE countries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE business_actors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT,
  phone_number TEXT,
  email_address TEXT,
  CONSTRAINT fk_business_actor_user
    FOREIGN KEY (id) REFERENCES users(id)
    ON DELETE CASCADE
);

-- =====================================================
-- ORGANIZATION TABLES
-- =====================================================

CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_actor_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  email TEXT,
  short_name TEXT,
  long_name TEXT,
  description TEXT,
  logo_uri TEXT,
  website_url TEXT,
  social_network TEXT,
  business_registration_number TEXT,
  tax_number TEXT,
  capital_share NUMERIC,
  ceo_name TEXT,
  year_founded INT,
  keywords TEXT,
  number_of_employees INT,
  legal_form TEXT,
  is_active BOOLEAN DEFAULT true,
  status status_enum DEFAULT 'DRAFT',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, -- Must belong to an org

  owner_id UUID REFERENCES business_actors(id),
  manager_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  name TEXT,
  location TEXT,
  description TEXT,
  transferable BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  logo_uri TEXT,
  short_name TEXT,
  long_name TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  is_headquarter BOOLEAN DEFAULT false,
  country TEXT,
  city TEXT,
  latitude NUMERIC,
  longitude NUMERIC,
  open_time TIME,
  close_time TIME,
  phone TEXT,
  email TEXT,
  whatsapp TEXT,
  greeting_message TEXT,
  average_revenue NUMERIC,
  capital_share NUMERIC,
  registration_number TEXT,
  social_network TEXT,
  tax_number TEXT,
  keywords TEXT,
  is_public BOOLEAN DEFAULT false,
  is_business BOOLEAN DEFAULT true,
  total_affiliated_customers INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE business_domains (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL, -- optional link to organization
  parent_id UUID REFERENCES business_domains(id) ON DELETE SET NULL,   -- self-referential for hierarchy
  image_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  name TEXT,
  image_uri TEXT,
  type TEXT,
  type_label TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE organization_business_domains (
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  business_domain_id UUID REFERENCES business_domains(id) ON DELETE CASCADE,
  PRIMARY KEY (organization_id, business_domain_id)
);

CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  contactable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  contactable_type TEXT,
  first_name TEXT,
  last_name TEXT,
  title TEXT,
  is_email_verified BOOLEAN DEFAULT false,
  is_phone_number_verified BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  phone_number TEXT,
  secondary_phone_number TEXT,
  fax_number TEXT,
  email TEXT,
  secondary_email TEXT,
  email_verified_at TIMESTAMP,
  phone_verified_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE certifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  description TEXT,
  obtainment_date DATE,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE third_parties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  logo_id UUID REFERENCES images(id),

  code TEXT,
  type TEXT,
  legal_form TEXT,
  unique_identification_number TEXT,
  trade_registration_number TEXT,
  name TEXT,
  acronym TEXT,
  long_name TEXT,
  logo_uri TEXT,
  accounting_account_numbers TEXT,
  authorized_payment_methods TEXT,
  authorized_credit_limit NUMERIC,
  max_discount_rate NUMERIC,
  vat_subject BOOLEAN,
  operations_balance NUMERIC,
  opening_balance NUMERIC,
  pay_term_number INT,
  pay_term_type TEXT,
  third_party_family TEXT,
  classification TEXT,
  tax_number TEXT,
  loyalty_points NUMERIC,
  loyalty_points_used NUMERIC,
  loyalty_points_expired NUMERIC,
  enabled BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE settings (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  theme TEXT,
  language TEXT,
  long_ride_enabled BOOLEAN DEFAULT false,
  short_ride_enabled BOOLEAN DEFAULT false,
  privacy_enable BOOLEAN DEFAULT true,
  allow_calls BOOLEAN DEFAULT true,
  allow_messages BOOLEAN DEFAULT true,
  notify_new_rides BOOLEAN DEFAULT true,
  notify_ratings BOOLEAN DEFAULT true,
  notify_practical_tips BOOLEAN DEFAULT true,
  notify_promotions BOOLEAN DEFAULT true,
  notify_policy_updates BOOLEAN DEFAULT true,
  notify_peak_hour_recommendations BOOLEAN DEFAULT true,
  receive_email BOOLEAN DEFAULT true,
  receive_sms BOOLEAN DEFAULT true,
  receive_push_notifications BOOLEAN DEFAULT true,
  receive_whatsapp BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE proposed_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  rate NUMERIC,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE addresses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  addressable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  country_id UUID REFERENCES countries(id) ON DELETE SET NULL,

  addressable_type TEXT,
  type TEXT,
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  state TEXT,
  locality TEXT,
  zip_code TEXT,
  postal_code TEXT,
  po_box TEXT,
  is_default BOOLEAN DEFAULT false,
  neighbor_hood TEXT,
  informal_description TEXT,
  latitude NUMERIC,
  longitude NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

-- =====================================================
-- USERS EXTENDED
-- =====================================================

CREATE TABLE providers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  contact_info TEXT,
  address TEXT,
  is_active BOOLEAN DEFAULT true,
  product_service_type TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE employees (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  is_manager BOOLEAN DEFAULT false,
  role TEXT,
  department TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE prospects (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,
  interest_level TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE sales_persons (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  commission_rate NUMERIC,
  credit NUMERIC,
  current_balance NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE customers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

-- =====================================================
-- RIDE & FLEET MANAGEMENT
-- =====================================================

CREATE TABLE drivers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  status TEXT,
  license_number TEXT,
  has_car BOOLEAN DEFAULT false
);

CREATE TABLE offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  passenger_id UUID REFERENCES customers(id) ON DELETE CASCADE,

  start_point TEXT,
  end_point TEXT,
  price NUMERIC,
  state offer_state_enum DEFAULT 'NEW',
  ids_interested_drivers TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE rides (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  offer_id UUID REFERENCES offers(id) ON DELETE SET NULL,
  passenger_id UUID REFERENCES users(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  distance NUMERIC,
  time_estimation NUMERIC,
  real_time NUMERIC,
  state ride_state_enum DEFAULT 'CONFIRMED',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet_managers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE fleets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fleet_manager_id UUID REFERENCES fleet_managers(id) ON DELETE SET NULL,

  name TEXT,
  phone_number TEXT,
  email_address TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE geofence_zones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  surface_area NUMERIC,
  perimeter NUMERIC
);

CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  fleet_id UUID REFERENCES fleets(id) ON DELETE SET NULL,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,

  license_plate TEXT,
  model TEXT,
  brand TEXT,
  manufacturing_year INT,
  type vehicle_type_enum,
  color TEXT
);

CREATE TABLE roads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  start_point TEXT,
  end_point TEXT
);

CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  road_id UUID REFERENCES roads(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  start_date DATE,
  end_date DATE,
  start_time TIME,
  end_time TIME,
  type TEXT,
  color TEXT
);

CREATE TABLE operational_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  statut TEXT,
  current_location TEXT,
  current_speed NUMERIC,
  fuel_level NUMERIC,
  mileage NUMERIC,
  odometer_reading NUMERIC,
  bearing NUMERIC,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE financial_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  insurance_number TEXT,
  insurance_expired_at DATE,
  registered_at DATE,
  purchased_at DATE,
  depreciation_rate NUMERIC,
  cost_per_km NUMERIC
);

CREATE TABLE maintenance_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  last_maintenance_at DATE,
  next_maintenance_at DATE,
  engine_status engine_status_enum DEFAULT 'OK',
  battery_health TEXT,
  maintenance_status maintenance_status_enum DEFAULT 'UP_TO_DATE'
);

CREATE TABLE geofence_points (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  latitude NUMERIC,
  longitude NUMERIC
);

CREATE TABLE geofence_point_zone_linkages (
  point_id UUID REFERENCES geofence_points(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE CASCADE,
  PRIMARY KEY (point_id, zone_id)
);

CREATE TABLE geofence_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,
  point_id UUID REFERENCES geofence_points(id) ON DELETE SET NULL,

  type event_type_enum,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE offer_driver_linkages (
  offer_id UUID REFERENCES offers(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE CASCADE,
  PRIMARY KEY (offer_id, driver_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- OTHERS: PRODUCTS, SYNDICATS, PUBLICATIONS & REVIEWS
-- =====================================================

CREATE TABLE syndicats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  is_approved BOOLEAN DEFAULT false,
  name TEXT,
  description TEXT,
  domain TEXT,
  type TEXT,
  charte_url TEXT,
  status_url TEXT,
  members_list_url TEXT,
  commitment_certificate_url TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE abstract_products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  abstract_product_id UUID REFERENCES abstract_products(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  standard_price NUMERIC,
  departure_location TEXT,
  arrival_location TEXT,
  start_date DATE,
  start_time TIME,
  end_date DATE,
  end_time TIME,
  baggage_info TEXT,
  is_negotiable BOOLEAN DEFAULT false,
  payment_method TEXT,
  title TEXT,
  status status_enum DEFAULT 'DRAFT',
  product_urls TEXT,
  regular_amount NUMERIC,
  discount_percentage NUMERIC,
  discounted_amount NUMERIC,
  metadata JSONB,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  title TEXT,
  description TEXT,
  closing_at TIMESTAMP,
  type category_enum
);

CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  publication_vote_id UUID REFERENCES publication_votes(id) ON DELETE CASCADE,

  label TEXT
);

CREATE TABLE avis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  comment TEXT,
  number INT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE branches (
  id UUID PRIMARY KEY REFERENCES agencies(id),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  location TEXT,
  contact TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  content TEXT,
  status status_enum DEFAULT 'DRAFT',
  n_likes INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_images (
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (publication_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,

  title TEXT,
  description TEXT,
  location TEXT,
  date DATE,
  start_time TIME,
  end_time TIME,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE event_images (
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (event_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  type reaction_type_enum,

  reacted_at TIMESTAMP DEFAULT now()
);

CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES comments(id) ON DELETE SET NULL,
  image_id UUID REFERENCES images(id) ON DELETE SET NULL,

  content TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  first_name TEXT,
  last_name TEXT,
  nickname TEXT,
  profile_image_url TEXT,
  birth_date DATE,
  nationality TEXT,
  gender TEXT,
  language TEXT,
  company_name TEXT,
  biography TEXT,
  rating NUMERIC,
  total_trips INT,
  is_available BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- PAYMENTS & SUBSCRIPTIONS
-- =====================================================

CREATE TABLE admins (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  admin_id UUID REFERENCES admins(id) ON DELETE SET NULL,

  label TEXT,
  price NUMERIC,
  duration_in_days INT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,
  user_id UUID REFERENCES business_actors(id) ON DELETE SET NULL,

  amount_paid NUMERIC,
  status TEXT,
  id_provider_transaction TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ride_id UUID REFERENCES rides(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  subject TEXT,
  comment TEXT,
  rating NUMERIC,

  created_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- ROLE-BASED ACCESS CONTROL (RBAC)
-- =====================================================

CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE role_has_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE user_has_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Commit the transaction
COMMIT;

-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================
```

---
### Fichier : `./docs/data/YOWYOB_DB/README.md`
```md
# Yowyob Database - Instructions

Ce dossier contient les scripts SQL nécessaires pour initialiser, peupler et tester la base de données PostgreSQL du projet Yowyob. Le projet a été principalement testé en local.

## [Contenu des fichiers]

1. **`yowyob_db_init.sql`** : 
   - Crée le schéma (tables, types ENUM, triggers).
   - **Note :** Ce script commence par un `DROP SCHEMA public CASCADE`. Il effacera toutes les données existantes.

2. **`yowyob_db_seed.sql`** : 
   - Remplit la base avec des **données factices (Fake Data)** pour le développement.

3. **`yowyob_db_test.sql`** : 
   - Contient des requêtes de lecture pour vérifier la cohérence des relations et des données sur **certaines relations** de la base de données. *Chaque jeu de test doit renvoyer **au moins une ligne de données.***

## [Guide d'installation]

### Pré-requis
- PostgreSQL 16 ou supérieur.
- Un utilisateur PostgreSQL ayant les droits de création de tables.

### Étape 1 : Création de la base (si elle n'existe pas)
```bash
createdb -U <user> yowyob_db
```

### Étape 2 : Initialisation de la structure
```bash
psql -U <user> -d yowyob_db -f yowyob_db_init.sql
```

### Étape 3 : Peuplement des données (DEV / STAGING UNIQUEMENT)
```bash
psql -U <user> -d yowyob_db -f yowyob_db_seed.sql
```

### Étape 4 : Vérification
```bash
psql -U <user> -d yowyob_db -f yowyob_db_test.sql
``````

---
### Fichier : `./docs/data/YOWYOB_DB/yowyob_db_test.sql`
```sql
-- =====================================================
-- YOWYOB DB - TEST QUERIES (SEMI-VALIDATION)
-- PostgreSQL
-- =====================================================

-- Summary Table to display what will be tested
SELECT * FROM (VALUES
    ('Test 1.1', 'Check Driver Inheritance (Name, Status, Car)'),
    ('Test 1.2', 'Check Customers Specific Data (Code, Payment)'),
    ('Test 2.1', 'User Role Assignments'),
    ('Test 3.1', 'Agency Locations & Headquarter Status'),
    ('Test 4.1', 'Vehicle Inventory (Fleet vs Independent)'),
    ('Test 5.1', 'Full Ride History (Passenger + Driver + Price)'),
    ('Test 5.2', 'Pending Offers (No Ride Created Yet)'),
    ('Test 6.1', 'Active Products by Organization'),
    ('Test 7.1', 'Publications Feed with Likes'),
    ('Test 7.2', 'Customer Reviews on Rides'),
    ('Test 8.1', 'Payment & Subscription Log')
) AS summary_table (Test_ID, Test_Description);

-- =====================================================
-- BLOCK 1: CORE & INHERITANCE VERIFICATION
-- =====================================================

-- 1.1. Check Driver Inheritance
SELECT 'Check Driver Inheritance (Name, Status, Car)' AS "TEST 1.1";
SELECT 
    u.id,
    u.name AS full_name,
    u.phone_number,
    d.status AS driver_status,
    d.license_number,
    d.has_car
FROM drivers d
JOIN business_actors ba ON d.id = ba.id
JOIN users u ON ba.id = u.id
LIMIT 5;

-- 1.2. Check Customers and Payment Methods
SELECT 'Check Customers Specific Data' AS "TEST 1.2";
SELECT 
    u.name AS customer_name,
    c.code AS customer_code,
    c.payment_method
FROM customers c
JOIN users u ON c.id = u.id
LIMIT 5;

-- =====================================================
-- BLOCK 2: RBAC (ROLES & SECURITY)
-- =====================================================

-- 2.1. Who has which role?
SELECT 'User Role Assignments' AS "TEST 2.1";
SELECT 
    u.name AS user_name,
    u.email_address,
    r.name AS assigned_role
FROM users u
JOIN user_has_roles uhr ON u.id = uhr.user_id
JOIN roles r ON uhr.role_id = r.id
ORDER BY u.name ASC
LIMIT 5;

-- =====================================================
-- BLOCK 3: ORGANIZATION & HIERARCHY
-- =====================================================

-- 3.1. Hierarchy Organization -> Agencies
SELECT 'Agency Locations & Headquarter Status' AS "TEST 3.1";
SELECT 
    org.short_name AS organization,
    a.name AS agency_name,
    a.city,
    a.is_headquarter
FROM agencies a
JOIN organizations org ON a.organization_id = org.id
ORDER BY org.short_name
LIMIT 5;

-- =====================================================
-- BLOCK 4: FLEET MANAGEMENT
-- =====================================================

-- 4.1. Vehicle Inventory
SELECT 'Vehicle Inventory (Fleet vs Independent)' AS "TEST 4.1";
SELECT 
    v.license_plate,
    v.brand || ' ' || v.model AS vehicle_model,
    v.type,
    f.name AS fleet_owner,
    u_owner.name AS independent_owner
FROM vehicles v
LEFT JOIN fleets f ON v.fleet_id = f.id
LEFT JOIN users u_owner ON v.user_id = u_owner.id
LIMIT 5;

-- =====================================================
-- BLOCK 5: RIDES & OFFERS (CORE BUSINESS)
-- =====================================================

-- 5.1. Full Ride Details
SELECT 'Full Ride History (Passenger + Driver + Price)' AS "TEST 5.1";
SELECT 
    r.id AS ride_id,
    r.state AS ride_state,
    passenger_u.name AS passenger,
    driver_u.name AS driver,
    o.start_point,
    o.end_point,
    o.price AS agreed_price,
    r.distance || ' km' AS real_distance
FROM rides r
JOIN offers o ON r.offer_id = o.id
JOIN customers c ON r.passenger_id = c.id
JOIN users passenger_u ON c.id = passenger_u.id
JOIN drivers d ON r.driver_id = d.id
JOIN users driver_u ON d.id = driver_u.id
WHERE r.state = 'COMPLETED'
LIMIT 5;

-- 5.2. Offers without Drivers
SELECT 'Pending Offers (No Ride Created Yet)' AS "TEST 5.2";
SELECT 
    o.id,
    o.state,
    o.price,
    o.created_at
FROM offers o
LEFT JOIN rides r ON o.id = r.offer_id
WHERE r.id IS NULL
LIMIT 5;

-- =====================================================
-- BLOCK 6: PRODUCTS & SERVICES
-- =====================================================

-- 6.1. Product Catalog by Organization
SELECT 'Active Products by Organization' AS "TEST 6.1";
SELECT 
    org.short_name AS seller,
    p.name AS product_name,
    p.standard_price AS price,
    p.status
FROM products p
JOIN organizations org ON p.organization_id = org.id
WHERE p.is_active = true
LIMIT 5;

-- =====================================================
-- BLOCK 7: SOCIAL (PUBLICATIONS & REVIEWS)
-- =====================================================

-- 7.1. Branch News Feed
SELECT 'Publications Feed with Likes' AS "TEST 7.1";
SELECT 
    b.name AS source_branch,
    u.name AS author,
    pub.content AS message,
    pub.n_likes AS likes
FROM publications pub
JOIN branches b ON pub.branch_id = b.id
JOIN users u ON pub.author_id = u.id
ORDER BY pub.created_at DESC
LIMIT 5;

-- 7.2. Ride Reviews
SELECT 'Customer Reviews on Rides' AS "TEST 7.2";
SELECT 
    rev.rating,
    rev.comment,
    u.name AS author
FROM reviews rev
JOIN users u ON rev.author_id = u.id
LIMIT 5;

-- =====================================================
-- BLOCK 8: FINANCE (SUBSCRIPTIONS & PAYMENTS)
-- =====================================================

-- 8.1. Payment History
SELECT 'Payment & Subscription Log' AS "TEST 8.1";
SELECT 
    pay.id AS payment_id,
    u.name AS payer,
    sub.label AS subscription_plan,
    pay.amount_paid,
    pay.status,
    pay.created_at
FROM payments pay
JOIN users u ON pay.user_id = u.id
JOIN subscriptions sub ON pay.subscription_id = sub.id
ORDER BY pay.created_at DESC
LIMIT 5;

-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================```

---
### Fichier : `./docs/prompts/master_pair_programmer.md`
```md
# 🤖 Master Prompt : Senior Pair Programmer WebFlux

Tu es mon Senior Pair Programmer expert en Java **Spring Boot WebFlux (Réactif)**.
Nous développons l'API **Fleet Management et Geofencing** (Projet TraEnSys).

### 📋 Ta Méthode de Travail (IMPÉRATIF)
Pour chaque tâche demandée, tu dois obligatoirement suivre ces étapes :

**Étape 1 : Conception fonctionnelle**
- Analyse du besoin, user stories et ajustement du modèle de données.Discuter avec moi de cette conception
- **Attente de ma validation explicite avant d'aller plus loin.**

**Étape 2 : Explication du Concept Réactif**
- Avant de coder, explique brièvement comment l'architechture sera gérée pour cette tâche.ne pas hesiter a dire les fichiers qui entrent en jeu,leur role et ce qu'on y ferra
- **Attente de ma validation explicite avant d'aller plus loin.**

**Étape 3 : Implémentation**
- Fournis le code complet par blocs Markdown copiables.
- Respecte l'architecture hexagonale du projet.
-respecte egalemngt mes consignes

**Étape 4 : Tests & Validation**
- Instructions pour tester via swagger .

### 🚫 Tes Règles de Conduite
1. **Zéro code non sollicité** : Ne propose aucune solution technique avant l'Étape 3.
2. **Focus** : Réponds uniquement à la question posée, de manière synthétique et précise.
3. **Fichiers complets** : Sauf mention contraire, donne toujours le code complet du fichier pour éviter les erreurs de copier-coller.
4. **Pédagogie** : Si une opération risque de bloquer un thread (ex: JDBC classique, thread sleep), arrête-moi et propose l'alternative non-bloquante.

### 📂 Contexte
Le code source complet est disponible dans le fichier `project_context.txt`.
La roadmap est suivie dans `todo.md`.


### Premiere mission
je suisi actuelleemnt en train de vouloir tester le module auth que je viens de refactorer,mais je rencontre des buggs,ta missions era de m'aider a comprendre le soucis ,puis de m'aider a le corriger```

---
### Fichier : `./docs/database_setup.md`
```md
# 🗄️ Database Setup Guide (Local Development)

This guide explains how to set up and initialize the Fleet Management database on your local machine. This process is fully automated for both **Linux** and **Windows**.

## 📋 Prerequisites

Ensure you have the following installed:
- **Docker** & **Docker Compose**
  - *Linux*: `sudo apt install docker-compose`
  - *Windows*: Install [Docker Desktop](https://www.docker.com/products/docker-desktop/)

## 🚀 Step 1: Start the Database Container

Open a terminal at the root of the project and run:

```bash
# Start the PostgreSQL 16 container in the background
docker-compose up -d
```

*Note: This will automatically pull the official Postgres 16 image and create a database named `yowyob_db`.*

## ⚙️ Step 2: Configure the Application

The application is configured to use a **Hybrid Mode** (Local DB + Remote Kafka/Redis).

1. Open `src/main/resources/application.yml`.
2. Ensure the active profile is set to `local`:
   ```yaml
   spring:
     profiles:
       active: local
   ```
3. (Optional) In the `LOCAL CONFIGURATION` block, verify that the credentials match those in `docker-compose.yml` (default: `fleet_admin` / `fleet_password`).

## 🛠️ Step 3: Run and Auto-Initialize

Simply start the application. The system will detect the local environment and automatically:
1. Create all tables and ENUM types (from `resources/local/schema.sql`).
2. Inject 100 test users and sample data (from `resources/local/data.sql`).

**Run Command:**
```bash
# Linux / macOS
./mvnw clean spring-boot:run

# Windows (CMD / PowerShell)
mvnw.cmd clean spring-boot:run
```

## ✅ Step 4: Verify the Setup

Once the log shows `🚀 LOCAL DATABASE READY!`, open your browser:

- **Swagger UI**: [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **Check Data**: Find the `health-check-controller` and execute `/api/v1/health/users-count`. You should see `users_in_db: 100`.

## ❌ Troubleshooting

- **Port 5432 already in use**: If you have a local PostgreSQL installed outside of Docker, stop it or change the port mapping in `docker-compose.yml`.
- **DNS/Pull Issues**: If Docker fails to pull the image, try:
  ```bash
  docker pull postgres:16
  ```
```

---
### Fichier : `./todo.md`
```md
# 📋 Roadmap Globale : API Fleet & Geofence

## 🏗️ PHASE 1 : FONDATIONS & INFRASTRUCTURE (Terminé)

#### Jalon 1 : Initialisation & Persistence `Gabriel`
- [x] **Tâche 1.1 :** Nettoyage et Refactoring du template (Renommage packages, suppression de la logique "Product" initiale).
- [x] **Tâche 1.2 :** Implémentation du Schéma de données (Traduction du contrat v1.0 en SQL).
- [x] **Tâche 1.3 :** Mécanisme de Seeding (Données de test).
- [x] **Tâche 1.4 :** Validation Swagger & Health Check.
- [x] **Tâche 1.5 :** Guide d'installation DB locale.
- [x] **Tâche 1.6 :** Intégration **Liquibase** (Multi-schémas `fleet`/`public`, migration JDBC au boot).
- [x] **Tâche 1.7 :** Infrastructure **Docker Locale Complète** (Postgres + Redis + Kafka KRaft).
- [x] **Tâche 1.8 :** Scripts d'automatisation Cross-Platform (`run_local.sh`, `run_local.bat`).

#### Jalon 2 : Authentification & Accès (Base) `Hassana`
- [x] **Tâche 2.1 :** Configuration de la Sécurité Réactive (Spring Security).
- [x] **Tâche 2.2 :** Intégration du Service d'Authentification externe (Adaptateur WebClient).
- [x] **Tâche 2.3 :** Implémentation du **Mode Dégradé (Fake Auth)** pour le développement local.
- [x] **Tâche 2.4 :** Validation Postman basique (Login/Token).

---

## 🛠️ PHASE 2 : REFACTORING & CONSOLIDATION (En cours) `Gabriel`

*Cette phase vise à stabiliser le socle technique, nettoyer le code inutile, et aligner parfaitement notre DB et nos Services avec (1) l'API d'Auth distante et (2) les besoins métier réels.*

#### Jalon 3 : Grand Nettoyage (Clean Code) `Gabriel`
- [x]**Tâche 3.1 :** Supprimer tout le code lié à "Product" (Controller, Service, Entity, Mapper, Repository). C'est du code exemple qui pollue.
- [x] **Tâche 3.2 :** Nettoyer les imports inutilisés et les dépendances mortes dans le `pom.xml`.

#### Jalon 4 : Analyse & Conformité DB `Gabriel`
- [x] **Tâche 4.1 :** Comparer le schéma Liquibase actuel (`fleet.*`) avec les sepcifications et la modelisation initiale et verifier les contracts d'api du frontend
- [x] **Tâche 4.2 :** Mettre à jour les scripts Liquibase  pour combler les manques.

#### Jalon 5 : Auth & User Management Avancé (Proxy Auth) `Gabriel`
*Objectif : Le microservice Fleet doit exposer les fonctionnalités de l'Auth Service de manière transparente.*
- [x] **Tâche 5.1 :** Refactoring `AuthApiClient` : Supporter le `MultipartFile` pour l'upload de photo de profil au `register`.
- [x] **Tâche 5.2 :** Logique "Auto-Role" : Vérifier/Créer les rôles (`FLEET_MANAGER`, `DRIVER`) sur l'Auth Service avant inscription.
- [x] **Tâche 5.3 :** Fixer le `register` : Synchro création Auth Service -> Création données locales (`fleet.drivers`).
- [x] **Tâche 5.4 :** Endpoint `User` : Créer un `UserController` local (Proxy vers Auth Service : Profil, Password).

#### Jalon 6 : Gestion des Acteurs (Managers & Drivers) `Gabriel`
- [ ] **Tâche 6.1 :** Implémenter la gestion des **Fleet Managers**.
- [ ] **Tâche 6.2 :** Refondre la gestion des **Drivers** (User Auth + Permis Local + Assignation Véhicule).

#### Jalon 7 : Flottes & Véhicules (Le Cœur) `Gabriel`
- [ ] **Tâche 7.1 :** CRUD **Flottes** (Lien avec le Fleet Manager connecté).
- [ ] **Tâche 7.2 :** CRUD **Véhicules** (Agrégation Données Locales + API Véhicule Distante).

#### Jalon 8 : Gestion des Trajets (Trips) `Gabriel`
- [ ] **Tâche 8.1 :** Start Trip / End Trip.

---

## 🚀 PHASE 3 : FONCTIONNALITÉS AVANCÉES (À venir)

#### Jalon 9 : Moteur de Geofencing & Alertes (CU10-CU13) `Hassana`
- [ ] **Tâche 9.1 :** Use-Case : Définir et gérer les zones (Geofence Zones).
- [ ] **Tâche 9.2 :** Moteur de détection réactif (Intersection position / zone).
- [ ] **Tâche 9.3 :** Publication des alertes dans Kafka.
- [ ] **Tâche 9.4 :** Validation Postman : Alertes géographiques.

#### Jalon 10 : Intégrations Services Périphériques `Gabriel`
- [ ] **Tâche 10.1 :** Adaptateurs pour Fare Calculator & Payment (avec mode Fake data).
- [ ] **Tâche 10.2 :** Adaptateur pour l'API Media (Gestion des images).
- [ ] **Tâche 10.3 :** Intégration finale du service de Notification.
- [ ] **Tâche 10.4 :** Tests de bout en bout (E2E).```

---
### Fichier : `./src/test/java/com/yowyob/reactive_hexagonal/ReactiveHexagonalApplicationTests.java`
```java
package com.yowyob.reactive_hexagonal;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class ReactiveHexagonalApplicationTests {

	@Test
	void contextLoads() {
	}

}
```

---
### Fichier : `./src/main/resources/application.yml`
```yaml
server:
  port: 8080

spring:
  application:
    name: fleet-management
  
  profiles:
    active: local

  # R2DBC (Application Runtime)
  r2dbc:
    url: r2dbc:postgresql://localhost:5432/yowyob_db
    username: fleet_admin
    password: fleet_password
    pool:
      enabled: true
      initial-size: 2
      max-size: 10

  # JDBC (Liquibase Migration)
  datasource:
    url: jdbc:postgresql://localhost:5432/yowyob_db
    username: fleet_admin
    password: fleet_password
    driver-class-name: org.postgresql.Driver

  # LIQUIBASE
  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.yaml
    default-schema: fleet
    liquibase-schema: public
    enabled: true
    contexts: local

  # REDIS
  data:
    redis:
      host: localhost
      port: 6379
      password: "" 

  # KAFKA
  kafka:
    bootstrap-servers: localhost:9092
    consumer:
      group-id: fleet-management-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

  docker:
    compose:
      enabled: false

# CONFIG METIER
application:
  external:
    vehicle-service-url: https://vehicule-service.pynfi.com
  auth:
    mode: remote 
    url: https://auth-service.pynfi.com

  # Kafka topics
  kafka:
    topics:
      # product-events removed
      geofence-alerts: geofence-alerts-topic # Anticipation pour le futur

# MONITORING
management:
  endpoints:
    web:
      exposure:
        include: ["health","info","prometheus"]
  endpoint:
    health:
      show-details: "always"
      probes:
        enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# Resilience4j nettoyé (plus de stock-service)
resilience4j:
  circuitbreaker:
    instances: {}```

---
### Fichier : `./src/main/resources/db/changelog/changes/002-fleet-tables.sql`
```sql
--liquibase formatted sql

--changeset gabriel:create-fleet-enums splitStatements:true
-- 1. ENUMS STATIQUES (Logique métier figée)
CREATE TYPE fleet.engine_status_enum AS ENUM ('OK', 'NEEDS_SERVICE', 'OUT_OF_SERVICE');
CREATE TYPE fleet.maintenance_status_enum AS ENUM ('UP_TO_DATE', 'PENDING', 'OVERDUE');
CREATE TYPE fleet.event_type_enum AS ENUM ('ENTRY', 'EXIT');
CREATE TYPE fleet.trip_status_enum AS ENUM ('SCHEDULED', 'ONGOING', 'COMPLETED', 'CANCELLED');
CREATE TYPE fleet.driver_status_enum AS ENUM ('ACTIVE', 'INACTIVE');
CREATE TYPE fleet.vehicle_status_enum AS ENUM ('AVAILABLE', 'ON_TRIP', 'MAINTENANCE');

--changeset gabriel:create-fleet-tables splitStatements:true

-- 2. DONNÉES DE RÉFÉRENCE DYNAMIQUES
CREATE TABLE fleet.vehicle_types (
    id UUID PRIMARY KEY,
    code VARCHAR(50) UNIQUE NOT NULL, -- Ex: CAR, TRUCK
    label VARCHAR(100) NOT NULL,      -- Ex: Voiture de Tourisme
    description TEXT
);

-- 3. ACTEURS (Extensions de public.users)
CREATE TABLE fleet.fleet_managers (
    user_id UUID PRIMARY KEY, -- FK vers public.users
    company_name VARCHAR(100)
);

-- 4. ORGANISATION
CREATE TABLE fleet.fleets (
  id UUID PRIMARY KEY,
  manager_id UUID NOT NULL REFERENCES fleet.fleet_managers(user_id),
  name VARCHAR(255) NOT NULL,
  phone_number VARCHAR(50),
  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet.drivers (
  user_id UUID PRIMARY KEY, -- FK vers public.users
  fleet_id UUID REFERENCES fleet.fleets(id) ON DELETE SET NULL,
  licence_number VARCHAR(100) UNIQUE NOT NULL,
  status fleet.driver_status_enum DEFAULT 'ACTIVE',
  photo_url VARCHAR(255)
);

-- 5. GEOFENCING (Zones)
CREATE TABLE fleet.geofence_zones (
  id UUID PRIMARY KEY,
  fleet_id UUID NOT NULL REFERENCES fleet.fleets(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  surface_area NUMERIC,
  perimeter NUMERIC
);

-- 6. VÉHICULES
CREATE TABLE fleet.vehicles (
  id UUID PRIMARY KEY,
  fleet_id UUID NOT NULL REFERENCES fleet.fleets(id) ON DELETE CASCADE,
  
  -- Assignation dynamique
  current_driver_id UUID REFERENCES fleet.drivers(user_id) ON DELETE SET NULL,
  
  -- Typage dynamique (FK vers table)
  vehicle_type_id UUID REFERENCES fleet.vehicle_types(id), 
  
  license_plate VARCHAR(50) UNIQUE NOT NULL,
  brand VARCHAR(100),
  model VARCHAR(100),
  manufacturing_year INT,
  color VARCHAR(50),
  status fleet.vehicle_status_enum DEFAULT 'AVAILABLE',
  photo_url VARCHAR(255)
);

-- 7. PARAMÈTRES VÉHICULES (1-1)
CREATE TABLE fleet.operational_parameters (
  id UUID PRIMARY KEY,
  vehicle_id UUID UNIQUE REFERENCES fleet.vehicles(id) ON DELETE CASCADE,
  current_location_point_id UUID, -- FK ajoutée plus bas
  status BOOLEAN DEFAULT true,
  current_speed NUMERIC,
  fuel_level VARCHAR(50),
  mileage NUMERIC,
  odometer_reading NUMERIC,
  bearing NUMERIC,
  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet.financial_parameters (
  id UUID PRIMARY KEY,
  vehicle_id UUID UNIQUE REFERENCES fleet.vehicles(id) ON DELETE CASCADE,
  insurance_number VARCHAR(100),
  insurance_expired_at DATE,
  registered_at DATE,
  purchased_at DATE,
  depreciation_rate INT,
  cost_per_km NUMERIC
);

CREATE TABLE fleet.maintenance_parameters (
  id UUID PRIMARY KEY,
  vehicle_id UUID UNIQUE REFERENCES fleet.vehicles(id) ON DELETE CASCADE,
  last_maintenance_at DATE,
  next_maintenance_at DATE,
  engine_status fleet.engine_status_enum DEFAULT 'OK',
  battery_health INT,
  maintenance_status fleet.maintenance_status_enum DEFAULT 'UP_TO_DATE'
);

-- 8. TRAJETS & ROUTES
CREATE TABLE fleet.trips (
  id UUID PRIMARY KEY,
  vehicle_id UUID REFERENCES fleet.vehicles(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES fleet.drivers(user_id) ON DELETE SET NULL,
  start_date DATE NOT NULL,
  end_date DATE,
  start_time TIME NOT NULL,
  end_time TIME,
  status fleet.trip_status_enum DEFAULT 'SCHEDULED',
  
  -- Historisation du type au moment du trajet
  vehicle_type_id UUID REFERENCES fleet.vehicle_types(id), 
  
  distance_km NUMERIC,
  duration_minutes INT
);

-- 9. GÉOMÉTRIE (Legacy / Compatibilité Objet)
CREATE TABLE fleet.geofence_points (
  id UUID PRIMARY KEY,
  latitude NUMERIC NOT NULL,
  longitude NUMERIC NOT NULL
);

ALTER TABLE fleet.operational_parameters 
ADD CONSTRAINT fk_operational_point 
FOREIGN KEY (current_location_point_id) REFERENCES fleet.geofence_points(id) ON DELETE SET NULL;

CREATE TABLE fleet.routes (
  id UUID PRIMARY KEY,
  trip_id UUID REFERENCES fleet.trips(id) ON DELETE CASCADE,
  start_point_id UUID REFERENCES fleet.geofence_points(id),
  end_point_id UUID REFERENCES fleet.geofence_points(id)
);

CREATE TABLE fleet.geofence_point_zone_linkages (
  point_id UUID REFERENCES fleet.geofence_points(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES fleet.geofence_zones(id) ON DELETE CASCADE,
  vertex_order INT,
  PRIMARY KEY (point_id, zone_id)
);

-- 10. ÉVÉNEMENTS
CREATE TABLE fleet.geofence_events (
  id UUID PRIMARY KEY,
  vehicle_id UUID REFERENCES fleet.vehicles(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES fleet.geofence_zones(id) ON DELETE SET NULL,
  type fleet.event_type_enum,
  timestamp TIMESTAMP DEFAULT now()
);```

---
### Fichier : `./src/main/resources/db/changelog/changes/001-init-schemas.sql`
```sql
--liquibase formatted sql

--changeset gabriel:create-fleet-schema
CREATE SCHEMA IF NOT EXISTS fleet;```

---
### Fichier : `./src/main/resources/db/changelog/data/001-local-public-mock.sql`
```sql
--liquibase formatted sql

--changeset gabriel:mock-public-schema context:local
-- 1. Structure PUBLIC (Simulation Auth Service)
CREATE TABLE IF NOT EXISTS public.users (
    id UUID PRIMARY KEY,
    name TEXT,
    email TEXT,
    password TEXT
);

CREATE TABLE IF NOT EXISTS public.roles (
    name VARCHAR(50) PRIMARY KEY
);

CREATE TABLE IF NOT EXISTS public.user_has_roles (
    user_id UUID REFERENCES public.users(id),
    role_name VARCHAR(50) REFERENCES public.roles(name),
    PRIMARY KEY (user_id, role_name)
);

-- 2. Insertion des Rôles (Standards TransEns)
INSERT INTO public.roles (name) VALUES 
('FLEET_ADMIN'), 
('FLEET_MANAGER'), 
('FLEET_DRIVER')
ON CONFLICT DO NOTHING;

-- 3. Insertion des Types de Véhicules (Obligatoire pour créer des véhicules)
-- UUIDs codés en dur pour faciliter les tests
INSERT INTO fleet.vehicle_types (id, code, label, description) VALUES 
('11111111-1111-1111-1111-111111111111', 'CAR', 'Voiture', 'Véhicule léger de tourisme'),
('22222222-2222-2222-2222-222222222222', 'TRUCK', 'Camion', 'Poids lourd pour logistique'),
('33333333-3333-3333-3333-333333333333', 'MOTO', 'Moto', 'Deux roues pour livraison rapide'),
('44444444-4444-4444-4444-444444444444', 'VAN', 'Fourgon', 'Transport de matériel')
ON CONFLICT DO NOTHING;

-- 4. SCÉNARIO DE TEST COMPLET

-- A. Création du Fleet Manager (Auth + Profil)
INSERT INTO public.users (id, name, email, password) VALUES 
('aaaa1111-bbbb-2222-cccc-333333333333', 'Jean Manager', 'manager@test.com', 'password')
ON CONFLICT DO NOTHING;

INSERT INTO public.user_has_roles VALUES ('aaaa1111-bbbb-2222-cccc-333333333333', 'FLEET_MANAGER')
ON CONFLICT DO NOTHING;

INSERT INTO fleet.fleet_managers (user_id, company_name) VALUES 
('aaaa1111-bbbb-2222-cccc-333333333333', 'TransCam S.A.')
ON CONFLICT DO NOTHING;

-- B. Création de la Flotte
INSERT INTO fleet.fleets (id, manager_id, name, phone_number) VALUES 
('ffffffff-aaaa-bbbb-cccc-dddddddddddd', 'aaaa1111-bbbb-2222-cccc-333333333333', 'Flotte Douala', '+237699000000')
ON CONFLICT DO NOTHING;

-- C. Création du Chauffeur (Auth + Profil + Lien Flotte)
INSERT INTO public.users (id, name, email, password) VALUES 
('dddd2222-eeee-3333-ffff-444444444444', 'Moussa Driver', 'driver@test.com', 'password')
ON CONFLICT DO NOTHING;

INSERT INTO public.user_has_roles VALUES ('dddd2222-eeee-3333-ffff-444444444444', 'FLEET_DRIVER')
ON CONFLICT DO NOTHING;

INSERT INTO fleet.drivers (user_id, fleet_id, licence_number, status) VALUES 
('dddd2222-eeee-3333-ffff-444444444444', 'ffffffff-aaaa-bbbb-cccc-dddddddddddd', 'LT-12345-X', 'ACTIVE')
ON CONFLICT DO NOTHING;

-- D. Création du Véhicule (Lien Flotte + Type Voiture + Chauffeur)
INSERT INTO fleet.vehicles (id, fleet_id, vehicle_type_id, current_driver_id, license_plate, brand, model, status) VALUES 
('vvvvvvvv-1111-2222-3333-444444444444', 
 'ffffffff-aaaa-bbbb-cccc-dddddddddddd', 
 '11111111-1111-1111-1111-111111111111', -- Type CAR
 'dddd2222-eeee-3333-ffff-444444444444', -- Assigné à Moussa
 'LT 007 JB', 'Toyota', 'Yaris', 'AVAILABLE')
ON CONFLICT DO NOTHING;```

---
### Fichier : `./src/main/resources/prod.application.yml`
```yaml
server:
  port: 8080

spring:
  application:
    name: fleet-management
    
  docker:
    compose:
      enabled: false

  # 1. R2DBC (Runtime - Réactif)
  r2dbc:
    url: r2dbc:postgresql://${DB_HOST:168.119.122.86}:${DB_PORT:5432}/${DB_NAME:yowyob}
    username: ${DB_USERNAME:master}
    password: ${DB_PASSWORD:Azerty1234*}
    pool:
      enabled: true
      initial-size: 5
      max-size: 20
      validation-query: SELECT 1

  # 2. JDBC (Migration - Bloquant pour Liquibase)
  datasource:
    url: jdbc:postgresql://${DB_HOST:168.119.122.86}:${DB_PORT:5432}/${DB_NAME:yowyob}
    username: ${DB_USERNAME:master}
    password: ${DB_PASSWORD:Azerty1234*}
    driver-class-name: org.postgresql.Driver

  # 3. LIQUIBASE
  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.yaml
    default-schema: fleet
    liquibase-schema: public
    enabled: true
    contexts: prod # Important : empêche le chargement du mock public

  # Désactivation de l'ancien init SQL
  sql:
    init:
      mode: never

  # REDIS CLUSTER (Spécifique Prod)
  data:
    redis:
      password: ${REDIS_PASSWORD:Azerty1234*}
      cluster:
        nodes:
          - ${REDIS_HOST:168.119.122.86}:7001
          - ${REDIS_HOST:168.119.122.86}:7002
          - ${REDIS_HOST:168.119.122.86}:7003
          - ${REDIS_HOST:168.119.122.86}:7004
          - ${REDIS_HOST:168.119.122.86}:7005
          - ${REDIS_HOST:168.119.122.86}:7006

  # KAFKA 
  kafka:
    bootstrap-servers: ${KAFKA_HOST:168.119.122.86}:${KAFKA_PORT:9092}
    consumer:
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CONFIG METIER
application:
  external:
    vehicle-service-url: https://fare-calculator-service.pynfi.com
  auth:
    mode: remote 
    url: https://auth-service.pynfi.com

  kafka:
    topics:
      geofence-alerts: geofence-alerts-topic

# MONITORING & RESILIENCE
management:
  endpoints:
    web:
      exposure:
        include: ["health","info","prometheus"]
  endpoint:
    health:
      show-details: "always"
      probes:
        enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5```

---
### Fichier : `./src/main/java/com/yowyob/fleet/FleetManagementApplication.java`
```java
package com.yowyob.fleet;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class FleetManagementApplication {

	public static void main(String[] args) {
		SpringApplication.run(FleetManagementApplication.class, args);
	}

}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/mappers/FleetMapper.java`
```java
package com.yowyob.fleet.infrastructure.mappers;

import com.yowyob.fleet.domain.model.Fleet;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.FleetRequest;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.FleetResponse;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.FleetEntity;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import java.time.Instant;
import java.time.LocalDate;
import java.time.ZoneOffset;

@Mapper(componentModel = "spring")
public interface FleetMapper {

    @Mapping(target = "fleetManagerId", source = "managerUserId")
    @Mapping(target = "createdAt", source = "creationDate")
    @Mapping(target = "phoneNumber", ignore = true) 
    FleetEntity toEntity(Fleet domain);
    
    @Mapping(target = "managerUserId", source = "fleetManagerId")
    @Mapping(target = "creationDate", source = "createdAt")
    @Mapping(target = "vehicleCount", ignore = true)
    Fleet toDomain(FleetEntity entity);

    @Mapping(target = "id", ignore = true)
    @Mapping(target = "creationDate", ignore = true)
    @Mapping(target = "vehicleCount", ignore = true)
    Fleet toDomain(FleetRequest request);

    FleetResponse toResponse(Fleet domain);

    /**
     * Custom mapping: LocalDate to Instant (Domain to Entity)
     * Sets the time to the start of the day in UTC.
     */
    default Instant map(LocalDate date) {
        return date == null ? null : date.atStartOfDay(ZoneOffset.UTC).toInstant();
    }

    /**
     * Custom mapping: Instant to LocalDate (Entity to Domain)
     * Extracts the date part from the UTC instant.
     */
    default LocalDate map(Instant instant) {
        return instant == null ? null : LocalDate.ofInstant(instant, ZoneOffset.UTC);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/mappers/VehicleLocalMapper.java`
```java
package com.yowyob.fleet.infrastructure.mappers;

import com.yowyob.fleet.domain.model.Vehicle;
import com.yowyob.fleet.domain.model.VehicleParameters;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.*;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

@Mapper(componentModel = "spring")
public abstract class VehicleLocalMapper {

    // --- Vers ENTITY ---

    @Mapping(target = "id", source = "id")
    @Mapping(target = "fleetId", source = "fleetId")
    @Mapping(target = "licensePlate", source = "licensePlate")
    @Mapping(target = "brand", source = "brand")
    @Mapping(target = "model", source = "model")
    @Mapping(target = "manufacturingYear", source = "manufacturingYear")
    @Mapping(target = "color", source = "color")
    @Mapping(target = "currentDriverId", ignore = true)
    @Mapping(target = "vehicleTypeId", ignore = true)
    @Mapping(target = "status", ignore = true)
    @Mapping(target = "photoUrl", ignore = true)
    public abstract VehicleLocalEntity toVehicleEntity(Vehicle domain);

    // --- Vers ENTITY (Paramètres) ---

    @Mapping(target = "id", ignore = true)
    @Mapping(target = "vehicleId", source = "id")
    @Mapping(target = "insuranceNumber", source = "financialParameters.insuranceNumber")
    @Mapping(target = "insuranceExpiredAt", source = "financialParameters.insuranceExpiryDate")
    @Mapping(target = "registeredAt", source = "financialParameters.registrationDate")
    @Mapping(target = "purchasedAt", source = "financialParameters.purchaseDate")
    @Mapping(target = "depreciationRate", source = "financialParameters.depreciationRate")
    @Mapping(target = "costPerKm", source = "financialParameters.costPerKm")
    public abstract FinancialParameterEntity toFinancialEntity(Vehicle domain);

    @Mapping(target = "id", ignore = true)
    @Mapping(target = "vehicleId", source = "id")
    @Mapping(target = "lastMaintenanceAt", source = "maintenanceParameters.lastMaintenanceDate")
    @Mapping(target = "nextMaintenanceAt", source = "maintenanceParameters.nextMaintenanceDue")
    @Mapping(target = "engineStatus", source = "maintenanceParameters.engineStatus")
    @Mapping(target = "batteryHealth", expression = "java(mapBatteryHealth(domain))")
    @Mapping(target = "maintenanceStatus", source = "maintenanceParameters.maintenanceStatus")
    public abstract MaintenanceParameterEntity toMaintenanceEntity(Vehicle domain);

    // Helper pour éviter les expressions complexes dans l'annotation
    protected String mapBatteryHealth(Vehicle domain) {
        if (domain.maintenanceParameters() != null && domain.maintenanceParameters().batteryHealth() != null) {
            return String.valueOf(domain.maintenanceParameters().batteryHealth());
        }
        return null;
    }

    // --- Vers DOMAINE (Méthode manuelle) ---

    public Vehicle toDomain(VehicleLocalEntity v, FinancialParameterEntity f, MaintenanceParameterEntity m) {
        if (v == null) return null;

        return new Vehicle(
            v.getId(),
            v.getFleetId(),
            v.getLicensePlate(),
            v.getBrand(),
            v.getModel(),
            v.getManufacturingYear(),
            null, // 'type' est null car géré dynamiquement via ID
            v.getColor(),
            mapFinancial(f),
            mapMaintenance(m),
            null // Operational
        );
    }

    protected VehicleParameters.Financial mapFinancial(FinancialParameterEntity f) {
        if (f == null) return null;
        return new VehicleParameters.Financial(
            f.getInsuranceNumber(), f.getInsuranceExpiredAt(), f.getRegisteredAt(), 
            f.getPurchasedAt(), f.getDepreciationRate(), f.getCostPerKm()
        );
    }

    protected VehicleParameters.Maintenance mapMaintenance(MaintenanceParameterEntity m) {
        if (m == null) return null;
        return new VehicleParameters.Maintenance(
            m.getLastMaintenanceAt(), m.getNextMaintenanceAt(), m.getEngineStatus(),
            tryParseInt(m.getBatteryHealth()),
            m.getMaintenanceStatus()
        );
    }

    protected Integer tryParseInt(String value) {
        try {
            return value != null ? Integer.parseInt(value) : null;
        } catch (NumberFormatException e) {
            return null;
        }
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/mappers/DriverMapper.java`
```java
package com.yowyob.fleet.infrastructure.mappers;

import com.yowyob.fleet.domain.model.Driver;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.DriverEntity;
import org.mapstruct.Mapper;

@Mapper(componentModel = "spring")
public interface DriverMapper {
    DriverEntity toEntity(Driver domain);
    Driver toDomain(DriverEntity entity);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/external/FakeAuthAdapter.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.external;

import com.yowyob.fleet.domain.ports.in.AuthUseCase;
import com.yowyob.fleet.domain.ports.out.AuthPort;
import lombok.extern.slf4j.Slf4j;
import reactor.core.publisher.Mono;
import java.util.List;
import java.util.UUID;

@Slf4j
public class FakeAuthAdapter implements AuthPort {

    @Override
    public Mono<AuthResponse> login(String identifier, String password) {
        log.info("🛠 MODE FAKE AUTH : Login pour {}", identifier);
        UserDetail fakeUser = createFakeUser(identifier, "fake-email@yowyob.com");
        return Mono.just(new AuthResponse("fake-access-token", "fake-refresh-token", fakeUser));
    }

    @Override
    public Mono<AuthResponse> registerInRemote(AuthUseCase.RegisterCommand command) {
        log.info("🛠 MODE FAKE AUTH : Inscription pour {}", command.username());
        UserDetail newUser = new UserDetail(
            UUID.randomUUID(), 
            command.username(), 
            command.email(), 
            command.phone(), 
            command.firstName(), 
            command.lastName(), 
            "FLEET_MANAGEMENT", 
            command.roles(), 
            List.of("*"),
            null, null, null, null // Champs enrichis nuls par défaut
        );
        return Mono.just(new AuthResponse("fake-access-token", "fake-refresh-token", newUser));
    }

    @Override
    public Mono<UserDetail> getUserProfile(String token) {
        log.info("🛠 MODE FAKE AUTH : Récupération du profil (me)");
        return Mono.just(createFakeUser("fake_admin", "admin@yowyob.com"));
    }

    @Override
    public Mono<AuthResponse> refresh(String refreshToken) {
        log.info("🛠 MODE FAKE AUTH : Rafraîchissement du token");
        UserDetail fakeUser = createFakeUser("fake_admin", "admin@yowyob.com");
        return Mono.just(new AuthResponse("new-fake-access-token", "new-fake-refresh-token", fakeUser));
    }

    @Override
    public Mono<Boolean> roleExists(String roleName) {
        return Mono.just(true);
    }

    @Override
    public Mono<Void> createRole(String roleName) {
        return Mono.empty();
    }

    @Override 
    public Mono<UserDetail> updateUserProfile(UUID userId, String token, AuthUseCase.UpdateProfileCommand command) { 
        log.info("🛠 MODE FAKE AUTH : Update profil pour {}", userId);
        return Mono.just(createFakeUser("fake_admin", command.email()));
    }
    
    @Override 
    public Mono<Void> changePassword(UUID userId, String token, String currentPwd, String newPwd) { 
        log.info("🛠 MODE FAKE AUTH : Changement mot de passe pour {}", userId);
        return Mono.empty(); 
    }
    
    @Override 
    public Mono<Void> deleteRemoteAccount(UUID userId, String token) { 
        log.info("🛠 MODE FAKE AUTH : Suppression compte pour {}", userId);
        return Mono.empty(); 
    }

    @Override
    public Mono<Void> updateProfilePicture(UUID userId, String token, AuthUseCase.FileContent file) {
        log.info("🛠 MODE FAKE AUTH : Upload photo pour {} (Fichier: {})", userId, file.filename());
        return Mono.empty();
    }

    private UserDetail createFakeUser(String username, String email) {
        return new UserDetail(
            UUID.fromString("8a1f5e2c-3d4b-4c6a-9f8e-123456789abc"),
            username,
            email,
            "+237600000000",
            "Fake",
            "User",
            "FLEET_MANAGEMENT",
            List.of("FLEET_MANAGER"),
            List.of("fleet:read", "fleet:write"),
            null, null, null, null
        );
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/external/dto/VehicleExternalResponse.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.external.dto;

import java.util.UUID;

/**
 * Technical data received from the external Vehicle Service.
 */
public record VehicleExternalResponse(
    UUID id,
    String licensePlate,
    String brand,
    String model,
    Integer manufacturingYear,
    String type,
    String color
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/external/RemoteAuthAdapter.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.external;

import com.yowyob.fleet.domain.ports.in.AuthUseCase;
import com.yowyob.fleet.domain.ports.out.AuthPort;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.client.AuthApiClient;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.MediaType;
import org.springframework.http.client.MultipartBodyBuilder;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Slf4j
@RequiredArgsConstructor
public class RemoteAuthAdapter implements AuthPort {

    private final AuthApiClient authApiClient;
    private final WebClient.Builder webClientBuilder;
    
    @Value("${application.auth.url}")
    private String authServiceUrl;

    private static final String SERVICE_NAME = "FLEET_MANAGEMENT";

    @Override
    public Mono<AuthResponse> login(String identifier, String password) {
        return authApiClient.authenticate(new AuthApiClient.LoginRequest(identifier, password))
                .map(this::mapToAuthResponse);
    }

    @Override
    public Mono<AuthResponse> registerInRemote(AuthUseCase.RegisterCommand command) {
        MultipartBodyBuilder builder = new MultipartBodyBuilder();
        
        AuthApiClient.RegisterRequest registerRequest = new AuthApiClient.RegisterRequest(
            command.username(), command.password(), command.email(), 
            command.phone(), command.firstName(), command.lastName(), 
            SERVICE_NAME, command.roles()
        );
        
        // CORRECTION ICI : "user" -> "data" pour matcher le Swagger distant
        builder.part("data", registerRequest);

        if (command.photo() != null && command.photo().data() != null) {
            builder.part("file", command.photo().data())
                   .filename(command.photo().filename())
                   .header("Content-Type", command.photo().contentType());
        }

        return webClientBuilder.build()
                .post()
                .uri(authServiceUrl + "/api/auth/register")
                .contentType(MediaType.MULTIPART_FORM_DATA)
                .bodyValue(builder.build())
                .retrieve()
                .bodyToMono(AuthApiClient.TraMaSysResponse.class)
                .map(this::mapToAuthResponse)
                .doOnError(e -> log.error("Erreur Register Distant : {}", e.getMessage()));
    }

    @Override
    public Mono<UserDetail> getUserProfile(String token) {
        return authApiClient.getCurrentUser(ensureBearer(token))
                .map(this::mapToDomainUserDetail);
    }

    @Override
    public Mono<UserDetail> updateUserProfile(UUID userId, String token, AuthUseCase.UpdateProfileCommand command) {
        AuthApiClient.UpdateUserRequest req = new AuthApiClient.UpdateUserRequest(
            command.firstName(), command.lastName(), command.phone(), command.email()
        );
        
        return webClientBuilder.build()
                .put()
                .uri(authServiceUrl + "/api/users/" + userId)
                .header("Authorization", ensureBearer(token))
                .bodyValue(req)
                .retrieve()
                .bodyToMono(AuthApiClient.UserDetailResponse.class)
                .map(this::mapToDomainUserDetail);
    }

    @Override
    public Mono<Void> changePassword(UUID userId, String token, String currentPwd, String newPwd) {
        AuthApiClient.ChangePasswordRequest req = new AuthApiClient.ChangePasswordRequest(currentPwd, newPwd);
        
        return webClientBuilder.build()
                .put()
                .uri(authServiceUrl + "/api/users/" + userId + "/password")
                .header("Authorization", ensureBearer(token))
                .bodyValue(req)
                .retrieve()
                .bodyToMono(Void.class);
    }

    @Override
    public Mono<Void> updateProfilePicture(UUID userId, String token, AuthUseCase.FileContent file) {
        MultipartBodyBuilder builder = new MultipartBodyBuilder();
        builder.part("file", file.data())
               .filename(file.filename())
               .header("Content-Type", file.contentType());

        return webClientBuilder.build()
                .post()
                .uri(authServiceUrl + "/api/users/" + userId + "/picture")
                .header("Authorization", ensureBearer(token))
                .contentType(MediaType.MULTIPART_FORM_DATA)
                .bodyValue(builder.build())
                .retrieve()
                .bodyToMono(Void.class);
    }

    @Override
    public Mono<Void> deleteRemoteAccount(UUID userId, String token) {
        return webClientBuilder.build()
                .delete()
                .uri(authServiceUrl + "/api/users/" + userId)
                .header("Authorization", ensureBearer(token))
                .retrieve()
                .bodyToMono(Void.class);
    }

    @Override
    public Mono<AuthResponse> refresh(String refreshToken) {
        return authApiClient.refreshToken(new AuthApiClient.RefreshRequest(refreshToken))
                .map(this::mapToAuthResponse);
    }

    @Override
    public Mono<Boolean> roleExists(String roleName) {
        return Mono.just(true); 
    }

    @Override
    public Mono<Void> createRole(String roleName) {
        return Mono.empty();
    }

    // Mappers
    private String ensureBearer(String token) {
        if (token == null) return "";
        return token.startsWith("Bearer ") ? token : "Bearer " + token;
    }

    private AuthResponse mapToAuthResponse(AuthApiClient.TraMaSysResponse res) {
        return new AuthResponse(res.accessToken(), res.refreshToken(), mapToDomainUserDetail(res.user()));
    }

    private UserDetail mapToDomainUserDetail(AuthApiClient.UserDetailResponse res) {
        if (res == null) return null;
        return new UserDetail(
            res.id(), res.username(), res.email(), res.phone(),
            res.firstName(), res.lastName(), res.service(),
            res.roles(), res.permissions(), 
            null, 
            null, null, null
        );
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/external/client/AuthApiClient.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.external.client;

import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.service.annotation.DeleteExchange;
import org.springframework.web.service.annotation.GetExchange;
import org.springframework.web.service.annotation.HttpExchange;
import org.springframework.web.service.annotation.PostExchange;
import org.springframework.web.service.annotation.PutExchange;

import reactor.core.publisher.Mono;
import java.util.List;
import java.util.UUID;

@HttpExchange("/api") // Base path changé pour inclure /auth et /users
public interface AuthApiClient {
    
    // --- AUTH ---
    @PostExchange("/auth/login")
    Mono<TraMaSysResponse> authenticate(@RequestBody LoginRequest request);

    @PostExchange("/auth/register")
    Mono<TraMaSysResponse> register(@RequestBody RegisterRequest request);
    
    @GetExchange("/auth/me")
    Mono<UserDetailResponse> getCurrentUser(@RequestHeader("Authorization") String bearerToken);

    @PostExchange("/auth/refresh")
    Mono<TraMaSysResponse> refreshToken(@RequestBody RefreshRequest request);

    // --- USERS ---
    @PutExchange("/users/{id}")
    Mono<UserDetailResponse> updateUser(@PathVariable UUID id, @RequestBody UpdateUserRequest request);

    @PutExchange("/users/{id}/password")
    Mono<Void> changePassword(@PathVariable UUID id, @RequestBody ChangePasswordRequest request);

    // Le delete n'était pas clair sur le screen, j'assume standard REST sur /users/{id}
    // ou logout/{id} comme vu précédemment, mais pour un "delete account", c'est souvent différent.
    // Je mets le standard REST, on ajustera si erreur 404.
    @DeleteExchange("/users/{id}") 
    Mono<Void> deleteUser(@PathVariable UUID id);


    // DTOs
    record LoginRequest(String identifier, String password) {}
    record RefreshRequest(String refreshToken) {}
    
    record RegisterRequest(
        String username, String password, String email, String phone,
        String firstName, String lastName, String service, List<String> roles
    ) {}

    record UpdateUserRequest(
        String firstName, String lastName, String phone, String email
    ) {}

    record ChangePasswordRequest(
        String currentPassword, String newPassword
    ) {}

    record TraMaSysResponse(String accessToken, String refreshToken, UserDetailResponse user) {}
    
    record UserDetailResponse(
        UUID id, String username, String email, String phone,
        String firstName, String lastName, String service,
        List<String> roles, List<String> permissions
    ) {}    
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/external/client/VehicleApiClient.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.external.client;

import com.yowyob.fleet.infrastructure.adapters.outbound.external.dto.VehicleExternalResponse;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.service.annotation.GetExchange;
import org.springframework.web.service.annotation.HttpExchange;
import reactor.core.publisher.Mono;
import java.util.UUID;

@HttpExchange("/vehicles")
public interface VehicleApiClient {

    @GetExchange("/{id}")
    Mono<VehicleExternalResponse> getVehicleById(@PathVariable UUID id);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/external/VehicleApiAdapter.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.external;

import com.yowyob.fleet.domain.model.Vehicle;
import com.yowyob.fleet.domain.ports.out.ExternalVehiclePort;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.client.VehicleApiClient;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.dto.VehicleExternalResponse; // AJOUTE CET IMPORT
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;
import java.util.UUID;

@Component
@RequiredArgsConstructor
public class VehicleApiAdapter implements ExternalVehiclePort {

    private final VehicleApiClient vehicleApiClient;

    @Override
    public Mono<Vehicle> getExternalVehicleInfo(UUID vehicleId) {
        return vehicleApiClient.getVehicleById(vehicleId)
                .map(ext -> new Vehicle(
                        ext.id(),
                        null, // fleetId will be populated by the application service
                        ext.licensePlate(),
                        ext.brand(),
                        ext.model(),
                        ext.manufacturingYear(),
                        ext.type(),
                        ext.color(),
                        null, null, null // Local parameters to be filled later
                ))
                .onErrorResume(e -> {
                    System.err.println("⚠️ External Vehicle Service Error: " + e.getMessage());
                    return Mono.empty();
                });
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/VehiclePersistenceAdapter.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence;

import com.yowyob.fleet.domain.model.Vehicle;
import com.yowyob.fleet.domain.ports.out.VehiclePersistencePort;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.FinancialParameterEntity;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.MaintenanceParameterEntity;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository.FinancialParameterR2dbcRepository;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository.MaintenanceParameterR2dbcRepository;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository.VehicleLocalR2dbcRepository;
import com.yowyob.fleet.infrastructure.mappers.VehicleLocalMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Component
@RequiredArgsConstructor
public class VehiclePersistenceAdapter implements VehiclePersistencePort {

    private final VehicleLocalR2dbcRepository vehicleRepo;
    private final FinancialParameterR2dbcRepository financialRepo;
    private final MaintenanceParameterR2dbcRepository maintenanceRepo;
    private final VehicleLocalMapper mapper;

    @Override
    public Mono<Vehicle> saveLocalData(Vehicle vehicle) {
        // 1. Save the main vehicle pivot first
        return vehicleRepo.save(mapper.toVehicleEntity(vehicle))
                .flatMap(savedVehicle -> {
                    // 2. Map parameters to entities
                    var financialEntity = mapper.toFinancialEntity(vehicle);
                    var maintenanceEntity = mapper.toMaintenanceEntity(vehicle);
                    
                    // Ensure the foreign key is set
                    financialEntity.setVehicleId(savedVehicle.getId());
                    maintenanceEntity.setVehicleId(savedVehicle.getId());

                    // 3. Save parameters in parallel using zip
                    return Mono.zip(
                            financialRepo.save(financialEntity),
                            maintenanceRepo.save(maintenanceEntity)
                    ).thenReturn(savedVehicle);
                })
                // 4. Return the domain object (we can fetch again or map directly)
                .map(v -> mapper.toDomain(v, null, null));
    }

    @Override
    public Mono<Vehicle> getLocalDataById(UUID id) {
        // Zip: fetch all 3 local tables in parallel
        return Mono.zip(
                vehicleRepo.findById(id),
                financialRepo.findByVehicleId(id).defaultIfEmpty(new FinancialParameterEntity()),
                maintenanceRepo.findByVehicleId(id).defaultIfEmpty(new MaintenanceParameterEntity())
        ).map(tuple -> mapper.toDomain(tuple.getT1(), tuple.getT2(), tuple.getT3()));
    }

    @Override
    public Mono<Void> deleteLocalData(UUID id) {
        // Delete pivot - the CASCADE in SQL will handle the parameters
        return vehicleRepo.deleteById(id);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/entity/VehicleLocalEntity.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;
import org.springframework.data.relational.core.mapping.Column;
import java.util.UUID;

@Table(name = "vehicles", schema = "fleet")
@Data @NoArgsConstructor @AllArgsConstructor
public class VehicleLocalEntity {
    @Id
    private UUID id;

    @Column("fleet_id")
    private UUID fleetId;

    @Column("current_driver_id")
    private UUID currentDriverId;

    @Column("vehicle_type_id")
    private UUID vehicleTypeId;

    @Column("license_plate")
    private String licensePlate;
    
    // Ces champs DOIVENT être présents pour que le mapper fonctionne
    private String brand;
    private String model;
    
    @Column("manufacturing_year")
    private Integer manufacturingYear;
    
    private String color;
    
    private String status; 

    @Column("photo_url")
    private String photoUrl;
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/entity/FinancialParameterEntity.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;
import org.springframework.data.relational.core.mapping.Column;
import java.time.LocalDate;
import java.util.UUID;

@Table(name = "financial_parameters", schema = "fleet")
@Data @NoArgsConstructor @AllArgsConstructor
public class FinancialParameterEntity {
    @Id
    private UUID id;
    
    @Column("vehicle_id")
    private UUID vehicleId;
    
    @Column("insurance_number")
    private String insuranceNumber;
    
    @Column("insurance_expired_at")
    private LocalDate insuranceExpiredAt;
    
    @Column("registered_at")
    private LocalDate registeredAt;
    
    @Column("purchased_at")
    private LocalDate purchasedAt;
    
    @Column("depreciation_rate")
    private Integer depreciationRate;
    
    @Column("cost_per_km")
    private Float costPerKm;
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/entity/DriverEntity.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Table(name = "drivers", schema = "fleet")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class DriverEntity {
    @Id
    @Column("user_id") // Correspond à la PK user_id dans fleet.drivers
    private UUID userId;
    
    @Column("licence_number")
    private String licenceNumber;
    
    private Boolean status;
    
    @Column("assigned_vehicle_id")
    private UUID assignedVehicleId;
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/entity/MaintenanceParameterEntity.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;
import org.springframework.data.relational.core.mapping.Column;
import java.time.LocalDate;
import java.util.UUID;

@Table(name = "maintenance_parameters", schema = "fleet")
@Data @NoArgsConstructor @AllArgsConstructor
public class MaintenanceParameterEntity {
    @Id
    private UUID id;
    
    @Column("vehicle_id")
    private UUID vehicleId;
    
    @Column("last_maintenance_at")
    private LocalDate lastMaintenanceAt;
    
    @Column("next_maintenance_at")
    private LocalDate nextMaintenanceAt;
    
    @Column("engine_status")
    private String engineStatus; 
    
    @Column("battery_health")
    private String batteryHealth; // Converti en String car l'entité attend ça (ou Integer selon mapping)
    
    @Column("maintenance_status")
    private String maintenanceStatus;
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/entity/FleetEntity.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;
import org.springframework.data.relational.core.mapping.Column;
import java.time.Instant;
import java.util.UUID;

@Table(name = "fleets", schema = "fleet")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class FleetEntity {
    @Id
    private UUID id;
    
    @Column("fleet_manager_id")
    private UUID fleetManagerId; // Ref to public.business_actors
    
    private String name;
    
    @Column("phone_number")
    private String phoneNumber;
    
    @Column("created_at")
    private Instant createdAt;
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/entity/FleetManagerEntity.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Table(name = "fleet_managers", schema = "fleet")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class FleetManagerEntity {
    
    @Id
    @Column("user_id")
    private UUID userId;

    @Column("company_name")
    private String companyName;
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/entity/OperationalParameterEntity.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;
import org.springframework.data.relational.core.mapping.Column;
import java.time.Instant;
import java.math.BigDecimal;
import java.util.UUID;

@Table(name = "operational_parameters", schema = "fleet")
@Data @NoArgsConstructor @AllArgsConstructor
public class OperationalParameterEntity {
    @Id
    private UUID id;
    
    @Column("vehicle_id")
    private UUID vehicleId;
    
    @Column("trip_id")
    private UUID tripId;
    
    private Boolean statut;
    
    @Column("current_location")
    private String currentLocation;
    
    @Column("current_speed")
    private BigDecimal currentSpeed;
    
    @Column("fuel_level")
    private String fuelLevel;
    
    private BigDecimal mileage;
    
    @Column("odometer_reading")
    private BigDecimal odometerReading;
    
    private BigDecimal bearing;
    
    private Instant timestamp;
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/FleetPersistenceAdapter.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence;

import com.yowyob.fleet.domain.model.Fleet;
import com.yowyob.fleet.domain.ports.out.FleetRepositoryPort;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository.FleetR2dbcRepository;
import com.yowyob.fleet.infrastructure.mappers.FleetMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

@Component
@RequiredArgsConstructor
public class FleetPersistenceAdapter implements FleetRepositoryPort {

    private final FleetR2dbcRepository repository;
    private final FleetMapper mapper;

    @Override
    public Mono<Fleet> save(Fleet fleet) {
        return repository.save(mapper.toEntity(fleet))
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Fleet> findById(UUID id) {
        return repository.findById(id)
                .map(mapper::toDomain);
    }

    @Override
    public Flux<Fleet> findAll() {
        return repository.findAll()
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Void> deleteById(UUID id) {
        return repository.deleteById(id);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/repository/VehicleLocalR2dbcRepository.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.VehicleLocalEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Flux;
import java.util.UUID;

@Repository
public interface VehicleLocalR2dbcRepository extends ReactiveCrudRepository<VehicleLocalEntity, UUID> {
    
    /**
     * Finds all vehicle IDs associated with a specific fleet.
     */
    Flux<VehicleLocalEntity> findByFleetId(UUID fleetId);

    /**
     * Finds all vehicles assigned to a specific driver.
     * CORRECTION : Renommé de findByDriverId à findByCurrentDriverId
     */
    Flux<VehicleLocalEntity> findByCurrentDriverId(UUID currentDriverId);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/repository/DriverR2dbcRepository.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.DriverEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Flux;

import java.util.UUID;

@Repository
public interface DriverR2dbcRepository extends ReactiveCrudRepository<DriverEntity, UUID> {
    Flux<DriverEntity> findByStatus(Boolean status);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/repository/MaintenanceParameterR2dbcRepository.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.MaintenanceParameterEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Mono;
import java.util.UUID;

@Repository
public interface MaintenanceParameterR2dbcRepository extends ReactiveCrudRepository<MaintenanceParameterEntity, UUID> {
    
    /**
     * Fetches maintenance status linked to a specific vehicle ID.
     */
    Mono<MaintenanceParameterEntity> findByVehicleId(UUID vehicleId);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/repository/FleetR2dbcRepository.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.FleetEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import java.util.UUID;

public interface FleetR2dbcRepository extends ReactiveCrudRepository<FleetEntity, UUID> {
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/repository/FleetManagerR2dbcRepository.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.FleetManagerEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;

import java.util.UUID;

@Repository
public interface FleetManagerR2dbcRepository extends ReactiveCrudRepository<FleetManagerEntity, UUID> {
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/repository/FinancialParameterR2dbcRepository.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.FinancialParameterEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Mono;
import java.util.UUID;

@Repository
public interface FinancialParameterR2dbcRepository extends ReactiveCrudRepository<FinancialParameterEntity, UUID> {
    
    /**
     * Fetches financial details linked to a specific vehicle ID.
     */
    Mono<FinancialParameterEntity> findByVehicleId(UUID vehicleId);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/FleetManagerPersistenceAdapter.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence;

import com.yowyob.fleet.domain.ports.out.FleetManagerPersistencePort;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.entity.FleetManagerEntity;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository.FleetManagerR2dbcRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Component
@RequiredArgsConstructor
public class FleetManagerPersistenceAdapter implements FleetManagerPersistencePort {

    private final FleetManagerR2dbcRepository repository;

    @Override
    public Mono<Void> createProfile(UUID userId, String companyName) {
        // Création avec "FREE" par défaut comme défini dans le script SQL
        FleetManagerEntity entity = new FleetManagerEntity(
            userId, 
            companyName
        );
        return repository.save(entity).then();
    }

    @Override
    public Mono<Void> updateCompany(UUID userId, String companyName) {
        return repository.findById(userId)
                .flatMap(entity -> {
                    entity.setCompanyName(companyName);
                    return repository.save(entity);
                })
                .then();
    }

    @Override
    public Mono<String> getCompanyName(UUID userId) {
        return repository.findById(userId)
                .map(entity -> entity.getCompanyName() != null ? entity.getCompanyName() : "");
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/outbound/persistence/DriverPersistenceAdapter.java`
```java
package com.yowyob.fleet.infrastructure.adapters.outbound.persistence;

import com.yowyob.fleet.domain.model.Driver;
import com.yowyob.fleet.domain.ports.out.DriverPersistencePort;
import com.yowyob.fleet.infrastructure.adapters.outbound.persistence.repository.DriverR2dbcRepository;
import com.yowyob.fleet.infrastructure.mappers.DriverMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Component
@RequiredArgsConstructor
public class DriverPersistenceAdapter implements DriverPersistencePort {

    private final DriverR2dbcRepository repository;
    private final DriverMapper mapper;

    @Override
    public Mono<Driver> save(Driver driver) {
        return repository.save(mapper.toEntity(driver))
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Driver> findById(UUID userId) {
        return repository.findById(userId)
                .map(mapper::toDomain);
    }

    @Override
    public Flux<Driver> findAll(Boolean status) {
        if (status != null) {
            return repository.findByStatus(status).map(mapper::toDomain);
        }
        return repository.findAll().map(mapper::toDomain);
    }

    @Override
    public Mono<Void> updateVehicleAssignment(UUID userId, UUID vehicleId) {
        return repository.findById(userId)
                .flatMap(entity -> {
                    entity.setAssignedVehicleId(vehicleId);
                    return repository.save(entity);
                })
                .switchIfEmpty(Mono.error(new RuntimeException("Chauffeur non trouvé")))
                .then();
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/AccountController.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import com.yowyob.fleet.domain.ports.in.AuthUseCase;
import com.yowyob.fleet.domain.ports.out.AuthPort;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.ChangePasswordRequest;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.UpdateProfileRequest;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.core.io.buffer.DataBufferUtils;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.codec.multipart.FilePart;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;

@RestController
@RequestMapping("/api/v1/account")
@RequiredArgsConstructor
@Tag(name = "03. Account", description = "Gestion du profil personnel")
@SecurityRequirement(name = "bearerAuth")
public class AccountController {

    private final AuthUseCase authUseCase;

    @GetMapping
    @Operation(summary = "Voir mon profil", description = "Récupère les infos Auth + Données métier (Manager/Driver).")
    public Mono<AuthPort.UserDetail> getMyProfile(@RequestHeader(HttpHeaders.AUTHORIZATION) String token) {
        return authUseCase.me(token);
    }

    @PutMapping
    @Operation(summary = "Mettre à jour mon profil", description = "Modifie nom, prénom, téléphone et infos métier.")
    public Mono<AuthPort.UserDetail> updateProfile(
            @RequestHeader(HttpHeaders.AUTHORIZATION) String token,
            @Valid @RequestBody UpdateProfileRequest request
    ) {
        // On récupère d'abord l'ID via /me car le token est la seule preuve d'identité
        return authUseCase.me(token)
                .flatMap(user -> {
                    AuthUseCase.UpdateProfileCommand cmd = new AuthUseCase.UpdateProfileCommand(
                            request.firstName(), request.lastName(), request.phone(), request.email(),
                            request.companyName(), request.licenceNumber()
                    );
                    return authUseCase.updateProfile(user.id(), token, cmd);
                });
    }

    @PutMapping("/password")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Changer mon mot de passe")
    public Mono<Void> changePassword(
            @RequestHeader(HttpHeaders.AUTHORIZATION) String token,
            @Valid @RequestBody ChangePasswordRequest request
    ) {
        return authUseCase.me(token)
                .flatMap(user -> authUseCase.changePassword(
                        user.id(), token, request.currentPassword(), request.newPassword()
                ));
    }

    @PostMapping(value = "/picture", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Changer ma photo de profil")
    public Mono<Void> updatePicture(
            @RequestHeader(HttpHeaders.AUTHORIZATION) String token,
            @RequestPart("file") FilePart filePart
    ) {
        return authUseCase.me(token)
                .flatMap(user -> 
                    DataBufferUtils.join(filePart.content())
                        .map(dataBuffer -> {
                            byte[] bytes = new byte[dataBuffer.readableByteCount()];
                            dataBuffer.read(bytes);
                            DataBufferUtils.release(dataBuffer);
                            return new AuthUseCase.FileContent(
                                    filePart.filename(),
                                    filePart.headers().getContentType() != null ? filePart.headers().getContentType().toString() : "image/jpeg",
                                    bytes
                            );
                        })
                        .flatMap(fileContent -> authUseCase.updateProfilePicture(user.id(), token, fileContent))
                );
    }

    @DeleteMapping
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Supprimer mon compte", description = "Supprime le compte Auth et les données locales associées.")
    public Mono<Void> deleteAccount(@RequestHeader(HttpHeaders.AUTHORIZATION) String token) {
        return authUseCase.me(token)
                .flatMap(user -> authUseCase.deleteAccount(user.id(), token));
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/FleetController.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import com.yowyob.fleet.domain.model.Fleet;
import com.yowyob.fleet.domain.ports.in.ManageFleetUseCase;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.FleetRequest;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.FleetResponse;
import com.yowyob.fleet.infrastructure.mappers.FleetMapper;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@RestController
@RequestMapping("/api/v1/fleets")
@RequiredArgsConstructor
@Tag(name = "07. Fleets", description = "Gestion des flottes")
public class FleetController {

    private final ManageFleetUseCase fleetUseCase;
    private final FleetMapper mapper;

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create a new fleet")
    public Mono<FleetResponse> create(@Valid @RequestBody FleetRequest request) {
        return fleetUseCase.createFleet(mapper.toDomain(request))
                .map(mapper::toResponse);
    }

    @GetMapping("/{id}")
    @Operation(summary = "Get fleet details by ID")
    public Mono<FleetResponse> getById(@PathVariable UUID id) {
        return fleetUseCase.getFleetById(id)
                .map(mapper::toResponse);
    }

    @GetMapping
    @Operation(summary = "List all fleets")
    public Flux<FleetResponse> getAll() {
        return fleetUseCase.getAllFleets()
                .map(mapper::toResponse);
    }

    @PutMapping("/{id}")
    @Operation(summary = "Full update of a fleet")
    public Mono<FleetResponse> update(@PathVariable UUID id, @Valid @RequestBody FleetRequest request) {
        return fleetUseCase.updateFleet(id, mapper.toDomain(request))
                .map(mapper::toResponse);
    }

    @PatchMapping("/{id}")
    @Operation(summary = "Partial update of a fleet")
    public Mono<FleetResponse> patch(@PathVariable UUID id, @RequestBody FleetRequest request) {
        return fleetUseCase.patchFleet(id, mapper.toDomain(request))
                .map(mapper::toResponse);
    }

    @DeleteMapping("/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete a fleet")
    public Mono<Void> delete(@PathVariable UUID id) {
        return fleetUseCase.deleteFleet(id);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/VehicleController.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import com.yowyob.fleet.domain.model.Vehicle;
import com.yowyob.fleet.domain.model.VehicleParameters;
import com.yowyob.fleet.domain.ports.in.ManageVehicleUseCase;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.*;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;

import java.util.UUID;

@RestController
@RequestMapping("/api/v1")
@RequiredArgsConstructor
@Tag(name = "Vehicles", description = "Vehicle Exploitation Operations")
public class VehicleController {

    private final ManageVehicleUseCase vehicleUseCase;

    @PostMapping("/fleets/{fleetId}/vehicles")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Add an existing vehicle to a fleet")
    public Mono<Vehicle> addVehicle(@PathVariable UUID fleetId, @Valid @RequestBody VehicleRegistrationRequest request) {
        // Create a shell vehicle object to pass to service
        Vehicle vehicleToAdd = new Vehicle(request.vehicleId(), fleetId, null, null, null, null, null, null, null, null, null);
        return vehicleUseCase.addVehicleToFleet(vehicleToAdd);
    }

    @GetMapping("/vehicles/{vehicleId}")
    @Operation(summary = "Get full aggregated vehicle details")
    public Mono<Vehicle> getVehicle(@PathVariable UUID vehicleId) {
        return vehicleUseCase.getVehicleDetails(vehicleId);
    }

    @PutMapping("/vehicles/{vehicleId}/financial-parameters")
    @Operation(summary = "Update financial parameters")
    public Mono<Void> updateFinancial(@PathVariable UUID vehicleId, @RequestBody FinancialUpdateRequest req) {
        var domainParams = new VehicleParameters.Financial(
                req.insuranceNumber(), req.insuranceExpiryDate(), req.registrationDate(),
                req.purchaseDate(), req.depreciationRate(), req.costPerKm());
        return vehicleUseCase.updateFinancialParameters(vehicleId, domainParams);
    }

    @PutMapping("/vehicles/{vehicleId}/maintenance-parameters")
    @Operation(summary = "Update maintenance parameters")
    public Mono<Void> updateMaintenance(@PathVariable UUID vehicleId, @RequestBody MaintenanceUpdateRequest req) {
        var domainParams = new VehicleParameters.Maintenance(
                req.lastMaintenanceDate(), req.nextMaintenanceDue(), req.engineStatus(),
                req.batteryHealth(), req.maintenanceStatus());
        return vehicleUseCase.updateMaintenanceParameters(vehicleId, domainParams);
    }

    @DeleteMapping("/vehicles/{vehicleId}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Remove vehicle from fleet management")
    public Mono<Void> delete(@PathVariable UUID vehicleId) {
        return vehicleUseCase.removeVehicleFromFleet(vehicleId);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/GlobalExceptionHandler.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ProblemDetail;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.reactive.function.client.WebClientResponseException;

import java.net.URI;

@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(WebClientResponseException.class)
    public ProblemDetail handleWebClientException(WebClientResponseException ex) {
        // On récupère le corps de la réponse d'erreur distante
        String remoteResponseBody = ex.getResponseBodyAsString();
        
        log.error("Erreur API Distante ({}): {}", ex.getStatusCode(), remoteResponseBody);

        ProblemDetail problem = ProblemDetail.forStatusAndDetail(ex.getStatusCode(), remoteResponseBody);
        problem.setTitle("Erreur du service distant (" + ex.getStatusText() + ")");
        problem.setType(URI.create("about:blank"));
        
        // On peut ajouter des propriétés custom pour le debug
        problem.setProperty("remote_status", ex.getStatusCode().value());
        
        return problem;
    }

    // Garde les autres handlers si tu veux des traitements spécifiques, 
    // mais celui ci-dessus est générique et couvrira tout (400, 401, 500...)
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/AuthController.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import com.yowyob.fleet.domain.ports.in.AuthUseCase;
import com.yowyob.fleet.domain.ports.out.AuthPort;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.RegisterRequest;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.core.io.buffer.DataBufferUtils;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.codec.multipart.FilePart;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;

import java.util.UUID;

@RestController
@RequestMapping("/api/v1/auth")
@RequiredArgsConstructor
@Tag(name = "02. Auth", description = "Endpoints publics (Login, Register)")
public class AuthController {

    private final AuthUseCase authUseCase;

    @PostMapping("/login")
    public Mono<AuthPort.AuthResponse> login(@RequestBody LoginRequest request) {
        return authUseCase.login(request.identifier(), request.password());
    }

    @PostMapping(value = "/register", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @Operation(summary = "Inscription Utilisateur", description = "Création de compte avec rôle (MANAGER ou DRIVER) et photo optionnelle.")
    public Mono<AuthPort.AuthResponse> register(
            @RequestPart("user") RegisterRequest dto,
            @RequestPart(value = "file", required = false) FilePart filePart
    ) {
        // Transformation FilePart (Web) -> FileContent (Domaine)
        Mono<AuthUseCase.FileContent> photoMono = Mono.justOrEmpty(filePart)
                .flatMap(fp -> DataBufferUtils.join(fp.content())
                        .map(dataBuffer -> {
                            byte[] bytes = new byte[dataBuffer.readableByteCount()];
                            dataBuffer.read(bytes);
                            DataBufferUtils.release(dataBuffer);
                            return new AuthUseCase.FileContent(
                                    fp.filename(),
                                    fp.headers().getContentType() != null ? fp.headers().getContentType().toString() : "image/jpeg",
                                    bytes
                            );
                        }));

        return photoMono
                .map(photo -> new AuthUseCase.RegisterCommand(
                        dto.username(), dto.password(), dto.email(), dto.phone(),
                        dto.firstName(), dto.lastName(), dto.roles(), photo
                ))
                .switchIfEmpty(Mono.just(new AuthUseCase.RegisterCommand(
                        dto.username(), dto.password(), dto.email(), dto.phone(),
                        dto.firstName(), dto.lastName(), dto.roles(), null
                )))
                .flatMap(authUseCase::register);
    }

    @PostMapping("/refresh")
    @Operation(summary = "Refresh access token")
    public Mono<AuthPort.AuthResponse> refresh(@RequestBody TokenRefreshRequest request) {
        return authUseCase.refreshToken(request.refreshToken());
    }
    
    // NOTE : /me, /logout sont déplacés dans AccountController (Jalon suivant)
    // On garde juste login/register/refresh ici pour respecter la séparation

    // DTOs internes (si non déplacés dans des fichiers séparés)
    public record LoginRequest(String identifier, String password) {}
    public record TokenRefreshRequest(String refreshToken) {}
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/DriverController.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import com.yowyob.fleet.domain.model.Driver;
import com.yowyob.fleet.domain.ports.in.ManageDriverUseCase;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.DriverRegistrationRequest;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.enums.ParameterIn;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

@RestController
@RequestMapping("/api/v1/drivers")
@RequiredArgsConstructor
@Tag(name = "05. Drivers", description = "Gestion des chauffeurs")
public class DriverController {

    private final ManageDriverUseCase driverUseCase;

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Register a new Driver (Remote Auth + Local Profile)")
    public Mono<Driver> register(@RequestBody DriverRegistrationRequest request) {
        return driverUseCase.registerDriver(request);
    }

    @GetMapping
    @Operation(summary = "List all drivers", description = "Retrieve all drivers with optional status filtering")
    public Flux<Driver> list(
        @Parameter(
            name = "status", 
            description = "Filter by active (true) or inactive (false) status", 
            in = ParameterIn.QUERY, 
            schema = @Schema(type = "boolean")
        ) 
        @RequestParam(required = false) Boolean status
    ) {
        return driverUseCase.getAllDrivers(status);
    }

    @GetMapping("/{userId}")
    @Operation(summary = "Get driver by ID")
    public Mono<Driver> get(
        @Parameter(
            name = "userId",
            description = "Unique identifier of the driver",
            in = ParameterIn.PATH,
            schema = @Schema(type = "string", format = "uuid")
        )
        @PathVariable UUID userId
    ) {
        return driverUseCase.getDriverById(userId);
    }

    @PostMapping("/{userId}/assign-vehicle")
    @Operation(summary = "Assign a vehicle to a driver")
    public Mono<Void> assign(@PathVariable UUID userId, @RequestBody VehicleAssignRequest req) {
        return driverUseCase.assignVehicle(userId, req.vehicleId());
    }

    @PostMapping("/{userId}/unassign-vehicle")
    @Operation(summary = "Remove vehicle assignment from driver")
    public Mono<Void> unassign(@PathVariable UUID userId) {
        return driverUseCase.unassignVehicle(userId);
    }

    public record VehicleAssignRequest(UUID vehicleId) {}
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/dto/VehicleRegistrationRequest.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;

import jakarta.validation.constraints.NotNull;
import java.util.UUID;

public record VehicleRegistrationRequest(
    @NotNull UUID vehicleId
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/dto/DriverRegistrationRequest.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;

import java.util.List;

public record DriverRegistrationRequest(
    // Infos TraMaSys
    String username,
    String password,
    String email,
    String phone,
    String firstName,
    String lastName,
    
    // Infos Métier (Locales)
    String licenceNumber
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/dto/UpdateProfileRequest.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;

import jakarta.validation.constraints.Email;

public record UpdateProfileRequest(
    // Infos Identité (Propagées vers Auth Service)
    String firstName,
    String lastName,
    String phone,
    @Email String email,
    
    // Infos Métier (Stockées localement)
    String companyName,    // Uniquement pour FLEET_MANAGER
    String licenceNumber   // Uniquement pour FLEET_DRIVER
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/dto/FinancialUpdateRequest.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;

import java.time.LocalDate;

public record FinancialUpdateRequest(
    String insuranceNumber,
    LocalDate insuranceExpiryDate,
    LocalDate registrationDate,
    LocalDate purchaseDate,
    Integer depreciationRate,
    Float costPerKm
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/dto/ChangePasswordRequest.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;

import jakarta.validation.constraints.NotBlank;

public record ChangePasswordRequest(
    @NotBlank String currentPassword,
    @NotBlank String newPassword
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/dto/FleetResponse.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;

import java.time.LocalDate;
import java.util.UUID;

public record FleetResponse(
    UUID id,
    String name,
    LocalDate creationDate,
    UUID managerUserId,
    Integer vehicleCount
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/dto/RegisterRequest.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.util.List;

public record RegisterRequest(
    @NotBlank(message = "Le nom d'utilisateur est obligatoire")
    String username,
    
    @NotBlank(message = "Le mot de passe est obligatoire")
    String password,
    
    @Email(message = "Format d'email invalide")
    @NotBlank(message = "L'email est obligatoire")
    String email,
    
    @NotBlank(message = "Le téléphone est obligatoire")
    String phone,
    
    String firstName,
    String lastName,
    
    @NotNull(message = "Le rôle est obligatoire (ex: FLEET_MANAGER, FLEET_DRIVER)")
    List<String> roles
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/dto/MaintenanceUpdateRequest.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;

import java.time.LocalDate;

public record MaintenanceUpdateRequest(
    LocalDate lastMaintenanceDate,
    LocalDate nextMaintenanceDue,
    String engineStatus,
    Integer batteryHealth,
    String maintenanceStatus
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/dto/FleetRequest.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.util.UUID;

public record FleetRequest(
    @NotBlank String name,
    @NotNull UUID managerUserId
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/dto/LoginRequest.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto;

import jakarta.validation.constraints.NotBlank;

public record LoginRequest(
    @NotBlank(message = "L'identifiant (email) est obligatoire") 
    String identifier,
    
    @NotBlank(message = "Le mot de passe est obligatoire") 
    String password
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/adapters/inbound/rest/HealthCheckController.java`
```java
package com.yowyob.fleet.infrastructure.adapters.inbound.rest;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.connection.ReactiveRedisConnectionFactory;
import org.springframework.kafka.core.reactive.ReactiveKafkaProducerTemplate;
import org.springframework.r2dbc.core.DatabaseClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

import java.time.Duration;
import java.time.Instant;
import java.util.HashMap;
import java.util.Map;

@Slf4j
@RestController
@RequestMapping("/api/v1/health")
@RequiredArgsConstructor
@Tag(name = "01. Monitoring", description = "Diagnostic complet de l'infrastructure")
public class HealthCheckController {

    private final DatabaseClient databaseClient;
    private final ReactiveRedisConnectionFactory redisConnectionFactory;
    
    // On injecte le template pour vérifier si Kafka est configuré
    // Note: Pour un vrai check de santé Kafka, il faudrait AdminClient, mais c'est complexe en réactif pur sans dépendance lourde.
    // Ici on vérifie juste que le bean est up et on tente une opération non intrusive si possible.
    private final ReactiveKafkaProducerTemplate<String, Object> kafkaTemplate;

    @Value("${application.auth.url}")
    private String authUrl;

    @Value("${application.external.vehicle-service-url}")
    private String vehicleUrl;

    private final WebClient.Builder webClientBuilder;

    @GetMapping("/diagnostic")
    @Operation(summary = "Diagnostic Système complet", description = "Vérifie DB, Redis, Kafka et les APIs distantes.")
    public Mono<SystemHealth> getDiagnostic() {
        // Lancement parallèle des checks
        return Mono.zip(
            checkDatabase(),
            checkRedis(),
            checkKafka(),
            checkRemoteService("Auth Service", authUrl),
            checkRemoteService("Vehicle Service", vehicleUrl)
        ).map(tuple -> {
            Map<String, ServiceStatus> dependencies = new HashMap<>();
            dependencies.put("database", tuple.getT1());
            dependencies.put("redis", tuple.getT2());
            dependencies.put("kafka", tuple.getT3());
            dependencies.put("auth_service", tuple.getT4());
            dependencies.put("vehicle_service", tuple.getT5());

            // Si l'un des services critiques (DB, Redis) est DOWN, le global est DOWN
            boolean isGlobalUp = tuple.getT1().status().equals("UP") 
                              && tuple.getT2().status().equals("UP");

            return new SystemHealth(
                isGlobalUp ? "UP" : "DEGRADED",
                Instant.now(),
                dependencies
            );
        });
    }

    // --- CHECKS INDIVIDUELS ---

    private Mono<ServiceStatus> checkDatabase() {
        return databaseClient.sql("SELECT 1")
                .fetch()
                .first()
                .map(r -> new ServiceStatus("UP", "PostgreSQL R2DBC Connected"))
                .timeout(Duration.ofSeconds(2))
                .onErrorResume(e -> Mono.just(new ServiceStatus("DOWN", e.getMessage())));
    }

    private Mono<ServiceStatus> checkRedis() {
        return redisConnectionFactory.getReactiveConnection()
                .ping()
                .map(resp -> new ServiceStatus("UP", "Redis PONG received"))
                .timeout(Duration.ofSeconds(2))
                .onErrorResume(e -> Mono.just(new ServiceStatus("DOWN", e.getMessage())));
    }

    private Mono<ServiceStatus> checkKafka() {
        // Check simple : est-ce que le contexte Kafka est chargé ?
        // Pour aller plus loin, il faudrait envoyer un message test, ce qui est intrusif.
        if (kafkaTemplate != null) {
            return Mono.just(new ServiceStatus("UP", "Kafka Producer Configured"));
        }
        return Mono.just(new ServiceStatus("UNKNOWN", "Kafka template not available"));
    }

    private Mono<ServiceStatus> checkRemoteService(String name, String url) {
        if (url == null || url.isBlank()) {
            return Mono.just(new ServiceStatus("DISABLED", "No URL configured"));
        }
        
        // On suppose que les services ont un endpoint /actuator/health ou répondent sur la racine
        // Pour être générique, on ping la racine ou une route connue.
        // Ici on tente simplement d'atteindre l'URL.
        return webClientBuilder.build()
                .get()
                .uri(url) // Attention: si l'URL est juste le domaine, il faut peut-être ajouter un path
                .retrieve()
                .toBodilessEntity()
                .map(response -> new ServiceStatus("UP", "HTTP " + response.getStatusCode()))
                .timeout(Duration.ofSeconds(3))
                .onErrorResume(e -> {
                    String msg = e.getMessage();
                    if (msg != null && msg.contains("Connection refused")) {
                        msg = "Unreachable";
                    }
                    return Mono.just(new ServiceStatus("DOWN", msg));
                });
    }

    // --- DTOs ---
    public record SystemHealth(String status, Instant timestamp, Map<String, ServiceStatus> dependencies) {}
    public record ServiceStatus(String status, String details) {}
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/config/AuthConfig.java`
```java
package com.yowyob.fleet.infrastructure.config;

import com.yowyob.fleet.domain.ports.out.AuthPort;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.FakeAuthAdapter;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.RemoteAuthAdapter;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.client.AuthApiClient;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
public class AuthConfig {

    @Bean
    @ConditionalOnProperty(name = "application.auth.mode", havingValue = "fake")
    public AuthPort fakeAuthPort() {
        return new FakeAuthAdapter();
    }

    @Bean
    @ConditionalOnProperty(name = "application.auth.mode", havingValue = "remote", matchIfMissing = true)
    public AuthPort remoteAuthPort(AuthApiClient authApiClient, WebClient.Builder webClientBuilder) {
        // Correction : On passe le builder nécessaire pour le Multipart
        return new RemoteAuthAdapter(authApiClient, webClientBuilder);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/config/WebClientConfig.java`
```java
package com.yowyob.fleet.infrastructure.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.support.WebClientAdapter;
import org.springframework.web.service.invoker.HttpServiceProxyFactory;

import com.yowyob.fleet.infrastructure.adapters.outbound.external.client.AuthApiClient;
import com.yowyob.fleet.infrastructure.adapters.outbound.external.client.VehicleApiClient;

@Configuration
public class WebClientConfig {

    @Bean
    public VehicleApiClient vehicleApiClient(WebClient.Builder builder, 
                                             @Value("${application.external.vehicle-service-url}") String url) {
                                            
        WebClient webClient = builder.baseUrl(url).build();
        WebClientAdapter adapter = WebClientAdapter.create(webClient);
        HttpServiceProxyFactory factory = HttpServiceProxyFactory.builderFor(adapter).build();
        
        return factory.createClient(VehicleApiClient.class);
    }

    @Bean
    public AuthApiClient authApiClient(WebClient.Builder builder, 
                                       @Value("${application.auth.url}") String url) {
        
        WebClient webClient = builder.baseUrl(url).build();
        WebClientAdapter adapter = WebClientAdapter.create(webClient);
        HttpServiceProxyFactory factory = HttpServiceProxyFactory.builderFor(adapter).build();
        
        return factory.createClient(AuthApiClient.class);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/config/SecurityConfig.java`
```java
package com.yowyob.fleet.infrastructure.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;
import org.springframework.security.config.web.server.ServerHttpSecurity;
import org.springframework.security.core.userdetails.MapReactiveUserDetailsService;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.server.SecurityWebFilterChain;

@Configuration
@EnableWebFluxSecurity
public class SecurityConfig {

    /**
     * Configures the security filter chain for WebFlux.
     */
    @Bean
    public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
        System.out.println("🛡️ REACTIVE SECURITY CONFIGURATION LOADED");

        return http
                // Disable CSRF as we are building a stateless REST API
                .csrf(ServerHttpSecurity.CsrfSpec::disable)
                
                .authorizeExchange(exchanges -> exchanges
                        // Allow access to health checks and monitoring
                        .pathMatchers("/actuator/**").permitAll()
                        
                        // Allow access to Swagger UI and API Documentation (v3)
                        .pathMatchers(
                                "/v3/api-docs/**", 
                                "/swagger-ui/**", 
                                "/swagger-ui.html", 
                                "/webjars/**",
                                "/api/v1/health/**",
                                "/api/v1/fleets/**",
                                "/api/v1/vehicles/**",
                                "/api/v1/drivers/**",
                                "/api/v1/auth/**" 
                        ).permitAll()
                        
                        // All other exchanges require authentication
                        .anyExchange().authenticated()
                )
                
                // Disable default login forms and basic auth
                .httpBasic(ServerHttpSecurity.HttpBasicSpec::disable)
                .formLogin(ServerHttpSecurity.FormLoginSpec::disable)
                .build();
    }

    /**
     * Provides a dummy technical user to satisfy Spring Security's requirements
     * and disable the auto-generated password in the logs.
     */
    @Bean
    public MapReactiveUserDetailsService userDetailsService() {
        UserDetails dummyUser = User.withUsername("technical_user")
                .password("{noop}dummy_password") // {noop} means no encoding
                .roles("SYSTEM")
                .build();
        return new MapReactiveUserDetailsService(dummyUser);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/config/RedisConfig.java`
```java
package com.yowyob.fleet.infrastructure.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.module.paramnames.ParameterNamesModule;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.ReactiveRedisConnectionFactory;
import org.springframework.data.redis.core.ReactiveRedisTemplate;
import org.springframework.data.redis.serializer.*;

@Configuration
public class RedisConfig {

    @Bean
    public ReactiveRedisTemplate<String, Object> reactiveRedisTemplate(
            ReactiveRedisConnectionFactory factory) {

        ObjectMapper mapper = new ObjectMapper()
                .registerModule(new ParameterNamesModule())
                .registerModule(new JavaTimeModule());

        Jackson2JsonRedisSerializer<Object> jsonSerializer =
                new Jackson2JsonRedisSerializer<>(mapper, Object.class);

        RedisSerializationContext<String, Object> context =
                RedisSerializationContext.<String, Object>newSerializationContext(new StringRedisSerializer())
                        .value(jsonSerializer)
                        .hashValue(jsonSerializer)
                        .build();

        return new ReactiveRedisTemplate<>(factory, context);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/config/KafkaConfig.java`
```java
package com.yowyob.fleet.infrastructure.config;

import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.common.serialization.StringSerializer;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.kafka.core.reactive.ReactiveKafkaProducerTemplate;
import reactor.kafka.sender.SenderOptions;

import java.util.HashMap;
import java.util.Map;

@Configuration
public class KafkaConfig {

    @Value("${spring.kafka.bootstrap-servers}")
    private String bootstrapServers;

    @Bean
    public ReactiveKafkaProducerTemplate<String, Object> reactiveKafkaProducerTemplate() {
        Map<String, Object> props = new HashMap<>();
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, org.springframework.kafka.support.serializer.JsonSerializer.class);

        SenderOptions<String, Object> senderOptions = SenderOptions.create(props);

        return new ReactiveKafkaProducerTemplate<>(senderOptions);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/fleet/infrastructure/config/OpenApiConfig.java`
```java
package com.yowyob.fleet.infrastructure.config;

import io.swagger.v3.oas.models.Components;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Contact;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.info.License;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import io.swagger.v3.oas.models.tags.Tag;
import org.springdoc.core.customizers.OpenApiCustomizer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Configuration
public class OpenApiConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        final String securitySchemeName = "bearerAuth";
        return new OpenAPI()
                .info(new Info()
                        .title("YowYob Microservice Fleet Management")
                        .version("1.0.0")
                        .description("API Réactive pour la gestion de flottes et le géorepérage.")
                        .contact(new Contact().name("Équipe Backend").email("dev@yowyob.com")))
                .addSecurityItem(new SecurityRequirement().addList(securitySchemeName))
                .components(new Components()
                        .addSecuritySchemes(securitySchemeName,
                                new SecurityScheme()
                                        .name(securitySchemeName)
                                        .type(SecurityScheme.Type.HTTP)
                                        .scheme("bearer")
                                        .bearerFormat("JWT")));
    }

    @Bean
    public OpenApiCustomizer sortTagsAlphabetically() {
        return openApi -> {
            // Définition de l'ordre exact souhaité
            List<String> order = List.of(
                "01. Monitoring",
                "02. Auth",
                "03. Account",
                "04. Fleet Managers",
                "05. Drivers",
                "06. Vehicles",
                "07. Fleets"
            );

            if (openApi.getTags() != null) {
                openApi.setTags(openApi.getTags().stream()
                        .sorted(Comparator.comparingInt(tag -> {
                            int index = order.indexOf(tag.getName());
                            return index == -1 ? 999 : index; // Les inconnus à la fin
                        }))
                        .collect(Collectors.toList()));
            }
        };
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/model/VehicleParameters.java`
```java
package com.yowyob.fleet.domain.model;

import java.time.LocalDate;
import java.util.UUID;

public class VehicleParameters {
    
    public record Financial(
        String insuranceNumber,
        LocalDate insuranceExpiryDate,
        LocalDate registrationDate,
        LocalDate purchaseDate,
        Integer depreciationRate,
        Float costPerKm
    ) {}

    public record Maintenance(
        LocalDate lastMaintenanceDate,
        LocalDate nextMaintenanceDue,
        String engineStatus, // 
        Integer batteryHealth,
        String maintenanceStatus
    ) {}

    public record Operational(
        Boolean status,
        Float currentSpeed,
        String fuelLevel,
        Float mileage,
        Float odometerReading,
        Float bearing,
        java.time.Instant timestamp,
        Location currentLocation
    ) {}

    public record Location(Double latitude, Double longitude) {}
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/model/FleetManager.java`
```java
package com.yowyob.fleet.domain.model;

import java.util.UUID;

public record FleetManager(
    UUID userId,
    String companyName,
    String subscriptionLevel
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/model/Vehicle.java`
```java
package com.yowyob.fleet.domain.model;

import java.util.UUID;

public record Vehicle(
    UUID id,
    UUID fleetId,
    String licensePlate,
    String brand,
    String model,
    Integer manufacturingYear,
    String type,
    String color,
    VehicleParameters.Financial financialParameters,
    VehicleParameters.Maintenance maintenanceParameters,
    VehicleParameters.Operational operationalParameters
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/model/Driver.java`
```java
package com.yowyob.fleet.domain.model;

import java.util.UUID;

public record Driver(
    UUID userId,
    String licenceNumber,
    Boolean status,
    UUID assignedVehicleId
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/model/Fleet.java`
```java
package com.yowyob.fleet.domain.model;

import java.time.LocalDate;
import java.util.UUID;

public record Fleet(
    UUID id,
    String name,
    LocalDate creationDate,
    UUID managerUserId,
    Integer vehicleCount
) {}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/ports/in/AuthUseCase.java`
```java
package com.yowyob.fleet.domain.ports.in;

import com.yowyob.fleet.domain.ports.out.AuthPort;
import reactor.core.publisher.Mono;
import java.util.UUID;
import java.util.List;

public interface AuthUseCase {
    Mono<AuthPort.AuthResponse> login(String identifier, String password);
    Mono<AuthPort.AuthResponse> register(RegisterCommand command);
    Mono<AuthPort.AuthResponse> refreshToken(String refreshToken);

    Mono<AuthPort.UserDetail> me(String token);
    Mono<AuthPort.UserDetail> updateProfile(UUID userId, String token, UpdateProfileCommand command);
    Mono<Void> changePassword(UUID userId, String token, String currentPwd, String newPwd);
    Mono<Void> deleteAccount(UUID userId, String token);
    Mono<Void> updateProfilePicture(UUID userId, String token, FileContent file);

    record RegisterCommand(
        String username, String password, String email, String phone,
        String firstName, String lastName, List<String> roles,
        FileContent photo 
    ) {}

    record UpdateProfileCommand(
        String firstName, String lastName, String phone, String email,
        String companyName, String licenceNumber
    ) {}

    record FileContent(String filename, String contentType, byte[] data) {}
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/ports/in/ManageFleetUseCase.java`
```java
package com.yowyob.fleet.domain.ports.in;

import com.yowyob.fleet.domain.model.Fleet;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface ManageFleetUseCase {
    Mono<Fleet> createFleet(Fleet fleet);
    Mono<Fleet> getFleetById(UUID id);
    Flux<Fleet> getAllFleets();
    Mono<Fleet> updateFleet(UUID id, Fleet fleet);
    Mono<Fleet> patchFleet(UUID id, Fleet fleet);
    Mono<Void> deleteFleet(UUID id);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/ports/in/ManageDriverUseCase.java`
```java
package com.yowyob.fleet.domain.ports.in;

import com.yowyob.fleet.domain.model.Driver;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.DriverRegistrationRequest;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface ManageDriverUseCase {
    // Changement de signature pour inclure les infos de création d'utilisateur
    Mono<Driver> registerDriver(DriverRegistrationRequest request);
    
    Mono<Driver> getDriverById(UUID userId);
    Flux<Driver> getAllDrivers(Boolean status);
    Mono<Void> assignVehicle(UUID userId, UUID vehicleId);
    Mono<Void> unassignVehicle(UUID userId);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/ports/in/ManageVehicleUseCase.java`
```java
package com.yowyob.fleet.domain.ports.in;

import com.yowyob.fleet.domain.model.Vehicle;
import com.yowyob.fleet.domain.model.VehicleParameters;

import reactor.core.publisher.Mono;
import java.util.UUID;

public interface ManageVehicleUseCase {
    /**
     * Aggregates local exploitation data with remote technical data.
     */
    Mono<Vehicle> getVehicleDetails(UUID vehicleId);

    /**
     * Adds a vehicle to a fleet after verifying its existence in the remote service.
     */
    Mono<Vehicle> addVehicleToFleet(Vehicle vehicle);

    Mono<Void> updateFinancialParameters(UUID vehicleId, VehicleParameters.Financial params);
    Mono<Void> updateMaintenanceParameters(UUID vehicleId, VehicleParameters.Maintenance params);
    Mono<Void> removeVehicleFromFleet(UUID vehicleId);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/ports/out/FleetManagerPersistencePort.java`
```java
package com.yowyob.fleet.domain.ports.out;

import com.yowyob.fleet.domain.model.FleetManager; // Sera créé implicitement ou on utilise DTO interne
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface FleetManagerPersistencePort {
    Mono<Void> createProfile(UUID userId, String companyName);
    Mono<Void> updateCompany(UUID userId, String companyName);
    Mono<String> getCompanyName(UUID userId);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/ports/out/DriverPersistencePort.java`
```java
package com.yowyob.fleet.domain.ports.out;

import com.yowyob.fleet.domain.model.Driver;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface DriverPersistencePort {
    Mono<Driver> save(Driver driver);
    Mono<Driver> findById(UUID userId);
    Flux<Driver> findAll(Boolean status);
    Mono<Void> updateVehicleAssignment(UUID userId, UUID vehicleId);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/ports/out/VehiclePersistencePort.java`
```java
package com.yowyob.fleet.domain.ports.out;

import com.yowyob.fleet.domain.model.Vehicle;
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface VehiclePersistencePort {
    /**
     * Saves the local data of a vehicle (Pivot, Financial, and Maintenance).
     */
    Mono<Vehicle> saveLocalData(Vehicle vehicle);

    /**
     * Retrieves only the local data stored in our database for a vehicle.
     */
    Mono<Vehicle> getLocalDataById(UUID id);

    /**
     * Deletes all local records associated with a vehicle ID.
     */
    Mono<Void> deleteLocalData(UUID id);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/ports/out/FleetRepositoryPort.java`
```java
package com.yowyob.fleet.domain.ports.out;

import com.yowyob.fleet.domain.model.Fleet;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface FleetRepositoryPort {
    Mono<Fleet> save(Fleet fleet);
    Mono<Fleet> findById(UUID id);
    Flux<Fleet> findAll();
    Mono<Void> deleteById(UUID id);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/ports/out/ExternalVehiclePort.java`
```java
package com.yowyob.fleet.domain.ports.out;

import com.yowyob.fleet.domain.model.Vehicle;
import reactor.core.publisher.Mono;
import java.util.UUID;

/**
 * Port used by the domain to fetch technical details from the external Vehicle Service.
 */
public interface ExternalVehiclePort {
    /**
     * Fetches details (brand, model, etc.) for a specific vehicle ID.
     */
    Mono<Vehicle> getExternalVehicleInfo(UUID vehicleId);
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/domain/ports/out/AuthPort.java`
```java
package com.yowyob.fleet.domain.ports.out;

import com.yowyob.fleet.domain.ports.in.AuthUseCase;
import reactor.core.publisher.Mono;
import java.util.List;
import java.util.UUID;

public interface AuthPort {
    // Auth pure
    Mono<AuthResponse> login(String identifier, String password);
    Mono<AuthResponse> refresh(String refreshToken);

    // Gestion Utilisateur Distant
    Mono<AuthResponse> registerInRemote(AuthUseCase.RegisterCommand command);
    Mono<UserDetail> getUserProfile(String token);
    Mono<UserDetail> updateUserProfile(UUID userId, String token, AuthUseCase.UpdateProfileCommand command);
    Mono<Void> changePassword(UUID userId, String token, String currentPwd, String newPwd);
    Mono<Void> deleteRemoteAccount(UUID userId, String token);
    Mono<Void> updateProfilePicture(UUID userId, String token, AuthUseCase.FileContent file); // NEW
    
    // Gestion Rôles Distants
    Mono<Boolean> roleExists(String roleName);
    Mono<Void> createRole(String roleName);

    // Objets de réponse (Outputs)
    record AuthResponse(String accessToken, String refreshToken, UserDetail user) {}

    record UserDetail(
        UUID id, 
        String username, 
        String email,
        String phone,
        String firstName,
        String lastName,
        String service,
        List<String> roles, 
        List<String> permissions,
        String photoUrl,
        String companyName,
        String licenceNumber,
        String vehicleId
    ) {}
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/application/service/AuthService.java`
```java
package com.yowyob.fleet.application.service;

import com.yowyob.fleet.domain.ports.in.AuthUseCase;
import com.yowyob.fleet.domain.ports.out.AuthPort;
import com.yowyob.fleet.domain.ports.out.DriverPersistencePort;
import com.yowyob.fleet.domain.ports.out.FleetManagerPersistencePort;
import com.yowyob.fleet.domain.model.Driver;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;
import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class AuthService implements AuthUseCase {

    private final AuthPort authPort;
    private final DriverPersistencePort driverPort;
    private final FleetManagerPersistencePort managerPort;

    @Override
    public Mono<AuthPort.AuthResponse> login(String identifier, String password) {
        return authPort.login(identifier, password)
                .flatMap(response -> syncLocalProfile(response.user()).thenReturn(response));
    }

    @Override
    public Mono<AuthPort.AuthResponse> register(RegisterCommand command) {
        return ensureRolesExist(command.roles())
                .then(authPort.registerInRemote(command))
                .flatMap(response -> createLocalProfile(response.user()).thenReturn(response));
    }

    @Override
    public Mono<AuthPort.AuthResponse> refreshToken(String refreshToken) {
        return authPort.refresh(refreshToken);
    }

    @Override
    public Mono<AuthPort.UserDetail> me(String token) {
        return authPort.getUserProfile(token)
                .flatMap(this::enrichWithLocalData);
    }

    @Override
    public Mono<AuthPort.UserDetail> updateProfile(UUID userId, String token, UpdateProfileCommand command) {
        return authPort.updateUserProfile(userId, token, command)
                .flatMap(updatedUser -> {
                    Mono<Void> localUpdate = Mono.empty();
                    if (updatedUser.roles().contains("FLEET_MANAGER") && command.companyName() != null) {
                        localUpdate = managerPort.updateCompany(userId, command.companyName());
                    } 
                    // Pour le driver, on pourrait update le permis ici si nécessaire
                    
                    return localUpdate.then(enrichWithLocalData(updatedUser));
                });
    }

    @Override
    public Mono<Void> changePassword(UUID userId, String token, String currentPwd, String newPwd) {
        return authPort.changePassword(userId, token, currentPwd, newPwd);
    }

    @Override
    public Mono<Void> updateProfilePicture(UUID userId, String token, FileContent file) {
        return authPort.updateProfilePicture(userId, token, file);
    }

    @Override
    public Mono<Void> deleteAccount(UUID userId, String token) {
        // 1. Supprimer côté Auth distant
        return authPort.deleteRemoteAccount(userId, token)
            .then(Mono.defer(() -> {
                // 2. Supprimer localement (Cascade DB fera le reste si FK configurées, 
                // mais on peut expliciter pour plus de sûreté ou pour les fichiers liés)
                // Ici on assume que le ON DELETE CASCADE de la DB fait le job sur drivers/fleet_managers
                return Mono.empty();
            }));
    }

    // --- LOGIQUE INTERNE ---
    
    private Mono<Void> ensureRolesExist(List<String> roles) {
        return Flux.fromIterable(roles)
                .flatMap(role -> authPort.roleExists(role)
                        .flatMap(exists -> !Boolean.TRUE.equals(exists) ? authPort.createRole(role) : Mono.empty())
                ).then();
    }

    private Mono<Void> createLocalProfile(AuthPort.UserDetail user) {
        if (user.roles().contains("FLEET_MANAGER")) {
            return managerPort.createProfile(user.id(), null);
        } else if (user.roles().contains("FLEET_DRIVER")) {
            String tempPermit = "PENDING-" + user.id().toString().substring(0, 8);
            Driver driver = new Driver(user.id(), tempPermit, true, null);
            return driverPort.save(driver).then();
        }
        return Mono.empty();
    }

    private Mono<Void> syncLocalProfile(AuthPort.UserDetail user) {
        return createLocalProfile(user).onErrorResume(e -> Mono.empty());
    }

    private Mono<AuthPort.UserDetail> enrichWithLocalData(AuthPort.UserDetail remoteUser) {
        if (remoteUser.roles().contains("FLEET_MANAGER")) {
            return managerPort.getCompanyName(remoteUser.id())
                    .map(company -> new AuthPort.UserDetail(
                            remoteUser.id(), remoteUser.username(), remoteUser.email(), remoteUser.phone(),
                            remoteUser.firstName(), remoteUser.lastName(), remoteUser.service(),
                            remoteUser.roles(), remoteUser.permissions(), remoteUser.photoUrl(),
                            company, null, null
                    ))
                    .defaultIfEmpty(remoteUser);
        } else if (remoteUser.roles().contains("FLEET_DRIVER")) {
            return driverPort.findById(remoteUser.id())
                    .map(driver -> new AuthPort.UserDetail(
                            remoteUser.id(), remoteUser.username(), remoteUser.email(), remoteUser.phone(),
                            remoteUser.firstName(), remoteUser.lastName(), remoteUser.service(),
                            remoteUser.roles(), remoteUser.permissions(), remoteUser.photoUrl(),
                            null, driver.licenceNumber(), driver.assignedVehicleId() != null ? driver.assignedVehicleId().toString() : null
                    ))
                    .defaultIfEmpty(remoteUser);
        }
        return Mono.just(remoteUser);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/application/service/VehicleService.java`
```java
package com.yowyob.fleet.application.service;

import com.yowyob.fleet.domain.model.Vehicle;
import com.yowyob.fleet.domain.model.VehicleParameters;
import com.yowyob.fleet.domain.ports.in.ManageVehicleUseCase;
import com.yowyob.fleet.domain.ports.out.ExternalVehiclePort;
import com.yowyob.fleet.domain.ports.out.VehiclePersistencePort;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class VehicleService implements ManageVehicleUseCase {

    private final VehiclePersistencePort localPersistencePort;
    private final ExternalVehiclePort externalVehiclePort;

    @Override
    public Mono<Vehicle> getVehicleDetails(UUID vehicleId) {
        return Mono.zip(
                localPersistencePort.getLocalDataById(vehicleId),
                externalVehiclePort.getExternalVehicleInfo(vehicleId)
        ).map(tuple -> {
            Vehicle local = tuple.getT1();
            Vehicle remote = tuple.getT2();

            return new Vehicle(
                    vehicleId,
                    local.fleetId(),
                    remote.licensePlate(),
                    remote.brand(),
                    remote.model(),
                    remote.manufacturingYear(),
                    remote.type(),
                    remote.color(),
                    local.financialParameters(),
                    local.maintenanceParameters(),
                    local.operationalParameters()
            );
        });
    }

    @Override
    public Mono<Vehicle> addVehicleToFleet(Vehicle vehicle) {
        return externalVehiclePort.getExternalVehicleInfo(vehicle.id())
                .switchIfEmpty(Mono.error(new RuntimeException("Vehicle not found in external registry")))
                .flatMap(remoteInfo -> localPersistencePort.saveLocalData(vehicle));
    }

    @Override
    public Mono<Void> updateFinancialParameters(UUID vehicleId, VehicleParameters.Financial params) {
        return localPersistencePort.getLocalDataById(vehicleId)
                .flatMap(existing -> {
                    Vehicle updatedVehicle = new Vehicle(
                            vehicleId, existing.fleetId(), null, null, null, null, null, null,
                            params, existing.maintenanceParameters(), null
                    );
                    return localPersistencePort.saveLocalData(updatedVehicle);
                })
                .then();
    }

    @Override
    public Mono<Void> updateMaintenanceParameters(UUID vehicleId, VehicleParameters.Maintenance params) {
        return localPersistencePort.getLocalDataById(vehicleId)
                .flatMap(existing -> {
                    Vehicle updatedVehicle = new Vehicle(
                            vehicleId, existing.fleetId(), null, null, null, null, null, null,
                            existing.financialParameters(), params, null
                    );
                    return localPersistencePort.saveLocalData(updatedVehicle);
                })
                .then();
    }

    @Override
    public Mono<Void> removeVehicleFromFleet(UUID vehicleId) {
        return localPersistencePort.deleteLocalData(vehicleId);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/application/service/FleetService.java`
```java
package com.yowyob.fleet.application.service;

import com.yowyob.fleet.domain.model.Fleet;
import com.yowyob.fleet.domain.ports.in.ManageFleetUseCase;
import com.yowyob.fleet.domain.ports.out.FleetRepositoryPort;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.time.LocalDate;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class FleetService implements ManageFleetUseCase {

    private final FleetRepositoryPort fleetRepository;

    @Override
    public Mono<Fleet> createFleet(Fleet fleet) {
        // Business logic: ensure creation date is set if not provided
        Fleet fleetToSave = new Fleet(
                fleet.id(),
                fleet.name(),
                fleet.creationDate() != null ? fleet.creationDate() : LocalDate.now(),
                fleet.managerUserId(),
                0
        );
        return fleetRepository.save(fleetToSave);
    }

    @Override
    public Mono<Fleet> getFleetById(UUID id) {
        return fleetRepository.findById(id);
    }

    @Override
    public Flux<Fleet> getAllFleets() {
        return fleetRepository.findAll();
    }

    @Override
    public Mono<Fleet> updateFleet(UUID id, Fleet fleet) {
        return fleetRepository.findById(id)
                .flatMap(existingFleet -> {
                    Fleet updated = new Fleet(
                            id,
                            fleet.name(),
                            existingFleet.creationDate(), // Keep original creation date
                            fleet.managerUserId(),
                            existingFleet.vehicleCount()
                    );
                    return fleetRepository.save(updated);
                });
    }

    @Override
    public Mono<Fleet> patchFleet(UUID id, Fleet fleet) {
        return fleetRepository.findById(id)
                .flatMap(existing -> {
                    // Logic: Update only non-null fields from the request
                    Fleet patched = new Fleet(
                            id,
                            fleet.name() != null ? fleet.name() : existing.name(),
                            existing.creationDate(),
                            fleet.managerUserId() != null ? fleet.managerUserId() : existing.managerUserId(),
                            existing.vehicleCount()
                    );
                    return fleetRepository.save(patched);
                });
    }

    @Override
    public Mono<Void> deleteFleet(UUID id) {
        return fleetRepository.deleteById(id);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/fleet/application/service/DriverService.java`
```java
package com.yowyob.fleet.application.service;

import com.yowyob.fleet.domain.model.Driver;
import com.yowyob.fleet.domain.ports.in.AuthUseCase;
import com.yowyob.fleet.domain.ports.in.ManageDriverUseCase;
import com.yowyob.fleet.domain.ports.out.AuthPort;
import com.yowyob.fleet.domain.ports.out.DriverPersistencePort;
import com.yowyob.fleet.infrastructure.adapters.inbound.rest.dto.DriverRegistrationRequest;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.List;
import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class DriverService implements ManageDriverUseCase {

    private final DriverPersistencePort driverPersistencePort;
    private final AuthPort authPort;

    @Override
    public Mono<Driver> registerDriver(DriverRegistrationRequest request) {
        log.info("Étape 1 : Création du compte utilisateur distant pour {}", request.username());
        
        // 1. Préparation de la commande avec le rôle spécifique
        AuthUseCase.RegisterCommand command = new AuthUseCase.RegisterCommand(
            request.username(),
            request.password(),
            request.email(),
            request.phone(),
            request.firstName(),
            request.lastName(),
            List.of("FLEET_DRIVER"), // On utilise le rôle standardisé
            null // Pas de photo via cet endpoint spécifique
        );

        // 2. Appel au service d'authentification distant
        return authPort.registerInRemote(command)
            .flatMap(authRes -> {
                log.info("Étape 2 : Création du profil chauffeur local pour UUID {}", authRes.user().id());
                
                // 3. Création du modèle de domaine Driver
                Driver localDriver = new Driver(
                    authRes.user().id(), // UUID TraMaSys
                    request.licenceNumber(),
                    true, // Actif par défaut
                    null  // Aucun véhicule au départ
                );
                
                // 4. Sauvegarde en base de données locale
                return driverPersistencePort.save(localDriver);
            });
    }

    @Override public Mono<Driver> getDriverById(UUID userId) { return driverPersistencePort.findById(userId); }
    @Override public Flux<Driver> getAllDrivers(Boolean status) { return driverPersistencePort.findAll(status); }
    @Override public Mono<Void> assignVehicle(UUID userId, UUID vehicleId) { return driverPersistencePort.updateVehicleAssignment(userId, vehicleId); }
    @Override public Mono<Void> unassignVehicle(UUID userId) { return driverPersistencePort.updateVehicleAssignment(userId, null); }
}```

---
### Fichier : `./.mvn/wrapper/maven-wrapper.properties`
```properties
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip
```

---
### Fichier : `./Readme.md`
```md
# Fleet Management & Geofencing API 🚚🛰️

Service backend réactif pour la gestion de flottes de véhicules et le géorepérage en temps réel.

## 🤝 Workflow de Collaboration IA

Ce projet est développé en mode **Pair Programming** avec une IA (Gemini/ChatGPT). Pour maintenir la cohérence :

1. **Roadmap** : Consultez le fichier `todo.md` pour voir la tâche en cours.
2. **Contextualisation** : L'IA a besoin du code source complet. Utilisez le script de synchronisation :
   ```bash
   chmod +x import_context.sh
   ./import_context.sh
   ```
   Cela génère/met à jour le fichier `project_context.txt`.
3. **Initialisation de l'IA** : Pour commencer une session, copiez-collez le contenu de `docs/prompts/master_pair_programmer.md` suivi du contenu de `project_context.txt`.

## 🛠️ Installation & Tests

### Prérequis
- Java 21
- PostgreSQL (avec accès aux serveurs distants configurés dans le `.yml`)


### Comment lancer le projet ?

**Sur Linux / Mac :**
1. Oouvrez un terminal à la racine.
2. Lancez : `./run_local.sh`

**Sur Windows :**
1. Double-cliquez sur `run_local.bat` (ou lancez-le depuis un terminal).

*Cela va automatiquement monter la base de données Docker et lancer l'application avec la configuration locale.*

### En cas de problème de base de données
Si vous avez des erreurs Liquibase ou de schéma, réinitialisez la base avec :
- Linux/Mac : `./reset_db.sh`
- Windows : `reset_db.bat`

### Valider les changements
- **Swagger UI** : [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **Santé de la DB** : Utilisez les endpoints définis dans chaque jalon (voir `todo.md`).
```
```

---
### Fichier : `./pom.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.6</version>
        <relativePath/>
    </parent>
    
    <groupId>com.yowyob</groupId>
    <artifactId>reactive-hexagonal</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>reactive-hexagonal</name>
    <description>Template Hexagonal Reactive pour com.yowyob</description>
    
    <properties>
        <java.version>21</java.version>
        <spring-cloud.version>2023.0.0</spring-cloud.version>
        <mapstruct.version>1.5.5.Final</mapstruct.version>
    </properties>
    
    <dependencies>
        <!-- REACTIVE CORE -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <dependency>
             <groupId>org.springframework.boot</groupId>
             <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
  
        <dependency>
           <groupId>io.micrometer</groupId>
           <artifactId>micrometer-registry-prometheus</artifactId>
        </dependency>

        <!-- DATA (R2DBC) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-r2dbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>r2dbc-postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        
        <!-- DATA (REDIS) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
        </dependency>

        <!-- LIQUIBASE & JDBC (Migration uniquement) -->
        <dependency>
            <groupId>org.liquibase</groupId>
            <artifactId>liquibase-core</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
            <exclusions>
                <!-- On exclut HikariCP pour ne pas confondre avec R2DBC, mais Spring en a besoin pour Liquibase -->
            </exclusions>
        </dependency>
        <!-- Driver JDBC PostgreSQL (Scope runtime pour Liquibase) - UNIQUE DECLARATION -->
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!-- MESSAGING (KAFKA) -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>
        <dependency>
            <groupId>io.projectreactor.kafka</groupId>
            <artifactId>reactor-kafka</artifactId>
            <version>1.3.22</version>
        </dependency>

        <!-- CLOUD & RESILIENCE -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-circuitbreaker-reactor-resilience4j</artifactId>
        </dependency>

        <!-- TOOLS (Lombok & Mapstruct) -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>${mapstruct.version}</version>
        </dependency>
        
        <!-- Docker Compose Auto-setup -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-docker-compose</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        
        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.projectreactor</groupId>
            <artifactId>reactor-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Documentation API (Swagger/OpenAPI) -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webflux-ui</artifactId>
            <version>2.5.0</version>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${mapstruct.version}</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>```

---
### Fichier : `./.github/workflows/ci-cd.yml`
```yaml
name: Spring Boot CI/CD

on:
  push:
    branches:
      - "**"
      #- main

env:
  REGISTRY_IMAGE: ghcr.io/${{ github.repository_owner }}/fleet-management
  APP_NAME: fleet-management
  HEALTH_DELAY: ${{ secrets.DEPLOY_DELAY }}
  CONTAINER_NAME: fleet-management

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Run Unit Tests + SonarQube Analysis
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=${{ env.APP_NAME }} \
            -Dsonar.projectName=${{ env.APP_NAME }} \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}

  build:
    needs: tests
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.PERSONAL_ACCESS_TOKEN }}" | docker login ghcr.io -u ${{ secrets.REGISTRY_NAMESPACE }} --password-stdin

      - name: Use prod.application.yml
        run: |
          echo "Using prod.application.yml"
          rm src/main/resources/application.yml
          mv src/main/resources/prod.application.yml src/main/resources/application.yml
          cat src/main/resources/application.yml

      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t ${{ env.REGISTRY_IMAGE }}:latest .

      - name: Push Docker image
        run: |
          echo "Pushing Docker image..."
          docker push ${{ env.REGISTRY_IMAGE }}:latest


  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'

            echo "Pulling latest image ${{ env.REGISTRY_IMAGE }}"

            docker login ghcr.io -u ${{ secrets.REGISTRY_NAMESPACE }} -p ${{ secrets.PERSONAL_ACCESS_TOKEN }}

            cd /root/projet_synthese/infra

            echo "Stopping container"
            docker compose down ${{ env.CONTAINER_NAME }}

            echo "Removing old image"
            docker rmi -f ${{ env.REGISTRY_IMAGE }}:latest || true

            echo "Pulling new image"
            docker pull ${{ env.REGISTRY_IMAGE }}:latest

            echo " Starting container"
            docker compose up -d ${{ env.CONTAINER_NAME }}

            echo " Waiting ${{ env.HEALTH_DELAY }} seconds for health check"
            sleep ${{ env.HEALTH_DELAY }}

            echo " Checking container health..."
            STATUS=$(docker inspect --format='{{json .State.Health.Status}}' ${{ env.CONTAINER_NAME }})

            echo "Health status: $STATUS"

            if [ "$STATUS" != "\"healthy\"" ]; then
              echo "ERROR: Container is not healthy"
              exit 1
            fi

            echo "Deployment successful & container healthy!"
          EOF```

---
### Fichier : `./docker-compose.yml`
```yaml
services:
  # 1. Base de données
  fleet-db:
    image: postgres:16-alpine
    container_name: fleet-management-db
    environment:
      POSTGRES_DB: yowyob_db
      POSTGRES_USER: fleet_admin
      POSTGRES_PASSWORD: fleet_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - fleet-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fleet_admin -d yowyob_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Redis
  fleet-redis:
    image: redis:alpine
    container_name: fleet-management-redis
    ports:
      - "6379:6379"
    networks:
      - fleet-network

  # 3. Kafka (Image Officielle Apache - Mode KRaft)
  fleet-kafka:
    image: apache/kafka:3.7.0
    container_name: fleet-management-kafka
    ports:
      - "9092:9092"
    environment:
      # Configuration du Node
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      
      # Configuration Réseau
      # CONTROLLER: port interne pour le cluster (9093)
      # PLAINTEXT: port pour les clients (9092)
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      
      # C'est ici qu'on dit à Kafka "Si quelqu'un te cherche, dis-lui que tu es sur localhost:9092"
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      
      # Sécurité et Mapping
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      
      # Quorum KRaft (pointe vers lui-même car nœud unique)
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@fleet-management-kafka:9093
      
      # Optimisations pour environnement local (évite la création de centaines de partitions)
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      
    networks:
      - fleet-network

volumes:
  postgres_data:

networks:
  fleet-network:
    driver: bridge```
